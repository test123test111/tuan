define(["cBase","cUICore","cUtility","cWidgetFactory","cGeoService","cWidgetGeolocation","libs"],function(e,t,n,r,i){function l(e){return e===Object(e)}var s="AMapWidget",o=function(){},u=null,a,f=$.isArray;a=new e.Class({__propertys__:function(){this.options={key:"0b895f63ca21c9e82eb158f46fe7f502",webapi:"http://webapi.amap.com/maps?v=1.2",level:13,center:u,height:0,width:0,locationButton:u,onReady:o,onZoom:o,onMovestart:o,onGeoBegin:o,onGeoComplete:o,onGeoError:o},this.__stacks=[]},initialize:function(e){var t=this,n;l(e)&&(n=$.extend(this.options,e)),this.options=n,t._updateContainerSize(n.width,n.height),t._loadScript($.proxy(t._createMap,t)),t.gps=i.GeoLocation},addMarker:function(e){var t=this,n=this.host,r=[];if(!n){this.__stacks.push(e);return}return f(e)?(e.forEach(function(e){r.push(t.addMarker(e))}),r):(r=new n.Marker(e),r.setMap(this.map),r)},removeMarker:function(e){e.setMap(null)},addEvent:function(e,t,n,r){var i,s=this;if(l(t)){for(i in t)t.hasOwnProperty(i)&&s.addEvent(e,t,t[item],r);return}s.host.event.addListener(e,t,n,r)},removeEvent:function(e,t,n,r){var i,s=this;if(l(t)){for(i in t)t.hasOwnProperty(i)&&s.addEvent(t,t[item]);return}s.host.event.removeListener(e,t,n)},setFitView:function(){this.map.setFitView()},setPosition:function(e,t,n){e.setPosition(new this.host.LngLat(t,n))},removeControl:function(e){this.map.removeControl(e)},_bindEvents:function(){var e=this.host.event;this.__zoomendHandler=$.proxy(this._zoomendHandler,this),this.__movestartHandler=$.proxy(this._movestartHandler,this),e.addListener(this.map,"zoomchange",this.__zoomendHandler),e.addListener(this.map,"movestart",this.__movestartHandler),this.__clickHandler=$.proxy(this._clickHandler,this),e.addListener(this.map,"click",this.__clickHandler)},_unbindEvents:function(){this.host.event.event.removeListener(this.map,"zoomchange",this.__zoomendHandler),this.host.event.event.removeListener(this.map,"click",this.__clickHandler)},_clickHandler:function(){this.options.onClick.call(this)},_zoomendHandler:function(e){var t=this.options;t.onZoom.call(this,e,this.map.getZoom())},_movestartHandler:function(e){var t=this.options;t.onMovestart.call(this,e)},_formatGPSInfo:function(e){return{coords:{latitude:e.lat,longitude:e.lng,accuracy:50},timestamp:+(new Date)}},_addCurrentLocationTool:function(e,t,r){var i=this,s=this.map,o=this.host;s.plugin("AMap.Geolocation",function(){geolocation=new o.Geolocation({enableHighAccuracy:!0,timeout:1e4,maximumAge:0,convert:!0,buttonDom:i.options.locationButton,showButton:!0,buttonPosition:"LB",buttonOffset:new o.Pixel(0,0),showMarker:!0,showCircle:!0,panToLocation:!1,zoomToAccuracy:!1}),n.isInApp()&&(geolocation.onButtonClick=function(){r&&r.call(geolocation,geolocation._container),i.gps.Subscribe("tuan/amap",{onComplete:function(e){geolocation.onPositionComplete(i._formatGPSInfo(e))},onError:function(e){geolocation.onPositionError(e)},onPosComplete:function(e,t){},onPosError:function(e){geolocation.onPositionError(e)}},i,!0)}),s.addControl(geolocation),o.event.addListener(geolocation,"complete",$.proxy(e,i)),o.event.addListener(geolocation,"error",$.proxy(t,i)),i.geolocation=geolocation})},_updateContainerSize:function(e,t){var n=this.options,r=n.container,i=document.body,s=r.offset();e||(e=s.width||i.clientWidth),t||(t=s.height||i.clientHeight),r.css({width:e,height:t})},_createMap:function(){var e=window.AMap,t=this.options,n=this.__stacks,r=t.center.split("|");if(!e)throw new Error("no mapapi!");this.host=e,this.map=new e.Map(t.container[0],{level:11,center:new e.LngLat(r[0],r[1])}),n.length&&this.addMarker(n),this._bindEvents(),t.locationButton&&this._addCurrentLocationTool(t.onGeoComplete,t.onGeoError,t.onGeoBegin),t.onReady.call(this)},_loadScript:function(e){if(window.AMap){e();return}var t=document.createElement("script"),n=this.options,r="__"+s+Date.now();window[r]=e,t.type="text/javascript",t.src=n.webapi+"&key="+n.key+"&callback="+r,document.body.appendChild(t)}}),r.register({name:s,fn:a})});