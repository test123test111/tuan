define(["cBase","cUtility","cWidgetFactory","cUIMask","cUIScroll","DropDown","Tab","StringsData","TuanModel","TuanStore","StoreManage"],function(e,t,n,r,i,s,o,u,a,f,l){var c,h=$.extend,p={weizhiquyu:"位置区域"},d=!1,v=t.getAppSys()==="youth",m=f.GroupCategoryFilterStore.getInstance(),g=f.GroupSortStore.getInstance(),y=f.GroupSearchStore.getInstance(),b=a.TuanConditionModel.getInstance(),w=f.GroupConditionStore.getInstance(),E=f.GroupCustomFilters.getInstance(),S=f.TuanHistoryCityListStore.getInstance(),x=f.GroupPositionFilterStore.getInstance(),T=["price","day","trait","distance","brand"],N=_.template(['<%if(["all", "hotel", "catering"].indexOf(category)!=-1){%>','<div class="pop_filter_chkitem" data-type="weekendsAvailable" data-text="周末可用">周末可用','<div class="pop_filter_label">','<input type="checkbox" id="weekends"<%if(weekendsAvailable==1){%> checked<%}%> /><label for="weekends"></label>',"</div>","</div>","<%}%>",'<%if(category=="hotel"){%>','<div class="pop_filter_chkitem" data-type="multiShop" data-text="多店可用">多店可用','<div class="pop_filter_label">','<input type="checkbox" id="multiShop"<%if(multiShop==1){%> checked<%}%> /><label for="multiShop"></label>',"</div>","</div>",'<div class="pop_filter_chkitem" data-type="voucher" data-text="代金券">代金券','<div class="pop_filter_label">','<input type="checkbox" id="voucher"<%if(voucher==1){%> checked<%}%> /><label for="voucher"></label>',"</div>","</div>","<%}%>"].join("")),C=_.template(['<ul class="pop_filter_tabs">','<li data-tab="price"><i class="pop_filter_point"<%if(!customdata.price || (customdata.price && customdata.price.val == "1|1")){%> style="display:none"<%}%>></i>价格</li>','<%if(category=="vacation"){%><li data-tab="day"><i class="pop_filter_point"<%if(!customdata.day){%> style="display:none"<%}%>></i>天数</li><%}%>','<%if(category=="hotel"){%><li data-tab="star"><i class="pop_filter_point"<%if(!customdata.star){%> style="display:none"<%}%>></i>星级</li><%}%>','<%if(category=="hotel"){%><li data-tab="brand"><i class="pop_filter_point"<%if(!customdata.brand){%> style="display:none"<%}%>></i>品牌</li><%}%>','<%if(category=="hotel"){%><li data-tab="trait"><i class="pop_filter_point"<%if(!customdata.trait){%> style="display:none"<%}%>></i>特色</li><%}%>','<%if((isNearBy && ["all", "hotel", "catering", "ticket", "entertainment"].indexOf(category)!=-1) || isUniversityNearBy){%><li data-tab="distance"><i class="pop_filter_point"<%if(!customdata.distance){%> style="display:none"<%}%>></i>距离</li><%}%>',"</ul>"].join("")),k=_.template(['<li data-filter="brand"<%if(!val){%> class="choosed"<%}%>><div class="txt01">不限</div></li>',"<%_.each(arr, function(a,i){%>",'<li data-filter="brand" data-value="<%=a.val%>" data-text="<%=a.txt%>"<%if(a.val==val){%> class="choosed"<%}%>>','<div class="txt01"><%=a.txt%></div>',"</li>","<%})%>"].join("")),L=_.template(['<li data-filter="trait"<%if(!val){%> class="choosed"<%}%>><div class="txt01">不限</div></li>',"<%_.each(arr, function(a,i){%>",'<li data-filter="trait" data-value="<%=a.val%>" data-text="<%=a.txt%>"<%if(a.val==val){%> class="choosed"<%}%>>','<div class="txt01"><%=a.txt%></div>',"</li>","<%})%>"].join("")),A=_.template(['<div class="pop_filter_lefttab">','<ul class="pop_filter_tabs">',"<%_.each(tuanType, function(v){%>",'<li class="J_categoryTabLabel<%if(v.val==tuanTypeVal){%> choosed<%}%>"><%=v.txt%></li>',"<%})%>","</ul>","</div>",'<div class="pop_filter_righttab">',"<%_.each(tuanType, function(v){%>",'<div class="J_categoryTabPanel" style="height:285px;<%if(v.val!=tuanTypeVal){%>display:none<%}%>">','<ul class="pop_filter_baselist" style="min-height:285px">','<li data-type="<%=v.val%>"<%if(v.val==tuanTypeVal && typeof subVal == "undefined"){%> class="choosed"<%}%>><div class="txt01"><%=v.val>0 ? "全部" : ""%><%=v.txt%></div><span class="txt02"><%=v.groupCount%></span></li>',"<%_.each(subTuanType, function(s){%>","<%if (s.parentType == v.val){%>",'<li data-type="<%=v.val%>" data-value="<%=s.val%>" data-name="<%=s.txt%>"<%if(typeof subVal !== "undefined" && s.val==subVal){%> class="choosed"<%}%>><div class="txt01"><%=s.txt%></div><span class="txt02"><%=s.groupCount%></span></li>',"<%}%>","<%})%>","</ul>","</div>","<%})%>","</div>"].join("")),O=_.template(['<div class="pop_filter_lefttab">','<ul class="pop_filter_tabs">','<%if(Zone.length){%><li class="J_positionTabLabel<%if(curr.type==5){%> choosed<%}%>">商业区</li><%}%>','<%if(Location.length){%><li class="J_positionTabLabel<%if(curr.type==4){%> choosed<%}%>">行政区</li><%}%>','<%if(tuanType!=7 && AirportStation.length){%><li class="J_positionTabLabel<%if(curr.type==-4){%> choosed<%}%>">机场车站</li><%}%>','<%if(tuanType!=7 && SubwayLine.length){%><li class="J_positionTabLabel<%if(curr.type==-3){%> choosed<%}%>">地铁线</li><%}%>','<%if(tuanType!=7 && Attraction.length){%><li class="J_positionTabLabel<%if(curr.type==-2){%> choosed<%}%>">景点</li><%}%>','<%if(tuanType!=7 && College.length){%><li class="J_positionTabLabel<%if(curr.type==-1){%> choosed<%}%>">大学周边</li><%}%>',"</ul>","</div>",'<div class="pop_filter_righttab">',"<%if(Zone.length){%>",'<div class="J_positionTabPanel"<%if(curr.type!=5){%> style="height:285px;display:none"<%}%>>','<ul class="pop_filter_baselist" style="min-height:285px">','<li<%if(!curr.val||curr.type!=5){%> class="choosed"<%}%>><div class="txt01">不限</div></li>',"<%_.each(Zone, function(val){%>",'<li data-type="5" data-value="<%=val.val%>" data-pos=\'<%=JSON.stringify(val.pos)%>\' data-text="<%=val.txt%>"<%if(curr.type==5&&curr.val==val.val){%> class="choosed"<%}%>><div class="txt01"><%=val.txt%></div><span class="txt02"><%=val.groupCount%></span></li>',"<%})%>","</ul>","</div>","<%}%>","<%if(Location.length){%>",'<div class="J_positionTabPanel"<%if(curr.type!=4){%> style="height:285px;display:none"<%}%>>','<ul class="pop_filter_baselist" style="min-height:285px">','<li<%if(!curr.val||curr.type!=4){%> class="choosed"<%}%>><div class="txt01">不限</div></li>',"<%_.each(Location, function(val){%>",'<li data-type="4" data-value="<%=val.val%>" data-text="<%=val.txt%>"<%if(curr.type==4&&curr.val==val.val){%> class="choosed"<%}%>><div class="txt01"><%=val.txt%></div><span class="txt02"><%=val.groupCount%></span></li>',"<%})%>","</ul>","</div>","<%}%>","<%if(tuanType!=7 && AirportStation.length){%>",'<div class="J_positionTabPanel"<%if(curr.type!=-4){%> style="height:285px;display:none"<%}%>>','<ul class="pop_filter_baselist" style="min-height:285px">','<li<%if(!curr.val||curr.type!=-4){%> class="choosed"<%}%>><div class="txt01">不限</div></li>',"<%_.each(AirportStation, function(val){%>",'<li data-type="-4" data-value="<%=val.val%>" data-pos=\'<%=JSON.stringify(val.pos)%>\' data-text="<%=val.txt%>"<%if(curr.type==-4&&curr.val==val.val){%> class="choosed"<%}%>><div class="txt01"><%=val.txt%></div><span class="txt02"><%=val.groupCount%></span></li>',"<%})%>","</ul>","</div>","<%}%>","<%if(tuanType!=7 && SubwayLine.length){%>",'<div class="J_positionTabPanel"<%if(curr.type!=19){%> style="height:285px;display:none"<%}%> id="J_subwayLine">','<ul class="pop_filter_baselist" style="min-height:285px">','<li<%if(!curr.line){%> class="backwards"<%}%>><div class="txt01">不限</div></li>',"<%_.each(SubwayLine, function(val){%>",'<li data-type="-5" data-value="<%=val.val%>" data-text="<%=val.txt%>" class="arr_r<%if(curr.line==val.val){%> backwards<%}%>"><div class="txt01"><%=val.txt%></div><span class="txt03"><%if(curr.line==val.val&&curr.type==-3){%><%=curr.name%><%}%></span><span class="txt02"><%=val.groupCount%></span></li>',"<%})%>","</ul>","</div>","<%}%>","<%if(tuanType!=7 && Attraction.length){%>",'<div class="J_positionTabPanel"<%if(curr.type!=-2){%> style="height:285px;display:none"<%}%>>','<ul class="pop_filter_baselist" style="min-height:285px">','<li<%if(!curr.val||curr.type!=-2){%> class="choosed"<%}%>><div class="txt01">不限</div></li>',"<%_.each(Attraction, function(val){%>",'<li data-type="-2" data-value="<%=val.val%>" data-pos=\'<%=JSON.stringify(val.pos)%>\' data-text="<%=val.txt%>"<%if(curr.type==-2&&curr.val==val.val){%> class="choosed"<%}%>><div class="txt01"><%=val.txt%></div><span class="txt02"><%=val.groupCount%></span></li>',"<%})%>","</ul>","</div>","<%}%>","<%if(tuanType!=7 && College.length){%>",'<div class="J_positionTabPanel"<%if(curr.type!=-1){%> style="height:285px;display:none"<%}%>>','<ul class="pop_filter_baselist" style="min-height:285px">','<li<%if(!curr.pos||curr.type!=-1){%> class="choosed"<%}%>><div class="txt01">不限</div></li>',"<%_.each(College, function(val){%>",'<li data-type="-1" data-pos=\'<%=JSON.stringify(val.pos)%>\' data-text="<%=val.txt%>"<%if(curr.type==-1&&curr.pos.lat==val.lat&&curr.pos.lon==val.lon){%> class="choosed"<%}%>><div class="txt01"><%=val.txt%></div></li>',"<%})%>","</ul>","</div>","<%}%>",'<div class="J_positionTabPanel" style="height:285px;overflow:hidden;display:none" id="J_subwayStation">','<ul class="pop_filter_baselist" style="min-height:285px;"></ul>',"</div>","</div>"].join("")),M=_.template(['<li data-type="-3"><div class="pop_filter_back">返回</div></li>','<li data-type="19" data-line="<%=lineId%>"<%if(curr.val==lineId&&curr.type==19){%> class="choosed"<%}%> data-text="<%=lineName%>"><div class="txt01">全线</div></li>',"<%_.each(arr, function(a,i){%>",'<li data-type="-3" data-value="<%=a.val%>" data-line="<%=lineId%>" data-pos=\'<%=JSON.stringify(a.pos)%>\' data-text="<%=a.txt%>"<%if(curr.val==a.val){%> class="choosed"<%}%>>','<div class="txt01"><%=a.txt%></div>',"</li>","<%})%>"].join(""));return c=new e.Class({__propertys__:function(){var e=this;this.options={},this.page=null,this.mask=new r({onCreate:function(){var t=this;this.root.on("click",function(){e.options.categoryPanel.hide(),e.options.positionPanel.hide(),e.options.filterPanel.hide(),e._categoryStatus=!1,e._positionStatus=!1,e._customFilterStatus=!1,t.hide()})}})},initSort:function(){var e=this,t=g.getAttr("sortTypeIndex")||0,n=y.getAttr("sortRule"),r=y.getAttr("sortType"),i=e.options;this.sort=new s({trigger:i.sortTrigger,panel:i.sortPanel,label:i.sortLabel,selectedIndex:t,selectedItemCls:"choosed",onShow:function(){i.categoryPanel.hide(),i.positionPanel.hide(),i.filterPanel.hide(),e.mask.hide(),e._categoryStatus=!1,e._positionStatus=!1,e._customFilterStatus=!1},onSelect:function(t){var n=$(t),r=n.attr("data-id"),i=n.attr("data-type"),s=+this.selectedIndex>=0?this.selectedIndex:0;g.setAttr("sortTypeIndex",s),y.setAttr("sortRule",r),r==2&&v&&(i=8),y.setAttr("sortType",i),e.getListData()}});var o=this.sort.panel.find('[data-id="'+n+'"][data-type="'+r+'"]');o=o&&o[0]||$(this.sort.getItemByIndex(t))[0],this.sort.select(o,!0),i.sortPanel.on("touchmove",function(e){e.preventDefault()})},initCategory:function(){var e=this,t=this.options.categoryTrigger,n=this.options.categoryPanel;this.renderCategory(),t.on("click",function(){e._categoryStatus?(n.hide(),e.mask.hide(),e._categoryStatus=!1):(e.options.positionPanel.hide(),e.options.filterPanel.hide(),e._positionStatus=!1,e._customFilterStatus=!1,e.sort.hide(),n.show(),e.mask.show(),n.css({"-webkit-transform":"translate(0, 30px) translateZ(0)",opacity:0}),n.animate({"-webkit-transform":"translate(0, -8px) translateZ(0)",opacity:1}),e._categoryStatus=!0,e._categoryInited==undefined&&(e.initCategoryTab(),e._categoryInited=!0))}),n.on("touchmove",function(e){e.preventDefault()})},initCategoryTab:function(){var e=this,t=this.page.$el,n=t.find(".J_categoryTabLabel"),r=t.find(".J_categoryTabPanel");this.categoryTab=new o({label:n,panel:r,isScroll:!0,labelSelectedClass:"choosed",labelSelectedIndex:m.getAttr("tuanTypeIndex")||0,itemClass:".pop_filter_baselist li",itemSelectedClass:"choosed",onSelect:function(t){var n=t.data("type"),i=t.data("value")||"",s=t.data("name"),o=u.groupType[n];r.find(".choosed").removeClass("choosed"),t.addClass("choosed"),e.page.updateTitle(o.name),e.page.searchKeywordInput.val(""),n==7&&S.removeAttr("nearby");var a=E.getAttr("distance");l.clearSpecified(!1),a&&l.isNearBy()&&E.setAttr("distance",a),e.clearCustomFilter(!0),m.setAttr("tuanType",n),m.setAttr("category",o.category),m.setAttr("name",o.name),m.setAttr("tuanTypeIndex",o.index),m.setAttr("subVal",i),m.setAttr("subName",s),y.setAttr("qparams",l.getGroupQueryParam()),y.setAttr("ctype",n),e.options.categoryTrigger.html(s||u.groupType[n].name),e.resetPosition(n),e.getListData(),e.renderFilter(o.category),e.mask.hide(),e.options.categoryPanel.hide(),e._categoryStatus=!1}})},renderCategory:function(){var e={},t=w.get(),n=m.get()||{},r=this.options.categoryTrigger;e.tuanTypeVal=n.tuanType||y.getAttr("ctype")||0,n.subVal&&(e.subVal=n.subVal),r.html(n.subName||u.groupType[e.tuanTypeVal].name);if(t&&$.isArray(t.categroy)&&t.categroy.length>0){var i=t.categroy[0].groupCondition;i&&$.isArray(i)&&i.length>0&&(e.tuanType=$.grep(i,function(e,t){return e.type==16}),e.subTuanType=$.grep(i,function(e,t){return e.type==32}),this.options.categoryPanel.html(A(e)))}},initPosition:function(){var e=this,t=this.options.positionTrigger,n=this.options.positionPanel;this.renderPosition(),t.on("click",function(){if(d)return;e._positionStatus?(n.hide(),e.mask.hide(),e._positionStatus=!1):(e.options.categoryPanel.hide(),e.options.filterPanel.hide(),e._categoryStatus=!1,e._customFilterStatus=!1,e.sort.hide(),n.show(),e.mask.show(),n.css({"-webkit-transform":"translate(0, 30px) translateZ(0)",opacity:0}),n.animate({"-webkit-transform":"translate(0, -8px) translateZ(0)",opacity:1}),e._positionInited==undefined&&(e.initPositionTab(),e._positionInited=!0),e._positionStatus=!0)}),n.on("touchmove",function(e){e.preventDefault()})},initPositionTab:function(){function c(e){r.find(".choosed").removeClass("choosed"),r.find("li:first-child").addClass("choosed"),e.addClass("choosed").siblings().removeClass("choosed")}function h(){s.find(".backwards").removeClass("backwards"),s.find(".txt03").text("")}function d(e){c(e),h()}var e=this,t=this.page.$el,n=t.find(".J_positionTabLabel"),r=t.find(".J_positionTabPanel"),s=t.find("#J_subwayLine"),a=t.find("#J_subwayStation"),f={5:0,4:1,"-4":2,"-3":3,19:3,"-2":4,"-1":5},v=new o({label:n,panel:r,isScroll:!0,labelSelectedClass:"choosed",labelSelectedIndex:f[x.getAttr("type")||5],itemClass:".pop_filter_baselist li",itemSelectedClass:"choosed",onSwitch:function(){a.hide()},onSelect:function(t){var n=t.data("type"),r=t.data("text"),o=y.get(),f=l.getCurrentKeyWord();if(l.isNearBy()){S.setAttr("nearby",!1),E.removeAttr("distance");var c=e.page.$el.find('#J_filterTabLabel li[data-tab="distance"]'),h=e.page.$el.find('#J_filterTabPanel div[data-tab="distance"]');c.hide(),h.hide(),c.find("i").hide(),e.updateCustomFilterIcon(),y.removeAttr("pos")}f&&((n<0||n=="5")&&(f.type=="zone"||f.type=="markland")&&l.removeCurrentKeyWord(),n=="4"&&f.type=="location"&&l.removeCurrentKeyWord());if(o){if(+o.ctyId>0){var v=l.findCityInfoById(o.ctyId);v&&y.setAttr("ctyName",v.name)}o.edate||y.setAttr("edate",o.bdate)}if(r)switch(n){case 5:d(t),x.set({type:5,name:r,val:t.data("value"),pos:t.data("pos")});break;case 4:d(t),x.set({type:4,name:r,val:t.data("value")});break;case 19:d(t);var m=t.data("line"),g=s.find('li[data-value="'+m+'"]');x.set({type:19,name:r,line:m,val:m}),a.hide(),s.show(),s.find(".txt03").text(""),s.find("li:first-child").removeClass("choosed"),g.addClass("backwards").siblings().removeClass("backwards");break;case-5:var m=t.data("value");if(m==a.data("line")){s.hide(),a.show();return}var b=e.getSubwayStation(m,r),w=a.find("ul");s.hide(),a.data("line",m).show(),w.html(M(b));var T=new i({wrapper:a,scroller:w});T.scrollTo(0,0,0);return;case-3:case-4:case-2:case-1:var N={type:n,name:r,pos:t.data("pos")},C=t.data("value");C&&(N.val=C);if(n==-3){var m=t.data("line"),g=s.find('li[data-value="'+m+'"]');N.line=m,s.show(),a.hide(),s.find(".txt03").text(""),g.addClass("backwards").siblings().removeClass("backwards"),g.find(".txt03").text(r),t.addClass("choosed").siblings().removeClass("choosed")}else d(t);x.set(N),E.setAttr("distance",{val:u.SEARCH_DISTANCE,txt:u.SEARCH_DISTANCE_TEXT})}else{if(n==-3){s.show(),a.hide();return}d(t),x.remove()}e.options.positionTrigger.html(r||p.weizhiquyu);if(n<0){var k=y.getAttr("ctype");e.renderFilter(u.groupType[k].category,!0),e.updateCustomFilterIcon()}var L=l.getGroupQueryParam();y.setAttr("qparams",L),x.setAttr("ctyId",o.ctyId),e.getListData(),e.mask.hide(),e.options.positionPanel.hide(),e._positionStatus=!1}})},renderPosition:function(e,t){var n={Zone:[],Location:[],College:[],AirportStation:[],SubwayLine:[],Attraction:[]},r=this.options.positionPanel,i=this.options.positionTrigger,s=w.get();n.curr=x.get()||{},i.html(n.curr.name||p.weizhiquyu),e=e||y.getAttr("ctype"),n.tuanType=e;if(s&&$.isArray(s.categroy)&&s.categroy.length>0){var o=$.grep(s.categroy,function(t,n){return t.ctype==e});if(o&&$.isArray(o)&&o.length>0){var u=s.categroy[0].groupCondition;u&&$.isArray(u)&&u.length>0&&($.each(u,function(e,t){switch(t.type){case 2:n.Location.push(t);break;case 4:n.Zone.push(t);break;case 8:n.College.push(t);break;case 256:case 512:n.AirportStation.push(t);break;case 1024:n.SubwayLine.push(t);break;case 4096:n.Attraction.push(t)}}),n.Zone.length||n.Location.length||n.College.length?(i.show(),r.html(O(n)),t&&t()):i.hide())}else i.hide()}},resetPosition:function(e){var t=this,n=1;n|=2,n|=4,n|=8,n|=64,n|=128,n|=256,n|=512,n|=1024,n|=2048,n|=4096,n|=8192,d=!0,this.options.positionTrigger.html(p.weizhiquyu),b.setParam({ctyId:y.getAttr("ctyId"),categroy:e,type:n}),b.excute(function(){t.renderPosition(e,function(){d=!1,t._positionInited=undefined})},function(e){},!1,this)},initCustomFilter:function(){var e=this,t=e.options.customFilter,n=this.page.$el,r=n.find("#J_filterPanel"),i=n.find("#J_pricePanel"),s=n.find("#J_checkboxWrap"),o=n.find(".pop_filter_cancel"),u=n.find(".pop_filter_sure"),a=n.find(".pop_filter_clear");this.renderFilter(m.getAttr("category")),this.updateCustomFilterIcon(),t.on("click",function(){e._customFilterStatus?(r.hide(),e.mask.hide(),e._customFilterStatus=!1):(e.sort.hide(),e.options.categoryPanel.hide(),e.options.positionPanel.hide(),e._categoryStatus=!1,e._positionStatus=!1,r.show(),e.mask.show(),r.css({"-webkit-transform":"translate(0, 30px) translateZ(0)",opacity:0}),r.animate({"-webkit-transform":"translate(0, -8px) translateZ(0)",opacity:1}),e._customFilterInited==undefined&&(e.initFilterTab(),e._customFilterInited=!0),e._customFilterStatus=!0)}),o.on("click",function(){r.hide(),e.mask.hide(),e._customFilterStatus=!1}),u.on("click",function(){r.hide(),e.mask.hide(),e.sureCustomFilter(),e._customFilterStatus=!1}),a.on("click",function(){e.clearCustomFilter(),e._customFilterStatus=!1}),s.on("click","div[data-type]",function(t){if(t.target.tagName=="LABEL")return;var n=$(t.currentTarget),r=n.data("type"),i=n.find("input:checked").length;r=="weekendsAvailable"?y.setAttr("weekendsAvailable",i?1:0):E.setAttr(r,i?1:0),a[e.customFilterSelectedCount()?"removeClass":"addClass"]("sta-disabled")}),r.on("touchmove",function(e){e.preventDefault()})},initFilterTab:function(){var e=this,t=this.page.$el,n=t.find("#J_filterTabLabel"),r=t.find("#J_filterTabPanel"),i=t.find("input[data-value]"),s=t.find(".pop_filter_clear");n.on("click","li",function(t){var i=$(t.currentTarget);if(i.hasClass("choosed"))return;var s=i.data("tab");n.find(".choosed").removeClass("choosed"),i.addClass("choosed"),r.find("div[data-tab]").hide(),e.renderTabWrap(s,r,!0)}),r.on("click",".pop_filter_baselist li",function(t){var r=$(t.currentTarget),o=r.data("value"),u=r.data("text"),a=r.data("filter");if(T.indexOf(a)>-1)r.addClass("choosed").siblings(".choosed").removeClass("choosed"),o?E.setAttr(a,{val:o,txt:u}):E.removeAttr(a),n.find('li[data-tab="'+a+'"]>i')[o?"show":"hide"]();else if(a=="star")if(!o)i.each(function(e,t){e>0&&(t.checked=!1)}),E.removeAttr("star"),n.find('li[data-tab="star"]>i').hide();else{var o=o.toString(),f=E.getAttr("star")||{};r.parent().find("input:checked").length?i[0].checked=!1:i[0].checked=!0,r.find("input:checked").length?f[o]=u:delete f[o],E.setAttr("star",f),n.find('li[data-tab="star"]>i')[$.isEmptyObject(f)?"hide":"show"]()}s[e.customFilterSelectedCount()?"removeClass":"addClass"]("sta-disabled")})},renderTabWrap:function(e,t,n){var r=E.get(),s=t.find('div[data-tab="'+e+'"]');n&&s.show();switch(e){case"price":y.getAttr("ctype")==7?(s.find('li[data-ptype="0"]').hide(),s.find('li[data-ptype="1"]').show()):(s.find('li[data-ptype="0"]').show(),s.find('li[data-ptype="1"]').hide()),s.find(".choosed").removeClass("choosed"),r&&r.price?s.find('li[data-value="'+r.price.val+'"]').addClass("choosed"):s.find('li[data-value=""]').addClass("choosed");break;case"day":s.find(".choosed").removeClass("choosed"),r&&r.day?s.find('li[data-value="'+r.day.val+'"]').addClass("choosed"):s.find('li[data-value=""]').addClass("choosed");break;case"star":if(r&&r.star){var o=r.star;s.find("input:checked")[0].checked=!1,_.each(o,function(e,t){s.find('input[data-value="'+t+'"]')[0].checked=!0})}else s.find("input[data-value]").each(function(e,t){t.checked=e<=0});break;case"brand":var u=s.find("#J_brand"),a=u.parent();a.css({overflow:"hidden","max-height":"295px"}),u.html(k(this.getDataFromCondition("brand",1))),new i({wrapper:a,scroller:u});break;case"trait":var f=s.find("#J_trait"),a=f.parent();a.css({overflow:"hidden","max-height":"295px"}),f.html(L(this.getDataFromCondition("trait",8192))),new i({wrapper:a,scroller:f});break;case"distance":s.data("scrolled")||(new i({wrapper:s,scroller:s.find("ul")}),s.data("scrolled","true")),s.find(".choosed").removeClass("choosed"),r&&r.distance?s.find('li[data-value="'+r.distance.val+'"]').addClass("choosed"):s.find('li[data-value=""]').addClass("choosed")}},renderFilter:function(e,t){var n=this.page.$el,r=E.get(),i=n.find("#J_checkboxWrap"),s=n.find("#J_filterTabLabel"),o=n.find("#J_filterTabPanel"),u={category:e,weekendsAvailable:y.getAttr("weekendsAvailable"),multiShop:r&&r.multiShop,voucher:r&&r.voucher},a=N(u);a?i.show().html(a):i.hide(),s.html(C({category:e||"all",isNearBy:l.isNearBy(),customdata:r||{},isUniversityNearBy:t})),o.find("div[data-tab]").hide(),this.renderTabWrap(s.find("li:first-child").addClass("choosed").data("tab"),o,!0)},getDataFromCondition:function(e,t){var n={val:"",arr:[]},r=w.get(),i=E.getAttr(e);i&&i.val&&(n.val=i.val);if(r&&$.isArray(r.categroy)&&r.categroy.length>0){var s=r.categroy[0].groupCondition;s&&$.isArray(s)&&s.length>0&&(n.arr=$.grep(s,function(e,n){return e.type==t}))}return n},getSubwayStation:function(e,t){var n={lineId:e,lineName:t,arr:[]},r=w.get();n.curr=x.get()||{};if(r&&$.isArray(r.categroy)&&r.categroy.length>0){var i=r.categroy[0].groupCondition;i&&$.isArray(i)&&i.length>0&&(n.arr=$.grep(i,function(t,n){return t.parentType==e}))}return n},clearCustomFilter:function(e){var t=this,n=l.isNearBy(),r=this.page.$el,i=r.find(".pop_filter_clear");if(i.hasClass("sta-disabled"))return;var s=r.find("#J_filterTabLabel"),o=r.find("#J_filterTabPanel");y.removeAttr("weekendsAvailable"),E.removeAttr("multiShop"),E.removeAttr("voucher");var u=T.concat(["star"]);e&&n&&u.splice(u.indexOf("distance"),1),_.each(u,function(e,n){E.removeAttr(e),t.renderTabWrap(e,o,!1)}),s.find(".choosed").removeClass("choosed"),s.find("li i").hide(),o.find("div[data-tab]").hide(),this.renderTabWrap(s.find("li:first-child").addClass("choosed").data("tab"),o,!0),r.find("#J_checkboxWrap input:checked").each(function(e,t){t.checked=!1}),this.updateCustomFilterIcon()},sureCustomFilter:function(){var e=y.get(),t=l.getGroupQueryParam();e&&(e.edate||y.setAttr("edate",e.bdate)),y.setAttr("qparams",t),this.getListData(),this.updateCustomFilterIcon()},customFilterSelectedCount:function(){var e=!1,t=l.getGroupQueryParam(),n=y.getAttr("weekendsAvailable"),r=t&&t.length>0&&t.filter(function(t){!e&&(e=parseInt(t.type,10)===9);var n=parseInt(t.type,10);return n==14&&t.value==m.getAttr("subVal")?!1:[1,2,3,9,14].indexOf(n)!==-1}).length;return n==1&&(r+=1),!E.getAttr("distance")&&e&&(r-=1),E.getAttr("price.val")=="1|1"&&(r-=1),r>0?r:0},updateCustomFilterIcon:function(){var e=this,t=this.page.$el,n=e.options.customFilter,r=e.customFilterSelectedCount(),i=t.find(".pop_filter_clear");n.find(".fil_num").text(r)[r>0?"show":"hide"](),i[r>0?"removeClass":"addClass"]("sta-disabled")},getListData:function(){y.setAttr("pageIdx","1"),this.page.isLoading=!0,window.scrollTo(0,0),this.page.showLoading(),this.page.hideBottomLoading(),this.page.getGroupListData()},initialize:function(e){h(this.options,e),this.page=this.options.page,this.initCategory(),this.initPosition(),this.initSort(),this.initCustomFilter()}}),c.getInstance=function(e){return new c(e)},c});