define(["cBase","cUICore","cWidgetFactory","libs"],function(e,t,n){function l(e){return e===Object(e)}function c(e,t,n){if(!e||$(e).data("loaded"))return;var r=new Image;r.src=e.dataset["data-src"]||e.getAttribute("data-src"),r.onload=function(){e.src=r.src,$(e).data("loaded",!0)}}var r="SmoothSlide",i=function(){},s=null,o=/\-?[0-9]+\.?[0-9]*/g,u,a=function(){var e=$.browser,t="";return t=e.webkit?"-webkit-":e.firefox?"-moz-":e.ie?"-ms-":"",t}(),f=a.replace(/\-/g,"");if(n.hasWidget(r))return;u=new e.Class({__propertys__:function(){this.options={container:s,autoplay:5e3,currentIndex:0,direction:u.LEFT,animationDuration:300,prefetch:0,placeholder:"",source:s,tpl:'<div class="cui-slide"><div class="cui-slide-imgsouter"><div class="cui-slide-imgsinter" style="width:9999px"><%for(var i=0,len=data.length;i<len;i++){%><%var item = data[i]%><div class="cui-slide-img-item"><img data-href="<%=item.href%>" data-src="<%=item.src%>" data-img-id="<%=item.id%>" data-img-title="<%=item.title%>"/></div><%}%></div></div></div>',itemCls:".cui-slide-img-item",pageSize:1,minSwipe:40,width:0,height:0,onSwitch:i,onSwitchEnd:i,onInit:i}},initialize:function(e){var t;l(e)&&(this.options=$.extend(this.options,e)),t=this.options,this.container=t.container,this.tpl=t.tpl,this.container&&this.container.length&&(this.render(t.source,t.currentIndex),this._isInteractive()&&this._bindEvents(),t.autoplay&&this._autoplay())},_isInteractive:function(){var e=this.options;return e.pageSize<e.source.length},_createLayout:function(){var e=this.source;this.container.html(_.template(this.tpl)({data:e}))},_autoplay:function(){var e=this;clearTimeout(this.__autoplayTimer),this.__autoplayTimer=setTimeout(function(){e.next(!0),e._autoplay()},this.options.autoplay)},_bindEvents:function(){var e=this._runtime,t=this.container;this.__moveHandler=$.proxy(this.__moveHandler,this),t.on("touchmove",this.__moveHandler),this.__touchStartHandler=$.proxy(this.__touchStartHandler,this),t.on("touchstart",this.__touchStartHandler),this.__touchEndHandler=$.proxy(this.__touchEndHandler,this),t.on("touchend",this.__touchEndHandler),this.__transitionEndHandler=$.proxy(this.__transitionEndHandler,this),e.root.on(f+"TransitionEnd",this.__transitionEndHandler)},_unbindEvents:function(){var e=this._runtime,t=this.container;t.off("touchmove",this.__moveHandler),t.on("touchstart",this.__touchStartHandler),t.on("touchend",this.__touchEndHandler),e.root.off(f+"TransitionEnd",this.__transitionEndHandler)},_current:0,count:function(){return this.source.length},render:function(e,t){clearTimeout(this.__autoplayTimer);var n=this.options;return this.source=e,this._createLayout(e),this.items=this.container.find(n.itemCls),this._runtime=this._getRuntimeEnv(),this.items.css("width",this._runtime.width),this._showCurrent(this._runtime.root,t),this._prefetch(n.direction),n.onInit.call(this,this._current),this},current:function(){return this._current},next:function(e){this.goto(this._current+this.options.pageSize,u.LEFT,e)},prev:function(){this.goto(this._current-this.options.pageSize,u.RIGHT)},play:function(){this.options.autoplay&&this._autoplay()},pause:function(){clearTimeout(this.__autoplayTimer)},stop:function(){clearTimeout(this.__autoplayTimer),this.goto(0)},"goto":function(e,t,n){var r=this,i=this._runtime,s=this.options,o=s.direction,a=s.autoplay&&n,f=i.count,l=i.width;a&&(e<0&&(e=f-1),e>=f&&(e=0)),e>=0&&e<f?(u.animate(i.root,o*l*this._current,o*l*e,this.options.animationDuration),this._current=e,this._prefetch(t),setTimeout(function(){r.options.onSwitch.call(r,e,r.source[e])},10)):this.goto(this._current)},_showCurrent:function(e,t){var n=this._runtime;u.translate(n.root,this.options.direction*n.width*t,0),this._current=t,this._prefetch()},_prefetch:function(e){if(this.options.prefetch<0)return;e||(e=u.LEFT);var t=this._current,n=this.options.prefetch,r,i=n*e;do r=this.items[t+n-i*e],r=r&&r.children[0],r&&c(r);while(i-=e)},_getSwipeDirection:function(e,t){var n=t-e,r=Math.abs(n),i;return r>0&&r>this.options.minSwipe&&(i=n/r),i},_getRuntimeEnv:function(){var e=this.items,t=this.options,n=$(e[0]),r=n.parent(),i=r.parent(),s=i.offset(),o=this.count();return{width:t.width||s.width,root:r,stage:i,count:o}},__touchStartHandler:function(e){var t=e.touches[0],n=this._getRuntimeEnv().root,r=n.css(a+"transform").match(o);r=r&&r[0]||0,this.__lastTouchStartPos={left:Number(r),x:t.pageX,y:t.pageY,t:+(new Date)}},__touchEndHandler:function(e){var t=this.__lastTouchStartPos,n=this._getSwipeDirection(t.x,e.changedTouches[0].pageX);this[n===u.LEFT?"next":n===u.RIGHT?"prev":"goto"]()},__transitionEndHandler:function(e){var t=this._current,n=this;setTimeout(function(){n.options.onSwitchEnd.call(n,e,t,n.source[t])},10)},__moveHandler:function(e){e.preventDefault();if(e.touches.length>1||e.scale&&e.scale!==1)return;var t=e.touches[0],n=this._getRuntimeEnv(),r=n.root,i=this.__lastTouchStartPos,s=i.left+t.pageX-i.x;u.translate(r,s,0)}}),u.LEFT=-1,u.RIGHT=1,u.translate=function(e,t,n){var r=e[0],i=r&&r.style;if(!i)return;e.css(a+"transition",n+"ms ease-out"),e.css(a+"transform","translate("+t+"px,0) translateZ(0)")},u.animate=function(e,t,n,r){this.translate(e,n,r)},n.register({name:r,fn:u})});