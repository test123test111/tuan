define(["TuanApp","TuanStore","CityListData"],function(e,t,n,r){function m(e){var t="-",n="元",r=e.split("|"),i=r[0],s=r[1];return i&&s?(i>s&&(i=s,s=r[0]),i+t+s+n):i?s?"":i+"以上":s+"以下"}function g(e){var t={2:"二星/经济",3:"三星/舒适",4:"四星/高档",5:"五星/豪华"};return t[e]||"不限"}var i=5,s=4,o=t.GroupSearchStore.getInstance(),u=t.GroupPositionFilterStore.getInstance(),a=t.GroupCategoryFilterStore.getInstance(),f=t.TuanHistoryCityListStore.getInstance(),l=t.GroupSortStore.getInstance(),c=t.TuanCityListStore.getInstance(),h=t.GroupGeolocation.getInstance(),p=t.TuanHistoryKeySearchStore.getInstance(),d=t.GroupCustomFilters.getInstance(),v={0:"0",1:"1",2:"8",3:"7",4:"6",5:"9"},r={clearSpecified:function(e){e&&o.setAttr("sortRule",2),e&&o.setAttr("sortType",0),!e&&d.remove(),!e&&o.setAttr("ctype",0),!e&&o.setAttr("weekendsAvailable",0),u.remove(),l.remove(),this.setCurrentKeyWord(!1),o.setAttr("qparams",this.getGroupQueryParam()),o.removeAttr("pos")},clearAll:function(){this.clearSpecified(),o.remove(),a.remove()},isNearBy:function(){return o.getAttr("nearby")||f.getAttr("nearby")},addHistoryCity:function(e,t){var n=f.get(),r=[];n&&n.list&&$.isArray(n.list)&&(r=n.list);var s,o=0;$.each(r,function(t,n){return n!=e?!0:(s=n,o=t,!1)}),s&&s==e?(r.splice(o,1),r.unshift(e)):(r.unshift(e),r.length>i&&r.pop()),f.setAttr("list",r)},findHistoryCity:function(e){var t=f.get(),n=[];if(!e){var r=c.get();if(!r)return;e=r.cities||r}if(t&&t.list){var i=t.list.length>3?3:t.list.length;for(var s=0;s<i;s++){var o=!1,u=t.list[s],a=this.findCityInfoById(u,e);a&&n.push(a)}}return n},getCityCount:function(e){if(!e){var t=c.get();if(!t)return;e=t.cities||t}var n=0;if(e&&e.cities&&e.cities.length>0)for(var r=0,i=e.cities.length,s;r<i;r++)s=e.cities[r],s&&s.tag&&s.tag!="热门"&&(n+=s.cities.length);return n},findCityInfoById:function(e,t,r){var i;if(!t){i=c.get();if(!i)return{CityID:e,name:n[e]||r,cGroups:""};t=i.cities||i}for(var s=0,o=t.length,u;s<o;s++){u=t[s];if(u.tag=="热门"&&u.cities)for(var a in u.cities){var f=u.cities[a];if(f.id==e)return f}}for(var s=0,o=t.length,u;s<o;s++){u=t[s];if(u.tag!="热门"&&u.cities)for(var a in u.cities){var f=u.cities[a];if(f.id==e)return f}}return!1},setCurrentCity:function(e){if(e){var t=h.get();if(t&&t.gps){var n=e.CityID||e,r=this.findCityInfoById(n);if(r)return t.gps.CityId=e.CityID,t.gps.CityName=r.name,t.gps.Groups=r.cGroups,h.setAttr("gps",t.gps),!0;e.CityID&&e.CityName&&(t.gps.CityId=e.CityID,t.gps.CityName=e.CityName,t.gps.Groups=0,h.setAttr("gps",t.gps))}}return!1},getCurrentCity:function(){var e=h.get();return e&&e.gps&&+e.gps.CityId>0?e.gps:!1},addHistoryKeyWord:function(e,t,n){var r=p.get(),s=u.getAttr("type"),o=[],a,f=0;r&&r.list&&$.isArray(r.list)&&(o=r.list),$.each(o,function(t,n){return n.id!=e?!0:(a=n,f=t,!1)}),a&&a.id==e?(o.splice(f,1),o.unshift({id:e,word:t,type:n})):(o.unshift({id:e,word:t,type:n}),o.length>i&&o.pop()),p.remove(),p.setAttr("list",o),this.setCurrentKeyWord({id:e,word:t,type:n}),(s=="-1"||s=="5")&&(n=="zone"||n=="markland")&&u.remove(),s=="4"&&n=="location"&&u.remove()},getHistoryKeyWord:function(){var e=p.get(),t=[];return e&&e.list&&(t=e.list),t},setCurrentKeyWord:function(e){p.setAttr("key",e)},removeCurrentKeyWord:function(){p.removeAttr("key")},getCurrentKeyWord:function(){var e=p.get();return e?e.key:!1},getGroupQueryParam:function(){var e=[],t=d.get(),n=u.get(),r=t&&t.price&&t.price.val;r&&e.push({type:1,value:r});var i=t&&t.star;if(i&&!$.isEmptyObject(i)){var s=[],o;for(var o in i)s.push(o);e.push({type:2,value:s.join(",")})}var l=t&&t.brand&&t.brand.val;l&&e.push({type:3,value:l});var c=t&&t.trait&&t.trait.val;c&&e.push({type:14,value:c});var p=h.get()&&h.get().gps,v=t&&t.distance&&t.distance.val;f.getAttr("nearby")&&p?e.push({type:9,value:p.lat+"|"+p.lng+(v?"|"+v:"")}):v&&e.push({type:9,value:v});var m=t&&t.day&&t.day.val;m&&e.push({type:14,value:m});var g=t&&t.multiShop;g==1&&e.push({type:14,value:"102|10201"});var y=t&&t.voucher;y==1&&e.push({type:14,value:"102|10202"});var b=a.get();b&&b.subVal&&e.push({type:14,value:b.subVal}),n=n?n:{type:"",val:""},n&&n.type&&+n.type>0&&n.val&&n.val!=""&&e.push({type:n.type,name:n.name,value:n.val});var w=this.getCurrentKeyWord();if(w){var E=(w.type||"").toString().toLowerCase(),S=w.id||w.word,x={hotelid:18,zone:5,hotelgroupid:3,location:4,activity:11,district:16,markland:17};E?/\D/.test(E)&&(x[E]?E=x[E]:E=7):E=7,e.push({type:E,value:S})}return e},saveQueryString:function(e){var t=Lizard.P,n=t("ctype"),r=t("price"),i=t("star"),u=t("kwd"),l=t("place"),c=t("lat"),p=t("lng")||t("lon"),m=t("cityid"),g=t("cityname"),y=t("sort");m&&m!=o.getAttr("ctyId")&&(this.clearAll(),f.remove()),m&&o.setAttr("ctyId",m),g&&o.setAttr("ctyName",g);if(c&&+c>0&&p&&+p>0&&l&&l!=""){h.setAttr("gps",{address:l,location:p+","+c,city:g,lng:+p,lat:+c}),this.setCurrentCity({CityID:m}),f.setAttr("nearby",!0),this.addHistoryCity(m,g);var b=o.getAttr("qparams")||[];for(var w=0,E=b.length;w<E;w++)if(b[w].type==9){b.splice(w,1);break}b.push({type:9,value:c+"|"+p+"|"+s}),o.setAttr("qparams",b)}n&&(a.remove(),o.setAttr("ctype",v[n])),i&&n==1&&d.setAttr("star",i.replace(",","|")),r&&d.setAttr("price",r),u&&(u=u.split("|"),this.addHistoryKeyWord(u[1],u[0],u[2])),y&&(y=y.split("|"),o.setAttr("sortRule",y[0]),o.setAttr("sortType",y[1]||1)),e&&e()},getCityIdByName:function(e){var t;return e&&(t=n[e]),!1}};return r});