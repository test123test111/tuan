define(["c","cStore","PageTreeConfig"],function(e,t,n){function i(e){return e===null||e===undefined}function s(e){this.data={};for(var t in e)e[t]&&this.add(t,e[t].url,e[t].prev,e[t].jump,e[t].range,e[t].params)}function f(){this.stack=a.getInstance()}var r=e.base,o=/\{([^\{\}]+)\}/g;s.prototype={constructor:s,buildNode:function(e,t,n,r,i,s){return{id:e,prev:n,url:t,jump:r||!1,range:i,params:s||{}}},add:function(e,t,n,r,i,s){this.data[e]=this.buildNode(e,t,n,r,i,s)},getNode:function(e,t){var n=this.data[e];if(!n)return null;var r=n.url||"",s=n.param||{};t=t||{};var u=(n.url||"").replace(o,function(e,n){return i(t[n])?i(s[n])?"":s[n]:t[n]});return{id:n.id,prev:n.prev,url:n.url,reurl:u,jump:n.jump,range:n.range}},getPrevNode:function(e,t){var n=this.data[e],r=n&&n.prev&&this.data[n.prev]&&this.data[n.prev];if(!r)return null;t=t||{};var s=r.params||{},u=(r.url||"").replace(o,function(e,n){return i(t[n])?i(s[n])?"":s[n]:t[n]});return{id:r.id,url:r.url,prevurl:u,prev:r.prev,jump:r.jump,range:r.range}}};var u=new s(n),a=new r.Class(t,{__propertys__:function(){this.key="P_TUAN_HISTORY_STACK",this.lifeTime="30D",this.isUserData=!0},initialize:function($super,e){$super(e)},pop:function(){var e=this.getAttr("history")||[],t=e.pop();return this.setAttr("history",e),t},push:function(e,t){var n=this.getAttr("history")||[],r=Math.max(0,n.length-1);t?n[r]=e:n.push(e),this.setAttr("history",n)},top:function(){var e=this.getAttr("history")||[],t=Math.max(0,e.length-1);return e[t]},length:function(){var e=this.getAttr("history");return e&&e.length||0},clear:function(){this.setAttr("history",[])},index:function(e){var t=this.getAttr("history")||[];return e=e<0?t.length+e:e,t[e]},addCache:function(e,t,n){var r={id:e,obj:t,replace:n};this.setAttr("cache",r)},getCache:function(){return this.getAttr("cache")||{}},clearCache:function(){this.setAttr("cache",{})},popById:function(e){var t=this.getAttr("history")||[],n=-1,r=0,i=null;for(var s=t.length-1;s>-1;s--){r++;if(t[s].id===e){n=s;break}}return n>-1&&(i=t.splice(n,r)),this.setAttr("history",t),i},addSequeHistory:function(e){var t=this.getAttr("sequehistory")||[],n=Math.max(0,t.length-1),r=t[n]||{};if(r.id===e.id)return;t.length>10&&t.splice(0,3),t.push(e),this.setAttr("sequehistory",t)},getSequeTop:function(e){var t=this.getAttr("sequehistory")||[],n=Math.max(0,t.length-1),r=null;return t[n]&&(t[n].id!=e?r=t[n]:t[n-1]&&(r=t[n-1])),r}});f.prototype={constructor:f,push:function(e,t,n,r){this.stack.addCache(e,f.buildEntry(e,t,n),r)},confirmPush:function(e){var t=this.stack.getCache();t.id===e&&(this.stack.push(t.obj,t.replace),this.stack.clearCache())},pop:function(){return this.stack.pop()},top:function(){return this.stack.top()},index:function(e){return this.stack.index(e)},clear:function(){this.stack.clear()},getCache:function(){return this.stack.getCache()},clearCache:function(){this.stack.clearCache()},popById:function(e){return this.stack.popById(e)},addSequeHistory:function(e){this.stack.addSequeHistory(e)},getSequeTop:function(e){return this.stack.getSequeTop(e)}},f.buildEntry=function(e,t,n){return{id:e,url:t,ver:n}};var l="_____FROM_____",c=function(e,t){this.tree=e,this.stack=t};c.prototype={constructor:c,back:function(e,t){var n=this.stack.pop(),r=this.stack.top(),i=this.tree.getPrevNode(e,t),s=this.tree.getNode(e),o="",u=s.range||[];if(r&&r.id===l)return this.stack.addSequeHistory({id:e,url:o}),this.stack.pop(),{fullurl:r.url,url:r.url.replace(/^[^#]+#/g,"").replace(/^#+/g,""),jump:!0};var a=!1,e;return n&&n.id===e&&r&&r.id&&(!u.length||_.indexOf(u,r.id)>-1)?(o=r.url,a=n.ver!==r.ver||s.jump,e=r.id):(o=i.prevurl,a=!!s.jump,e=i.id,this.stack.clear()),this.stack.addSequeHistory({id:e,url:o}),{fullurl:o,url:o.replace(/^[^#]+#/g,"").replace(/^#+/g,""),jump:a,id:e}},popById:function(e){return this.stack.popById(e)},forward:function(e,t,n,r){if(typeof t=="object"){var i=this.tree.getNode(e,t);t=i.reurl}return this.stack.push(e,t,n,r),this.stack.addSequeHistory({id:e,url:t}),t},confirmForward:function(e){this.stack.confirmPush(e)},getLastView:function(){var e=this.stack.getCache()||{},t,n;return e.id?t=this.stack.top():t=this.stack.index(-2),t},getLatelyView:function(e){var t=this.stack.getSequeTop(e);return t?t.id:null},addHistory:function(e,t,n){var r=this.stack.getCache()||{};r.id&&r.id!==e&&this.stack.clearCache();var i=this.stack.top(),s=this._getFromByUrl(t);if(!i||i.id!==e||s)s&&(this.clearHistory(),this.stack.push(l,s),this.stack.addSequeHistory({id:l,url:s}),this.confirmForward(l)),this.stack.push(e,t,n),this.stack.addSequeHistory({id:e,url:t}),this.confirmForward(e)},clearHistory:function(e,t,n){this.stack.clear(),e&&t&&this.addHistory(e,t,n)},isPrevPageOrigin:function(){var e=this.getLastView();return e&&e.id===l},switchTree:function(e){this.tree=e},_getFromByUrl:function(e){var t="from",n=(e||"").split(/#+/g),r=n[0],i=n[1]||"",s=null;if(r.indexOf(t)>-1){var o=this._getQueryString(r);o[t]&&(s=o[t])}if(i.indexOf(t)>-1){var u=this._getQueryString(i);u[t]&&(s=u[t])}return s&&(s=decodeURIComponent(s)),s&&!s.match(/^\s*(?:http|\/)/)&&(s=null),s},_getQueryString:function(e){var t=(e||"").split("?");t.shift();var t=t.join("?").split(/(?!\?[^?]*)&/g),n={},r;for(var i=0,s=t.length;i<s;i++)r=t[i].split("="),n[r.shift()]=r.join("=");return n}};var h=new c(u,new f);return h});