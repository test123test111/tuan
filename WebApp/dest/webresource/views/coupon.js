define(["TuanApp","libs","c","cUtility","cUserModel","CommonStore","TuanStore","TuanModel","TuanBaseView","cCommonPageFactory","text!CouponTpl"],function(e,t,n,r,i,s,o,u,a,f,l){function w(e){return(new n.base.Date(e)).format("Y-m-d")}var c=o.TuanDetailsStore.getInstance(),h=u.TuanValidateCouponModel.getInstance(),p=u.TuanCouponListModel.getInstance(),d=o.TuanCouponListStore.getInstance(),v=o.TuanSelectedCouponStore.getInstance(),m=s.UserStore.getInstance(),g=r.isInApp(),y="choosed",b={pageTitle:"使用优惠券",invaildCoupon:"优惠券代码无效，请更换优惠券",codeNotEmpty:"请输入团购优惠券码",errorTry:"发生错误，请重试"},E=f.create("TuanBaseView"),S=E.extend({tpl:l,events:{"click #J_useCouponToggle":"useCouponToggle","click #J_clearCoupon":"clearCoupon","input #J_couponInput":"showClearIcon","focus #J_couponInput":"adjustInputPosition","click #J_validateCoupon":"validateCoupon","click #J_couponList>li":"selectedCoupon"},render:function(e){e=e||[];var t=this.$el,n=v.get(),r={coupons:e,dateFormat:w,hasUsedCoupon:n&&typeof n=="object"};this.coupons=e,t.html($.trim(_.template(this.tpl,r))),this.els={useCouponToggle:t.find("#J_useCouponToggle"),couponInput:t.find("#J_couponInput"),clearCoupon:t.find("#J_clearCoupon"),couponWrap:t.find("#J_couponList"),couponList:t.find("#J_couponList>li"),enterWrap:t.find("#J_enterWrap")};if(e.length&&n&&n.pid==this.pid){var i=this.els.couponWrap.find('[data-code="'+n.code+'"]');i&&(i.addClass(y),i.remove().prependTo("#J_couponList"))}},onCreate:function(){},onLoad:function(){this.pid=c.getAttr("id"),this._setPageView(),m.isLogin()?this.getCouponList():this.render()},_setPageView:function(){var e=this;this.header.set({title:b.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.back()},homeHandler:function(){e.redirectToIndex()}}}),this.header.show()},onShow:function(){this.setTitle(b.pageTitle)},onHide:function(){},redirectToIndex:function(){e.tHome()},useCouponToggle:function(e){var t=$(e.target);t.hasClass(y)||(this.els.couponList.removeClass(y),v.remove(),v.set("0"),this.back())},adjustInputPosition:function(){this.els.enterWrap[0].scrollIntoView(),g||(document.body.scrollTop=document.body.scrollTop-48)},getCouponList:function(e){var t=this;this.showLoading(),p.setParam({pid:this.pid,head:p.getHead().get()}),p.execute(function(e){t.render(e.coupons),t.hideLoading()},function(e){t.render(),t.hideLoading()},!1,this)},showClearIcon:function(e){$(e.target).val()?this.els.clearCoupon.show():this.els.clearCoupon.hide()},clearCoupon:function(){this.els.couponInput.val(""),this.els.clearCoupon.hide()},validateCoupon:function(){var e=this,t=this.els.couponInput.val();if(!t){this.showToast(b.codeNotEmpty);return}h.setParam({code:t,pid:this.pid}),h.execute(function(n){if(n.res===1){var r=n.couponInfo;r.pid=e.pid,r.isInput=!0,r.code=t;var i=e.$el.find('li[data-code="'+t+'"]');i&&(i.siblings("."+y).removeClass(y),i.addClass(y),i.remove().prependTo("#J_couponList")),e.els.useCouponToggle.removeClass(y),v.set(r),e.back("booking")}else e.showToast(n.msg||b.invaildCoupon)},function(t){e.showToast(b.errorTry)},!1,this)},selectedCoupon:function(e){var t=$(e.currentTarget),n=t.data("index"),r=this.coupons[n];t.siblings("."+y).removeClass(y),t.toggleClass(y),this.els.useCouponToggle.removeClass(y),t.hasClass(y)?(r&&(r.pid=this.pid,v.set(r)),this.back("booking"),t.remove().prependTo("#J_couponList")):v.remove()}});return S});