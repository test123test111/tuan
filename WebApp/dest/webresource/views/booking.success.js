define(["TuanApp","libs","cUtility","TuanStore","c","cWidgetGuider","cWidgetFactory","TuanModel","TuanBaseView","cCommonPageFactory","CommonStore","Payment","text!BookingSuccessTpl","text!RecommendTpl"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){function A(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(t*100)/100}var d,v=o.create("Guider"),m=o.create("Member"),g=i.ui,y=n.isInApp(),b=encodeURIComponent("source=groupon"),w=r.OrderDetailReturnPage.getInstance(),E=u.TuanSubmitOrder.getInstance(),S=u.TuanApplyOrder.getInstance(),x=r.TuanOrderListStore.getInstance(),T=u.TuanOrderDetailModel.getInstance(),N=r.GroupSearchStore.getInstance(),C=l.UserStore.getInstance(),k=u.CrossRecommendModel.getInstance(),L={pageTitle:"订单完成",warningTip:"没有检索到数据!",needLoginTip:"需要先登录才能查看订单信息"};c=o.create("Payment");var O=f.create("TuanBaseView"),M=O.extend({pageid:"214016",hpageid:"215016",hasAd:!0,render:function(){var e=this,t=C.getUser(),n=_.template(h);if(d&&d>0)T.setParam({oid:d,module:"1",auth:t?t.Auth:"",cityid:N.getAttr("ctyId"),head:l.HeadStore.getInstance().get()}),T.execute(function(r){if(r){if(!r.oid){e.forwardJump("list","/webapp/tuan/list");return}r.user=e.user,r.retainTwoDecimal=A,r.isNonUser=t&&t.IsNonUser,e.$el.html($.trim(n(r))),r.product&&r.product.id&&e.getCrossRecommend(r.product.id)}},function(){e.showToast(L.needLoginTip,3,function(){e.redirectToLogin()},!0);return},!0,this);else{var r={};r.user=t,r.oid=d,r.retainTwoDecimal=A,this.$el.html($.trim(n(r)))}},events:{"click #J_orderDetail":"viewOrderDetail","click #J_registerBtn":"redirectToRegister","click #J_tel":"callPhone","click #J_destLink":"gotoDestnation","click .J_viewDetail":"gotoDetail","click .link-more":"gotoNearList","click #J_tabNav>li":"recommendSwitch"},onCreate:function(){},onLoad:function(){d=Lizard.P("orderid");if(!C.getUser()){this.redirectToLogin();return}var e=this.getQuery("paytype");e==1||(e&2)==2||parseInt(this.getQuery("success"),10)?this.submitOrder(function(){this.render()}):this.render(),x.remove(),this.setHeader(),$("#bf_ubt_orderid").val(d)},onShow:function(){},onHide:function(){},setHeader:function(){var e=this;this.header.set({title:L.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.forwardJump("home","/webapp/tuan/home")},homeHandler:function(){e.redirectToIndex()}}}),this.header.show()},getCrossRecommend:function(t){var n=this,r=_.template(p),i=this.$el.find("#J_recommendWrap");k.setParam({id:t,isInApp:y,environment:e.environment,head:l.HeadStore.getInstance().get()}),k.execute(function(e){var n=e&&e.RecommendGroups;n.length?(i.show(),i.html(r({data:n,pid:t,city:e.city}))):i.hide()},function(){i.hide()},this,this)},recommendSwitch:function(e){var t=$(e.currentTarget),n=t.data("index");if(t.hasClass("sta-on"))return;t.addClass("sta-on").siblings().removeClass("sta-on"),this.$el.find("#J_tabCon .ui-item").hide().eq(n).show()},gotoDestnation:function(e){var t=$(e.target),n=t.attr("data-dest-id"),r=t.attr("data-dest-name");v.apply({hybridCallback:function(){v.jump({module:"destination/toDestMain",param:{districtId:n,districtName:r},targetModel:"app"})},callback:function(){location.href="http://m.ctrip.com/you/summary/"+n+".html"}})},callPhone:function(e){e.preventDefault(),this.alert=new g.Alert({title:"拨打电话",message:'<a href="tel:4008216666">拨打携程客服</a>',buttons:[{text:"取消",click:function(){this.hide()}},{text:'<a href="tel:4008216666" data-phone="4008216666">拨打</a>',click:function(e){this.hide(),v.callService()}}]}),this.alert.show()},submitOrder:function(e){var t=C.getUser(),n={head:l.HeadStore.getInstance().get(),SubmitOrder:{OrderID:+this.getQuery("orderid")||this.getPath(0),Ver:3},Operator:{UID:t.UserID,SourceForm:1}};this.showLoading(),E.setParam(n),E.execute(function(t){this.hideLoading(),e.call(this)},function(){this.hideLoading(),e.call(this)},this,this)},redirectToIndex:function(){e.tHome()},gotoDetail:function(e){var t=$(e.currentTarget),n=t.data("pid");t.data("type")==99?y?v.cross({path:"activity",param:"index.html#/dest/t"+n+".html?ext="+b}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/t"+n+".html?from="+encodeURIComponent(location.href)+"&ext="+b:this.forwardJump("detail","/webapp/tuan/detail/"+n+".html")},gotoNearList:function(e){var t=$(e.currentTarget),n=t.data("pid"),r=t.data("cityid"),i=t.data("cityname"),s=t.data("type"),o=t.data("title");t.data("type")==99?y?v.cross({path:"activity",param:"index.html#/dest/ct-"+i+"-"+r+"?ext="+b}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/ct-"+i+"-"+r+".html?from="+encodeURIComponent(location.href)+"&ext="+b:this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+n+"&category="+s+"&title="+o)},viewOrderDetail:function(){var e=C.getUser();if(d&&e&&e.Auth){this.showLoading();var t={Id:d,page:"bookingsuccess"};w.set(t),this.forwardJump("tuanorderdetail","/webapp/tuan/tuanorderdetail/"+d+".html")}},redirectToRegister:function(){m.register()},redirectToLogin:function(){var e="from="+encodeURIComponent("/webapp/tuan/bookingsuccess/"+d+".html");m.memberLogin({param:e})}});return M});