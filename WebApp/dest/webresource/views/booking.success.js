define(["TuanApp","libs","cUtility","TuanStore","c","cWidgetGuider","cWidgetFactory","TuanModel","TuanBaseView","cCommonPageFactory","CommonStore","Payment","text!BookingSuccessTpl","text!RecommendTpl"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p){function A(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(t*100)/100}var d,v,m,g,y,b,c=o.create("Payment"),w=o.create("Guider"),E=o.create("Member"),S=i.ui,x=n.isInApp(),T=encodeURIComponent("source=groupon"),d=r.OrderDetailReturnPage.getInstance(),N=u.TuanSubmitOrder.getInstance(),C=u.TuanApplyOrder.getInstance(),m=r.TuanOrderListStore.getInstance(),g=u.TuanOrderDetailModel.getInstance(),k=r.GroupSearchStore.getInstance(),y=l.UserStore.getInstance(),L=u.CrossRecommendModel.getInstance(),b={pageTitle:"订单完成",warningTip:"没有检索到数据!",needLoginTip:"需要先登录才能查看订单信息"},O=f.create("TuanBaseView"),M=O.extend({pageid:"214016",hpageid:"215016",hasAd:!0,render:function(){var e=this,t=y.getUser(),n=_.template(h);if(v&&v>0)g.setParam({oid:v,auth:t?t.Auth:"",cityid:k.getAttr("ctyId"),head:l.HeadStore.getInstance().get()}),g.execute(function(t){if(t){if(!t.oid){e.forwardJump("list","/webapp/tuan/list");return}t.user=e.user,t.retainTwoDecimal=A,e.$el.html($.trim(n(t))),t.product&&t.product.id&&e.getCrossRecommend(t.product.id)}},function(){e.showToast(b.needLoginTip,3,function(){e.redirectToLogin()},!0);return},!0,this);else{var r={};r.user=t,r.oid=v,r.retainTwoDecimal=A,this.$el.html($.trim(n(r)))}},events:{"click #J_orderDetail":"viewOrderDetail","click #J_registerBtn":"redirectToRegister","click #J_tel":"callPhone","click #J_destLink":"gotoDestnation","click .J_viewDetail":"gotoDetail","click .link-more":"gotoNearList","click #J_tabNav>li":"recommendSwitch"},onCreate:function(){},onLoad:function(){v=Lizard.P("orderid");if(!y.getUser()){this.redirectToLogin();return}var e=this.getQuery("paytype");e==1||(e&2)==2||parseInt(this.getQuery("success"),10)?this.submitOrder(function(){this.render()}):this.render(),m.remove(),this.setHeader(),$("#bf_ubt_orderid").val(v)},onShow:function(){},onHide:function(){},setHeader:function(){var e=this;this.header.set({title:b.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.forwardJump("home","/webapp/tuan/home")},homeHandler:function(){e.redirectToIndex()}}}),this.header.show()},getCrossRecommend:function(t){var n=this,r=_.template(p),i=this.$el.find("#J_recommendWrap");L.setParam({id:t,isInApp:x,environment:e.environment,head:l.HeadStore.getInstance().get()}),L.execute(function(e){var n=e&&e.RecommendGroups;n.length?(i.show(),i.html(r({data:n,pid:t,city:e.city}))):i.hide()},function(){i.hide()},this,this)},recommendSwitch:function(e){var t=$(e.currentTarget),n=t.data("index");if(t.hasClass("sta-on"))return;t.addClass("sta-on").siblings().removeClass("sta-on"),this.$el.find("#J_tabCon .ui-item").hide().eq(n).show()},gotoDestnation:function(e){var t=$(e.target),n=t.attr("data-dest-id"),r=t.attr("data-dest-name");w.apply({hybridCallback:function(){w.jump({module:"destination/toDestMain",param:{districtId:n,districtName:r},targetModel:"app"})},callback:function(){location.href="http://m.ctrip.com/you/summary/"+n+".html"}})},callPhone:function(e){e.preventDefault(),this.alert=new S.Alert({title:"拨打电话",message:'<a href="tel:4008216666">拨打携程客服</a>',buttons:[{text:"取消",click:function(){this.hide()}},{text:'<a href="tel:4008216666" data-phone="4008216666">拨打</a>',click:function(e){this.hide(),w.callService()}}]}),this.alert.show()},submitOrder:function(e){var t=y.getUser(),n={head:l.HeadStore.getInstance().get(),SubmitOrder:{OrderID:+this.getQuery("orderid")||this.getPath(0),Ver:3},Operator:{UID:t.UserID,SourceForm:1}};this.showLoading(),N.setParam(n),N.execute(function(t){this.hideLoading(),e.call(this)},function(){this.hideLoading(),e.call(this)},this,this)},redirectToIndex:function(){e.tHome()},gotoDetail:function(e){var t=$(e.currentTarget),n=t.data("pid");t.data("type")==99?x?w.cross({path:"activity",param:"index.html#/dest/t"+n+".html?ext="+T}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/t"+n+".html?from="+encodeURIComponent(location.href)+"&ext="+T:this.forwardJump("detail","/webapp/tuan/detail/"+n+".html")},gotoNearList:function(e){var t=$(e.currentTarget),n=t.data("pid"),r=t.data("cityid"),i=t.data("cityname"),s=t.data("type"),o=t.data("title");t.data("type")==99?x?w.cross({path:"activity",param:"index.html#/dest/ct-"+i+"-"+r+"?ext="+T}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/ct-"+i+"-"+r+".html?from="+encodeURIComponent(location.href)+"&ext="+T:this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+n+"&category="+s+"&title="+o)},viewOrderDetail:function(){var e=y.getUser();if(v&&e&&e.Auth){this.showLoading();var t={Id:v,page:"bookingsuccess"};d.set(t),this.forwardJump("tuanorderdetail","/webapp/tuan/tuanorderdetail/"+v+".html")}},redirectToRegister:function(){E.register()},redirectToLogin:function(){var e="from="+encodeURIComponent("/webapp/tuan/bookingsuccess/"+v+".html");E.memberLogin({param:e})}});return M});