define(["TuanApp","libs","c","TuanBaseView","cCommonPageFactory","cWidgetFactory","cGeoService","TuanModel","cDataSource","TuanStore","StoreManage","text!CityListTpl","cWidgetGeolocation","HttpErrorHelper","cUtility"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d){var v=n.ui,m=o.GeoLocation,g=f.GroupSearchStore.getInstance(),y=f.GroupGeolocation.getInstance(),b=f.TuanPositionStore.getInstance(),w=f.TuanHistoryCityListStore.getInstance(),E=f.TuanCityListStore.getInstance(),S=u.TuanLocalCityInfo.getInstance(),x=f.TuanHistoryKeySearchStore.getInstance(),T=i.create("TuanBaseView"),N=d.isInApp(),C={up:"arr_up",down:"arr_down"},k=T.extend({pageid:"214002",hpageid:"215002",tuanCityList:u.TuanCityListModel.getInstance(),dateSource:new a,selectItem:null,render:function(){this.els={eltuancitylistbox:this.$el.find("#citylist_box"),eltuancitykeyword:this.$el.find("#J_searchCityInput"),searchBox:this.$el.find(".J_searchWrap")},this.cityListTplfun=_.template(c)},events:{"click .history_close":"cancelInput","click .J_cityType":"cityGroupTitleClick","focus #J_searchCityInput":"clickInput","input #J_searchCityInput":"searchKeyWordInput","click .J_cityItem":"cityItemOnClick","click .J_cityTagTitle":"cityTagTitleClick"},backAction:function(){this.back()},cityItemOnClick:function(e){var t=g.get();l.clearAll();var n=[],r=this,i=$(e.currentTarget),s,o=i.attr("data-id"),u=i.attr("data-name");if(o.toLowerCase()=="nearby"){s=l.getCurrentCity(),s?(w.setAttr("nearby",!0),g.setAttr("ctyId",s.CityId),n=l.getGroupQueryParam(),g.setAttr("qparams",n),l.addHistoryCity(s.CityId,s.CityName)):(w.setAttr("nearby",!1),g.setAttr("ctyId",t.ctyId),g.setAttr("ctyName",t.ctyName)),r.forwardJump("list","/webapp/tuan/list");return}if(o.toLowerCase()=="positioning"){this.getGeolocation(),this.upNearbyBtn(2);return}w.setAttr("nearby",!1),y.setAttr("isParentCity",!1),g.setAttr("ctyId",o),g.setAttr("ctyName",u),l.addHistoryCity(o,u),x.remove(),setTimeout(function(){r.forwardJump("home","/webapp/tuan/home")},100)},cityGroupTitleClick:function(e){var t=$(e.currentTarget);t.parent().find(".city_list").hide(),t.next("ul").toggle(200)},cityTagTitleClick:function(e){var t=$(e.currentTarget),n=t.parent(),r=t.hasClass(C.up),i;this.els.$allCityBox.find(".J_cityTagTitle").removeClass(C.up).addClass(C.down),r||t.toggleClass(C.down+" "+C.up),n.siblings().find(".city_list>li").hide(),n.find(".city_list>li").show(),i=N?n.offset().top:n.offset().top-45,window.scrollTo(0,i)},buildEvent:function(){v.InputClear(this.els.eltuancitykeyword),this.onBodyChange=$.proxy(function(){this.els.eltuancitykeyword[0].blur(),this.$el.find(".history_close").hide()},this)},updatePage:function(e){this.tuanCityList.excute(function(t){t=E.get(),this.createPage(t),e.call(this)},function(t){var n=p.getMessage(t);this.showToast(n),e.call(this)},!1,this)},createGPS:function(){this.gps=s.create("Geolocation")},getLocalCityInfo:function(e,t,n){var r=l.getCityIdByName(n),i,s=this,o=function(e){var t=s.$el.find(".current>.currentcity");s.upNearbyBtn(1);if(t.length>0){var n=t.html(),r=y.get();n=n.replace("<!--cityname-->",r.gps.CityName),n=n.replace("<!--groups-->",r.gps.Groups),t.html(n),t.attr("data-name",r.gps.CityName),t.attr("data-id",e.CityID),t.show()}};if(r){i={CityName:n,CityID:r};if(l.setCurrentCity(i)){o(i);return}}S.setParam({lng:e,lat:t,cityname:encodeURIComponent(n)}),S.excute(_.bind(function(e){s.checkParentCity(e),typeof e!=undefined&&l.setCurrentCity(e)?o(e):this.upNearbyBtn(3)},this))},checkParentCity:function(e){y.setAttr("isParentCity",!1),e.IsParentCity&&(e.HasGroupProduct?y.setAttr("isParentCity",!0):e.CityID=defaultCity.id)},getGeolocation:function(){var e=this;changeSuccessStatus=function(t){var n=e.$el.find(".current>.currentcity");e.upNearbyBtn(1);if(n.length>0){var r=n.html(),i=y.get(),s=i.gps.Groups;if(!s){var o=l.findCityInfoById(t.cityId);o&&(s=o.cGroups||0)}r=r.replace("<!--cityname-->",t.cityName),r=r.replace("<!--groups-->",s),n.html(r),n.attr("data-name",t.cityName),n.attr("data-id",t.cityId),n.show()}};var t=b.get();if(t&&t.cityId&&t.cityName){var n={cityId:t.cityId,cityName:t.cityName,hasGroupProduct:t.hasGroupProduct};changeSuccessStatus(n);return}m.Subscribe("tuan/citylist",{onComplete:function(t){b.set(t),t.city=t.city.replace("市市","市"),t.city.length>2&&(t.city=t.city.replace("市","")),y.setAttr("gps",t);var n={lng:t.lng,lat:t.lat,district:t.district,city:t.city,province:t.province,isOverseas:t.country!="中国"};e.getCityInfo(n,changeSuccessStatus)},onError:this.geoError,onPosComplete:function(e,t){},onPosError:this.geoError},this,!0)},geoError:function(){this.upNearbyBtn(3)},getCityCount:function(e){return l.getCityCount(e)},upNearbyBtn:function(e){var t=this.$el.find(".current>li").first();if(t)switch(e){case 1:t.attr("data-id","nearby"),t.attr("data-name","我附近的"),t.text("我附近的团购");break;case 2:t.attr("data-id","positioning"),t.attr("data-name","定位中"),t.text("定位中");break;case 3:t.attr("data-id","positioning"),t.attr("data-name","定位失败，请点这里重试"),t.text("定位失败，请点这里重试")}},createPage:function(e){var t=g.get(),n=w.get(),r=t.ctyId,i=t.ctyName,s,o,u,a=!1;this.citycount=this.getCityCount(e);var f=l.findHistoryCity(e.cities),c=this.cityListTplfun({data:e.cities,history:f,cityid:r,currentcityid:o,currentcityname:s,currentgroups:u,nearby:a});this.els.eltuancitylistbox.html($.trim(c)),this.els.$allCityBox=this.$el.find("#J_allCitiesBox"),e.cities.length<=0?this.els.eltuancitylistbox.find(".city_noresult").show():this.els.eltuancitylistbox.find(".city_noresult").hide(),this.getGeolocation(),a==1&&typeof o!="undefined"&&o!=null&&o!=""?(a=!0,w.setAttr("nearby",a),g.setAttr("ctyId",o),r=0):(a=!1,w.setAttr("nearby",a),g.setAttr("ctyId",r)),this.$el.find(".s_city_num>span").text(this.citycount),this.$el.find(".s_city_loading").hide(),this.$el.find(".s_city_num").show()},onCreate:function(){this.render(),this.buildEvent()},onLoad:function(e){this.turning(),this.setHeader(),this.updatePage(function(){this.hideLoading(),this.$el.bind("focus",this.onBodyChange),this.$el.bind("touchstart",this.onBodyChange)})},setHeader:function(){var e=this;this.header.set({title:"选择城市",back:!0,view:this,tel:null,events:{returnHandler:function(){e.backAction()}}}),this.header.show(),!N&&this.header.rootBox.show()},cancelInput:function(t){this.hasSearchShow=!1,this.els.eltuancitykeyword.val(""),this.$el.find(".history_close").hide(),this.els.eltuancitylistbox.find(".J_cityTagTitle").addClass(C.down).removeClass(C.up).show(),this.showHotCitys(),this.updateZIndex(!1),this.mask&&this.mask.hide(),this.setHeader(),N&&e.isOverOS7()&&this.els.searchBox.css("border-top","0")},clickInput:function(){this.hasSearchShow=!0,this.$el.find(".history_close").show(),this.els.eltuancitylistbox.find(".J_cityTagTitle").addClass(C.up).removeClass(C.down),this.header&&(this.header.hide(),this.header.rootBox&&this.header.rootBox.hide(),N&&e.isOverOS7()&&this.els.searchBox.css("border-top","20px solid #b3b3b3")),this.updateZIndex(!0),!this.mask&&(this.mask=new n.ui.Mask),this.mask.show()},updateZIndex:function(e){e?(this.els.searchBox.css({zIndex:4e3}),this.els.$allCityBox.css({position:"relative",zIndex:4e3}),this.els.eltuancitykeyword.focus()):(this.els.searchBox.css({zIndex:"auto"}),this.els.$allCityBox.css({position:"static",zIndex:"auto"}))},showHotCitys:function(){this.els.eltuancitylistbox.find(".city_list:not(.allcity)").show(),this.els.eltuancitylistbox.find(".J_cityType").show(),this.$el.find(".s_city_num>span").text(this.citycount),this.els.eltuancitylistbox.find(".city_list.allcity>li[data-filter]").hide()},hideHotCitys:function(){this.els.eltuancitylistbox.find(".city_list.allcity").show(),this.els.eltuancitylistbox.find(".J_cityType").hide(),this.els.eltuancitylistbox.find(".city_list:not(.allcity)").hide()},searchKeyWordInput:function(e){var t=$(e.currentTarget),n=t.val();if(n){n=n.replace(/\.|\{|\}|\[|\]|\*|\^|\'/img,""),n=n.toLowerCase().trim(),this.hideHotCitys(),this.els.eltuancitylistbox.find(".city_list.allcity>li").hide(),this.els.eltuancitylistbox.find(".J_cityTagTitle").hide();var r=this.els.eltuancitylistbox.find(".box-city-all .city_list>li[data-filter*="+n+"]");r.show(),r.length<=0?(this.els.eltuancitylistbox.find(".city_noresult").show(),this.$el.find(".s_city_num>span").text(0)):(this.els.eltuancitylistbox.find(".city_noresult").hide(),this.$el.find(".s_city_num>span").text(r.length))}else this.showHotCitys(),this.els.eltuancitylistbox.find(".city_noresult").hide()},onShow:function(){},onHide:function(){this.hasSearchShow==1&&this.cancelInput(),m.UnSubscribe("tuan/citylist"),this.$el.unbind("focus",this.onBodyChange),this.$el.unbind("touchstart",this.onBodyChange)},getCityInfo:function(e,t){var n=this;S.setParam({lng:e.lng,lat:e.lat,district:encodeURIComponent(e.district),cityname:encodeURIComponent(e.city),province:encodeURIComponent(e.province),isOverseas:e.isOverseas}),S.excute(function(e){n.locating=!1;var r;e&&e.CityID&&e.CityID>0&&(r={cityId:e.CityID,cityName:e.CityName,hasGroupProduct:e.HasGroupProduct},b.setAttr("cityId",e.CityID),b.setAttr("cityName",e.CityName),b.setAttr("hasGroupProduct",e.HasGroupProduct),l.setCurrentCity(e)),typeof t=="function"&&t.call(n,r)},function(e){n.locating=!1,b.setAttr("cityId",null),b.setAttr("cityName",null),n.upNearbyBtn(3)},!1,this)}});return k});