define(["TuanApp","libs","c","MemCache","cUtility","cHybridFacade","cWidgetMember","cWidgetGuider","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","CommonStore","text!DetailTpl","cWidgetFactory","CallPhone"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){function F(e){return e.toISOString().substring(0,10).replace(/-/g,"")}var m={pageTitle:"团购详情",delFavoriteSuccess:"已取消收藏",addFavoriteSuccess:"收藏成功",delFavoriteError:"取消收藏失败",addFavoriteError:"添加收藏失败"},g={content:"仅售<%=price%>元！<%=name%>，<%if(score>0){%>评价<%=score%>分，<%}%><%if(addr){%><%=addr%><%}%>"},y,b="view_unfold",w="view_fold",E="success",S="btm_tuan_btn_dis",x=n.ui,T,N=i.isInApp(),C=c.TuanDetailModel.getInstance(),k=a.TuanDetailsStore.getInstance(),L=c.TuanAddFavorite.getInstance(),A=c.TuanDelFavorite.getInstance(),O=a.GroupGeolocation.getInstance(),M=h.UserStore.getInstance(),D=a.TuanOrderInfoStore.getInstance(),P=a.TuanInvoiceStore.getInstance(),H=d.create("Member"),B=d.create("Guider"),j=Lizard.P,I=l.create("TuanBaseView");return y=I.extend({pageid:"214008",hpageid:"215008",hasAd:!1,backHome:function(t){e.tHome()},events:{"click #J_submit":"submit","click .J_relatedProducts":"gotoRelatedProducts","click .J_tips":"showTips","click .J_viewMoreBtn":"ctrlInfoTip","click #J_pic":"showImages","click #J_branch":"showBranch","click .J_showDetailMap":"showMap","click #J_comment":"showComment","click #J_service":"showService","click #J_morehotel":"showMorehotel","click #J_expandInvalid":"toggleInvalidDateInfo","click #J_recommendNearby":"recommendNearby","click #J_gotoHotelDetail":"onHotelDetailClick","click .J_nearProducts":"gotoNearProduct","click #J_groupContain":"gotoGroupContent"},onCreate:function(){this.htmlfun=_.template(p),this.cityId=j("cityid"),this.productId=j("pid")||j("productID"),this.externalReferURL=j("url")},_onLoad:function(e){this.fromUrl=i.getUrlParam(location.href,"from");if(!this.fromUrl||this.isFromWeChat(this.fromUrl))this.fromUrl="";this.removeOrderData(),this.getTuanDetail()},isFromWeChat:function(e){return e&&e.toLowerCase().indexOf("singlemessage")>-1},recommendNearby:function(){var e=this.cityId;this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+this.productId+(e?"&cityid="+e:""))},setHeader:function(e){var t=this,n;n={title:m.pageTitle,back:!0,view:this,favorited:!!e,favorite:!e,share:!0,events:{returnHandler:function(){t.backAction()}}};if(!N){var r=e?"icon_fav i_bef":"icon_unfav i_bef";n.events.commitHandler=function(){t.favorite()},n.btn={title:"",id:"favorite",classname:r}}this.header.set(n),this.header.show()},favorite:function(){var e=this,t=e.favorInfo;e.checkLogin()&&(t&&t.isFavor?e._delFavorite():e._addFavorite())},prepareShareData:function(e){var t=this,n,r=g,i=t.detailData,s="http://m.ctrip.com/webapp/tuan/detail/"+t.productId+".html?cityid="+t.cityId,o=i.hotels[0]||i.recommendHotel.hotel||{name:i.name},u=i.images,a=u&&u.length&&u[0].small,f=i.name||o.name;n={imgUrl:a,text:_.template(r.content)({price:i.price&&i.price.dPrice||"",name:f,score:o.score,addr:o&&o.addr||"",link:s}),title:o.name,linkUrl:s,isIOSSystemShare:!1},a&&B.downloadData({url:a,callback:function(r){n.imgUrl=r.savedPath,e&&e.call(t,n)}})},bindShareEvent:function(){var e=this;B.apply({callback:function(){},hybridCallback:function(){B.register({tagname:s.METHOD_SHARE,callback:function(){e.prepareShareData(function(e){B.shareToVendor(e)})}})}})},updateFavorStatus:function(e,t){var n=this;n.updateFavorButton(e),n.favorInfo={isFavor:!!e,favorId:t},k.setAttr("favorInfo",n.favorInfo)},updateFavorButton:function(e){var t=this,n="favorite",r=this.header.rootBox.find("#favorite");t.setHeader(e),B.apply({callback:function(){},hybridCallback:function(){B.register({tagname:s.METHOD_FAVORITE,callback:function(){t.favorite()}}),B.register({tagname:s.METHOD_FAVORITED,callback:function(){t.favorite()}})}})},_addFavorite:function(){var e=this;L.setParam({pid:e.productId,type:e.productInfo.pcId}),L.excute(function(t){t&&t.ResponseStatus.Ack.toLowerCase()===E&&(e.updateFavorStatus(!0,t.favorId),e.showToast(m.addFavoriteSuccess))},function(){e.showToast(m.addFavoriteError)})},_delFavorite:function(){var e=this;A.setParam({favorId:e.favorInfo.favorId}),A.excute(function(t){t&&t.ResponseStatus.Ack.toLowerCase()===E&&(e.updateFavorStatus(!1),e.showToast(m.delFavoriteSuccess))},function(){e.showToast(m.delFavoriteError)})},checkLogin:function(){var e=this,t=location.port;return M.isLogin()?!0:(!N&&e.showLoading(),H.memberLogin({domain:"//"+document.domain+(t&&t==80?"":":"+t),param:"?t=1&from="+encodeURIComponent("/webapp/tuan/detail/"+e.productId+".html"+(this.cityId?"?cityid="+this.cityId:"")),callback:function(){e._onLoad(e.referer)}}),!1)},onShow:function(){this.hideLoading(),this._onLoad()},onHide:function(){this.timer&&clearInterval(this.timer),this.hideLoading(),this.hideWarning404(),this.mask&&this.mask.hide()},isFromHybridFavorPage:function(){return N&&j("from_native_page")==1},isFromHotel:function(e){return e.indexOf("/hotel/")>-1},backAction:function(){if(this.isFromHybridFavorPage()){B.backToLastPage({param:JSON.stringify({biz:"tuan",refresh:"1"})});return}var t=decodeURIComponent(this.fromUrl||"");if(t){var n=this.getHistory();n.stack.pop(),this.isFromHotel(t)?location.href=t:e.jumpToPage(t,this)}else this.back()},removeOrderData:function(){P&&P.remove(),D&&D.remove()},getTuanDetail:function(){var t=this,n=this.cityId,r,i=O.getAttr("gps")||{};this.showLoading(),r={id:t.productId,pos:{lon:i.lng,lat:i.lat,type:3,name:i.city},environment:e.environment},n&&(r.cityid=n),C.setParam(r),C.excute(function(e){var n,r=e.channelInfo,i=r&&r.isCorrectChannel;this.hideLoading();if(!e||!e.hotels){this.showMessage("抱歉，数据加载失败，请重试或返回!");return}i||this.showMessage("该产品暂不支持手机售卖， 请在电脑端登录携程后购买。"),this.detailData=e,this.renderData(e),n=e.favorInfo,t.favorInfo=n,t.productInfo=e,t.updateFavorStatus(n&&n.isFavor,n&&n.favorId),t.bindShareEvent()},function(e){var t=this;this.showWarning404($.proxy(t.getTuanDetail,t)),this.hideLoading()},!1,this)},renderData:function(e){var t=e.labelVal,n="",r,i=e.channelInfo,s=i&&i.isCorrectChannel;e.isInApp=N,this.$el.html($.trim(this.htmlfun({data:e}))),r=this.$el.find("#J_submit"),t!=98&&(t==99?n="已售完":t==100&&(n="已结束")),n&&r.attr("class",S).text(n).removeAttr("id"),s||r.attr("class",S),this.showTimer(e.etime),this.productData=e,this.CallPhone=new v({view:this})},gotoGroupContent:function(){this.forwardJump("lashou","/webapp/tuan/lashou/"+this.productId+".html")},submit:function(){this.$el.find("#J_submit").hasClass(S)||this.forwardJump("booking","/webapp/tuan/booking"+(this.externalReferURL?"?from="+this.externalReferURL:""))},gotoRelatedProducts:function(e){var t=$(e.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+t+".html"+(this.cityId?"?cityid="+this.cityId:""))},ctrlInfoTip:function(e){var t=$(e.target),n=t.parent().prev().find(".J_tipsHidden");t.attr("data-state")==="hide"?(n.show(),t.attr({"data-state":"show"}).html("收起").removeClass("view_unfold").addClass("view_fold")):(t.attr({"data-state":"hide"}).html("查看全部").removeClass("view_fold").addClass("view_unfold"),n.hide())},showTips:function(e){this.forwardJump("detailtips","/webapp/tuan/detailtips")},showImages:function(){var e=this.productData.images;e&&e.length&&this.forwardJump("hotelimages","/webapp/tuan/hotelimages/"+this.productId+".html",{viewName:"hotelimages"})},showBranch:function(){var e=this.cityId;this.forwardJump("hotelsubbranch","/webapp/tuan/hotelsubbranch"+(e?"?cityid="+e:""))},showMap:function(e){var t=$(e.currentTarget),n=t.attr("data-coords").split(","),r=t.attr("data-hotel-name");window.mapdata={Longitude:n[0],Latitude:n[1],hotelName:r},this.forwardJump("hotelmap","/webapp/tuan/hotelmap?lon="+n[0]+"&lat="+n[1]+"&hotelName="+r)},showComment:function(){this.forwardJump("hotelcomments","/webapp/tuan/hotelcomments")},showService:function(){this.forwardJump("hotelservice","/webapp/tuan/hotelservice")},showMorehotel:function(e){var t=this.$el.find(".J_relatedRest"),n=$(e.target),r=n.data("expanded");t.css({display:r?"none":""}).removeClass("no_bb"),n.data("expanded",!r).html(r?"更多":"收起").attr("class",r?"view_unfold":"view_fold")},showTimer:function(e){var t=Date.parse(e.replace(/\-/g,"/")),n=this.getServerDate();this.dateDiff=t-n;var r=864e5;this.dateDiff/r<3&&(this.timer=setInterval(_.bind(this.updateTimer,this),600))},updateTimer:function(){if(this.dateDiff>0){var e=864e5,t=36e5,n=6e4,r=1e3,i=this.dateDiff,s=Math.floor(i/e);i%=e;var o=Math.floor(i/t);i%=t;var u=Math.floor(i/n);i%=n;var a=Math.floor(i/r);this.$el.find(".tuan_hotel_time").text("剩余  "+s+"天"+o+"小时"+u+"分"+a+"秒"),this.dateDiff=this.dateDiff-1e3}else this.endTimer()},endTimer:function(){clearInterval(this.timer),this.$el.find(".tuan_hotel_time").text("0天0小时0分0秒"),this.$el.find("#J_submit").addClass(S)},getAppUrl:function(){var e=j("pid");return"ctrip://wireless/hotel_groupon_detail?c1="+e},toggleInvalidDateInfo:function(e){var t=$(e.target),n=t.hasClass(b),r=t.parent().prev();r[n?"show":"hide"](),n?t.removeClass(b).addClass(w).text("收起"):t.removeClass(w).addClass(b).text("查看不适用日期")},onHotelDetailClick:function(e){var t=$(e.target).attr("data-hotel-id");this.gotoHotelDetail(t)},gotoNearProduct:function(e){var t=$(e.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+t+".html"+(this.cityId?"?cityid="+this.cityId:""))},gotoHotelDetail:function(t){var n=new Date,r=new Date(n.setDate(n.getDate()+1)),i=encodeURIComponent(location.href),s=N?"ctrip://wireless/InlandHotel?hotelDataType=1&checkInDate="+F(new Date)+"&checkOutDate="+F(r)+"&hotelId="+t+"&from="+i:"http://m.ctrip.com/webapp/hotel/hoteldetail/"+t+".html?from="+i;e.jumpToPage(s,this)}}),y});