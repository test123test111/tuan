define(["TuanApp","c","cUIInputClear","TuanBaseView","cCommonPageFactory","cUIScrollRadioList","cWidgetGuider","cWidgetMember","cUserModel","cUtility","cWidgetFactory","CommonStore","TuanStore","TuanModel","text!BookingTpl","NumberStep","cHolidayPriceCalendar","ValidatorUtil","FieldUtil","Payment"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y){function z(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(t*100)/100}function W(e){return!!e}var b=h.TuanOrderInfoStore.getInstance(),w=h.TuanInvoiceStore.getInstance(),E=c.UserStore.getInstance(),S=h.TuanDetailsStore.getInstance(),x=c.UnionStore&&c.UnionStore.getInstance(),T=p.TuanCreateOrder.getInstance(),N=p.TuanDetailModel.getInstance(),C=h.TuanOrderDetailStore.getInstance(),k=p.TuanCouponListModel.getInstance(),L=h.TuanCouponListStore.getInstance(),A=h.TuanSelectedCouponStore.getInstance(),O=a.NotUserLoginModel.getInstance(),M=h.GroupSearchStore.getInstance(),D=p.TicketBookingModel.getInstance(),P=f.isInApp(),H=c.HeadStore.getInstance(),B=l.create("Payment"),j=l.create("Guider"),F=l.create("Member"),I,q="电话",R={max:9,min:1},U={100:"操作成功",101:"节点数据验证不通过",102:"系统程序错误",201999:"产品不处于可售状态，不能生成订单",201e3:"产品没有供应商,生成订单失败",201001:"产品已团完,生成订单失败",201002:"产品无分销商,生成订单失败",201003:"电话格式不符合规范（例：021-10106666-），未能生成订单",201004:"产品属0元团购，分销联盟不能生成订单",201005:"产品属马上订产品，分销联盟不能生成订单",201006:"超过此产品的最大购买数量，不能生成订单",201007:"小于此产品的最少购买数量，不能生成订单",201008:"本产品携程不开发票，不能生成订单",201009:"发票创建失败，不能生成订单",201010:"发票信息有误，不能生成订单",201012:"本产品每个手机号码仅限购买一次",201011:"产品属0元团购，一个手机号只能预订一次",301e3:"订单取消成功",301001:"订单不属于用户或订单不存在",301002:"订单状态为非新订单",301003:"取消订单失败,订单状态修改失败",301004:"订单删除失败",301005:"订单删除成功",301006:"生成订单失败",301007:"订单状态修改失败",301008:"订单未查到支付记录",301009:"订单不存在",301010:"该订单已在处理中",401e3:"券号或者订单不存在或已更新，券取消失败",401001:"更新订单失败，券取消失败",401002:"更新券号失败，券取消失败",401003:"券使用失败",401004:"现渠道和此张券应属于的渠道不同，不能取消券",401005:"券取消失败",401006:"此张券已使用，不能取消券",401007:"此张券已取消，不能再次取消券",401008:"此张券已作废，不能取消券",401009:"券号已有预约记录,不能使用",401010:"券状态:已过期超过两天,不可使用",401011:"订单类型错误(1为携程收款，2为对方收款)",501e3:"联盟信息错误，无法取消券",501001:"更新联盟信息失败，未能生成订单",501002:"生成券号时发生异常，未能生成订单",601e3:"信用卡发送扣款请求失败",601001:"存在重复流水号",601002:"保存信用卡信息错误",601003:"增加支付记录失败",601004:"调用支付接口失败"};I={submitTitle:"订单提交",submitTip:"由于您长时间未提交订单，数据可能已经过时，请返回重新选择",pageTitle:"订单填写",giftCard:"携程礼品卡",cash:"现金",alertTitle:"提示信息",leaveTips:"您的订单尚未完成，确定要离开吗？",cancel:"取消",sure:"确定",telTips:"请填写正确的手机号码",failTips:"抱歉，订单未能成功提交，请重试！",timeoutTips:"非常抱歉，由于您刚才提交的服务已超时，请稍后在“我的携程”中查看订单信息或拨打服务电话400-008-6666，以确认您的订单是否提交成功。",couponCount:"(<%=count%>张)",phoneListTitle:"选择手机号",dateNone:"请选择游玩日期",telNone:"请输入手机号码",telError:"请输入正确的手机号码",nameNone:"请输入取票人姓名",nameError:"请输入正确的取票人姓名",submitting:"提交中...",selectDateTitle:"选择日期",submitError:"网络不给力，请稍后再试"};var X=i.create("TuanBaseView"),V=X.extend({pageid:"214015",hpageid:"215015",tpl:d,latlon:null,render:function(){var e=this,t=S.get(),n=E.getUser(),r=A.get(),i=b.get();this.store=t,t&&t.id?(t.min=t.min>R.min?t.min:R.min,t.max=t.max<R.max?R.max:t.max,t.curNum=i&&i.curNum||t.min,t.tel=i&&i.tel||n&&(n.BMobile||n.Mobile)||"",t.retainTwoDecimal=z,t.user=n,t.isLogin=E.isLogin(),t.invoice=w.get(),t.invoiceText=t.invoiceText||null,r&&r.pid===t.id?t.coupon=r:t.coupon=undefined,this.pid=t.id,this.price=t.price.dPrice,this.$el.html($.trim(_.template(this.tpl,t))),this.els={curNumDom:this.$el.find("#J_curNum"),numStepDom:this.$el.find(".J_numberStep"),pPriceDom:this.$el.find("#J_pPrice"),totalPriceDom:this.$el.find("#J_totalPrice"),telDom:this.$el.find("#J_tel"),submitBtn:this.$el.find("#J_submitOrder"),couponCount:this.$el.find("#J_couponCount"),couponAmount:this.$el.find("#J_couponAmount"),selectDate:this.$el.find(".J_selectDate"),ticketUserDom:this.$el.find("#J_ticketUser")},E.isLogin()&&this.getCouponList(function(t){e.els.couponCount.html(_.template(I.couponCount,{count:t}))}),this._createNumberStep(),this.initValidator()):(this.alert.setViewData({title:I.submitTitle,message:I.submitTip,buttons:[{text:"知道了",click:function(){var t=S.get();t&&t.id?e.forwardJump("detail","/webapp/tuan/detail/"+t.id+".html"):e.forwardJump("list","/webapp/tuan/list"),this.hide()}}]}),this.alert.show())},isFreeProduct:function(){return this.price<=0},events:{"click #J_submitOrder":"goNextStep","click #J_invoice":function(){this.forwardJump("invoice","/webapp/tuan/invoice")},"click #J_coupon":function(){this.forwardJump("coupon","/webapp/tuan/coupon")},"click .J_loginBtn":"loginAction","click #J_selectContact":"selectContact","click .J_selectDate":"selectDate"},initValidator:function(){var e=this;this.els.selectDate.length&&this.validator.addField(new y({dom:e.els.selectDate,rules:[W],onCheck:function(t,n){t?e._addOrRemoveHighLight(n.dom,!1):e.showToast(I.dateNone,3,function(){e._addOrRemoveHighLight(n.dom,!0),n.dom.focus()})}})),this.els.ticketUserDom.length&&this.validator.addField(new y({dom:e.els.ticketUserDom,rules:[W,function(e){return e.length<=10}],onCheck:function(t,n){var r="";t?e._addOrRemoveHighLight(n.dom,!1):(r=n.rule==0?I.nameNone:I.nameError,e.showToast(r,3,function(){e._addOrRemoveHighLight(n.dom,!0),n.dom.focus()}))}})),this.validator.addField(new y({dom:e.els.telDom,rules:[W,t.utility.validate.isMobile],onCheck:function(t,n){var r="";t?e._addOrRemoveHighLight(n.dom,!1):(r=n.rule==0?I.telNone:I.telError,e.showToast(r,3,function(){e._addOrRemoveHighLight(n.dom,!0),n.dom.focus()}))}}))},_addOrRemoveHighLight:function(e,t){e.closest("li")[t?"addClass":"removeClass"]("errorli")},onCreate:function(){this.validator=new g},getTuanDetail:function(t,n){var n=$.type(n)==="function"?n.bind(this):function(){};N.setParam({id:t,environment:e.environment}),this.showLoading(),N.excute(function(e){n(),this.hideLoading()},function(e){var t=e.msg?e.msg:"啊哦,数据加载出错了!",r=this;this.showHeadWarning("团购详情",t,function(){r.cancelOrder()}),this.hideLoading(),n()},!1,this)},loadTuan:function(){this.render(),this.isFreeProduct()&&(this.numberStep.disable(),this.$el.find("#J_invoice").hide()),this.store&&this.store.id&&(this.isIOS7()&&this._fixIOS7Bug(),n(this.els.telDom))},onLoad:function(t){var n=Lizard.P("productid")||Lizard.P("detailid");this.refer=t,this._setPageView(),n&&+n>0?(e.saveUnion(),this.getTuanDetail(n,this.loadTuan)):this.loadTuan()},selectContact:function(){var e=this;j.chooseContactFromAddressbook({callback:function(t){var n=t&&t.phoneList,r=n&&n.length;r>0&&(r==1?e.selectPhoneItem({val:n[0][q]}):e.showPhoneListPanel(n))}})},selectDate:function(){var e=this,t=this.els.selectDate.attr("data-date")||S.getAttr("ckintime"),n="cui_cld_daycrt";this.showLoading(),D.setParam({pid:e.pid,daterange:{sdate:"",edate:""}}),D.excute(function(r){e.hideLoading();var i=r.plist[0].PDList;_.each(i,function(t){t.dateStr=t.date,t.date=new Date(e._convertTimeString(t.date)),t.price=parseInt(t.price,10)}),e.calendar=new m({monthsNum:2,voidInvalid:!0,priceDate:i,header:{title:I.selectDateTitle},onShow:function(){this.$el.find('[data-date="'+t+'"]').addClass(n)},onHide:function(){this.remove()},callback:function(t,r,s){var o=e._formatCalendarDate(t)+(r.holiday||r.days);this.$el.find("."+n).removeClass(n),s.addClass(n),e.els.selectDate.val(o).attr("data-date",r.value),S.setAttr("ckintimetxt",o),e._storeDailyPrice(i,r.value),e.numberStep.options.onChange(),e._addOrRemoveHighLight(e.els.selectDate),this.hide()}}),e.calendar.show()},function(t){e.hideLoading()})},_storeDailyPrice:function(e,t){var n;_.each(e,function(e){if(e.dateStr==t)return n=e.price,!1}),S.setAttr("ckintime",t),S.setAttr("ticketPrice",n||0)},_formatCalendarDate:function(e){return typeof e=="string"&&(e=new Date(this._convertTimeString(e))),e.getMonth()+1+"月"+e.getDate()+"日 "},_convertTimeString:function(e){return e&&e.replace(/-/g,"/")},_formatPhoneList:function(e){return e.map(function(e){var t=e[q];return{key:t,val:t}})},showPhoneListPanel:function(e){var t=this,n;n=new s({data:t._formatPhoneList(e),title:I.phoneListTitle,itemClick:$.proxy(t.selectPhoneItem,t)}),n.show()},selectPhoneItem:function(e){this.els.telDom.val(e.val),this.changeBtnState()},isIOS7:function(){var e=$.os;return e.ios&&Math.floor(e.version)===7},_fixIOS7Bug:function(){var e=$(".order_btnbox");this.els.telDom.add(this.els.ticketUserDom).on("focus",function(){e.css({position:"absolute",bottom:"0px"})}).on("blur",function(){e.css({position:"fixed",bottom:"0px"})})},_setPageView:function(){var e=this;this.header.set({title:I.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.cancelOrder()},homeHandler:function(){e.redirectToIndex()}}})},onShow:function(){this.setTitle(I.pageTitle),this.hideLoading(),P&&this.$el.find("#J_selectContact").show()},onHide:function(){this.hideLoading()},redirectToIndex:function(){e.tHome()},cancelOrder:function(){var e=this,n=S.get(),r=new t.ui.Alert({title:I.alertTitle,onShow:function(){e.isCanceling=!0},onHide:function(){e.isCanceling=!1},message:I.leaveTips,buttons:[{text:I.cancel,click:function(){this.hide()}},{text:I.sure,click:function(){var t=S.get();this.hide(),e.showLoading(),n&&n.id?e.back({did:n.id}):e.back()}}]})||this.returnAlert;e.isCanceling||r.show()},changeBtnState:function(){return!1;var e},showLoadingLayer:function(e,n){!this.loadingLayer&&(this.loadingLayer=new t.ui.LoadingLayer(function(){e&&e()},n||I.submitting)),this.loadingLayer.show()},hideLoadingLayer:function(){this.loadingLayer&&this.loadingLayer.hide()},goNextStep:function(){var e=E.getUser();this.validator.validate()&&(this.showLoadingLayer(function(){O.abort(),T.abort()}),!e||!e.Auth||e.IsNonUser?this.noMemberLogin($.proxy(this.submitOrder,this)):this.submitOrder())},submitOrder:function(){var n=this,r,i=e.getQuery("from"),s=this.els.telDom.val(),o=this.numberStep.getCurrentNum(),u,a={OInfo:{User:{UID:""},Product:{Price:{Price:1,CurCode:"RMB"},ProductID:0,Quantity:1},Contact:{Mobile:"13802200000",Email:"",Phone:""},Invoice:{InvoiceHead:"",InvoiceDesc:"",RevAddr:"",RevPerName:"",PostCode:"",ExType:0,ExInfo:{PName:"",CName:"",LName:"",ExpressAmount:{Price:0,CurCode:"RMB"}}},CouponInfo:null,OrderType:1,PaymentVersion:3,PartnerID:0,IsReturnCute:!1,IsMarketPrice:!1,Source:"1",IsInvoice:!1,MemberType:0,UserIP:""},head:{syscode:"09",lang:"01",auth:"",cid:"",ctok:"",cver:"1.0",sid:"8888"}},f=w.get(),l=S.get(),c=E.getUser(),h=x&&x.get();b.setAttr("curNum",o);if(!s||s===""||!t.utility.validate.isMobile(s)){this.hideLoading(),this.showMessage(I.telTips);return}b.setAttr("tel",s);if(!l||!l.id){this.forwardJump("detial","/webapp/tuan/detail/"+n.pid+".html"),this.hide();return}if(l.activities&&l.activities.length>0)for(var p in l.activities){var d=l.activities[p];d&&d.type&&+d.type>0&&+d.type==1&&(a.OInfo.IsMarketPrice=!0)}f&&f.needed&&(a.OInfo.IsInvoice=f.needed,a.OInfo.Invoice.InvoiceHead=f.title,a.OInfo.Invoice.RevPerName=f.recipient,a.OInfo.Invoice.RevAddr=f.addr,a.OInfo.Invoice.PostCode=f.zip,r=f.regionText.split(" "),a.OInfo.Invoice.ExInfo.PName=r[0],a.OInfo.Invoice.ExInfo.CName=r[1],a.OInfo.Invoice.ExInfo.LName=r[2],a.OInfo.ItemType=l.pcId,a.OInfo.Invoice.ExType=f.deliveryMethod||0,a.OInfo.Invoice.ExInfo.ExpressAmount.Price=f.deliveryMethod==1?10:0),a.OInfo.Contact.Mobile=s,a.OInfo.Product.Quantity=o,a.OInfo.Product.ProductID=l.id,l.ticketPrice?u=l.ticketPrice:u=l.price.dPrice-(this.store.coupon?this.store.coupon.amount:0),a.OInfo.Product.Price.Price=parseFloat(u>0?u:0),H.getAttr("auth")&&(a.head.auth=H.getAttr("auth"),a.OInfo.User.UID=c.UserID,a.LoginToken=c.loginToken),h&&(a.OInfo.AllianceInfo={AllianceID:h.AllianceID,OUID:h.OUID,SID:h.SID},a.OInfo.PartnerID=h.PartnerID),i&&(a.url=i),a.OInfo.Source=n._getUAInfo(),this.store.coupon&&(a.OInfo.CouponInfo={CouponCode:this.store.coupon.code});var v=S.getAttr("ckintime"),m=n.els.ticketUserDom.val();v&&m&&(a.OInfo.binfo={name:m,ckintime:v}),this._sendOrderRequest(a)},_getUAInfo:function(){var e=$.os,t=P?"Hybird":"H5",n="other";return e.ios?e.iphone?n="iphone":e.ipad&&(n="ipad"):e.android&&(e.tablet?n="android":n="androidpad"),"client/"+n+"/"+t},_createNumberStep:function(){var e=this,t=e.store.max<R.max?e.store.max:R.max,n=e.store.min>R.min?e.store.min:R.min,r=S.getAttr("curNum")||1;this.numberStep=new v({max:t,min:n,initialVal:r<n?n:r,wrap:e.els.numStepDom,html:'<i class="minus <%if(initialVal <= min ){ %>num_invalid<%} %>" data-flag="-"></i><span id="J_curNum" class="numtext"><%=initialVal %></span><i data-flag="+" class="plus <%if(initialVal >= max ){ %>num_invalid<%} %>"></i>',onChange:function(){var t=e.store,n,r,i,s=w.get(),o=t.coupon?t.coupon.amount:0,u=parseInt(e.$el.find("#J_curNum").text().trim()),a=e.price;S.setAttr("curNum",u),t.activities&&t.activities.length>0&&e.els.pPriceDom[0]&&(n=t.activities[0],r=n.arg*u,e.els.pPriceDom.html(r)),i=z((parseFloat(S.getAttr("ticketPrice")||a)-o)*u),i=(i>0?i:0)+(s&&s.deliveryMethod==1?10:0),e.els.totalPriceDom.html(i>0?i:0),e.els.couponAmount.length&&e.els.couponAmount.html(z(o*u))}}),this.numberStep.options.onChange()},_sendOrderRequest:function(e){var t=this;T.setParam(e),T.excute(function(e){var n,r=11,i=H.getAttr("auth"),s,o,u=w.get(),a={},f;f=E.isLogin()?0:1,e.Status.toLowerCase()==="success"?(n=e.GOrder.OID,o=e.GOrder.Price,s=e.GOrder.Price.TotalAmount.Price,a={oid:n,bustype:r,requestid:e.RequestId,islogin:f,from:"",rback:"",sback:"",eback:"",auth:i,title:t.store.name,recall:"Group.Switch.LTPPayment.LTPOrderProcessWS",amount:s,extno:e.GOrder.ExNo,needInvoice:!!u&&u.needed,payTypeList:e.GOrder.PayType,subPayTypeList:e.GOrder.SubPayType},s>0?B.submit(t,a):t.forwardJump("bookingsuccess","/webapp/tuan/bookingsuccess/"+n+".html")):e.ResponseStatus.Ack.toLowerCase()=="failure"&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0?t.showToast(t.getMsgByCode(e.ResponseStatus.Errors[0].ErrorCode)):t.showToast("订单提交失败请重试!"),t.hideLoading(),t.store.coupon&&t._clearUsedCoupon()},function(e){t.hideLoading();var n=e.statusText==="timeout"?I.timeoutTips:I.failTips;e.ResponseStatus&&e.ResponseStatus.Ack.toLowerCase()=="failure"&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0&&(n=t.getMsgByCode(e.ResponseStatus.Errors[0].ErrorCode),n||(n=e.ResponseStatus.Errors[0].Message)),t.showToast(n)},this,!0)},loginAction:function(){var e=this;E.isLogin()||F.memberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent("/webapp/tuan/booking"),callback:function(){e.onLoad(e.refer)}})},h5NoMemberLogin:function(e){var t=this;O.excute(function(n){e&&e.call(t)},function(){t.hideLoadingLayer(),t.showToast("自动登录失败")},!1,t,function(){t.hideLoadingLayer()})},noMemberLogin:function(e){P?F.nonMemberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent(location.href),callback:e}):this.h5NoMemberLogin(e)},getMsgByCode:function(e){return U[e]||""},_clearUsedCoupon:function(){delete this.store.coupon,A.remove()},getCouponList:function(e){var t=this;k.setParam({pid:this.pid,head:k.getHead().get()}),k.execute(function(t){var n=t.coupons&&t.coupons.length;n&&e&&e(n)},function(e){},!1,this)}});return V});