define(["TuanApp","c","cUIInputClear","TuanBaseView","cCommonPageFactory","cUIScrollRadioList","cWidgetGuider","cWidgetMember","cUserModel","cUtility","cWidgetFactory","CommonStore","TuanStore","TuanModel","text!BookingTpl","NumberStep","Payment"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){function I(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(t*100)/100}var m=h.TuanOrderInfoStore.getInstance(),g=h.TuanInvoiceStore.getInstance(),y=c.UserStore.getInstance(),b=h.TuanDetailsStore.getInstance(),w=c.UnionStore&&c.UnionStore.getInstance(),E=p.TuanCreateOrder.getInstance(),S=p.TuanDetailModel.getInstance(),x=h.TuanOrderDetailStore.getInstance(),T=p.TuanCouponListModel.getInstance(),N=h.TuanCouponListStore.getInstance(),C=h.TuanSelectedCouponStore.getInstance(),k=a.NotUserLoginModel.getInstance(),L=h.GroupSearchStore.getInstance(),A=f.isInApp(),O=c.HeadStore.getInstance(),M=l.create("Payment"),D=l.create("Guider"),P=l.create("Member"),H,B="电话",j={max:9,min:1},F={100:"操作成功",101:"节点数据验证不通过",102:"系统程序错误",201999:"产品不处于可售状态，不能生成订单",201e3:"产品没有供应商,生成订单失败",201001:"产品已团完,生成订单失败",201002:"产品无分销商,生成订单失败",201003:"电话格式不符合规范（例：021-10106666-），未能生成订单",201004:"产品属0元团购，分销联盟不能生成订单",201005:"产品属马上订产品，分销联盟不能生成订单",201006:"超过此产品的最大购买数量，不能生成订单",201007:"小于此产品的最少购买数量，不能生成订单",201008:"本产品携程不开发票，不能生成订单",201009:"发票创建失败，不能生成订单",201010:"发票信息有误，不能生成订单",201012:"本产品每个手机号码仅限购买一次",201011:"产品属0元团购，一个手机号只能预订一次",301e3:"订单取消成功",301001:"订单不属于用户或订单不存在",301002:"订单状态为非新订单",301003:"取消订单失败,订单状态修改失败",301004:"订单删除失败",301005:"订单删除成功",301006:"生成订单失败",301007:"订单状态修改失败",301008:"订单未查到支付记录",301009:"订单不存在",301010:"该订单已在处理中",401e3:"券号或者订单不存在或已更新，券取消失败",401001:"更新订单失败，券取消失败",401002:"更新券号失败，券取消失败",401003:"券使用失败",401004:"现渠道和此张券应属于的渠道不同，不能取消券",401005:"券取消失败",401006:"此张券已使用，不能取消券",401007:"此张券已取消，不能再次取消券",401008:"此张券已作废，不能取消券",401009:"券号已有预约记录,不能使用",401010:"券状态:已过期超过两天,不可使用",401011:"订单类型错误(1为携程收款，2为对方收款)",501e3:"联盟信息错误，无法取消券",501001:"更新联盟信息失败，未能生成订单",501002:"生成券号时发生异常，未能生成订单",601e3:"信用卡发送扣款请求失败",601001:"存在重复流水号",601002:"保存信用卡信息错误",601003:"增加支付记录失败",601004:"调用支付接口失败"};H={submitTitle:"订单提交",submitTip:"由于您长时间未提交订单，数据可能已经过时，请返回重新选择",pageTitle:"订单填写",giftCard:"携程礼品卡",cash:"现金",alertTitle:"提示信息",leaveTips:"您的订单尚未完成，确定要离开吗？",cancel:"取消",sure:"确定",telTips:"请填写正确的手机号码",failTips:"抱歉，订单未能成功提交，请重试！",timeoutTips:"非常抱歉，由于您刚才提交的服务已超时，请稍后在“我的携程”中查看订单信息或拨打服务电话400-008-6666，以确认您的订单是否提交成功。",couponCount:"(<%=count%>张)",phoneListTitle:"选择手机号"};var q=i.create("TuanBaseView"),R=q.extend({pageid:"214015",hpageid:"215015",tpl:d,latlon:null,render:function(){var e=this,t=b.get(),n=y.getUser(),r=C.get(),i=m.get();this.store=t,t&&t.id?(t.min=t.min>j.min?t.min:j.min,t.max=t.max<j.max?j.max:t.max,t.curNum=i&&i.curNum||t.min,t.tel=i&&i.tel||n&&n.Mobile||"",t.retainTwoDecimal=I,t.user=n,t.isLogin=y.isLogin(),t.invoice=g.get(),t.invoiceText=t.invoiceText||null,r&&r.pid===t.id?t.coupon=r:t.coupon=undefined,this.pid=t.id,this.price=t.price.dPrice,this.$el.html($.trim(_.template(this.tpl,t))),this.els={curNumDom:this.$el.find("#J_curNum"),numStepDom:this.$el.find(".J_numberStep"),pPriceDom:this.$el.find("#J_pPrice"),totalPriceDom:this.$el.find("#J_totalPrice"),telDom:this.$el.find("#J_tel"),submitBtn:this.$el.find("#J_submitOrder"),couponCount:this.$el.find("#J_couponCount"),couponAmount:this.$el.find("#J_couponAmount")},y.isLogin()&&this.getCouponList(function(t){e.els.couponCount.html(_.template(H.couponCount,{count:t}))}),this._createNumberStep()):(this.alert.setViewData({title:H.submitTitle,message:H.submitTip,buttons:[{text:"知道了",click:function(){var t=b.get();t&&t.id?e.forwardJump("detail","/webapp/tuan/detail/"+t.id+".html"):e.forwardJump("list","/webapp/tuan/list"),this.hide()}}]}),this.alert.show())},isFreeProduct:function(){return this.price<=0},events:{"click #J_submitOrder":"goNextStep","focus #J_tel":function(){var e=this;this.submitBtnTimer=setInterval(function(){e.changeBtnState()},500)},"blur #J_tel":function(){this.changeBtnState(),this.submitBtnTimer&&clearInterval(this.submitBtnTimer)},"click #J_invoice":function(){this.forwardJump("invoice","/webapp/tuan/invoice")},"click #J_coupon":function(){this.forwardJump("coupon","/webapp/tuan/coupon")},"click .J_loginBtn":"loginAction","click #J_selectContact":"selectContact"},onCreate:function(){m?m.remove():""},getTuanDetail:function(t,n){var n=$.type(n)==="function"?n.bind(this):function(){};S.setParam({id:t,environment:e.environment}),this.showLoading(),S.excute(function(e){n(),this.hideLoading()},function(e){var t=e.msg?e.msg:"啊哦,数据加载出错了!",r=this;this.showHeadWarning("团购详情",t,function(){r.cancelOrder()}),this.hideLoading(),n()},!1,this)},loadTuan:function(){this.render(),this.isFreeProduct()&&(this.numberStep.disable(),this.$el.find("#J_invoice").hide()),this.store&&this.store.id&&(this.isIOS7()&&this._fixIOS7Bug(),n(this.els.telDom))},onLoad:function(t){var n=Lizard.P("productid")||Lizard.P("detailid");this.refer=t,this._setPageView(),n&&+n>0?(e.saveUnion(),this.getTuanDetail(n,this.loadTuan)):this.loadTuan()},selectContact:function(){var e=this;D.chooseContactFromAddressbook({callback:function(t){var n=t&&t.phoneList,r=n&&n.length;r>0&&(r==1?e.selectPhoneItem({val:n[0][B]}):e.showPhoneListPanel(n))}})},_formatPhoneList:function(e){return e.map(function(e){var t=e[B];return{key:t,val:t}})},showPhoneListPanel:function(e){var t=this,n;n=new s({data:t._formatPhoneList(e),title:H.phoneListTitle,itemClick:$.proxy(t.selectPhoneItem,t)}),n.show()},selectPhoneItem:function(e){this.els.telDom.val(e.val),this.changeBtnState()},isIOS7:function(){var e=$.os;return e.ios&&Math.floor(e.version)===7},_fixIOS7Bug:function(){var e=$(".order_btnbox");this.els.telDom.on("focus",function(){e.css({position:"absolute",bottom:"0px"})}).on("blur",function(){e.css({position:"fixed",bottom:"0px"})})},_setPageView:function(){var e=this;this.header.set({title:H.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.cancelOrder()},homeHandler:function(){e.redirectToIndex()}}})},onShow:function(){this.setTitle(H.pageTitle),this.hideLoading(),A&&this.$el.find("#J_selectContact").show()},onHide:function(){this.hideLoading()},redirectToIndex:function(){e.tHome()},cancelOrder:function(){var e=this,n=b.get(),r=new t.ui.Alert({title:H.alertTitle,onShow:function(){e.isCanceling=!0},onHide:function(){e.isCanceling=!1},message:H.leaveTips,buttons:[{text:H.cancel,click:function(){this.hide()}},{text:H.sure,click:function(){var t=b.get();this.hide(),e.showLoading(),n&&n.id?e.back({did:n.id}):e.back()}}]})||this.returnAlert;e.isCanceling||r.show()},changeBtnState:function(){var e=this.els.telDom.val();""===e?this.els.submitBtn.addClass("disabled").attr("disabled","disabled"):this.els.submitBtn.removeClass("disabled").removeAttr("disabled"),m.setAttr("tel",e)},goNextStep:function(){var e=y.getUser();this.showLoading(),!e||!e.Auth||e.IsNonUser?this.noMemberLogin($.proxy(this.submitOrder,this)):this.submitOrder()},submitOrder:function(){var n=this,r,i=e.getQuery("from"),s=this.els.telDom.val(),o=this.numberStep.getCurrentNum(),u,a={OInfo:{User:{UID:""},Product:{Price:{Price:1,CurCode:"RMB"},ProductID:0,Quantity:1},Contact:{Mobile:"13802200000",Email:"",Phone:""},Invoice:{InvoiceHead:"",InvoiceDesc:"",RevAddr:"",RevPerName:"",PostCode:"",ExType:0,ExInfo:{PName:"",CName:"",LName:"",ExpressAmount:{Price:0,CurCode:"RMB"}}},CouponInfo:null,OrderType:1,PaymentVersion:3,PartnerID:0,IsReturnCute:!1,IsMarketPrice:!1,Source:"1",IsInvoice:!1,MemberType:0,UserIP:""},head:{syscode:"09",lang:"01",auth:"",cid:"",ctok:"",cver:"1.0",sid:"8888"}},f=g.get(),l=b.get(),c=y.getUser(),h=w&&w.get();m.setAttr("curNum",o);if(!s||s===""||!t.utility.validate.isMobile(s)){this.hideLoading(),this.showMessage(H.telTips);return}if(!l||!l.id){this.forwardJump("detial","/webapp/tuan/detail/"+n.pid+".html"),this.hide();return}if(l.activities&&l.activities.length>0)for(var p in l.activities){var d=l.activities[p];d&&d.type&&+d.type>0&&+d.type==1&&(a.OInfo.IsMarketPrice=!0)}f&&f.needed&&(a.OInfo.IsInvoice=f.needed,a.OInfo.Invoice.InvoiceHead=f.title,a.OInfo.Invoice.RevPerName=f.recipient,a.OInfo.Invoice.RevAddr=f.addr,a.OInfo.Invoice.PostCode=f.zip,r=f.regionText.split(" "),a.OInfo.Invoice.ExInfo.PName=r[0],a.OInfo.Invoice.ExInfo.CName=r[1],a.OInfo.Invoice.ExInfo.LName=r[2],a.OInfo.ItemType=l.pcId,a.OInfo.Invoice.ExType=f.deliveryMethod||0,a.OInfo.Invoice.ExInfo.ExpressAmount.Price=f.deliveryMethod==1?10:0),a.OInfo.Contact.Mobile=s,a.OInfo.Product.Quantity=o,a.OInfo.Product.ProductID=l.id,u=l.price.dPrice-(this.store.coupon?this.store.coupon.amount:0),a.OInfo.Product.Price.Price=parseFloat(u>0?u:0),O.getAttr("auth")&&(a.head.auth=O.getAttr("auth"),a.OInfo.User.UID=c.UserID,a.LoginToken=c.loginToken),h&&(a.OInfo.AllianceInfo={AllianceID:h.AllianceID,OUID:h.OUID,SID:h.SID},a.OInfo.PartnerID=h.PartnerID),i&&(a.url=i),a.OInfo.Source=n._getUAInfo(),this.store.coupon&&(a.OInfo.CouponInfo={CouponCode:this.store.coupon.code}),this._sendOrderRequest(a)},_getUAInfo:function(){var e=$.os,t=A?"Hybird":"H5",n="other";return e.ios?e.iphone?n="iphone":e.ipad&&(n="ipad"):e.android&&(e.tablet?n="android":n="androidpad"),"client/"+n+"/"+t},_createNumberStep:function(){var e=this,t=e.store.max<j.max?e.store.max:j.max,n=e.store.min>j.min?e.store.min:j.min,r=b.getAttr("curNum")||1;this.numberStep=new v({max:t,min:n,initialVal:r<n?n:r,wrap:e.els.numStepDom,onChange:function(){var t=e.store,n,r,i,s=g.get(),o=t.coupon?t.coupon.amount:0,u=parseInt(e.$el.find("#J_curNum").text().trim());window.tuanDetailStore=b,b.setAttr("curNum",u),t.activities&&t.activities.length>0&&e.els.pPriceDom[0]&&(n=t.activities[0],r=n.arg*u,e.els.pPriceDom.html(r)),i=I((parseFloat(e.price)-o)*u),i=(i>0?i:0)+(s&&s.deliveryMethod==1?10:0),e.els.totalPriceDom.html(i>0?i:0),e.els.couponAmount.length&&e.els.couponAmount.html(I(o*u))}}),this.numberStep.options.onChange()},_sendOrderRequest:function(e){var t=this;E.setParam(e),E.excute(function(e){var n,r=11,i=O.getAttr("auth"),s,o,u=g.get(),a={},f;f=y.isLogin()?0:1,e.Status.toLowerCase()==="success"?(n=e.GOrder.OID,o=e.GOrder.Price,s=e.GOrder.Price.TotalAmount.Price,a={oid:n,bustype:r,requestid:e.RequestId,islogin:f,from:"",rback:"",sback:"",eback:"",auth:i,title:t.store.name,recall:"Group.Switch.LTPPayment.LTPOrderProcessWS",amount:s,extno:e.GOrder.ExNo,needInvoice:!!u&&u.needed,payTypeList:e.GOrder.PayType,subPayTypeList:e.GOrder.SubPayType},s>0?M.submit(t,a):t.forwardJump("bookingsuccess","/webapp/tuan/bookingsuccess/"+n+".html")):e.ResponseStatus.Ack.toLowerCase()=="failure"&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0?t.showToast(t.getMsgByCode(e.ResponseStatus.Errors[0].ErrorCode)):t.showToast("订单提交失败请重试!"),t.hideLoading(),t.store.coupon&&t._clearUsedCoupon()},function(e){t.hideLoading();var n=e.statusText==="timeout"?H.timeoutTips:H.failTips;e.ResponseStatus&&e.ResponseStatus.Ack.toLowerCase()=="failure"&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0&&(n=t.getMsgByCode(e.ResponseStatus.Errors[0].ErrorCode),n||(n=e.ResponseStatus.Errors[0].Message)),t.showToast(n)},this,!0)},loginAction:function(){var e=this;y.isLogin()||P.memberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent("/webapp/tuan/booking"),callback:function(){e.onLoad(e.refer)}})},h5NoMemberLogin:function(e){var t=this;k.excute(function(n){e&&e.call(t)},function(){t.hideLoading(),t.showToast("自动登录失败")},!1,t,function(){t.hideLoading()})},noMemberLogin:function(e){this.showLoading(),A?P.nonMemberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent(location.href),callback:e}):this.h5NoMemberLogin(e)},getMsgByCode:function(e){return F[e]||""},_clearUsedCoupon:function(){delete this.store.coupon,C.remove()},getCouponList:function(e){var t=this;T.setParam({pid:this.pid,head:T.getHead().get()}),T.execute(function(t){var n=t.coupons&&t.coupons.length;n&&e&&e(n)},function(e){},!1,this)}});return R});