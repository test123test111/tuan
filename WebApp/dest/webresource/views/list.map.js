define(["TuanApp","TuanBaseView","cCommonPageFactory","TuanStore","AMapWidget","POIWidget","cUtility","cWidgetFactory","cWidgetGeolocation","TuanModel","CommonStore","StoreManage","text!ListMapTpl"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p={cityCenter:"市中心",pageTitle:"团购地图"},d="current",v="gray",m=15,g="map_pshow",y="ani_rotation",b,i=u.create("AMapWidget"),w=u.create("POIWidget"),E=r.GroupSearchStore.getInstance(),S=r.GroupGeolocation.getInstance(),x=r.GroupListStore.getInstance(),T=f.TuanPOIListModel.getInstance(),N=r.GroupPositionFilterStore.getInstance(),C=n.create("TuanBaseView");return b=C.extend({pageid:"260002",hpageid:"261002",tpl:h,render:function(){this.$el.html(this.tpl),o.isInApp()&&$.os&&$.os.ios&&parseInt($.os.version,10)>=7&&(this.$el.find("#J_listmapWrap").css({"padding-top":"20px","background-color":"#b3b3b3"}),this.$el.find("#J_return").css("top","30px"))},events:{"click #J_return":"returnHandler","click #J_category>li":"categorySelectHandler"},returnHandler:function(){this.back("list")},onCreate:function(){this.render(),this.categoryWrap=this.$el.find("#J_category"),this.geolocation=u.create("Geolocation"),this.createMap(),this.markerTpl=this.$el.find("#J_markerTpl").html()},inited:!1,onLoad:function(){},createPOI:function(){var e=this;e.poi=new w({model:T,onSuccess:function(t){var n;e.poiData=t,n=e.getCenterMarkerData(),e.addPOIMarkers(t.products),e.centerMarker&&e.centerMarker.getPosition().getLat()==n.lat&&e.centerMarker.getPosition().getLng()==n.lon?(e.centerMarker.show(),e.mapWidget.setPosition(e.centerMarker,n.lon,n.lat)):e.addCenterMarker(n),e.mapWidget.setFitView(),e.inited=!0}})},poiMarkers:[],renderMarkerDOM:function(e){return _.template(this.markerTpl)(e)},removeCurrentLocationTool:function(){var e=this.mapWidget,t=e&&e.geolocation;t&&(t._marker&&t._marker.setMap(null),t._circle&&t._circle.setMap(null))},clearPOIMarkers:function(){var e=this.mapWidget,t=this,n=this.poiMarkers;return n.forEach(function(n){e.removeMarker(n),e.removeEvent(n,"click",t.markerClickHandler)}),this.poiMarkers=[],this},addPOIMarkers:function(e){var t=this.mapWidget,n=this,r=t.host,i=this.poiMarkers,s,o;e.forEach(function(e){s=e.pos,o=t.addMarker({position:new r.LngLat(s.lon,s.lat),content:n.renderMarkerDOM(e)}),t.addEvent(o,"click",n.markerClickHandler,n),i.push(o)}),this.poiMarkers=i},markerClickHandler:function(e){var t=e.originalEvent,n=this.currentMarkerDom,r=$(t.currentTarget||t.srcElement).children();!this.isDetailView&&!r.data("isDetailView")?(n&&this.changeMarkerView(!1,n),r.addClass(g).find(".J_detailMarker").show(),r.data("isDetailView",!0),this.currentMarkerDom=r):(this.isDetailView||$(t.target).parent(".J_detailMarker").length)&&this.gotoDetailPage(r.attr("data-pid"))},gotoDetailPage:function(e){this.forwardJump("detail","/webapp/tuan/detail/"+e+".html")},formatPOIData:function(e){var t=this.mapWidget.host;return e.map(function(e){return{position:new t.LngLat(e.lon,e.lat),content:e.shortName||e.name}})},categorySelectHandler:function(e){var t=$(e.target);this.clearPOIMarkers(),this.selectCategory(t.attr("data-type"))},selectCategory:function(e){var t=this.categoryWrap,n=e||0,r=t.find('li[data-type="'+n+'"]');n!=0?(t.find("li").addClass(v),r.removeClass(v)):t.find("li").removeClass(v),this.poi&&this.poi.abort(),this.selectedCategoryItem&&this.selectedCategoryItem.removeClass(d),r.addClass(d),this.poi.query(n,this.getParams()),this.selectedCategoryItem=r},getCenterMarkerData:function(){var e=c.isNearBy(),t,n,r,i=S.getAttr("gps"),s=N.getAttr("pos"),o=N.getAttr("type"),u;if(e)u=i,u.name=i.address||"",delete u.address;else if(!s||o=="4")n=E.getAttr("ctyId"),t=c.findCityInfoById(n),u=t&&t.pos,u.name=t.name+p.cityCenter;else if(o=="-1"||o=="5")u=s;return u&&!u.lon&&(u.lon=u.lng),u||{}},needShowMarkerDetail:function(e){return e>=m},getParams:function(){var e=E.get(),t=this,n=c.isNearBy();return n||(e.pos=t.getCenterMarkerData(),e.pos.posty=3),e},createMap:function(){var t=this,n,r=x.getAttr("curpos"),s=t.$el.find("#J_map");t.container=s,t.mapWidget=new i({container:s,height:document.body.clientHeight+(o.isInApp()?48:0),center:r?r.lon+"|"+r.lat:"116.397428|39.90923",locationButton:'<div class="map_curpos_btn" style="opacity: 0.8"></div>',onReady:function(){setTimeout(function(){t.createPOI(),t.selectCategory(this.category||e.getQuery("ctype"))},0)},onZoom:function(e,n){t.needShowMarkerDetail(n)?(t.changeMarkerView(!1,t.currentMarkerDom),t.changeMarkerView(!0)):t.changeMarkerView(!1)},onClick:function(){var e=t.centerMarker;e&&e.tipDOM&&e.tipDOM.hide(),!t.isDetailView&&t.currentMarkerDom&&t.changeMarkerView(!1,t.currentMarkerDom)},onGeoBegin:function(e){e=$(e).children(),e.css("background-color","#1491c5"),n=e},onGeoComplete:function(e){n&&n.css("background-color","rgba(0,0,0,.8)"),this.setFitView()},onGeoError:function(){n&&n.css("background-color","rgba(0,0,0,.8)")}})},changeMarkerView:function(e,t){var n=this.isDetailView,r=this.container;t?(r=t,n=t.data("isDetailView"),t.data("isDetailView",!!e),t[e?"addClass":"removeClass"](g)):this.isDetailView=!!e;if(n===e)return;r.find(".J_detailMarker")[e?"show":"hide"](),r.find(".J_simpleMarker")[e?"hide":"show"]()},addCenterMarker:function(e){var t=this,n=this.mapWidget,r=Number(e.lon),i=Number(e.lat),s;if(!r||!i)return;s=n.addMarker({position:new n.host.LngLat(r,i),offset:{x:-8,y:-34},content:_.template(t.$el.find("#J_centerMarkerTpl").html())({name:e.name||e.address})}),n.addEvent(s,"click",this.centerMarkerHandler,this),this.centerMarker=s},centerMarkerHandler:function(e){var t=$(e.originalEvent.currentTarget).find(".J_centerMarkerTip");t.show(),e.target.tipDOM=t},showMapNav:function(){var e=window.mapdata||{},t=this.mapWidget,n={latitude:e.Latitude,longitude:e.Longitude,title:e.hotelName};n&&t.gps.show_map(n)},onShow:function(){var e=this.getQuery("ctype");this.header&&this.header.hide(),this.category=e,this.inited&&this.selectCategory(this.category)},onHide:function(){!o.isInApp()&&this.header&&this.header.rootBox&&this.header.rootBox.show(),this.clearPOIMarkers(),this.centerMarker&&this.centerMarker.hide(),this.removeCurrentLocationTool()}}),b});