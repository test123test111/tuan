define(["cBase","cUICore","cUtility","cWidgetFactory","cGeoService","cWidgetGeolocation","libs"],function(t,o,e,n,i){function a(t){return t===Object(t)}var r,s="AMapWidget",c=function(){},h=null,d=$.isArray;r=new t.Class({__propertys__:function(){this.options={key:"0b895f63ca21c9e82eb158f46fe7f502",webapi:"http://webapi.amap.com/maps?v=1.2",level:13,center:h,height:0,width:0,locationButton:h,onReady:c,onZoom:c,onMovestart:c,onGeoBegin:c,onGeoComplete:c,onGeoError:c},this.__stacks=[]},initialize:function(t){var o,e=this;a(t)&&(o=$.extend(this.options,t)),this.options=o,e._updateContainerSize(o.width,o.height),e._loadScript($.proxy(e._createMap,e)),e.gps=i.GeoLocation},addMarker:function(t){var o=this,e=this.host,n=[];return e?d(t)?(t.forEach(function(t){n.push(o.addMarker(t))}),n):(n=new e.Marker(t),n.setMap(this.map),n):void this.__stacks.push(t)},removeMarker:function(t){t.setMap(null)},addEvent:function(t,o,e,n){var i,r=this;if(a(o))for(i in o)o.hasOwnProperty(i)&&r.addEvent(t,o,o[i],n);else r.host.event.addListener(t,o,e,n)},removeEvent:function(t,o,e){var n,i=this;if(a(o))for(n in o)o.hasOwnProperty(n)&&i.addEvent(o,o[n]);else i.host.event.removeListener(t,o,e)},setFitView:function(){this.map.setFitView()},setPosition:function(t,o,e){t.setPosition(new this.host.LngLat(o,e))},removeControl:function(t){this.map.removeControl(t)},_bindEvents:function(){var t=this.host.event;this.__zoomendHandler=$.proxy(this._zoomendHandler,this),this.__movestartHandler=$.proxy(this._movestartHandler,this),t.addListener(this.map,"zoomchange",this.__zoomendHandler),t.addListener(this.map,"movestart",this.__movestartHandler),this.__clickHandler=$.proxy(this._clickHandler,this),t.addListener(this.map,"click",this.__clickHandler)},_unbindEvents:function(){this.host.event.event.removeListener(this.map,"zoomchange",this.__zoomendHandler),this.host.event.event.removeListener(this.map,"click",this.__clickHandler)},_clickHandler:function(){this.options.onClick.call(this)},_zoomendHandler:function(t){var o=this.options;o.onZoom.call(this,t,this.map.getZoom())},_movestartHandler:function(t){var o=this.options;o.onMovestart.call(this,t)},_formatGPSInfo:function(t){return{coords:{latitude:t.lat,longitude:t.lng,accuracy:50},timestamp:+new Date}},_addCurrentLocationTool:function(t,o,n){var i=this,a=this.map,r=this.host;a.plugin("AMap.Geolocation",function(){var s=new r.Geolocation({enableHighAccuracy:!0,timeout:1e4,maximumAge:0,convert:!0,buttonDom:i.options.locationButton,showButton:!0,buttonPosition:"LB",buttonOffset:new r.Pixel(0,0),showMarker:!0,showCircle:!0,panToLocation:!1,zoomToAccuracy:!1});e.isInApp()&&(s.onButtonClick=function(){n&&n.call(s,s._container),i.gps.Subscribe("tuan/amap",{onComplete:function(t){s.onPositionComplete(i._formatGPSInfo(t))},onError:function(t){s.onPositionError(t)},onPosComplete:function(){},onPosError:function(t){s.onPositionError(t)}},i,!0)}),a.addControl(s),r.event.addListener(s,"complete",$.proxy(t,i)),r.event.addListener(s,"error",$.proxy(o,i)),i.geolocation=s})},_updateContainerSize:function(t,o){var e=this.options,n=e.container,i=document.body,a=n.offset();t||(t=a.width||i.clientWidth),o||(o=a.height||i.clientHeight),n.css({width:t,height:o})},_createMap:function(){var t=window.AMap,o=this.options,e=this.__stacks,n=o.center.split("|");if(!t)throw new Error("no mapapi!");this.host=t,this.map=new t.Map(o.container[0],{level:11,center:new t.LngLat(n[0],n[1])}),e.length&&this.addMarker(e),this._bindEvents(),o.locationButton&&this._addCurrentLocationTool(o.onGeoComplete,o.onGeoError,o.onGeoBegin),o.onReady.call(this)},_loadScript:function(t){if(window.AMap)return void t();var o=document.createElement("script"),e=this.options,n="__"+s+Date.now();window[n]=t,o.type="text/javascript",o.src=e.webapi+"&key="+e.key+"&callback="+n,document.body.appendChild(o)}}),n.register({name:s,fn:r})});