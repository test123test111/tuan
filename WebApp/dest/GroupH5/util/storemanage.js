define(["TuanApp","TuanStore","CityListData","StringsData"],function(t,e,r,i){var a=e.GroupSearchStore.getInstance(),s=e.GroupPositionFilterStore.getInstance(),n=e.GroupCategoryFilterStore.getInstance(),o=e.TuanHistoryCityListStore.getInstance(),u=e.GroupSortStore.getInstance(),y=e.TuanCityListStore.getInstance(),p=e.GroupGeolocation.getInstance(),l=e.TuanHistoryKeySearchStore.getInstance(),c=e.GroupCustomFilters.getInstance(),v={clearSpecified:function(t){t&&a.setAttr("sortRule",2),t&&a.setAttr("sortType",0),!t&&c.remove(),!t&&a.setAttr("ctype",0),!t&&a.setAttr("weekendsAvailable",0),s.remove(),u.remove(),this.setCurrentKeyWord(!1),a.setAttr("qparams",this.getGroupQueryParam()),a.removeAttr("pos")},clearAll:function(){this.clearSpecified(),a.remove(),n.remove()},isNearBy:function(){return a.getAttr("nearby")||o.getAttr("nearby")},addHistoryCity:function(t){var e=o.get(),r=[];e&&e.list&&$.isArray(e.list)&&(r=e.list);var a,s=0;$.each(r,function(e,r){return r!=t?!0:(a=r,s=e,!1)}),a&&a==t?(r.splice(s,1),r.unshift(t)):(r.unshift(t),r.length>i.MAX_KEYWORDS_HISTORY&&r.pop()),o.setAttr("list",r)},findHistoryCity:function(t){var e=o.get(),r=[];if(!t){var i=y.get();if(!i)return;t=i.cities||i}if(e&&e.list)for(var a=e.list.length>3?3:e.list.length,s=0;a>s;s++){var n=e.list[s],u=this.findCityInfoById(n,t);u&&r.push(u)}return r},getCityCount:function(t){if(!t){var e=y.get();if(!e)return;t=e.cities||e}var r=0;if(t&&t.cities&&t.cities.length>0)for(var i,a=0,s=t.cities.length;s>a;a++)i=t.cities[a],i&&i.tag&&"热门"!=i.tag&&(r+=i.cities.length);return r},findCityInfoById:function(t,e,i){var a;if(!e){if(a=y.get(),!a)return{CityID:t,name:r[t]||i,cGroups:""};e=a.cities||a}for(var s,n=0,o=e.length;o>n;n++)if(s=e[n],"热门"==s.tag&&s.cities)for(var u in s.cities){var p=s.cities[u];if(p.id==t)return p}for(var s,n=0,o=e.length;o>n;n++)if(s=e[n],"热门"!=s.tag&&s.cities)for(var u in s.cities){var p=s.cities[u];if(p.id==t)return p}return!1},setCurrentCity:function(t){if(t){var e=p.get();if(e&&e.gps){var r=t.CityID||t,i=this.findCityInfoById(r);if(i)return e.gps.CityId=t.CityID,e.gps.CityName=i.name,e.gps.Groups=i.cGroups,p.setAttr("gps",e.gps),!0;t.CityID&&t.CityName&&(e.gps.CityId=t.CityID,e.gps.CityName=t.CityName,e.gps.Groups=0,p.setAttr("gps",e.gps))}}return!1},getCurrentCity:function(){var t=p.get();return t&&t.gps&&+t.gps.CityId>0?t.gps:!1},addHistoryKeyWord:function(t,e,r){var a,n=l.get(),o=s.getAttr("type"),u=[],y=0;n&&n.list&&$.isArray(n.list)&&(u=n.list),$.each(u,function(e,r){return r.id!=t?!0:(a=r,y=e,!1)}),a&&a.id==t?(u.splice(y,1),u.unshift({id:t,word:e,type:r})):(u.unshift({id:t,word:e,type:r}),u.length>i.MAX_KEYWORDS_HISTORY&&u.pop()),l.remove(),l.setAttr("list",u),this.setCurrentKeyWord({id:t,word:e,type:r}),!(0>o||"5"==o)||"zone"!=r&&"markland"!=r||s.remove(),"4"==o&&"location"==r&&s.remove()},getHistoryKeyWord:function(){var t=l.get(),e=[];return t&&t.list&&(e=t.list),e},setCurrentKeyWord:function(t){l.setAttr("key",t)},removeCurrentKeyWord:function(){l.removeAttr("key")},getCurrentKeyWord:function(){var t=l.get();return t?t.key:!1},getGroupQueryParam:function(){var t=[],e=c.get(),r=s.get(),i=e&&e.price&&e.price.val;i&&t.push({type:1,value:i});var a=e&&e.star;if(a&&!$.isEmptyObject(a)){var u,y=[];for(var u in a)y.push(u);t.push({type:2,value:y.join(",")})}var l=e&&e.brand&&e.brand.val;l&&t.push({type:3,value:l});var v=e&&e.trait&&e.trait.val;v&&t.push({type:14,value:v});var g=p.get()&&p.get().gps,d=e&&e.distance&&e.distance.val;o.getAttr("nearby")&&g?t.push({type:9,value:g.lat+"|"+g.lng+(d?"|"+d:"")}):d&&t.push({type:9,value:d});var f=e&&e.day&&e.day.val;f&&t.push({type:14,value:f});var h=e&&e.multiShop;1==h&&t.push({type:14,value:"102|10201"});var C=e&&e.voucher;1==C&&t.push({type:14,value:"102|10202"});var A=n.get();A&&A.subVal&&t.push({type:14,value:A.subVal}),r=r?r:{type:"",val:""},r&&r.type&&+r.type>0&&r.val&&""!=r.val&&t.push({type:r.type,name:r.name,value:r.val});var m=this.getCurrentKeyWord();if(m){var I=(m.type||"").toString().toLowerCase(),S=m.id||m.word,G={hotelid:18,zone:5,hotelgroupid:3,location:4,activity:11,district:16,markland:17};I?/\D/.test(I)&&(I=G[I]?G[I]:7):I=7,t.push({type:I,value:S})}return t},saveQueryString:function(t){var e=Lizard.P,s=e("ctype"),u=e("price"),y=e("star"),l=e("kwd"),v=e("place"),g=e("lat"),d=e("lng")||e("lon"),f=e("cityid"),h=e("cityname"),C=e("sort");if(f&&f!=a.getAttr("ctyId")&&(this.clearAll(),o.remove()),f&&(a.setAttr("ctyId",f),h=h||r[f]||"",a.setAttr("ctyName",h)),g&&+g>0&&d&&+d>0&&v&&""!=v){p.setAttr("gps",{address:v,location:d+","+g,city:h,lng:+d,lat:+g}),o.setAttr("nearby",!0),f&&(this.setCurrentCity({CityID:f}),this.addHistoryCity(f,h));for(var A=a.getAttr("qparams")||[],m=0,I=A.length;I>m;m++)if(9==A[m].type){A.splice(m,1);break}A.push({type:9,value:g+"|"+d+"|"+i.SEARCH_DISTANCE}),a.setAttr("qparams",A)}if(s&&(n.remove(),a.setAttr("ctype",i.index2ctype[s])),y&&1==s&&c.setAttr("star",y.replace(",","|")),u&&c.setAttr("price",u),l&&(l=l.split("|"),this.addHistoryKeyWord(l[1],l[0],l[2])),C){var S=C.indexOf("/")>-1?"/":"|";C=C.split(S),a.setAttr("sortRule",C[0]),a.setAttr("sortType",C[1]||1)}t&&t()},getCityIdByName:function(t){var e;return t&&(e=r[t]),!1}};return v});