define(["TuanApp","TuanStore","CityListData","StringsData"],function(t,e,r,i){var s=e.GroupSearchStore.getInstance(),a=e.GroupPositionFilterStore.getInstance(),n=e.GroupCategoryFilterStore.getInstance(),o=e.TuanHistoryCityListStore.getInstance(),u=e.GroupSortStore.getInstance(),y=e.TuanCityListStore.getInstance(),p=e.GroupGeolocation.getInstance(),c=e.TuanHistoryKeySearchStore.getInstance(),l=e.GroupCustomFilters.getInstance(),g={clearSpecified:function(t){t&&s.setAttr("sortRule",2),t&&s.setAttr("sortType",0),!t&&l.remove(),!t&&s.setAttr("ctype",0),!t&&s.setAttr("weekendsAvailable",0),a.remove(),u.remove(),this.setCurrentKeyWord(!1),s.setAttr("qparams",this.getGroupQueryParam()),s.removeAttr("pos")},clearAll:function(){this.clearSpecified(),s.remove(),n.remove()},isNearBy:function(){return s.getAttr("nearby")||o.getAttr("nearby")},addHistoryCity:function(t){var e=o.get(),r=[];e&&e.list&&$.isArray(e.list)&&(r=e.list);var s,a=0;$.each(r,function(e,r){return r!=t?!0:(s=r,a=e,!1)}),s&&s==t?(r.splice(a,1),r.unshift(t)):(r.unshift(t),r.length>i.MAX_KEYWORDS_HISTORY&&r.pop()),o.setAttr("list",r)},findHistoryCity:function(t){var e=o.get(),r=[];if(!t){var i=y.get();if(!i)return;t=i.cities||i}if(e&&e.list)for(var s=e.list.length>3?3:e.list.length,a=0;s>a;a++){var n=e.list[a],u=this.findCityInfoById(n,t);u&&r.push(u)}return r},getCityCount:function(t){if(!t){var e=y.get();if(!e)return;t=e.cities||e}var r=0;if(t&&t.cities&&t.cities.length>0)for(var i,s=0,a=t.cities.length;a>s;s++)i=t.cities[s],i&&i.tag&&"热门"!=i.tag&&(r+=i.cities.length);return r},findCityInfoById:function(t,e,i){var s,a,n,o,u,p;if(!e){if(s=y.get(),!s)return{CityID:t,name:r[t]||i,cGroups:""};e=s.cities||s}for(a=0,p=e.length;p>a;a++)if(u=e[a],"热门"==u.tag&&u.cities)for(n in u.cities)if(o=u.cities[n],o.id==t)return o;for(a=0,p=e.length;p>a;a++)if(u=e[a],"热门"!=u.tag&&u.cities)for(n in u.cities)if(o=u.cities[n],o.id==t)return o;return!1},setCurrentCity:function(t){if(t){var e=p.get();if(e&&e.gps){var r=t.CityID||t,i=this.findCityInfoById(r);if(i)return e.gps.CityId=t.CityID,e.gps.CityName=i.name,e.gps.Groups=i.cGroups,p.setAttr("gps",e.gps),!0;t.CityID&&t.CityName&&(e.gps.CityId=t.CityID,e.gps.CityName=t.CityName,e.gps.Groups=0,p.setAttr("gps",e.gps))}}return!1},getCurrentCity:function(){var t=p.get();return t&&t.gps&&+t.gps.CityId>0?t.gps:!1},addHistoryKeyWord:function(t,e,r){var s,n=c.get(),o=a.getAttr("type"),u=[],y=0;n&&n.list&&$.isArray(n.list)&&(u=n.list),$.each(u,function(e,r){return r.id!=t?!0:(s=r,y=e,!1)}),s&&s.id==t?(u.splice(y,1),u.unshift({id:t,word:e,type:r})):(u.unshift({id:t,word:e,type:r}),u.length>i.MAX_KEYWORDS_HISTORY&&u.pop()),c.remove(),c.setAttr("list",u),this.setCurrentKeyWord({id:t,word:e,type:r}),(0>o||"5"==o)&&a.remove(),"4"==o&&"location"==r&&a.remove()},getHistoryKeyWord:function(){var t=c.get(),e=[];return t&&t.list&&(e=t.list),e},setCurrentKeyWord:function(t){c.setAttr("key",t)},removeCurrentKeyWord:function(){c.removeAttr("key")},getCurrentKeyWord:function(){var t=c.get();return t?t.key:!1},getGroupQueryParam:function(){var t=[],e=l.get(),r=a.get(),s=e&&e.price&&e.price.val;s&&t.push({type:1,value:s});var u=e&&e.star;if(u&&!$.isEmptyObject(u)){var y,c=[];for(y in u)c.push(y);t.push({type:2,value:c.join(",")})}var g=e&&e.brand&&e.brand.val;g&&t.push({type:3,value:g});var v=e&&e.trait&&e.trait.val;v&&t.push({type:14,value:v});var f=p.get()&&p.get().gps,d=e&&e.distance&&e.distance.val;o.getAttr("nearby")&&f?t.push({type:9,value:f.lat+"|"+f.lng+(d?"|"+d:"")}):d&&t.push({type:9,value:d});var h=e&&e.day&&e.day.val;h&&t.push({type:14,value:h});var C=e&&e.multiShop;1==C&&t.push({type:14,value:"102|10201"});var A=e&&e.voucher;1==A&&t.push({type:14,value:"102|10202"});var m=n.get();m&&m.subVal&&t.push({type:14,value:m.subVal}),r=r?r:{type:"",val:""},r&&r.type&&+r.type>0&&r.val&&""!==r.val&&t.push({type:r.type,name:r.name,value:r.val});var I=this.getCurrentKeyWord();if(I){var S=(I.type||"").toString().toLowerCase(),G=I.id||I.word,D=i.traType;S?/\D/.test(S)&&(S=D[S]?D[S]:7):S=7,t.push({type:S,value:G})}return t},saveQueryString:function(t){var e=Lizard.P,a=e("ctype"),u=e("price"),y=e("star"),c=e("kwd"),g=e("place"),v=e("lat"),f=e("lng")||e("lon"),d=e("cityid"),h=e("cityname"),C=e("sort");if(d&&d!=s.getAttr("ctyId")&&(this.clearAll(),o.remove()),d&&(s.setAttr("ctyId",d),h=h||r[d]||"",s.setAttr("ctyName",h)),v&&+v>0&&f&&+f>0&&g&&""!==g){p.setAttr("gps",{address:g,location:f+","+v,city:h,lng:+f,lat:+v}),o.setAttr("nearby",!0),d&&(this.setCurrentCity({CityID:d}),this.addHistoryCity(d,h));for(var A=s.getAttr("qparams")||[],m=0,I=A.length;I>m;m++)if(9==A[m].type){A.splice(m,1);break}A.push({type:9,value:v+"|"+f+"|"+i.SEARCH_DISTANCE}),s.setAttr("qparams",A)}if(a&&(n.remove(),s.setAttr("ctype",i.index2ctype[a])),y&&1==a&&l.setAttr("star",y.replace(",","|")),u&&l.setAttr("price",u),c&&(c=c.split("|"),this.addHistoryKeyWord(c[1],c[0],c[2])),C){var S=C.indexOf("/")>-1?"/":"|";C=C.split(S),s.setAttr("sortRule",C[0]),s.setAttr("sortType",C[1]||1)}t&&t()},getCityIdByName:function(t){var e;return t&&(e=r[t]),!1}};return g});