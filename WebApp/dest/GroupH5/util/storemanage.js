define(["TuanApp","TuanStore","CityListData","StringsData"],function(t,e,r,i){var a=e.GroupSearchStore.getInstance(),s=e.GroupPositionFilterStore.getInstance(),n=e.GroupCategoryFilterStore.getInstance(),o=e.TuanHistoryCityListStore.getInstance(),y=e.GroupSortStore.getInstance(),p=e.TuanCityListStore.getInstance(),u=e.GroupGeolocation.getInstance(),l=e.TuanHistoryKeySearchStore.getInstance(),c=e.GroupCustomFilters.getInstance(),d={clearSpecified:function(t){t&&a.setAttr("sortRule",2),t&&a.setAttr("sortType",0),!t&&c.remove(),!t&&a.setAttr("ctype",0),!t&&a.setAttr("weekendsAvailable",0),s.remove(),y.remove(),this.setCurrentKeyWord(!1),a.setAttr("qparams",this.getGroupQueryParam()),a.removeAttr("pos")},clearAll:function(){this.clearSpecified(),a.remove(),n.remove()},isNearBy:function(){return a.getAttr("nearby")||o.getAttr("nearby")},addHistoryCity:function(t){var e=o.get(),r=[];e&&e.list&&$.isArray(e.list)&&(r=e.list);var a,s=0;$.each(r,function(e,r){return r!=t?!0:(a=r,s=e,!1)}),a&&a==t?(r.splice(s,1),r.unshift(t)):(r.unshift(t),r.length>i.MAX_KEYWORDS_HISTORY&&r.pop()),o.setAttr("list",r)},findHistoryCity:function(t){var e=o.get(),r=[];if(!t){var i=p.get();if(!i)return;t=i.cities||i}if(e&&e.list)for(var a=e.list.length>3?3:e.list.length,s=0;a>s;s++){var n=e.list[s],y=this.findCityInfoById(n,t);y&&r.push(y)}return r},getCityCount:function(t){if(!t){var e=p.get();if(!e)return;t=e.cities||e}var r=0;if(t&&t.cities&&t.cities.length>0)for(var i,a=0,s=t.cities.length;s>a;a++)i=t.cities[a],i&&i.tag&&"热门"!=i.tag&&(r+=i.cities.length);return r},findCityInfoById:function(t,e,i){var a,s,n,o,y,u;if(!e){if(a=p.get(),!a)return{CityID:t,name:r[t]||i,cGroups:""};e=a.cities||a}for(s=0,u=e.length;u>s;s++)if(y=e[s],"热门"==y.tag&&y.cities)for(n in y.cities)if(o=y.cities[n],o.id==t)return o;for(s=0,u=e.length;u>s;s++)if(y=e[s],"热门"!=y.tag&&y.cities)for(n in y.cities)if(o=y.cities[n],o.id==t)return o;return!1},setCurrentCity:function(t){if(t){var e=u.get();if(e&&e.gps){var r=t.CityID||t,i=this.findCityInfoById(r);if(i)return e.gps.CityId=t.CityID,e.gps.CityName=i.name,e.gps.Groups=i.cGroups,u.setAttr("gps",e.gps),!0;t.CityID&&t.CityName&&(e.gps.CityId=t.CityID,e.gps.CityName=t.CityName,e.gps.Groups=0,u.setAttr("gps",e.gps))}}return!1},getCurrentCity:function(){var t=u.get();return t&&t.gps&&+t.gps.CityId>0?t.gps:!1},addHistoryKeyWord:function(t,e,r){var a,n=l.get(),o=s.getAttr("type"),y=[],p=0;n&&n.list&&$.isArray(n.list)&&(y=n.list),$.each(y,function(e,r){return r.id!=t?!0:(a=r,p=e,!1)}),a&&a.id==t?(y.splice(p,1),y.unshift({id:t,word:e,type:r})):(y.unshift({id:t,word:e,type:r}),y.length>i.MAX_KEYWORDS_HISTORY&&y.pop()),l.remove(),l.setAttr("list",y),this.setCurrentKeyWord({id:t,word:e,type:r}),(0>o||"5"==o)&&s.remove(),"4"==o&&"location"==r&&s.remove()},getHistoryKeyWord:function(){var t=l.get(),e=[];return t&&t.list&&(e=t.list),e},setCurrentKeyWord:function(t){l.setAttr("key",t)},removeCurrentKeyWord:function(){l.removeAttr("key")},getCurrentKeyWord:function(){var t=l.get();return t?t.key:!1},getGroupQueryParam:function(){var t=[],e=c.get(),r=s.get(),a=e&&e.price&&e.price.val;a&&t.push({type:1,value:a});var y=e&&e.star;if(y&&!$.isEmptyObject(y)){var p,l=[];for(p in y)l.push(p);t.push({type:2,value:l.join(",")})}var d=e&&e.brand&&e.brand.val;d&&t.push({type:3,value:d});var v=e&&e.trait&&e.trait.val;v&&t.push({type:14,value:v});var g=u.get()&&u.get().gps,f=e&&e.distance&&e.distance.val;o.getAttr("nearby")&&g?t.push({type:9,value:g.lat+"|"+g.lng+(f?"|"+f:"")}):f&&t.push({type:9,value:f});var A=e&&e.day&&e.day.val;A&&t.push({type:14,value:A});var h=e&&e.multiShop;1==h&&t.push({type:14,value:"102|10201"});var m=e&&e.voucher;1==m&&t.push({type:14,value:"102|10202"});var C=n.get();C&&C.subVal&&t.push({type:14,value:C.subVal}),r=r?r:{type:"",val:""},r&&r.type&&+r.type>0&&r.val&&""!==r.val&&t.push({type:r.type,name:r.name,value:r.val});var I=this.getCurrentKeyWord();if(I){var S=(I.type||"").toString().toLowerCase(),T=I.id||I.word,b=i.traType;S?/\D/.test(S)&&(S=b[S]?b[S]:7):S=7,t.push({type:S,value:T})}return t},saveQueryString:function(t){var e=Lizard.P,s=e("ctype"),y=e("price"),p=e("star"),l=e("kwd"),d=e("place"),v=e("lat"),g=e("lng")||e("lon"),f=e("cityid"),A=e("cityname"),h=e("sort");if(f&&f!=a.getAttr("ctyId")&&(this.clearAll(),o.remove()),f&&(a.setAttr("ctyId",f),A=A||r[f]||"",a.setAttr("ctyName",A)),v&&+v>0&&g&&+g>0&&d&&""!==d){u.setAttr("gps",{address:d,location:g+","+v,city:A,lng:+g,lat:+v}),o.setAttr("nearby",!0),f&&(this.setCurrentCity({CityID:f}),this.addHistoryCity(f,A));for(var m=a.getAttr("qparams")||[],C=0,I=m.length;I>C;C++)if(9==m[C].type){m.splice(C,1);break}m.push({type:9,value:v+"|"+g+"|"+i.SEARCH_DISTANCE}),a.setAttr("qparams",m)}if(s&&(n.remove(),a.setAttr("ctype",i.index2ctype[s])),p&&1==s&&c.setAttr("star",p.replace(",","|")),y&&c.setAttr("price",y),l&&(l=l.split("|"),this.addHistoryKeyWord(l[1],l[0],l[2])),h){var S=h.indexOf("/")>-1?"/":"|";h=h.split(S),a.setAttr("sortRule",h[0]),a.setAttr("sortType",h[1]||1)}t&&t()},getCityIdByName:function(t){var e;return t&&(e=r[t]),!1},saveHotWordParam:function(t){var e=a.get();if(d.clearAll(),o.removeAttr("nearby"),t.pos){var r=t.pos.type,y=t.pos.val,p=t.pos.lat,u=t.pos.lon,l=t.pos.name;s.set({type:r,val:y,name:l,pos:{type:3,lat:p,lon:u,name:l}})}if(t.price&&i.priceText[t.price]&&c.setAttr("price",{val:t.price,txt:i.priceText[t.price]}),t.trait&&i.traitText[t.trait]&&c.setAttr("trait",{val:t.trait,txt:i.traitText[t.trait]}),t.star){var v=t.star.split(","),g={};for(var f in v)f=v[f],i.starText[f]&&(g[f]=i.starText[f]);g&&c.setAttr("star",g)}if(t.brand&&t.brand.length>0)for(var A in t.brand)A=t.brand[A],A&&A.val&&A.key&&c.setAttr("brand",{flag:1,val:A.val,txt:A.key});if(t.markland&&d.setCurrentKeyWord({id:t.markland.id,word:t.markland.name,type:"markland"}),t.hotel&&d.setCurrentKeyWord({id:t.hotel.id,word:t.hotel.name,type:"hotelid"}),t.keyword&&d.setCurrentKeyWord({word:t.word}),t.activity&&d.setCurrentKeyWord({id:t.activity.id,word:t.activity.name,type:"activity"}),t.district&&d.setCurrentKeyWord({id:t.district.id,word:t.district.name,type:"district"}),t.isweekend&&a.setAttr("weekendsAvailable",t.isweekend),t.multishop&&c.setAttr("multiShop",t.multishop),t.voucher&&c.setAttr("voucher",t.voucher),t.sort&&(a.setAttr("sortRule",t.sort.stype),a.setAttr("sortType",t.sort.sval)),t.classty){var h,m,C,I;t.classty.parent?(h=t.classty.parent.val,m=i.groupType[h],C=t.classty.val,I=t.word):(h=t.classty.val,m=i.groupType[h]),n.setAttr("tuanType",h),m&&(n.setAttr("category",m.category),n.setAttr("name",m.name),n.setAttr("tuanTypeIndex",m.index)),n.setAttr("subVal",C),n.setAttr("subName",I),a.setAttr("ctype",h)}var S=d.getGroupQueryParam();a.setAttr("qparams",S),a.setAttr("ctyId",e.ctyId),a.setAttr("ctyName",e.ctyName)}};return d});