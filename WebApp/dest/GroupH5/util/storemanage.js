define(["TuanApp","TuanStore","CityListData","StringsData"],function(t,e,r,a){var s=e.GroupSearchStore.getInstance(),i=e.GroupPositionFilterStore.getInstance(),n=e.GroupCategoryFilterStore.getInstance(),o=e.TuanHistoryCityListStore.getInstance(),y=e.GroupSortStore.getInstance(),p=e.TuanCityListStore.getInstance(),u=e.GroupGeolocation.getInstance(),l=e.TuanHistoryKeySearchStore.getInstance(),c=e.GroupCustomFilters.getInstance(),v={clearSpecified:function(t){t&&s.setAttr("sortRule",2),t&&s.setAttr("sortType",0),!t&&c.remove(),!t&&s.setAttr("ctype",0),!t&&s.setAttr("weekendsAvailable",0),i.remove(),y.remove(),this.setCurrentKeyWord(!1),s.setAttr("qparams",this.getGroupQueryParam()),s.removeAttr("pos")},clearAll:function(){this.clearSpecified(),s.remove(),n.remove()},isNearBy:function(){return s.getAttr("nearby")||o.getAttr("nearby")},addHistoryCity:function(t){var e=o.get(),r=[];e&&e.list&&$.isArray(e.list)&&(r=e.list);var s,i=0;$.each(r,function(e,r){return r!=t?!0:(s=r,i=e,!1)}),s&&s==t?(r.splice(i,1),r.unshift(t)):(r.unshift(t),r.length>a.MAX_KEYWORDS_HISTORY&&r.pop()),o.setAttr("list",r)},findHistoryCity:function(t){var e=o.get(),r=[];if(!t){var a=p.get();if(!a)return;t=a.cities||a}if(e&&e.list)for(var s=e.list.length>3?3:e.list.length,i=0;s>i;i++){var n=e.list[i],y=this.findCityInfoById(n,t);y&&r.push(y)}return r},getCityCount:function(t){if(!t){var e=p.get();if(!e)return;t=e.cities||e}var r=0;if(t&&t.cities&&t.cities.length>0)for(var a,s=0,i=t.cities.length;i>s;s++)a=t.cities[s],a&&a.tag&&"热门"!=a.tag&&(r+=a.cities.length);return r},findCityInfoById:function(t,e,a){var s,i,n,o,y,u;if(!e){if(s=p.get(),!s)return{CityID:t,name:r[t]||a,cGroups:""};e=s.cities||s}for(i=0,u=e.length;u>i;i++)if(y=e[i],"热门"==y.tag&&y.cities)for(n in y.cities)if(o=y.cities[n],o.id==t)return o;for(i=0,u=e.length;u>i;i++)if(y=e[i],"热门"!=y.tag&&y.cities)for(n in y.cities)if(o=y.cities[n],o.id==t)return o;return!1},setCurrentCity:function(t){if(t){var e=u.get();if(e&&e.gps){var r=t.CityID||t,a=this.findCityInfoById(r);if(a)return e.gps.CityId=t.CityID,e.gps.CityName=a.name,e.gps.Groups=a.cGroups,u.setAttr("gps",e.gps),!0;t.CityID&&t.CityName&&(e.gps.CityId=t.CityID,e.gps.CityName=t.CityName,e.gps.Groups=0,u.setAttr("gps",e.gps))}}return!1},getCurrentCity:function(){var t=u.get();return t&&t.gps&&+t.gps.CityId>0?t.gps:!1},addHistoryKeyWord:function(t,e,r){var s,n=l.get(),o=i.getAttr("type"),y=[],p=0;n&&n.list&&$.isArray(n.list)&&(y=n.list),$.each(y,function(e,r){return r.id!=t?!0:(s=r,p=e,!1)}),s&&s.id==t?(y.splice(p,1),y.unshift({id:t,word:e,type:r})):(y.unshift({id:t,word:e,type:r}),y.length>a.MAX_KEYWORDS_HISTORY&&y.pop()),l.remove(),l.setAttr("list",y),this.setCurrentKeyWord({id:t,word:e,type:r}),(0>o||"5"==o)&&i.remove(),"4"==o&&"location"==r&&i.remove()},getHistoryKeyWord:function(){var t=l.get(),e=[];return t&&t.list&&(e=t.list),e},setCurrentKeyWord:function(t){l.setAttr("key",t)},removeCurrentKeyWord:function(){l.removeAttr("key")},getCurrentKeyWord:function(){var t=l.get();return t?t.key:!1},getGroupQueryParam:function(){var t=[],e=c.get(),r=i.get(),a=e&&e.price&&e.price.val;a&&t.push({type:1,value:a});var s=e&&e.star;if(s&&!$.isEmptyObject(s)){var y,p=[];for(y in s)p.push(y);t.push({type:2,value:p.join(",")})}var l=e&&e.brand&&e.brand.val;l&&t.push({type:3,value:l});var v=e&&e.trait&&e.trait.val;v&&t.push({type:14,value:v});var d=u.get()&&u.get().gps,g=e&&e.distance&&e.distance.val;o.getAttr("nearby")&&d?t.push({type:9,value:d.lat+"|"+d.lng+(g?"|"+g:"")}):g&&t.push({type:9,value:g});var A=e&&e.day&&e.day.val;A&&t.push({type:14,value:A});var f=e&&e.multiShop;1==f&&t.push({type:14,value:"102|10201"});var m=e&&e.voucher;1==m&&t.push({type:14,value:"102|10202"});var h=n.get();h&&h.subVal&&t.push({type:14,value:h.subVal}),r=r?r:{type:"",val:""},r&&r.type&&+r.type>0&&r.val&&""!==r.val&&t.push({type:r.type,name:r.name,value:r.val});var C=this.getCurrentKeyWord();return C&&t.push({type:7,value:C.word}),t},saveQueryString:function(t){var e=Lizard.P,i=e("ctype"),y=e("tuantype"),p=e("price"),l=e("star"),v=e("kwd"),d=e("place"),g=e("lat"),A=e("lng")||e("lon"),f=e("cityid"),m=e("cityname"),h=e("sort");if(f&&f!=s.getAttr("ctyId")&&(this.clearAll(),o.remove()),f&&(s.setAttr("ctyId",f),m=m||r[f]||"",s.setAttr("ctyName",m)),g&&+g>0&&A&&+A>0&&d&&""!==d){u.setAttr("gps",{address:d,location:A+","+g,city:m,lng:+A,lat:+g}),o.setAttr("nearby",!0),f&&(this.setCurrentCity({CityID:f}),this.addHistoryCity(f,m));for(var C=s.getAttr("qparams")||[],I=0,b=C.length;b>I;I++)if(9==C[I].type){C.splice(I,1);break}C.push({type:9,value:g+"|"+A+"|"+a.SEARCH_DISTANCE}),s.setAttr("qparams",C)}if(y||i){var T=y||a.index2ctype[i],S=a.groupType[T];n.remove(),n.setAttr("tuanType",T),n.setAttr("category",S.category),n.setAttr("name",S.name),n.setAttr("tuanTypeIndex",S.index),s.setAttr("ctype",T)}if(l&&1==i&&c.setAttr("star",l.replace(",","|")),p&&c.setAttr("price",p),v&&(v=v.split("|"),this.addHistoryKeyWord(v[1],v[0],v[2])),h){var k=h.indexOf("/")>-1?"/":"|";h=h.split(k),s.setAttr("sortRule",h[0]),s.setAttr("sortType",h[1]||1)}t&&t()},getCityIdByName:function(t){var e;return t&&(e=r[t]),!1},saveHotWordParam:function(t){var e=s.get();if(v.clearAll(),o.removeAttr("nearby"),t.pos){var r=t.pos.type,y=t.pos.val,p=t.pos.lat,u=t.pos.lon,l=t.pos.name;i.set({type:r,val:y,name:l,pos:{type:3,lat:p,lon:u,name:l}})}if(t.price&&a.priceText[t.price]&&c.setAttr("price",{val:t.price,txt:a.priceText[t.price]}),t.trait&&a.traitText[t.trait]&&c.setAttr("trait",{val:t.trait,txt:a.traitText[t.trait]}),t.star){var d=t.star.split(","),g={};for(var A in d)A=d[A],a.starText[A]&&(g[A]=a.starText[A]);g&&c.setAttr("star",g)}if(t.brand&&t.brand.length>0)for(var f in t.brand)f=t.brand[f],f&&f.val&&f.key&&c.setAttr("brand",{flag:1,val:f.val,txt:f.key});if(t.markland&&v.setCurrentKeyWord({id:t.markland.id,word:t.markland.name,type:"markland"}),t.hotel&&v.setCurrentKeyWord({id:t.hotel.id,word:t.hotel.name,type:"hotelid"}),t.keyword&&v.setCurrentKeyWord({word:t.word}),t.activity&&v.setCurrentKeyWord({id:t.activity.id,word:t.activity.name,type:"activity"}),t.district&&v.setCurrentKeyWord({id:t.district.id,word:t.district.name,type:"district"}),t.isweekend&&s.setAttr("weekendsAvailable",t.isweekend),t.multishop&&c.setAttr("multiShop",t.multishop),t.voucher&&c.setAttr("voucher",t.voucher),t.sort&&(s.setAttr("sortRule",t.sort.stype),s.setAttr("sortType",t.sort.sval)),t.classty){var m,h,C,I;t.classty.parent?(m=t.classty.parent.val,h=a.groupType[m],C=t.classty.val,I=t.word):(m=t.classty.val,h=a.groupType[m]),n.setAttr("tuanType",m),h&&(n.setAttr("category",h.category),n.setAttr("name",h.name),n.setAttr("tuanTypeIndex",h.index)),n.setAttr("subVal",C),n.setAttr("subName",I),s.setAttr("ctype",m)}var b=v.getGroupQueryParam();s.setAttr("qparams",b),s.setAttr("ctyId",e.ctyId),s.setAttr("ctyName",e.ctyName)},parseHotkeyJson:function(t){var e=s.get(),r=+e.ctype,a=1===r;s.setAttr("pageIdx","1"),s.setAttr("sortRule",t.sortRule),s.setAttr("sortType",t.sortType),t.pos&&t.ctyId===e.ctyId&&s.setAttr("pos",t.pos);for(var o,y=0,p=t.qparams.length;p>y;y++)switch(o=t.qparams[y],o.type){case 1:c.setAttr("price",o.value);break;case 2:a&&c.setAttr("star",o.value);break;case 3:a&&c.setAttr("brand",o.value);break;case 4:case 5:case 19:t.ctyId===e.ctyId&&i.set({type:o.type,name:o.name,val:o.value});break;case 9:this.isNearBy()&&c.setAttr("distance",o.value);break;case 14:var u=o.value.split("|"),l=u[0];"102"===l?a&&("10201"==u[1]?c.setAttr("multishop",1):"10202"==u[1]&&c.setAttr("voucher",1)):"101"===l?a&&n.getAttr("subVal",o.value):"103"===l?a&&c.setAttr("trait",o.value):"701"===l&&7===r&&c.setAttr("day",o.value)}var v=this.getGroupQueryParam();s.setAttr("qparams",v)}};return v});