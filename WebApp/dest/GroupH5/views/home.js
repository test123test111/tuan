define(["TuanApp","c","cUIAlert","TuanBaseView","cCommonPageFactory","StoreManage","StringsData","cHybridFacade","cWidgetGuider","cUtility","cGeoService","cWidgetFactory","TuanStore","TuanModel","LazyLoad","text!HomeTpl","cWidgetGeolocation"],function(t,e,a,i,r,n,c,o,s,l,d,h,u,y,g,p){var m,f,C=l.isInApp(),w=y.TuanHotListModel.getInstance(),b=u.GroupSearchStore.getInstance(),v=u.GroupCategoryFilterStore.getInstance(),k=u.GroupCustomFilters.getInstance(),I=u.TuanHistoryCityListStore.getInstance(),A=u.GroupGeolocation.getInstance(),S=u.TuanPositionStore.getInstance(),L=y.TuanLocalCityInfo.getInstance(),N=(u.TuanHistoryKeySearchStore.getInstance(),y.BannerSearch.getInstance()),T=y.BannerClassModel.getInstance(),P=h.create("Guider"),x=_.template('<%_.each(ads, function(ad){%><li data-id="<%=ad.toUrl%>"><a href="javascript:;"><img src="<%=ad.imgUrl%>" /></a></li><%})%>'),G="TUAN_IGNORE_CITY_CHANGE",H="http://m.ctrip.com/m/c312",F="55559355",B="",D=d.GeoLocation,E=r.create("TuanBaseView");return m=E.extend({pageid:"214019",hpageid:"215019",hasAd:!0,locating:!1,geoCallback:{status:0,type:0,cancelNearby:0},events:{"click .pro_list>li[data-id]":"detailHandler","click .list_s>.list_s_input":"showKeywordSearch","click .js_qr_link>li":"goListByType","click .base_btn01":"goList","click #J_allTuan":"goList","click .ad_link>li":"onBannerClick","click #js_reload":"getGroupListData"},onCreate:function(){var e=this.$el;this.listWrap=e.find("#J_hotSaleWrap"),this.itemRenderFn=_.template(p),C&&(e.find("#J_searchBoxWrap").addClass("hybrid"),t.initVoiceSearch&&t.initVoiceSearch(e.find("#J_voiceTrigger")))},isNearBy:function(){return b.getAttr("nearby")||I.getAttr("nearby")},setHeader:function(e){var a=this,i=e+"团购";this.setTitle("携程旅行网触屏版-酒店团购"),this.header.set({customtitle:'<h1 id="J_headerTitle"><div id="J_cityBtn" class="list_hd_button"><em class="header_mutrow">'+i+'</em><i class="i_tri"></i></div></h1>',citybtn:i,back:!0,view:this,tel:null,home:!0,events:{returnHandler:function(){C?t.backToLastPage():t.tHome()},homeHandler:$.proxy(a.homeHandler,a),citybtnHandler:function(){a.showCityPage()}}}),this.header.show(),!C&&this.header.root.find("#J_cityBtn").on("click",$.proxy(a.showCityPage,this))},onShow:function(){this.LazyLoad=new g({wrap:this.$el})},onHide:function(){D.UnSubscribe("tuan/home"),w.abort(),this.alert.hide(),this.listWrap.html(B),this.LazyLoad.unbindEvents(),this.hideLoading()},getCityFromAppCached:function(t){if(!C)return void t();window.app.callback=function(e){if("get_cached_ctrip_city"==e.tagname)if(e.param){var a=e.param.CityEntities[0];t({id:a.CityID,name:a.CityName})}else t()};try{CtripMap.app_get_cached_ctrip_city()}catch(e){t()}},onLoad:function(t){this.tplLoading=Lizard.T("J_Loading"),this.tplReload=Lizard.T("J_Reload"),this.tplNoproduct=Lizard.T("J_NoGroupProduct"),this.listWrap.html(this.tplLoading),t=this.getLastViewName();var e=this;+b.getAttr("ctyId")<=0&&(b.setAttr("ctyId",c.defaultCity.id),b.setAttr("ctyName",c.defaultCity.name));var a=b.get(),i=a.ctyId||c.defaultCity.id,r=a.ctyName||c.defaultCity.name;e.setHeader(r||e.isNearBy()&&"我附近的"||c.defaultCity.name),e.getBannerSearch(i);try{e.getGroupListData()}catch(n){}var s="citylist"==t||"detail"==t||"list"==t||"keywordsearch"==t||1==sessionStorage.getItem(G);s||(e.geoCallback.type=0,e.locateInterface()),C&&o.request({name:o.METHOD_SET_NAVBAR_HIDDEN,isNeedHidden:!1}),e.updateAdInfo()},getSelectedCity:function(){return{id:b.getAttr("ctyId")||c.defaultCity.id,name:b.getAttr("ctyName")||c.defaultCity.name}},goNearbyGroup:function(t,e){var a=b.get();if(n.clearAll(),e)if("nearby"==e)k.setAttr("distance",{val:c.SEARCH_DISTANCE,txt:c.SEARCH_DISTANCE_TEXT});else{var i=this.$el.find('.js_qr_link li[data-category="'+e+'"]');index=i.attr("data-id"),tuanType=i.attr("data-type"),b.setAttr("ctype",tuanType),b.setAttr("ctyId",a.ctyId),b.setAttr("ctyName",a.ctyName),v.setAttr("tuanType",tuanType),v.setAttr("category",i.attr("data-category")),v.setAttr("name",i.attr("data-name")),v.setAttr("tuanTypeIndex",+index>0?+index:0)}I.setAttr("nearby",!0),qparams=n.getGroupQueryParam(),b.setAttr("qparams",qparams),this.forwardJump("list","/webapp/tuan/list")},getGroupListData:function(){this.listWrap.html(this.tplLoading);var e=b.get(),a=(A.getAttr("gps"),this),i={};i.ctyId=e.ctyId,i.environment=t.environment,w.abort(),w.setParam(i),w.excute(function(t){var e=t;this.isLoading=!1,t&&t.products&&t.count&&+t.count>0?a.renderList(e):this.listWrap.html(this.tplNoproduct)},function(){this.listWrap.html(this.tplReload)},!0,this)},renderList:function(t){var e=this.itemRenderFn(t);t.count&&+t.count>0&&(this.listWrap.html(e),this.LazyLoad&&this.LazyLoad.updateDom())},detailHandler:function(t){var e=$(t.currentTarget).attr("data-id"),a=b.getAttr("ctyId");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(a?"?cityid="+a:""))},homeHandler:function(){t.tHome()},goList:function(e){var a,i,r,c,o=b.get();b.setAttr("from_feature",0),n.clearAll(),I.removeAttr("nearby"),e&&(c=this.$el.find('.js_qr_link li[data-category="'+e+'"]'),r=c.attr("data-id"),i=c.attr("data-type"),"onepaygroup"!=e&&(b.setAttr("ctype",i),v.setAttr("tuanType",i),v.setAttr("category",c.attr("data-category")),v.setAttr("name",c.attr("data-name")),v.setAttr("tuanTypeIndex",+r>0?+r:0)),"onepaygroup"==e&&(k.setAttr("price.val","1|1"),k.setAttr("price.txt","一元团购")),"weeknew"==e&&(b.setAttr("sortRule","1"),b.setAttr("sortType","1"))),a=n.getGroupQueryParam(),b.setAttr("qparams",a),b.setAttr("ctyId",o.ctyId),b.setAttr("ctyName",o.ctyName);var s=this;return"feature"===e?void this.getBannerClass(function(e){var a=e[o.ctyId];a?t.jumpToPage(a,s):s.forwardJump("localfeature","/webapp/tuan/localfeature")},function(){s.forwardJump("localfeature","/webapp/tuan/localfeature")}):void this.forwardJump("list","/webapp/tuan/list")},goListByType:function(e){var a=this,i=$(e.currentTarget);i.attr("data-category")||(i=i.parent("li"));var r=i.attr("data-category");if("hotel"==r||"catering"==r||"ticket"==r||"entertainment"==r||"nearby"==r)this.geoCallback.type=r,this.geoCallback.cancelNearby=0,this.showLoading(),this.locateInterface();else if("redenvelope"==r){var n="http://"+(t.isProduction?"pages.ctrip.com":"pages.dev.sh.ctriptravel.com");t.jumpToPage(n+"/commerce/promote/201411/hotel/hbh5/packet.html?t="+ +new Date,a)}else this.goList(r)},showCityPage:function(){this.forwardJump("citylist","/webapp/tuan/citylist")},showKeywordSearch:function(){var t=b.get();n.clearAll();var e=n.getGroupQueryParam();b.setAttr("qparams",e),b.setAttr("ctyId",t.ctyId),b.setAttr("ctyName",t.ctyName),this.forwardJump("keywordsearch","/webapp/tuan/keywordsearch")},onBannerClick:function(e){var a=$(e.currentTarget),i=a.attr("data-id");i&&t.jumpToPage(i,this)},getBannerSearch:function(t){N.setParam("cid",t),N.excute(function(t){var e=this.$el.find(".ad_link"),a=t&&t.banners;!a||2!=a.length&&4!=a.length?(e.hide(),e.html("")):(e.html(x({ads:a})),e.show())},function(){},!0,this)},updateAdInfo:function(){var t=this.footer,e=t&&t.rootBox,a=e&&e.find("#dl_app");a&&a.length&&(a.attr("data-appurl","ctrip://wireless?v=2&extendSourceID="+F),e.find("#app_link").attr("href",H))},locateInterface:function(){this.geoCallback.cancelNearby=0,this.checkPositionCache()||this.checkNetwork(this.getPosition)},checkPositionCache:function(){var t=!1,e=S.get();if(e&&e.cityId&&e.cityName){var a={cityId:e.cityId,cityName:e.cityName,hasGroupProduct:e.hasGroupProduct};this.geoCallback.status=1,this.locatedCallback(a),t=!0}return t},checkNetwork:function(t){var e=this;C?P.app_check_network_status({callback:function(i){var r=i&&i.hasNetwork;if(!r){var n=new a({title:"提示",message:"未连接到互联网，请检查网络设置<br/>您也可以拨打携程客服电话咨询",buttons:[{text:"知道了",click:function(){this.hide()}},{text:"拨打电话",click:function(){P.callService(),this.hide()}}]});return void n.show()}t&&t.call(e)}}):t&&t.call(e)},getPosition:function(){var t=this;1==this.geoCallback.type&&(this.geoCallback.cancelNearby=0,f=new e.ui.LoadingLayer(function(){t.geoCallback.cancelNearby=1,this.hide()},"定位中..."),f.show()),1!=this.locating&&(this.locating=!0,D.Subscribe("tuan/home",{onComplete:function(e){this.locating=!1,e.city=e.city.replace("市市","市"),e.city.length>2&&(e.city=e.city.replace("市","")),S.set(e),A.setAttr("gps",e);var a={lng:e.lng,lat:e.lat,district:e.district,city:e.city,province:e.province,isOverseas:"中国"!=e.country};"nearby"==t.geoCallback.type?(t.geoCallback.status=1,t.locatedCallback(a)):t.getCityInfo(a,t.locatedCallback)},onError:this.geoError,onPosComplete:function(){},onPosError:this.geoError},this,!0))},geoError:function(){var t=this.geoCallback.type;if(t&&("hotel"==t||"catering"==t||"ticket"==t||"entertainment"==t))return void this.goList(t);this.locating=!1;var e=this;S.set(null),f&&f.hide();var i=new a({title:"提示",message:"无法获取您的城市，您可以选择其他城市",buttons:[{text:"取消",click:function(){e.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){e.recordSwitchCityFlag(),e.showCityPage(),this.hide()}}]});i.show(),this.hideLoading()},getCityInfo:function(t,e){var a=this;L.setParam({lng:t.lng,lat:t.lat,district:encodeURIComponent(t.district),cityname:encodeURIComponent(t.city),province:encodeURIComponent(t.province),isOverseas:t.isOverseas}),L.excute(function(t){a.locating=!1;var i;t&&t.CityID&&t.CityID>0&&(n.setCurrentCity(t),i={cityId:t.CityID,cityName:t.CityName,hasGroupProduct:t.HasGroupProduct},S.setAttr("cityId",t.CityID),S.setAttr("cityName",t.CityName),S.setAttr("hasGroupProduct",t.HasGroupProduct)),a.geoCallback.status=1,"function"==typeof e&&e.call(a,i)},function(){a.geoCallback.status=0,"function"==typeof e&&e.call(a)},!1,this)},getCityFailed:function(){var t=this;t.locating=!1,S.setAttr("cityId",null),S.setAttr("cityName",null);var e=new a({title:"提示",message:"无法获取您的城市，您可以选择其他城市",buttons:[{text:"取消",click:function(){t.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){t.showCityPage(),t.recordSwitchCityFlag(),this.hide()}}]});e.show()},promptSwitchCity:function(t){var e,i=this,r=i.getSelectedCity();1!=sessionStorage.getItem(G)&&(t&&t.cityId&&t.cityName?(1!=sessionStorage.getItem(G)&&r.id>0&&r.id!=t.cityId&&(t.hasGroupProduct?(e=new a({title:"提示",message:"目前您的定位在"+t.cityName+"，是否切换?",buttons:[{text:"取消",click:function(){i.recordSwitchCityFlag(),this.hide()}},{text:"切换",click:function(){i.recordSwitchCityFlag();var e=t.cityId;b.setAttr("ctyId",e),b.setAttr("ctyName",t.cityName),i.setHeader(t.cityName),i.getGroupListData(),i.getBannerSearch(e),this.hide()}}]}),e.show()):(e=new a({title:"提示",message:"您所在的城市暂无团购产品<br/>您可以选择其他城市",buttons:[{text:"取消",click:function(){i.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){i.recordSwitchCityFlag(),i.showCityPage(),this.hide()}}]}),e.show())),r.id!=t.cityId&&i.recordSwitchCityFlag()):(e=new a({title:"提示",message:"无法获取您的城市，您可以选择其他城市",buttons:[{text:"取消",click:function(){i.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){i.recordSwitchCityFlag(),i.showCityPage(),this.hide()}}]}),e.show()))},recordSwitchCityFlag:function(){sessionStorage.setItem(G,1)},locatedCallback:function(t){var e=this.geoCallback.type,a=this.geoCallback.status,i=this.geoCallback.cancelNearby,r=this;if(0==e)1==a?r.promptSwitchCity(t):0==a&&r.getCityFailed();else{if(i)return;f&&f.hide(),1==a?"nearby"==e?r.goNearbyGroup(t,e):t.cityId==b.getAttr("ctyId")?r.goNearbyGroup(t,e):r.goList(e):0==a&&("nearby"==e?r.getCityFailed():r.goList(e))}},getBannerClass:function(t,e){this.showLoading(),T.excute(function(e){this.hideLoading();var a={};_.each(_.filter(e.Banner||[],function(t){return 14===t.type}),function(t){return a[t.cityid]=$.trim(t.url)}),t&&t(a)},function(){this.hideLoading(),e&&e()},!1,this,function(){this.hideLoading()})}})});