define(["TuanApp","c","cUIAlert","TuanBaseView","cCommonPageFactory","StoreManage","StringsData","cHybridFacade","cHybridShell","cWidgetGuider","cUtility","cGeoService","cWidgetFactory","TuanStore","TuanModel","LazyLoad","text!HomeTpl","cWidgetGeolocation","bridge"],function(t,e,i,a,r,n,c,o,s,l,d,h,u,y,g,p,m){var f,C,w=d.isInApp(),b=g.TuanHotListModel.getInstance(),v=y.GroupSearchStore.getInstance(),k=y.GroupCategoryFilterStore.getInstance(),I=y.GroupCustomFilters.getInstance(),A=y.TuanHistoryCityListStore.getInstance(),L=y.GroupGeolocation.getInstance(),N=y.TuanPositionStore.getInstance(),S=g.TuanLocalCityInfo.getInstance(),T=g.BannerSearch.getInstance(),P=g.BannerClassModel.getInstance(),x=u.create("Guider"),G=_.template('<%_.each(ads, function(ad){%><li data-id="<%=ad.toUrl%>"><a href="javascript:;"><img src="<%=ad.imgUrl%>" /></a></li><%})%>'),H="TUAN_IGNORE_CITY_CHANGE",F="http://m.ctrip.com/m/c312",B="55559355",D="",E="携程旅行网触屏版-酒店团购",J="我的附近",R=h.GeoLocation,W=r.create("TuanBaseView");return f=W.extend({pageid:"214019",hpageid:"215019",hasAd:!0,locating:!1,geoCallback:{status:0,type:0,cancelNearby:0},events:{"click .pro_list>li[data-id]":"detailHandler","click .list_s>.list_s_input":"showKeywordSearch","click .js_qr_link>li":"goListByType","click .base_btn01":"goList","click #J_allTuan":"goList","click .ad_link>li":"onBannerClick","click #js_reload":"getGroupListData"},onCreate:function(){var e=this.$el;this.listWrap=e.find("#J_hotSaleWrap"),this.itemRenderFn=_.template(m),w&&(e.find("#J_searchBoxWrap").addClass("hybrid"),t.initVoiceSearch&&t.initVoiceSearch(e.find("#J_voiceTrigger")))},isNearBy:function(){return v.getAttr("nearby")||A.getAttr("nearby")},setHeader:function(e){var i=this,a=e+"团购";this.setTitle(E),this.header.set({customtitle:'<h1 id="J_headerTitle"><div id="J_cityBtn" class="list_hd_button"><em class="header_mutrow">'+a+'</em><i class="i_tri"></i></div></h1>',citybtn:a,back:!0,view:this,tel:null,home:!0,events:{returnHandler:function(){w?t.backToLastPage():t.tHome()},homeHandler:$.proxy(i.homeHandler,i),citybtnHandler:function(){i.showCityPage()}}}),this.header.show(),!w&&this.header.root.find("#J_cityBtn").on("click",$.proxy(i.showCityPage,this))},onShow:function(){this.LazyLoad=new p({wrap:this.$el})},onHide:function(){R.UnSubscribe("tuan/home"),b.abort(),this.alert.hide(),this.listWrap.html(D),this.LazyLoad.unbindEvents(),this.hideLoading()},getCityFromAppCached:function(t){return w?void s.Fn("get_cached_ctrip_city",function(e){var i;e?(i=e.CityEntities[0],t({id:i.CityID,name:i.CityName})):t()}).run():void t()},onLoad:function(t){this.tplLoading=Lizard.T("J_Loading"),this.tplReload=Lizard.T("J_Reload"),this.tplNoproduct=Lizard.T("J_NoGroupProduct"),this.listWrap.html(this.tplLoading),t=this.getLastViewName();var e=this;this.getCityFromAppCached(function(i){i&&(c.defaultCity=i);var a=c.defaultCity,r=v.get(),n=r.ctyId||a.id,s=r.ctyName||a.name,l="citylist"==t||"detail"==t||"list"==t||"keywordsearch"==t||1==sessionStorage.getItem(H);+v.getAttr("ctyId")<=0&&(v.setAttr("ctyId",a.id),v.setAttr("ctyName",a.name)),e.setHeader(e.isNearBy()?J:s),e.getBannerSearch(n);try{e.getGroupListData()}catch(d){}l||(e.geoCallback.type=0,e.locateInterface()),w&&o.request({name:o.METHOD_SET_NAVBAR_HIDDEN,isNeedHidden:!1}),e.updateAdInfo()})},getSelectedCity:function(){return{id:v.getAttr("ctyId")||c.defaultCity.id,name:v.getAttr("ctyName")||c.defaultCity.name}},goNearbyGroup:function(t,e){var i=v.get();if(n.clearAll(),e)if("nearby"==e)I.setAttr("distance",{val:c.SEARCH_DISTANCE,txt:c.SEARCH_DISTANCE_TEXT});else{var a=this.$el.find('.js_qr_link li[data-category="'+e+'"]');index=a.attr("data-id"),tuanType=a.attr("data-type"),v.setAttr("ctype",tuanType),v.setAttr("ctyId",i.ctyId),v.setAttr("ctyName",i.ctyName),k.setAttr("tuanType",tuanType),k.setAttr("category",a.attr("data-category")),k.setAttr("name",a.attr("data-name")),k.setAttr("tuanTypeIndex",+index>0?+index:0)}A.setAttr("nearby",!0),qparams=n.getGroupQueryParam(),v.setAttr("qparams",qparams),this.forwardJump("list","/webapp/tuan/list")},getGroupListData:function(){this.listWrap.html(this.tplLoading);var e=v.get(),i=(L.getAttr("gps"),this),a={};a.ctyId=e.ctyId,a.environment=t.environment,b.abort(),b.setParam(a),b.excute(function(t){var e=t;this.isLoading=!1,t&&t.products&&t.count&&+t.count>0?i.renderList(e):this.listWrap.html(this.tplNoproduct)},function(){this.listWrap.html(this.tplReload)},!0,this)},renderList:function(t){var e=this.itemRenderFn(t);t.count&&+t.count>0&&(this.listWrap.html(e),this.LazyLoad&&this.LazyLoad.updateDom())},detailHandler:function(t){var e=$(t.currentTarget).attr("data-id"),i=v.getAttr("ctyId");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(i?"?cityid="+i:""))},homeHandler:function(){t.tHome()},goList:function(e){var i,a,r,c,o=v.get();v.setAttr("from_feature",0),n.clearAll(),A.removeAttr("nearby"),e&&(c=this.$el.find('.js_qr_link li[data-category="'+e+'"]'),r=c.attr("data-id"),a=c.attr("data-type"),"onepaygroup"!=e&&(v.setAttr("ctype",a),k.setAttr("tuanType",a),k.setAttr("category",c.attr("data-category")),k.setAttr("name",c.attr("data-name")),k.setAttr("tuanTypeIndex",+r>0?+r:0)),"onepaygroup"==e&&(I.setAttr("price.val","1|1"),I.setAttr("price.txt","一元团购")),"weeknew"==e&&(v.setAttr("sortRule","1"),v.setAttr("sortType","1"))),i=n.getGroupQueryParam(),v.setAttr("qparams",i),v.setAttr("ctyId",o.ctyId),v.setAttr("ctyName",o.ctyName);var s=this;return"feature"===e?void this.getBannerClass(function(e){var i=e[o.ctyId];i?t.jumpToPage(i,s):s.forwardJump("localfeature","/webapp/tuan/localfeature")},function(){s.forwardJump("localfeature","/webapp/tuan/localfeature")}):void this.forwardJump("list","/webapp/tuan/list")},goListByType:function(e){var i=this,a=$(e.currentTarget);a.attr("data-category")||(a=a.parent("li"));var r=a.attr("data-category");if("hotel"==r||"catering"==r||"ticket"==r||"entertainment"==r||"nearby"==r)this.geoCallback.type=r,this.geoCallback.cancelNearby=0,this.showLoading(),this.locateInterface();else if("redenvelope"==r){var n="http://"+(t.isProduction?"pages.ctrip.com":"pages.dev.sh.ctriptravel.com");t.jumpToPage(n+"/commerce/promote/201411/hotel/hbh5/packet.html?t="+ +new Date,i)}else this.goList(r)},showCityPage:function(){this.forwardJump("citylist","/webapp/tuan/citylist")},showKeywordSearch:function(){var t=v.get();n.clearAll();var e=n.getGroupQueryParam();v.setAttr("qparams",e),v.setAttr("ctyId",t.ctyId),v.setAttr("ctyName",t.ctyName),this.forwardJump("keywordsearch","/webapp/tuan/keywordsearch")},onBannerClick:function(e){var i=$(e.currentTarget),a=i.attr("data-id");a&&t.jumpToPage(a,this)},getBannerSearch:function(t){T.setParam("cid",t),T.excute(function(t){var e=this.$el.find(".ad_link"),i=t&&t.banners;!i||2!=i.length&&4!=i.length?(e.hide(),e.html("")):(e.html(G({ads:i})),e.show())},function(){},!0,this)},updateAdInfo:function(){var t=this.footer,e=t&&t.rootBox,i=e&&e.find("#dl_app");i&&i.length&&(i.attr("data-appurl","ctrip://wireless?v=2&extendSourceID="+B),e.find("#app_link").attr("href",F))},locateInterface:function(){this.geoCallback.cancelNearby=0,this.checkPositionCache()||this.checkNetwork(this.getPosition)},checkPositionCache:function(){var t=!1,e=N.get();if(e&&e.cityId&&e.cityName){var i={cityId:e.cityId,cityName:e.cityName,hasGroupProduct:e.hasGroupProduct};this.geoCallback.status=1,this.locatedCallback(i),t=!0}return t},checkNetwork:function(t){var e=this;w?x.app_check_network_status({callback:function(a){var r=a&&a.hasNetwork;if(!r){var n=new i({title:"提示",message:"未连接到互联网，请检查网络设置<br/>您也可以拨打携程客服电话咨询",buttons:[{text:"知道了",click:function(){this.hide()}},{text:"拨打电话",click:function(){x.callService(),this.hide()}}]});return void n.show()}t&&t.call(e)}}):t&&t.call(e)},getPosition:function(){var t=this;1==this.geoCallback.type&&(this.geoCallback.cancelNearby=0,C=new e.ui.LoadingLayer(function(){t.geoCallback.cancelNearby=1,this.hide()},"定位中..."),C.show()),1!=this.locating&&(this.locating=!0,R.Subscribe("tuan/home",{onComplete:function(e){this.locating=!1,e.city=e.city.replace("市市","市"),e.city.length>2&&(e.city=e.city.replace("市","")),N.set(e),L.setAttr("gps",e);var i={lng:e.lng,lat:e.lat,district:e.district,city:e.city,province:e.province,isOverseas:"中国"!=e.country};"nearby"==t.geoCallback.type?(t.geoCallback.status=1,t.locatedCallback(i)):t.getCityInfo(i,t.locatedCallback)},onError:this.geoError,onPosComplete:function(){},onPosError:this.geoError},this,!0))},geoError:function(){var t=this.geoCallback.type;if(t&&("hotel"==t||"catering"==t||"ticket"==t||"entertainment"==t))return void this.goList(t);this.locating=!1;var e=this;N.set(null),C&&C.hide();var a=new i({title:"提示",message:"无法获取您的城市，您可以选择其他城市",buttons:[{text:"取消",click:function(){e.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){e.recordSwitchCityFlag(),e.showCityPage(),this.hide()}}]});a.show(),this.hideLoading()},getCityInfo:function(t,e){var i=this;S.setParam({lng:t.lng,lat:t.lat,district:encodeURIComponent(t.district),cityname:encodeURIComponent(t.city),province:encodeURIComponent(t.province),isOverseas:t.isOverseas}),S.excute(function(t){i.locating=!1;var a;t&&t.CityID&&t.CityID>0&&(n.setCurrentCity(t),a={cityId:t.CityID,cityName:t.CityName,hasGroupProduct:t.HasGroupProduct},N.setAttr("cityId",t.CityID),N.setAttr("cityName",t.CityName),N.setAttr("hasGroupProduct",t.HasGroupProduct)),i.geoCallback.status=1,"function"==typeof e&&e.call(i,a)},function(){i.geoCallback.status=0,"function"==typeof e&&e.call(i)},!1,this)},getCityFailed:function(){var t=this;t.locating=!1,N.setAttr("cityId",null),N.setAttr("cityName",null);var e=new i({title:"提示",message:"无法获取您的城市，您可以选择其他城市",buttons:[{text:"取消",click:function(){t.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){t.showCityPage(),t.recordSwitchCityFlag(),this.hide()}}]});e.show()},promptSwitchCity:function(t){var e,a=this,r=a.getSelectedCity();1!=sessionStorage.getItem(H)&&(t&&t.cityId&&t.cityName?(1!=sessionStorage.getItem(H)&&r.id>0&&r.id!=t.cityId&&(t.hasGroupProduct?(e=new i({title:"提示",message:"目前您的定位在"+t.cityName+"，是否切换?",buttons:[{text:"取消",click:function(){a.recordSwitchCityFlag(),this.hide()}},{text:"切换",click:function(){a.recordSwitchCityFlag();var e=t.cityId;v.setAttr("ctyId",e),v.setAttr("ctyName",t.cityName),a.setHeader(t.cityName),a.getGroupListData(),a.getBannerSearch(e),this.hide()}}]}),e.show()):(e=new i({title:"提示",message:"您所在的城市暂无团购产品<br/>您可以选择其他城市",buttons:[{text:"取消",click:function(){a.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){a.recordSwitchCityFlag(),a.showCityPage(),this.hide()}}]}),e.show())),r.id!=t.cityId&&a.recordSwitchCityFlag()):(e=new i({title:"提示",message:"无法获取您的城市，您可以选择其他城市",buttons:[{text:"取消",click:function(){a.recordSwitchCityFlag(),this.hide()}},{text:"选择城市",click:function(){a.recordSwitchCityFlag(),a.showCityPage(),this.hide()}}]}),e.show()))},recordSwitchCityFlag:function(){sessionStorage.setItem(H,1)},locatedCallback:function(t){var e=this.geoCallback.type,i=this.geoCallback.status,a=this.geoCallback.cancelNearby,r=this;if(0==e)1==i?r.promptSwitchCity(t):0==i&&r.getCityFailed();else{if(a)return;C&&C.hide(),1==i?"nearby"==e?r.goNearbyGroup(t,e):t.cityId==v.getAttr("ctyId")?r.goNearbyGroup(t,e):r.goList(e):0==i&&("nearby"==e?r.getCityFailed():r.goList(e))}},getBannerClass:function(t,e){this.showLoading(),P.excute(function(e){this.hideLoading();var i={};_.each(_.filter(e.Banner||[],function(t){return 14===t.type}),function(t){return i[t.cityid]=$.trim(t.url)}),t&&t(i)},function(){this.hideLoading(),e&&e()},!1,this,function(){this.hideLoading()})}})});