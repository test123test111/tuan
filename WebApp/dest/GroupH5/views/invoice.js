define(["TuanApp","libs","c","cUIScrollRadio","cUIScrollRadioList","TuanStore","TuanModel","Switch","CommonStore","TuanBaseView","cCommonPageFactory","cWidgetFactory","text!InvoiceTpl"],function(e,i,t,n,s,r,o,l,d,h,c,a,p){var v,g=r.TuanInvoiceStore.getInstance(),u=o.TuanRegionInfoModel.getInstance(),f=r.TuanRegionInfoStore.getInstance(),T={pageTitle:"发票",titleLessTip:"发票抬头不能为空",titleMoreTip:"发票抬头不能超过50个汉字",recipientNullTip:"收件人姓名不能为空",recipientLessTip:"收件人姓名不可少于2个汉字",recipientMoreTip:"收件人姓名不可多于10个汉字",selectRegion:"请选择所在地区",addrLessTip:"请填写详细地址",addrMoreTip:"详细地址不可多于50个汉字",zipLessTip:"邮政编码不能为空",zipIncorrectTip:"请输入正确的邮政编码"},x=[{key:"平信(免费)",tip:"发票在您的团购券使用后10个工作日内以平信方式送达。"},{key:"快递(￥10)",tip:"发票在您的团购券使用后5个工作日内以快递方式送达。"}],y=c.create("TuanBaseView");return v=y.extend({tpl:p,events:{"click #J_region":"showRegion","click #J_delivery":"showDelivery"},onCreate:function(){this.$el.html($.trim(this.tpl)),this.els={needInvoice:this.$el.find("#J_needInvoice"),invoiceWrap:this.$el.find("#J_invoiceWrap"),invoiceTitle:this.$el.find("#J_invoiceTitle"),recipient:this.$el.find("#J_recipient"),region:this.$el.find("#J_region"),regionText:this.$el.find("#J_regionText"),addr:this.$el.find("#J_addr"),zip:this.$el.find("#J_zip"),delivery:this.$el.find("#J_delivery"),deliveryText:this.$el.find("#J_deliveryText"),deliveryTips:this.$el.find("#J_deliveryTips")}},_setPageView:function(){var e=this;this.header.set({title:T.pageTitle,back:!0,view:this,btn:{title:"完成",id:"J_submitOrder",classname:"rightblue"},events:{returnHandler:function(){e.back()},commitHandler:function(){e.saveInvoiceInfo()&&e.back()}}}),this.header.show()},onLoad:function(){var e=g.get();this.setTitle(T.pageTitle),e?(e.needed?(this._needInvoice(),this.invoiceSwitch(!0)):(this._noNeedInvoice(),this.invoiceSwitch(!1)),this.fillValue(e)):(this._noNeedInvoice(),this.invoiceSwitch(!1)),this._setPageView()},onShow:function(){},onHide:function(){},invoiceSwitch:function(e){var i=this;return new l({cursor:this.els.needInvoice,isTurnOn:e,onChange:function(e){try{this.cursor[e?"attr":"removeAttr"]("checked","checked")}catch(t){}e?i._needInvoice():i._noNeedInvoice()}})},fillValue:function(e){var i=e.deliveryMethod?e.deliveryMethod:"0";this.els.invoiceTitle.val(e.title?e.title:""),this.els.recipient.val(e.recipient?e.recipient:""),this.els.region.data("region-index",e.regionIndex?e.regionIndex:"2,2,2"),this.els.regionText.text(e.regionText?e.regionText:""),this.els.addr.val(e.addr?e.addr:""),this.els.zip.val(e.zip?e.zip:""),this.els.delivery.data("delivery-method",i),this.els.deliveryText.text(x[i].key),this.els.deliveryTips.text(x[i].tip)},_noNeedInvoice:function(){this.els.invoiceWrap.hide(),this.els.deliveryTips.hide(),g.remove(),this.fillValue({})},_needInvoice:function(){this.els.invoiceWrap.show(),this.els.deliveryTips.show(),!f.get()&&this.getRegionInfo()},saveInvoiceInfo:function(){var e={needed:this.els.needInvoice[0].checked,title:this.els.invoiceTitle.val().trim(),recipient:this.els.recipient.val().trim(),regionIndex:this.els.region.data("regionIndex"),regionText:this.els.regionText.text(),addr:this.els.addr.val().trim(),zip:this.els.zip.val().trim(),deliveryMethod:this.els.delivery.data("deliveryMethod")};if(e.needed){if(0===e.title.length)return this.showMessage(T.titleLessTip),!1;if(this._length(e.title)>100)return this.showMessage(T.titleMoreTip),!1;if(0===e.recipient.length)return this.showMessage(T.recipientNullTip),!1;if(this._length(e.recipient)<4)return this.showMessage(T.recipientLessTip),!1;if(this._length(e.recipient)>20)return this.showMessage(T.recipientMoreTip),!1;if(0===e.regionText.length)return this.showMessage(T.selectRegion),!1;if(0===e.addr.length)return this.showMessage(T.addrLessTip),!1;if(this._length(e.addr)>100)return this.showMessage(T.addrMoreTip),!1;if(0===e.zip.length)return this.showMessage(T.zipLessTip),!1;if(!/^\d{6}$/.test(e.zip))return this.showMessage(T.zipIncorrectTip),!1;g.set(e)}else g.remove();return!0},_length:function(e){var i=e.match(/[^ -~]/g);return null===i?e.length:e.length+i.length},getRegionInfo:function(e){u.setParam({head:u.getHead().get()}),u.excute(function(i){e&&e(i)},function(){this.showMessage("抱歉，数据加载失败，请重试!")},!1,this)},showRegion:function(){var e=f.get();e?this._displayRegionScroll(e):this.getRegionInfo(this._displayRegionScroll)},_displayRegionScroll:function(e){function i(){}var t=e.provinces,s=[],r=[],o=$("#J_region"),l=$("#J_regionText"),d=o.data("regionIndex").split(",");_.each(e.cities,function(e){e.pid==t[d[0]].pid&&s.push(e)}),_.each(e.zones,function(e){e.cid==s[d[1]].cid&&r.push(e)});var h=function(i){var t=[];_.each(e.zones,function(e){e.cid==i.cid&&t.push(e)}),this.scroll[2].reload(t)},c=function(i){var t=[];_.each(e.cities,function(e){e.pid==i.pid&&t.push(e)}),this.scroll[1].reload(t),h.call(this,t[this.scroll[1].selectedIndex])},a=new n({title:"选择所在地区",data:[t,s,r],index:d,okClick:function(e){var i=e[0],t=e[1],n=e[2],s=i.key+" "+t.key+" "+n.key,r=i.index+","+t.index+","+n.index;l.text(s),o.data("regionIndex",r)},changed:[c,h,i]});a.show(),a.scroll[0].wrapper.find(".cui-flex2").removeClass("cui-flex2")},showDelivery:function(e){var i,n=$(e.currentTarget),s=this.els.deliveryText,r=this.els.deliveryTips,o=n.data("deliveryMethod");i=new t.ui.ScrollRadioList({title:"选择配送方式",index:o,data:x,disItemNum:2,itemClick:function(e){s.html(e.key),r.html(e.tip),n.data("deliveryMethod",e.index)}}),i.show()}})});