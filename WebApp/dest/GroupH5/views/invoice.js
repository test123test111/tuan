define(["TuanApp","libs","c","cUIScrollRadio","cUIScrollRadioList","TuanStore","TuanModel","Switch","CommonStore","TuanBaseView","cCommonPageFactory","cWidgetFactory","text!InvoiceTpl"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=s.TuanInvoiceStore.getInstance(),d=o.TuanRegionInfoModel.getInstance(),v=s.TuanRegionInfoStore.getInstance(),m={pageTitle:"发票",titleLessTip:"发票抬头不能为空",titleMoreTip:"发票抬头不能超过50个汉字",recipientNullTip:"收件人姓名不能为空",recipientLessTip:"收件人姓名不可少于2个汉字",recipientMoreTip:"收件人姓名不可多于10个汉字",selectRegion:"请选择所在地区",addrLessTip:"请填写详细地址",addrMoreTip:"详细地址不可多于50个汉字",zipLessTip:"邮政编码不能为空",zipIncorrectTip:"请输入正确的邮政编码"},g=[{key:"平信(免费)",tip:"发票在您的团购券使用后10个工作日内以平信方式送达。"},{key:"快递(￥10)",tip:"发票在您的团购券使用后5个工作日内以快递方式送达。"}],y=l.create("TuanBaseView"),b=y.extend({tpl:h,events:{"click #J_region":"showRegion","click #J_delivery":"showDelivery"},onCreate:function(){this.$el.html($.trim(this.tpl)),this.els={needInvoice:this.$el.find("#J_needInvoice"),invoiceWrap:this.$el.find("#J_invoiceWrap"),invoiceTitle:this.$el.find("#J_invoiceTitle"),recipient:this.$el.find("#J_recipient"),region:this.$el.find("#J_region"),regionText:this.$el.find("#J_regionText"),addr:this.$el.find("#J_addr"),zip:this.$el.find("#J_zip"),delivery:this.$el.find("#J_delivery"),deliveryText:this.$el.find("#J_deliveryText"),deliveryTips:this.$el.find("#J_deliveryTips")}},_setPageView:function(){var e=this;this.header.set({title:m.pageTitle,back:!0,view:this,btn:{title:"完成",id:"J_submitOrder",classname:"rightblue"},events:{returnHandler:function(){e.back()},commitHandler:function(){e.saveInvoiceInfo()&&e.back()}}}),this.header.show()},onLoad:function(){var e=p.get();this.setTitle(m.pageTitle),e?(e.needed?(this._needInvoice(),this.invoiceSwitch(!0)):(this._noNeedInvoice(),this.invoiceSwitch(!1)),this.fillValue(e)):(this._noNeedInvoice(),this.invoiceSwitch(!1)),this._setPageView()},onShow:function(){},onHide:function(){},invoiceSwitch:function(e){var t=this;new u({cursor:this.els.needInvoice,isTurnOn:e,onChange:function(e){try{this.cursor[e?"attr":"removeAttr"]("checked","checked")}catch(n){}e?t._needInvoice():t._noNeedInvoice()}})},fillValue:function(e){var t=e.deliveryMethod?e.deliveryMethod:"0";this.els.invoiceTitle.val(e.title?e.title:""),this.els.recipient.val(e.recipient?e.recipient:""),this.els.region.data("region-index",e.regionIndex?e.regionIndex:"2,2,2"),this.els.regionText.text(e.regionText?e.regionText:""),this.els.addr.val(e.addr?e.addr:""),this.els.zip.val(e.zip?e.zip:""),this.els.delivery.data("delivery-method",t),this.els.deliveryText.text(g[t].key),this.els.deliveryTips.text(g[t].tip)},_noNeedInvoice:function(){this.els.invoiceWrap.hide(),this.els.deliveryTips.hide(),p.remove(),this.fillValue({})},_needInvoice:function(){this.els.invoiceWrap.show(),this.els.deliveryTips.show(),!v.get()&&this.getRegionInfo()},saveInvoiceInfo:function(){var e={needed:this.els.needInvoice[0].checked,title:this.els.invoiceTitle.val().trim(),recipient:this.els.recipient.val().trim(),regionIndex:this.els.region.data("regionIndex"),regionText:this.els.regionText.text(),addr:this.els.addr.val().trim(),zip:this.els.zip.val().trim(),deliveryMethod:this.els.delivery.data("deliveryMethod")};if(e.needed){if(e.title.length===0)return this.showMessage(m.titleLessTip),!1;if(this._length(e.title)>100)return this.showMessage(m.titleMoreTip),!1;if(e.recipient.length===0)return this.showMessage(m.recipientNullTip),!1;if(this._length(e.recipient)<4)return this.showMessage(m.recipientLessTip),!1;if(this._length(e.recipient)>20)return this.showMessage(m.recipientMoreTip),!1;if(e.regionText.length===0)return this.showMessage(m.selectRegion),!1;if(e.addr.length===0)return this.showMessage(m.addrLessTip),!1;if(this._length(e.addr)>100)return this.showMessage(m.addrMoreTip),!1;if(e.zip.length==0)return this.showMessage(m.zipLessTip),!1;if(!/^\d{6}$/.test(e.zip))return this.showMessage(m.zipIncorrectTip),!1;p.set(e)}else p.remove();return!0},_length:function(e){var t=e.match(/[^ -~]/g);return t==null?e.length:e.length+t.length},getRegionInfo:function(e){d.setParam({head:d.getHead().get()}),d.excute(function(t){e&&e(t)},function(e){this.showMessage("抱歉，数据加载失败，请重试!")},!1,this)},showRegion:function(){var e=v.get();e?this._displayRegionScroll(e):this.getRegionInfo(this._displayRegionScroll)},_displayRegionScroll:function(e){function a(t){var n=0,r=[];_.each(e.cities,function(e,n){e.pid==t.pid&&r.push(e)}),this.scroll[1].reload(r),f.call(this,r[this.scroll[1].selectedIndex])}function f(t){var n=0,r=[];_.each(e.zones,function(e,n){e.cid==t.cid&&r.push(e)}),this.scroll[2].reload(r)}function l(e){}var t=e.provinces,n=[],i=[],s=$("#J_region"),o=$("#J_regionText"),u=s.data("regionIndex").split(",");_.each(e.cities,function(e,r){e.pid==t[u[0]].pid&&n.push(e)}),_.each(e.zones,function(e,t){e.cid==n[u[1]].cid&&i.push(e)});var c=new r({title:"选择所在地区",data:[t,n,i],index:u,okClick:function(e){var t=e[0],n=e[1],r=e[2],i=t.key+" "+n.key+" "+r.key,u=t.index+","+n.index+","+r.index;o.text(i),s.data("regionIndex",u)},changed:[a,f,l]});c.show(),c.scroll[0].wrapper.find(".cui-flex2").removeClass("cui-flex2")},showDelivery:function(e){var t=$(e.currentTarget),r,i=this.els.deliveryText,s=this.els.deliveryTips,o=t.data("deliveryMethod");r=new n.ui.ScrollRadioList({title:"选择配送方式",index:o,data:g,disItemNum:2,itemClick:function(e){i.html(e.key),s.html(e.tip),t.data("deliveryMethod",e.index)}}),r.show()}});return b});