define(["TuanApp","c","TuanBaseView","cCommonPageFactory","cWidgetGuider","MemCache","StringsData","cUtility","cGeoService","cWidgetFactory","cUIToast","TuanStore","TuanModel","TuanFilters","StoreManage","LazyLoad","ScrollObserver","text!ListProductTpl","text!ListBusinessTpl","cWidgetGeolocation"],function(t,e,i,a,s,r,o,n,l,d,c,h,u,p,g,f,y,m,v){var I,w="ani_rotation",P="PAGE_LIST_POSITION",b=e.ui,C=n.isInApp(),A=u.TuanListModel.getInstance(),L=u.TuanHotelListModel.getInstance(),T=h.GroupSortStore.getInstance(),S=u.TuanLocalCityInfo.getInstance(),x=h.GroupSearchStore.getInstance(),k=(h.GroupCategoryFilterStore.getInstance(),h.OrderDetailReturnPage.getInstance()),W=u.TuanCityListModel.getInstance(),G=h.GroupPositionFilterStore.getInstance(),N=h.GroupCustomFilters.getInstance(),J=u.TuanConditionModel.getInstance(),F=(h.GroupConditionStore.getInstance(),h.GroupGeolocation.getInstance()),D=h.TuanPositionStore.getInstance(),B=h.TuanHistoryCityListStore.getInstance(),R=h.GroupGeolocation.getInstance(),H={tuangou:"团购",youAreHere:"您的位置 "},O=d.create("Guider"),M=l.GeoLocation,E=a.create("TuanBaseView");return I=E.extend({pageid:"214001",hpageid:"215001",totalPages:null,isComplete:!1,isLoading:!1,isScrolling:!1,pageSize:25,render:function(){var t=this.$el;this.listWrap=t.find("#J_listWrap"),this.filterWrap=t.find(".J_filtersAndSortPanel"),this.productListTpl=_.template(m),this.businessListTpl=_.template(v),this.gpsInfoWrap=t.find("#J_gpsInfoWrap")},events:{"click li[data-id]":"detailHandler","click #J_reloadGPS":"refreshGeolocation","click #J_keywordSearch":"showKeywordSearch","click .cui-btns-retry":"reloadPage","click .J_showMore":"showMore","click .J_phone":"callPhone","click #J_deleteFilter li":"deleteFilter"},callPhone:function(t){O.apply({hybridCallback:function(){var e="data-phone",i=$(t.target);return i.attr(e)||(i=i.find("["+e+"]")),t.preventDefault(),O.callPhone({tel:i.attr(e)}),!1},callback:function(){return!0}})},getLocalCityInfo:function(t,e){var i,a,s=this,r=this.gpsReloadBtn;i=function(t){r.removeClass(w),g.setCurrentCity(t),D.setAttr("cityId",t.CityID),D.setAttr("cityName",t.CityName),D.setAttr("hasGroupProduct",t.HasGroupProduct),x.setAttr("ctyId",t.CityID),x.setAttr("ctyName",t.CityName),e&&e()},a=function(){r.removeClass(w),D.setAttr("cityId",null),D.setAttr("cityName",null),s.showToast("抱歉，获取不到当前位置!")},S.setParam({lng:t.lng,lat:t.lat,district:encodeURIComponent(t.district),cityname:encodeURIComponent(t.city),province:encodeURIComponent(t.province),isOverseas:t.isOverseas}),S.excute(i,a,!1,this)},isCurrentCityChange:function(){var t=g.getCurrentCity(),e=t.CityId;return e&&e!=x.getAttr("ctyId")},positionSearchPanel:function(t){var e=this,i=t.direction;"up"==i.toLowerCase()&&t.y>30?(e.keywordPanel.addClass("list_s_fixed"),e.keywordPanel.css("top",!C&&e.isNearBy()?"78px":C?"0":"48px")):(e.keywordPanel.removeClass("list_s_fixed"),e.keywordPanel.css("top","0"))},refreshGeolocation:function(t){var e=$(t.target),i=this;e.addClass(w),this.getGeolocation(function(){i.getGroupListData()})},getGeolocation:function(t){var e,i,a=this,s=this.$el.find("#J_gpsInfo");e=function(e){a.displayGPSInfo(e,!0,t)},i=function(){D.set(null),s.parent().find("."+w).removeClass(w),a.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")},M.Subscribe("tuan/list",{onComplete:function(t){e(t)},onError:i,onPosComplete:function(){},onPosError:i},this,!0)},displayGPSInfo:function(t,e,i){var a=this.gpsInfoWrap,s=this.gpsReloadBtn,r=x.getAttr("ctyName")||"",n=G.get(),l="距离: ";if(t=t||{},s[e?"show":"hide"](),l+=e&&t?H.youAreHere+t.address:n&&n.name?4!=n.type?n.pos&&n.pos.name||n.name:r+o.CITY_CENTER:t.address?t.address==r?r+o.CITY_CENTER:t.address:(r||"")+o.CITY_CENTER,a.html(l),e){t.city=t.city&&t.city.replace("市",""),D.set(t),F.setAttr("gps",t);var d={lng:t.lng,lat:t.lat,district:t.district,city:t.city,province:t.province,isOverseas:"中国"!=t.country};this.getLocalCityInfo(d,i)}},initTuanFilters:function(){var t=this.$el;if(this.tuanfilters){this.hideFilterDropDowns(),this.tuanfilters.updateCategoryName();var e=G.get();!e||e&&-6==e.type?(this.tuanfilters.renderPosition(),this.tuanfilters._positionInited=void 0):this.tuanfilters.updatePositionName(),this.tuanfilters.updateCustomFilterIcon(),e||this.tuanfilters.sort.reset()}else this.tuanfilters=p.getInstance({sortTrigger:t.find("#J_sortTrigger"),sortPanel:t.find("#J_sortPanel"),sortLabel:t.find("#J_sortTrigger"),categoryTrigger:t.find("#J_categoryTrigger"),categoryPanel:t.find("#J_categoryPanel"),positionTrigger:t.find("#J_positionTrigger"),positionPanel:t.find("#J_positionPanel"),customFilter:t.find("#J_customFilters"),filterPanel:t.find("#J_filterPanel"),page:this,sortDefaultIndex:T.getAttr("sortTypeIndex")||0}),this.filterWrap.show()},hideFilterDropDowns:function(){var t=this.tuanfilters;t.sort.hide()},onCreate:function(){var e=this.$el;x.setAttr("pageIdx",1),this.onWindowScroll=$.proxy(this._onWindowScroll,this),this.render(),t.saveUnion(!0),this.gpsInfoWrap.css("top",C?"0px":"48px"),C&&(e.find("#J_searchBoxWrap").addClass("hybrid"),t.initVoiceSearch&&t.initVoiceSearch(e.find("#J_voiceTrigger")))},isFromDetail:function(t){return t&&t.match(/detail/i)},isFromListMap:function(t){return t&&t.match(/listmap/i)},controlGPSInfoWrap:function(t){this.gpsInfoWrap.css("display",t?"":"none")},getCurrentCity:function(t){var e={id:t.ctyId,name:t.ctyName},i=this.getQuery("cityid");return i&&+i>0&&(e=g.findCityInfoById(i)),+e.id||(e=o.defaultCity),e},isNearBy:function(){return x.getAttr("nearby")||B.getAttr("nearby")},isFromHybridFavorPage:function(){return C&&1==Lizard.P("from_native_page")},isOneYuan:function(){return"1|1"==N.getAttr("price.val")},updateTitle:function(e){var i=this;this.header.set({title:e.indexOf(H.tuangou)>-1?e:e+H.tuangou,back:!0,view:this,events:{returnHandler:function(){if(i.isNearBy()&&(x.removeAttr("nearby"),B.removeAttr("nearby")),i.clearPagePos(),i.isFromHybridFavorPage())return void O.backToLastPage({param:JSON.stringify({biz:"tuan",refresh:"1"})});var e=Lizard.P("from");e?t.jumpToPage(e,i):i.back("home")},homeHandler:$.proxy(i.homeHandler,i),commitHandler:function(){i.gotoMapPage()}},btn:{title:"地图",id:"J_gotoMapPage",classname:"rightblue"}}),this.header.show()},gotoMapPage:function(){this.isDataReady&&this.forwardJump("listmap","/webapp/tuan/listmap")},createPage:function(){var t=x.get(),e=t.ctype,i=t.ctyId||o.defaultCity.id,a=this.isNearBy(),s=this.isOneYuan(),r=o.groupType[e].name||o.groupType[0].name;if(s&&(r="一元团购"),this.updateTitle(r),this.initKeywordSearch(),this.hideForbiddens(!a,".J_forbidden"),this.keywordPanel=this.$el.find("#J_keywordSearchPanel"),a)this.getGroupListData(),this.isFromListMap(this.referUrl)&&this.tuanfilters&&this.tuanfilters.updateCategoryName();else{if(Lizard.P("cityid")){var n=g.getGroupQueryParam();x.setAttr("qparams",n)}this.getGroupListData(),s?this.filterWrap.hide():(this.tuanfilters&&this.filterWrap.show(),this.getConditionData(i))}},hideForbiddens:function(t,e){this.$el.find(e)[t?"hide":"show"]()},getConditionData:function(t){J.setParam("ctyId",t);var e=1;e|=2,e|=4,e|=8,e|=64,e|=128,e|=256,e|=512,e|=1024,e|=2048,e|=4096,e|=8192,J.setParam("type",e),J.setParam("categroy",x.getAttr("ctype")),J.excute(function(){this.initTuanFilters()},function(){},!1,this)},renderPageByCity:function(){var t=this;W.excute(function(e){t.createPage(e)},function(e){t.createPage(e)},!1,this)},onHide:function(){M.UnSubscribe("tuan/list"),this.$el.find("#J_reloadGPS").removeClass(w);var t=this.tuanfilters,e=t&&t.sort;this.LazyLoad&&this.LazyLoad.unbindEvents(),$(window).unbind("scroll",this.onWindowScroll),this.hideWarning404(),this.hideLoading(),this.scrollObserver&&this.scrollObserver.disable(),this.alert&&this.alert.hide(),e&&e.mask.root&&e.mask.root.hide(),t&&t.mask&&t.mask.hide()},onShow:function(t){this.referUrl=t||this.getLastViewName(),this.gpsInfoWrap=this.$el.find("#J_gpsInfo"),this.gpsReloadBtn=this.$el.find("#J_reloadGPS");var e,i=this;if(k&&k.remove(),x.getAttr("from_feature"))return void this.emptyPage("当地特色",x.getAttr("ctyName"));if(this.isFromDetail(this.referUrl)&&r.getItem("hasListData")){var a=x.getAttr("ctype"),s=o.groupType[a].name||o.groupType[0].name;this.isOneYuan()&&(s="一元团购"),this.updateTitle(s),this._restoreScrollPos()}else this.showLoading(),this.listWrap.empty(),x.setAttr("pageIdx",1),g.saveQueryString(function(){e=i.isNearBy();var t=F.getAttr("gps");if(e&&t){var a=i.gpsInfoWrap,s=i.gpsReloadBtn,r=R.getAttr("gps"),o="距离: ";s.show(),o+=H.youAreHere+r.address,a.html(o)}if(null==T.getAttr("sortTypeIndex")&&i.isNearBy()&&(x.setAttr("sortRule",8),T.setAttr("sortTypeIndex",1),i.tuanfilters)){var n=$(i.tuanfilters.sort.getItemByIndex(1))[0];i.tuanfilters.sort.select(n,!0)}i.renderPageByCity()});this.LazyLoad=new f({wrap:this.$el,animate:"opacity-fade-in"}),$(window).bind("scroll",this.onWindowScroll),this.scrollObserver&&this.scrollObserver.enable()},_onWindowScroll:function(){var t=e.ui.Tools.getPageScrollPos(),i=x.get(),a=isNaN(i.pageIdx)?1:i.pageIdx;i.pageIdx<this.totalPages&&this.totalPages>1&&(this.isComplete=!1);var s=t.pageHeight-(t.top+t.height);if(300>=s&&!this.isComplete&&!this.isLoading){if(this.isLoading=!0,i.pageIdx>=this.totalPages)return void(this.isComplete=!0);i.pageIdx=++a,x.setAttr("pageIdx",i.pageIdx),this.getGroupListData(!0)}},showBottomLoading:function(){this.bottomLoading||(this.bottomLoading=$('<div style="bottom: 48px;" class="cui-zl-load"> <div class="cui-i cui-b-loading"></div><div class="cui-i cui-mb-logo"></div> <p>加载中…</p></div>'),this.$el.append(this.bottomLoading)),this.bottomLoading.show()},hideBottomLoading:function(){this.bottomLoading&&this.bottomLoading.hide()},reloadPage:function(){this.showLoading(),this.getGroupListData(!1,!0)},renderList:function(t){var e=x.get(),i=e.sortRule;t.pageIdx=e.pageIdx;var a=$.trim(this["8"==i?"businessListTpl":"productListTpl"](t));t.count&&+t.count>0&&this.totalPages&&+this.totalPages>1?"8"==i?this.listWrap.append(a):t.pageIdx>1?this.listWrap.find("ul").append(a):this.listWrap.append(a):(!this.totalPages||+this.totalPages<1||!e.pageIdx||+e.pageIdx<=1)&&this.listWrap.html(a),t.count>0&&t.pageIdx>=this.totalPages&&this.listWrap.append('<p class="sec-waiting" style="display:block;">没有更多结果了</p>')},isDataReady:!1,getGroupListData:function(e,i){var a,s,n,l,d=this,c=d.isNearBy(),h=R.getAttr("gps"),u=x.getAttr("sortRule"),p=G.getAttr("pos"),f=G.getAttr("type");"8"==u?(l=L,n="hotels",c?x.removeAttr("pos"):p&&"4"!=f?(0>f||"5"==f)&&x.setAttr("pos",p):(s=x.getAttr("ctyId"),a=g.findCityInfoById(s),h=a&&a.pos||{},x.setAttr("pos",{posty:o.MAP_SOURCE_ID,lon:h.lon||0,lat:h.lat||0,name:a.name+o.CITY_CENTER}))):(l=A,n="products",p&&0>f?x.setAttr("pos",p):x.removeAttr("pos")),e&&d.showBottomLoading(),x.setAttr("environment",t.environment),l.param=x.get(),c&&0==x.getAttr("ctype")&&(l.param.ctyId=0,l.param.ctyName="");var y=l.param.pageIdx;l.excute(function(t){var i=t;if(this.isLoading=!1,d.hideLoading(),e&&d.hideBottomLoading(),t&&t[n]&&t[n].length&&t.count&&+t.count>0){if(this.isDataReady=!0,this.totalPages=Math.ceil(t.count/this.pageSize),this.totalPages>1&&$(window).bind("scroll",this.onWindowScroll),i.isNearBy=c,!e&&this.listWrap.empty(),this.renderList(i),c&&"8"==u&&1>=y){var a=t&&t.city&&t.city.cityid,s=t&&t.city&&t.city.cityName;a&&s&&(x.setAttr("ctyId",a),x.setAttr("ctyName",s),this.tuanfilters||this.getConditionData(a))}r.setItem("hasListData",!0),x.getAttr("pageIdx")<=1&&!c&&d.displayGPSInfo(t.curpos||{},c)}else x.getAttr("pageIdx")>1?d.showToast("亲，数据加载完毕"):(this.totalPages||this.totalPages<=0)&&this.renderNoResult("",n),x.setAttr("pageIdx",1),this.isComplete=!0,$(window).unbind("scroll",this.onWindowScroll),c||d.displayGPSInfo(t.curpos||{},c);this.LazyLoad&&this.LazyLoad.updateDom()},function(t){this.hideLoading(),this.isLoading=!1,this.isComplete=!0,this.totalPages<=0&&(this.listWrap.empty(),this.renderNoResult(t.msg,n)),x.setAttr("pageIdx",1),$(window).unbind("scroll",this.onWindowScroll)},!!i,d)},emptyPage:function(t,e){this.updateTitle(t),this.renderNoResult("","hotels",{feature:{val:"",txt:t}}),this.gpsInfoWrap.text("距离："+e+o.CITY_CENTER)},renderNoResult:function(t,e,i){var a={count:0,positionFilter:G.get()||{},weekendsAvailable:x.getAttr("weekendsAvailable"),keywordData:g.getCurrentKeyWord()};i=i||N.get()||{};var s=i&&i.distance&&i.distance.val;s=s||a.positionFilter.pos&&a.positionFilter.pos.distance,a[e]=null,a.msg=t?t:(s?s+"公里内":"")+"没找到符合条件的结果，请修改条件重新查询",a.customFilter=i,this.renderList(a)},initKeywordSearch:function(){var t=this.$el.find("#J_keywordSearch"),e=g.getCurrentKeyWord();this.searchKeywordInput=t,b.InputClear(t),t.val(e&&e.word||"")},detailHandler:function(t){var e=$(t.currentTarget).attr("data-id"),i=x.getAttr("ctyId");this._saveScrollPos(),this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(i?"?cityid="+i:""))},clearPagePos:function(){r.setItem(P,null)},_restoreScrollPos:function(){var t=r.getItem(P);t&&t.y&&setTimeout(function(){window.scrollTo(t.x,t.y)},0)},_saveScrollPos:function(){r.setItem(P,{x:window.scrollX,y:window.scrollY})},deleteFilter:function(t){var e=$(t.currentTarget),i=e.data("type"),a=this.$el.find("#J_filterTabLabel"),s=this.$el.find("#J_filterTabPanel");switch(i){case"position":G.remove(),this.tuanfilters&&this.tuanfilters.renderPosition(),this.tuanfilters&&(this.tuanfilters._positionInited=void 0);break;case"star":var r=N.getAttr("star");delete r[e.data("value")],$.isEmptyObject(r)?(N.removeAttr("star"),a.find('li[data-tab="star"] i').hide()):N.setAttr("star",r);break;case"weekendsAvailable":x.setAttr("weekendsAvailable",0),this.$el.find("#weekends")[0].checked=!1;break;case"voucher":N.removeAttr("voucher"),this.$el.find("#voucher")[0].checked=!1;break;case"multiShop":N.removeAttr("multiShop"),this.$el.find("#multiShop")[0].checked=!1;break;case"keyword":g.removeCurrentKeyWord(),this.$el.find("#J_keywordSearch").val("");break;case"feature":x.removeAttr("from_feature"),this.updateTitle(o.groupType[0].name);break;case"price":x.setAttr("qparams",[]),a.find('li[data-tab="price"] i').hide(),N.removeAttr("price"),this.updateTitle(o.groupType[0].name);break;default:N.removeAttr(i),a.find('li[data-tab="'+i+'"] i').hide()}this.tuanfilters&&(this.tuanfilters.renderTabWrap(i,s,!1),this.tuanfilters.updateCustomFilterIcon()),x.setAttr("qparams",g.getGroupQueryParam()),x.setAttr("pageIdx","1"),this.isLoading=!0,window.scrollTo(0,0),this.listWrap.empty(),this.showLoading(),this.hideBottomLoading(),this.getGroupListData()},homeHandler:function(){x.setAttr("pageIdx",1),$(window).unbind("scroll",this.onWindowScroll),g.clearSpecified(),t.tHome()},showCityPage:function(){this.forwardJump("citylist","/webapp/tuan/citylist")},showKeywordSearch:function(){this.forwardJump("keywordsearch","/webapp/tuan/keywordsearch")},showMore:function(t){$(t.currentTarget).hide().siblings("li").show()},getAppUrl:function(){var t=x.get(),e=t.ctype;return"ctrip://wireless/hotel_groupon_list?c1="+t.ctyId+"&c2="+e}})});