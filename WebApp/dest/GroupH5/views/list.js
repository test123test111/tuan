define(["TuanApp","c","TuanBaseView","cCommonPageFactory","cWidgetGuider","MemCache","StringsData","cUtility","cGeoService","cWidgetFactory","cUIToast","cUIScroll","TuanStore","TuanModel","TuanFilters","StoreManage","LazyLoad","ScrollObserver","text!ListProductTpl","text!ListBusinessTpl","cWidgetGeolocation"],function(t,e,i,a,r,s,o,n,l,c,d,h,u,p,g,f,y,m,v,w){var I,P="ani_rotation",b="PAGE_LIST_POSITION",A=(e.ui,n.isInApp()),S=p.TuanListModel.getInstance(),C=p.TuanHotelListModel.getInstance(),L=u.GroupSortStore.getInstance(),T=p.TuanLocalCityInfo.getInstance(),x=u.GroupSearchStore.getInstance(),k=u.OrderDetailReturnPage.getInstance(),W=p.TuanCityListModel.getInstance(),J=u.GroupPositionFilterStore.getInstance(),N=u.GroupCustomFilters.getInstance(),G=p.TuanConditionModel.getInstance(),F=u.GroupGeolocation.getInstance(),D=u.TuanPositionStore.getInstance(),B=u.TuanHistoryCityListStore.getInstance(),R=u.GroupGeolocation.getInstance(),O={youAreHere:"您的位置 "},M=c.create("Guider"),E=l.GeoLocation,H=a.create("TuanBaseView");return I=H.extend({pageid:"214001",hpageid:"215001",totalPages:null,isComplete:!1,isLoading:!1,isScrolling:!1,pageSize:25,render:function(){var t=this.$el;this.listWrap=t.find("#J_listWrap"),this.filterWrap=t.find(".J_filtersAndSortPanel"),this.productListTpl=_.template(v),this.businessListTpl=_.template(w),this.gpsInfoWrap=t.find("#J_gpsInfoWrap"),this.quickOpBar=t.find("#J_quickOpBar"),this.toolbar=t.find("#J_toolbar"),this.toolbarSpace=t.find("#J_toolbarSpace")},events:{"click li[data-id]":"detailHandler","click #J_reloadGPS":"refreshGeolocation","click #J_keywordSearch":"showKeywordSearch","click .cui-btns-retry":"reloadPage","click .J_showMore":"showMore","click .J_phone":"callPhone","click #J_deleteFilter li":"deleteFilter","click .J_filtersAndSortPanel":function(){this.filterWrap.css("z-index","9999")}},callPhone:function(t){M.apply({hybridCallback:function(){var e="data-phone",i=$(t.target);return i.attr(e)||(i=i.find("["+e+"]")),t.preventDefault(),M.callPhone({tel:i.attr(e)}),!1},callback:function(){return!0}})},getLocalCityInfo:function(t,e){var i,a,r=this,s=this.gpsReloadBtn;i=function(t){s.removeClass(P),f.setCurrentCity(t),D.setAttr("cityId",t.CityID),D.setAttr("cityName",t.CityName),D.setAttr("hasGroupProduct",t.HasGroupProduct),x.setAttr("ctyId",t.CityID),x.setAttr("ctyName",t.CityName),e&&e()},a=function(){s.removeClass(P),D.setAttr("cityId",null),D.setAttr("cityName",null),r.showToast("抱歉，获取不到当前位置!")},T.setParam({lng:t.lng,lat:t.lat,district:encodeURIComponent(t.district),cityname:encodeURIComponent(t.city),province:encodeURIComponent(t.province),isOverseas:t.isOverseas}),T.excute(i,a,!1,this)},isCurrentCityChange:function(){var t=f.getCurrentCity(),e=t.CityId;return e&&e!=x.getAttr("ctyId")},refreshGeolocation:function(t){var e=$(t.target),i=this;e.addClass(P),this.getGeolocation(function(){i.getGroupListData()})},getGeolocation:function(t){var e,i,a=this,r=this.$el.find("#J_gpsInfo");e=function(e){a.displayGPSInfo(e,!0,t)},i=function(){D.set(null),r.parent().find("."+P).removeClass(P),a.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")},E.Subscribe("tuan/list",{onComplete:function(t){e(t)},onError:i,onPosComplete:function(){},onPosError:i},this,!0)},displayGPSInfo:function(t,e,i){var a=this.gpsInfoWrap,r=this.gpsReloadBtn,s=x.getAttr("ctyName")||"",n=J.get(),l="距离: ";if(t=t||{},r[e?"show":"hide"](),l+=e&&t?O.youAreHere+t.address:n&&n.name?4!=n.type?n.pos&&n.pos.name||n.name:s+o.CITY_CENTER:t.address?t.address==s?s+o.CITY_CENTER:t.address:(s||"")+o.CITY_CENTER,a.html(l),e){t.city=t.city&&t.city.replace("市",""),D.set(t),F.setAttr("gps",t);var c={lng:t.lng,lat:t.lat,district:t.district,city:t.city,province:t.province,isOverseas:"中国"!=t.country};this.getLocalCityInfo(c,i)}},initTuanFilters:function(){var t=this.$el;if(this.tuanfilters){this.hideFilterDropDowns(),this.tuanfilters.updateCategoryName();var e=J.get();!e||e&&-6==e.type?(this.tuanfilters.renderPosition(),this.tuanfilters._positionInited=void 0):this.tuanfilters.updatePositionName(),this.tuanfilters.updateCustomFilterIcon(),e||this.tuanfilters.sort.reset()}else this.tuanfilters=g.getInstance({sortTrigger:t.find("#J_sortTrigger"),sortPanel:t.find("#J_sortPanel"),sortLabel:t.find("#J_sortTrigger"),categoryTrigger:t.find("#J_categoryTrigger"),categoryPanel:t.find("#J_categoryPanel"),positionTrigger:t.find("#J_positionTrigger"),positionPanel:t.find("#J_positionPanel"),customFilter:t.find("#J_customFilters"),filterPanel:t.find("#J_filterPanel"),page:this,sortDefaultIndex:L.getAttr("sortTypeIndex")||0}),this.filterWrap.show()},hideFilterDropDowns:function(){var t=this.tuanfilters;t.sort.hide()},onCreate:function(){this.$el;x.setAttr("pageIdx",1),this.onWindowScroll=$.proxy(this._onWindowScroll,this),this.render(),t.saveUnion(!0);var e=7===+x.getAttr("ctype");this.controlGPSInfoWrap(!e);var i=e?0:30;i+=45,this.toolbar.css("top",A?"0px":"48px"),this.toolbarSpace.css("height",i)},toolbarObserver:function(t,e){var i=this.toolbar,a=this.toolbarSpace,r=e.direction;"down"==r.toLowerCase()?e.y>75&&(i.removeClass("list_s_fixed"),a.hide()):(i.addClass("list_s_fixed"),i.css("top",A?"0px":"48px"),a.show())},setQuickScroll:function(){var t=this.$el.find("#J_quickWrapper"),e=t.find("ul"),i=0,a=e.find("li");_.each(a,function(t){i+=$(t).width()+3}),e.css("width",i);new h({wrapper:t,scrollbars:!1,scrollX:!0,scrollY:!1})},isFromDetail:function(){var t=this.referUrl;return t&&t.match(/detail/i)},isFromListMap:function(){var t=this.referUrl;return t&&t.match(/listmap/i)},isFromKeywordSearch:function(){var t=this.referUrl;return t&&t.match(/keywordsearch/i)},controlGPSInfoWrap:function(t){this.gpsInfoWrap[t?"show":"hide"]()},getCurrentCity:function(t){var e={id:t.ctyId,name:t.ctyName},i=this.getQuery("cityid");return i&&+i>0&&(e=f.findCityInfoById(i)),e.id&&(e=o.defaultCity),e},isNearBy:function(){return x.getAttr("nearby")||B.getAttr("nearby")},isFromHybridFavorPage:function(){return A&&1==Lizard.P("from_native_page")},isOneYuan:function(){return"1|1"==N.getAttr("price.val")},updateTitle:function(e,i){var a=this,r=this.header,s={back:!0,view:this,events:{returnHandler:function(){if(a.isNearBy()&&(x.removeAttr("nearby"),B.removeAttr("nearby")),a.clearPagePos(),a.isFromHybridFavorPage())return void M.backToLastPage({param:JSON.stringify({biz:"tuan",refresh:"1"})});var e=Lizard.P("from");e?t.jumpToPage(e,a):a.back("home")}}},o=x.getAttr("ctype"),n={map:'<b id="J_gotoMapPage" class="i_bef icon_map_w"></b>',search:'<b id="J_gotoSearch" class="i_bef icon_search_w"></b>',down:'<i class="i_tri"></i>'},l=this.isFromKeywordSearch()&&f.getCurrentKeyWord();l||(s.moreRightMenus=[{tagname:"tuan_keyword_search",imagePath:"tuan/pic/h5/tuan/icon_search_w.png",pressedImagePath:"tuan/pic/h5/tuan/icon_search_w.png",callback:function(){a.showKeywordSearch()}}]);var c='<h2><div id="J_cityBtn" class="list_hd_button2"><em class="header_mutrow">'+e+"</em>"+(i?n.down:"")+'</div></h2><i id="js_return" class="returnico"></i>';7===+o?s.customtitle=c+(l?"":n.search):(s.customtitle=c+(l?"":n.search)+n.map,(s.moreRightMenus||(s.moreRightMenus=[])).unshift({tagname:"tuan_list_map",imagePath:"tuan/pic/h5/tuan/icon_map_w.png",pressedImagePath:"tuan/pic/h5/tuan/icon_map_w.png",callback:function(){a.gotoMapPage()}})),i?(s.citybtn=e,s.events.citybtnHandler=function(){a.showCityPage()}):s.title=e,r.set(s),r.show(),A||(i&&r.root.find("#J_cityBtn").on("click",$.proxy(a.showCityPage,this)),r.root.find("#J_gotoSearch").on("click",$.proxy(a.showKeywordSearch,this)),r.root.find("#J_gotoMapPage").on("click",$.proxy(a.gotoMapPage,this)))},gotoMapPage:function(){this.forwardJump("listmap","/webapp/tuan/listmap")},createPage:function(){var t=x.get(),e=(t.ctype,t.ctyId||o.defaultCity.id),i=this.isNearBy(),a=this.isOneYuan(),r=f.getCurrentKeyWord();if(this.isFromKeywordSearch()&&r?this.updateTitle(r.word,!1):a?this.updateTitle("一元团购",!1):this.updateTitle(t.ctyName,!0),this.hideForbiddens(!i,".J_forbidden"),i)this.getGroupListData(),this.isFromListMap()&&this.tuanfilters&&this.tuanfilters.updateCategoryName();else{if(Lizard.P("cityid")){var s=f.getGroupQueryParam();x.setAttr("qparams",s)}this.getGroupListData(),a?this.filterWrap.hide():(this.tuanfilters&&this.filterWrap.show(),this.getConditionData(e))}},hideForbiddens:function(t,e){this.$el.find(e)[t?"hide":"show"]()},getConditionData:function(t){G.setParam("ctyId",t);var e=1;e|=2,e|=4,e|=8,e|=64,e|=128,e|=256,e|=512,e|=1024,e|=2048,e|=4096,e|=8192,G.setParam("type",e),G.setParam("categroy",x.getAttr("ctype")),G.excute(function(){this.initTuanFilters()},function(){},!1,this)},renderPageByCity:function(){var t=this;W.excute(function(e){t.createPage(e)},function(e){t.createPage(e)},!1,this)},onHide:function(){E.UnSubscribe("tuan/list"),this.$el.find("#J_reloadGPS").removeClass(P),this.LazyLoad&&this.LazyLoad.unbindEvents(),$(window).unbind("scroll",this.onWindowScroll),this.hideWarning404(),this.hideLoading(),this.scrollObserver&&this.scrollObserver.disable(),this.alert&&this.alert.hide();var t=this.tuanfilters,e=t&&t.mask,i=t&&t.sort;e&&e.hide(),i&&i.mask.root&&i.mask.root.hide(),t&&(t.options.categoryPanel.hide(),t.options.positionPanel.hide(),t.options.filterPanel.hide())},parseSEOPostData:function(){var t=$.trim(this.$el.find("#J_seoPostData").text());t&&x.set(JSON.parse(t))},onShow:function(t){this.referUrl=t||this.getLastViewName(),this.parseSEOPostData(),this.infoWrap=this.$el.find("#J_gpsInfo"),this.gpsReloadBtn=this.$el.find("#J_reloadGPS"),this.setQuickScroll();var e,i=this;return k&&k.remove(),x.getAttr("from_feature")?(this.updateTitle("当地特色",!1),this.renderNoResult("","hotels",{feature:{val:"",txt:"当地特色"}}),void this.gpsInfoWrap.text("距离："+x.getAttr("ctyName")+o.CITY_CENTER)):(this.isFromDetail()&&s.getItem("hasListData")?(this.isOneYuan()?this.updateTitle("一元团购",!1):this.updateTitle(x.getAttr("ctyName"),!0),this._restoreScrollPos()):(this.showLoading(),this.listWrap.empty(),x.setAttr("pageIdx",1),f.saveQueryString(function(){e=i.isNearBy();var t=F.getAttr("gps");if(e&&t){var a=i.infoWrap,r=i.gpsReloadBtn,s=R.getAttr("gps"),o="距离: ";r.show(),o+=O.youAreHere+s.address,a.html(o)}if(null===L.getAttr("sortTypeIndex")&&i.isNearBy()&&(x.setAttr("sortRule",8),L.setAttr("sortTypeIndex",1),i.tuanfilters)){var n=$(i.tuanfilters.sort.getItemByIndex(1))[0];i.tuanfilters.sort.select(n,!0)}i.renderPageByCity()})),this.LazyLoad=new y({wrap:this.$el,animate:"opacity-fade-in"}),$(window).bind("scroll",this.onWindowScroll),this.scrollObserver=m.init(),this.scrollObserver&&this.scrollObserver.enable(),void $(window).bind("customScrollStart",$.proxy(this.toolbarObserver,this)))},_onWindowScroll:function(){var t=e.ui.Tools.getPageScrollPos(),i=x.get(),a=isNaN(i.pageIdx)?1:i.pageIdx;i.pageIdx<this.totalPages&&this.totalPages>1&&(this.isComplete=!1);var r=t.pageHeight-(t.top+t.height);if(300>=r&&!this.isComplete&&!this.isLoading){if(this.isLoading=!0,i.pageIdx>=this.totalPages)return void(this.isComplete=!0);i.pageIdx=++a,x.setAttr("pageIdx",i.pageIdx),this.getGroupListData(!0)}},showBottomLoading:function(){this.bottomLoading||(this.bottomLoading=$('<div style="bottom: 48px;" class="cui-zl-load"> <div class="cui-i cui-b-loading"></div><div class="cui-i cui-mb-logo"></div> <p>加载中…</p></div>'),this.$el.append(this.bottomLoading)),this.bottomLoading.show()},hideBottomLoading:function(){this.bottomLoading&&this.bottomLoading.hide()},reloadPage:function(){this.showLoading(),this.getGroupListData(!1,!0)},renderList:function(t){var e=x.get(),i=e.sortRule;t.pageIdx=e.pageIdx,t.ctype=e.ctype;var a=$.trim(this["8"==i?"businessListTpl":"productListTpl"](t));t.count&&+t.count>0&&this.totalPages&&+this.totalPages>1?"8"==i?this.listWrap.append(a):t.pageIdx>1?this.listWrap.find("ul").append(a):this.listWrap.append(a):(!this.totalPages||+this.totalPages<1||!e.pageIdx||+e.pageIdx<=1)&&this.listWrap.html(a),t.count>0&&t.pageIdx>=this.totalPages&&this.listWrap.append('<p class="sec-waiting" style="display:block;">没有更多结果了</p>')},isDataReady:!1,getGroupListData:function(e,i){var a,r,n,l,c=this,d=c.isNearBy(),h=R.getAttr("gps"),u=x.getAttr("sortRule"),p=J.getAttr("pos"),g=J.getAttr("type");"8"==u?(l=C,n="hotels",d?x.removeAttr("pos"):p&&"4"!=g?(0>g||"5"==g)&&x.setAttr("pos",p):(r=x.getAttr("ctyId"),a=f.findCityInfoById(r),h=a&&a.pos||{},x.setAttr("pos",{posty:o.MAP_SOURCE_ID,lon:h.lon||0,lat:h.lat||0,name:a.name+o.CITY_CENTER}))):(l=S,n="products",p&&0>g?x.setAttr("pos",p):x.removeAttr("pos")),e&&c.showBottomLoading(),x.setAttr("environment",t.environment),l.param=x.get(),d&&0===x.getAttr("ctype")&&(l.param.ctyId=0,l.param.ctyName="");var y=l.param.pageIdx;l.excute(function(t){var i=t;if(this.isLoading=!1,c.hideLoading(),e&&c.hideBottomLoading(),t&&t[n]&&t[n].length&&t.count&&+t.count>0){var a=f.getCurrentKeyWord();if(c.isFromKeywordSearch()&&a&&c.updateTitle(a.word+"("+t.count+")",!1),this.isDataReady=!0,this.totalPages=Math.ceil(t.count/this.pageSize),this.totalPages>1&&$(window).bind("scroll",this.onWindowScroll),i.isNearBy=d,!e&&this.listWrap.empty(),this.renderList(i),d&&"8"==u&&1>=y){var r=t&&t.city&&t.city.cityid,o=t&&t.city&&t.city.cityName;r&&o&&(x.setAttr("ctyId",r),x.setAttr("ctyName",o)),r&&o&&!this.tuanfilters&&this.getConditionData(r)}s.setItem("hasListData",!0),x.getAttr("pageIdx")<=1&&!d&&c.displayGPSInfo(t.curpos||{},d)}else x.getAttr("pageIdx")>1?c.showToast("亲，数据加载完毕"):(this.totalPages||this.totalPages<=0)&&this.renderNoResult("",n),x.setAttr("pageIdx",1),this.isComplete=!0,$(window).unbind("scroll",this.onWindowScroll),d||c.displayGPSInfo(t.curpos||{},d);this.LazyLoad&&this.LazyLoad.updateDom()},function(t){this.hideLoading(),this.isLoading=!1,this.isComplete=!0,this.totalPages<=0&&(this.listWrap.empty(),this.renderNoResult(t.msg,n)),x.setAttr("pageIdx",1),$(window).unbind("scroll",this.onWindowScroll)},!!i,c)},renderNoResult:function(t,e,i){var a=f.getCurrentKeyWord();this.isFromKeywordSearch()&&a&&this.updateTitle(a.word+"(0)",!1);var r={count:0,positionFilter:J.get()||{},weekendsAvailable:x.getAttr("weekendsAvailable"),keywordData:a};i=i||N.get()||{};var s=i&&i.distance&&i.distance.val;s=s||r.positionFilter.pos&&r.positionFilter.pos.distance,r[e]=null,r.msg=t?t:(s?s+"公里内":"")+"没找到符合条件的结果，请修改条件重新查询",r.customFilter=i,this.renderList(r)},detailHandler:function(t){var e=$(t.currentTarget).attr("data-id"),i=x.getAttr("ctyId");this._saveScrollPos(),this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(i?"?cityid="+i:""))},clearPagePos:function(){s.setItem(b,null)},_restoreScrollPos:function(){var t=s.getItem(b);t&&t.y&&setTimeout(function(){window.scrollTo(t.x,t.y)},0)},_saveScrollPos:function(){s.setItem(b,{x:window.scrollX,y:window.scrollY})},deleteFilter:function(t){var e=$(t.currentTarget),i=e.data("type"),a=this.$el.find("#J_filterTabLabel"),r=this.$el.find("#J_filterTabPanel");switch(i){case"position":J.remove(),this.tuanfilters&&this.tuanfilters.renderPosition(),this.tuanfilters&&(this.tuanfilters._positionInited=void 0);break;case"star":var s=N.getAttr("star");delete s[e.data("value")],$.isEmptyObject(s)?(N.removeAttr("star"),a.find('li[data-tab="star"] i').hide()):N.setAttr("star",s);break;case"weekendsAvailable":x.setAttr("weekendsAvailable",0),this.$el.find("#weekends")[0].checked=!1;break;case"voucher":N.removeAttr("voucher"),this.$el.find("#voucher")[0].checked=!1;break;case"multiShop":N.removeAttr("multiShop"),this.$el.find("#multiShop")[0].checked=!1;break;case"keyword":f.removeCurrentKeyWord(),this.$el.find("#J_keywordSearch").val(""),this.updateTitle(x.getAttr("ctyName"),!0);break;case"feature":x.removeAttr("from_feature"),this.updateTitle(x.getAttr("ctyName"),!0);break;case"price":x.setAttr("qparams",[]),a.find('li[data-tab="price"] i').hide(),N.removeAttr("price"),this.updateTitle(x.getAttr("ctyName"),!0);break;default:N.removeAttr(i),a.find('li[data-tab="'+i+'"] i').hide()}this.tuanfilters&&(this.tuanfilters.renderTabWrap(i,r,!1),this.tuanfilters.updateCustomFilterIcon()),x.setAttr("qparams",f.getGroupQueryParam()),x.setAttr("pageIdx","1"),this.isLoading=!0,window.scrollTo(0,0),this.listWrap.empty(),this.showLoading(),this.hideBottomLoading(),this.getGroupListData()},homeHandler:function(){x.setAttr("pageIdx",1),$(window).unbind("scroll",this.onWindowScroll),f.clearSpecified(),t.tHome()},showCityPage:function(){this.forwardJump("citylist","/webapp/tuan/citylist")},showKeywordSearch:function(){this.forwardJump("keywordsearch","/webapp/tuan/keywordsearch")},showMore:function(t){$(t.currentTarget).hide().siblings("li").show()},getAppUrl:function(){var t=x.get(),e=t.ctype;return"ctrip://wireless/hotel_groupon_list?c1="+t.ctyId+"&c2="+e}})});