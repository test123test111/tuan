define(["TuanApp","libs","c","TuanBaseView","cWidgetFactory","cCommonPageFactory","cUtility","TuanModel","cDataSource","TuanStore","StoreManage","StringsData","FilterXss","text!KeywordSearchTpl","HttpErrorHelper","TabSlide"],function(e,t,i,r,s,o,n,a,d,h,l,u,c,y,p){var w,g=i.ui,f=h.GroupSearchStore.getInstance(),k=h.TuanHistoryKeySearchStore.getInstance(),S=h.GroupSearchStore.getInstance(),m=s.create("TabSlide"),T=o.create("TuanBaseView");return w=T.extend({pageid:"214001",hpageid:"215001",tuankeyWordList:a.TuanKeyWordListModel.getInstance(),tuanHotKeywords:a.TuanHotWordsNewModel.getInstance(),dateSource:new d,selectItem:null,isComplete:!1,isLoading:!1,isScrolling:!1,render:function(){this.$el.html($.trim(y)),this.els={keywordSuggestBox:this.$el.find("#J_keywordSuggestWrap"),keywordSuggestTpl:this.$el.find("#J_keywordSuggestTpl"),keywordSuggestWrap:this.$el.find("#js_historykeysearch"),hotKeywordsTpl:this.$el.find("#J_hotKeywordsTpl"),hotKeywordsWrap:this.$el.find("#js_hotkeyword"),keywordInput:this.$el.find("#J_keywordInput"),keywordSearch:this.$el.find("#J_keywordSearch")},this.cityListTplfun=_.template(this.els.keywordSuggestTpl.html()),this.hotKeywordsTplfun=_.template(this.els.hotKeywordsTpl.html()),n.isInApp()&&e.isOverOS7()&&(this.els.keywordSearch.css("border-top","20px solid #b3b3b3"),this.els.keywordSearch.css("padding-top","10px"),this.els.keywordSuggestBox.css("padding-top","20px"))},events:{"input #J_keywordInput":"tuanKeyWordInput","submit .search_wrap>form":"onSubmitSearch","click .J_resultItem":"onKeywordItemClick","click #J_cancel":"onCancelInput","click .J_clearhistory":"onClearHistory","click #js_hotkeyword .sw_con>li":"goHotSearch"},onCancelInput:function(){l.clearSpecified(!0),l.setCurrentKeyWord(!1),this.back()},onClearHistory:function(){k.remove(),this.createPage({}),this.els.keywordInput.val("")},doSubmit:function(){var e=l.getGroupQueryParam(),t=this;f.setAttr("qparams",e),setTimeout(_.bind(function(){t.forwardJump("list","/webapp/tuan/list")},this),100)},onKeywordItemClick:function(e){l.clearSpecified(!0);var t=$(e.currentTarget),i=t.attr("data-id"),r=t.attr("data-name"),s=t.attr("data-type");l.addHistoryKeyWord(i,r,s),"markland"===(s||"").toLocaleLowerCase()&&S.setAttr("sortRule",8),this.doSubmit()},onSubmitSearch:function(){var e,t=c.filterXSS(this.els.keywordInput.val());return"undefined"==typeof t||""===t||null===t?!1:(l.clearSpecified(!0),e=this.els.keywordSuggestWrap.find('[data-name="'+t+'"]'),e.length&&"markland"===e.attr("data-type")?e[0].click():(l.addHistoryKeyWord(t,t,7),this.doSubmit()),!1)},tuanKeyWordInput:function(e){var t=$(e.currentTarget),i=c.filterXSS(t.val()),r=this.els.keywordSuggestWrap,s=this.els.hotKeywordsWrap,o=t.attr("inputwait")||300;t.attr("waitsend",(new Date).getTime()),i?setTimeout(_.bind(function(e,t){if(e){var i=e.attr("waitsend");i&&(new Date).getTime()-parseInt(i)>parseInt(t)-10&&(r.find(".J_historykeysearch").hide(),r.find(".J_clearhistory").hide(),s.hide(),this.doQueryData(c.filterXSS(e.val())))}},this,t,o),o):(r.find(".J_historykeysearch").show(),r.find(".J_clearhistory").show(),r.find(".city_list.searchresult>li[data-filter]").hide(),r.find(".city_noresult").hide(),s.show())},buildEvent:function(){g.InputClear(this.els.keywordInput),this.onBodyChange=$.proxy(function(){this.els.keywordInput[0].blur()},this)},doQueryData:function(e){try{if("undefined"==typeof e||""===e||null===e)return;var t=f.get();this.lastinputkey=e,this.$el.find(".s_city_loading").show(),this.getKeywordListData(e,t.ctyId,function(){this.$el.find(".s_city_loading").hide()})}catch(i){}},isVisible:function(){return"none"!=this.$el.css("display").toLowerCase()},getKeywordListData:function(e,t,i){var r=this;r.tuankeyWordList.setParam("cityid",t),r.tuankeyWordList.setParam("keyword",e),r.tuankeyWordList.setParam("itemType",S.getAttr("ctype")),r.tuankeyWordList.excute(function(e){r.createPage(e),i.call(this)},function(e){var t=p.getMessage(e);r.isVisible()&&this.showToast(t),i.call(this)},!1,this)},createPage:function(e){try{var t,i,r=l.getHistoryKeyWord();r.length>0&&(t=r[0].id,!e.history&&(e.history=[]),e.history=e.history.concat.apply(e.history,r));var s=this.lastinputkey;e.Results&&e.Results.length&&_.each(e.Results,function(e){e.word&&(e.wordNew=e.word.replace(new RegExp(s.toLocaleLowerCase(),"g"),"<em>"+s.toLocaleLowerCase()+"</em>").replace(new RegExp(s.toLocaleUpperCase(),"g"),"<em>"+s.toLocaleUpperCase()+"</em>")),e.typeNew=u.typeToName[e.type&&e.type.toLocaleLowerCase()]||""}),i=this.cityListTplfun({data:e,keyid:t}),this.els.keywordSuggestWrap.html(i),e.Results&&(this.els.keywordSuggestWrap.find(".J_historykeysearch").hide(),this.els.keywordSuggestWrap.find(".J_clearhistory").hide())}catch(o){}},onCreate:function(){this.render(),this.buildEvent()},onLoad:function(e){this._refer=e,this.turning(),this.els.keywordInput.val(l.getCurrentKeyWord()?l.getCurrentKeyWord().word:""),setTimeout(_.bind(function(){this.els.keywordInput[0].focus()},this),1e3),this.renderHotkeyword(),this.createPage({}),this.header&&this.header.rootBox&&(this.header.set({title:"",view:this,tel:null,events:{returnHandler:function(){this.back()}}}),this.header.show(),this.header.rootBox.hide()),this.hideLoading(),this.$el.bind("focus",this.onBodyChange),this.$el.bind("touchstart",this.onBodyChange)},onShow:function(){this.header.hide(),setTimeout(function(){this.els.keywordInput&&this.els.keywordInput[0].focus()}.bind(this),10)},onHide:function(){this.header.show(),this.hotkeywordsSlide&&this.hotkeywordsSlide.destroy(),this.tuankeyWordList.abort(),this.$el.unbind("focus",this.onBodyChange),this.$el.unbind("touchstart",this.onBodyChange)},renderHotkeyword:function(){var e=this,t=f.get();this.tuanHotKeywords.setParam("CityID",t.ctyId),this.tuanHotKeywords.excute(_.bind(function(t){var i=[];t&&t.hotkey&&t.hotkey.length>0&&(_.each(t.hotkey,function(e){_.each(e.KeyWords,function(t){t.ItemType=e.ItemType,i.push(t)})}),e.hotkeywordsSlide=new m({container:e.els.hotKeywordsWrap,source:i,tpl:e.els.hotKeywordsTpl.html()}))},this))},goHotSearch:function(e){var t=$(e.currentTarget),i=decodeURIComponent(t.attr("data-json"));i=this._parseJSON(i),i&&i.Val&&(l.parseHotkeyJson(this._parseJSON(i.Val)),this.forwardJump("list","/webapp/tuan/list"))},_parseJSON:function(e){try{e=JSON.parse(e)}catch(t){}return e}})});