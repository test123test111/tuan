define(["TuanApp","libs","c","TuanBaseView","cWidgetFactory","cCommonPageFactory","cUtility","TuanModel","cDataSource","TuanStore","StoreManage","StringsData","FilterXss","text!KeywordSearchTpl","HttpErrorHelper","TabSlide"],function(t,e,r,s,i,o,a,n,d,l,h,c,u,y,p){var w,g=r.ui,f=l.GroupSearchStore.getInstance(),k=l.TuanHistoryKeySearchStore.getInstance(),m=l.GroupPositionFilterStore.getInstance(),S=l.GroupCustomFilters.getInstance(),v=l.GroupCategoryFilterStore.getInstance(),T=l.GroupSearchStore.getInstance(),b=l.TuanHistoryCityListStore.getInstance(),I=i.create("TabSlide"),W=o.create("TuanBaseView");return w=W.extend({pageid:"214001",hpageid:"215001",tuankeyWordList:n.TuanKeyWordListModel.getInstance(),tuanHotKeywords:n.TuanHotKeywordsModel.getInstance(),dateSource:new d,selectItem:null,isComplete:!1,isLoading:!1,isScrolling:!1,render:function(){this.$el.html($.trim(y)),this.els={keywordSuggestBox:this.$el.find("#J_keywordSuggestWrap"),keywordSuggestTpl:this.$el.find("#J_keywordSuggestTpl"),keywordSuggestWrap:this.$el.find("#js_historykeysearch"),hotKeywordsTpl:this.$el.find("#J_hotKeywordsTpl"),hotKeywordsWrap:this.$el.find("#js_hotkeyword"),keywordInput:this.$el.find("#J_keywordInput"),keywordSearch:this.$el.find("#J_keywordSearch")},this.cityListTplfun=_.template(this.els.keywordSuggestTpl.html()),this.hotKeywordsTplfun=_.template(this.els.hotKeywordsTpl.html()),a.isInApp()&&t.isOverOS7()&&(this.els.keywordSearch.css("border-top","20px solid #b3b3b3"),this.els.keywordSearch.css("padding-top","10px"),this.els.keywordSuggestBox.css("padding-top","20px"))},events:{"input #J_keywordInput":"tuanKeyWordInput","submit .search_wrap>form":"onSubmitSearch","click .J_resultItem":"onKeywordItemClick","click #J_cancel":"onCancelInput","click .J_clearhistory":"onClearHistory","click #js_hotkeyword .sw_con>li":"goHotSearch"},onCancelInput:function(){h.clearSpecified(!0),h.setCurrentKeyWord(!1),this.back()},onClearHistory:function(){k.remove(),this.createPage({}),this.els.keywordInput.val("")},doSubmit:function(){var t=h.getGroupQueryParam(),e=this;f.setAttr("qparams",t),setTimeout(_.bind(function(){e.forwardJump("list","/webapp/tuan/list")},this),100)},onKeywordItemClick:function(t){h.clearSpecified(!0);var e=$(t.currentTarget),r=e.attr("data-id"),s=e.attr("data-name"),i=e.attr("data-type");h.addHistoryKeyWord(r,s,i),"markland"===i&&T.setAttr("sortRule",8),this.doSubmit()},onSubmitSearch:function(){var t,e=u.filterXSS(this.els.keywordInput.val());return"undefined"==typeof e||""===e||null===e?!1:(this.els.keywordInput[0].blur(),h.clearSpecified(!0),t=this.els.keywordSuggestWrap.find('[data-name="'+e+'"]'),t.length&&"markland"===t.attr("data-type")?t[0].click():(h.addHistoryKeyWord(e,e,7),this.doSubmit()),!1)},tuanKeyWordInput:function(t){var e=$(t.currentTarget),r=u.filterXSS(e.val()),s=this.els.keywordSuggestWrap,i=this.els.hotKeywordsWrap,o=e.attr("inputwait")||300;e.attr("waitsend",(new Date).getTime()),r?setTimeout(_.bind(function(t,e){if(t){var r=t.attr("waitsend");r&&(new Date).getTime()-parseInt(r)>parseInt(e)-10&&(s.find(".J_historykeysearch").hide(),s.find(".J_clearhistory").hide(),i.hide(),this.doQueryData(u.filterXSS(t.val())))}},this,e,o),o):(s.find(".J_historykeysearch").show(),s.find(".J_clearhistory").show(),s.find(".city_list.searchresult>li[data-filter]").hide(),s.find(".city_noresult").hide(),i.show())},buildEvent:function(){g.InputClear(this.els.keywordInput),this.onBodyChange=$.proxy(function(){this.els.keywordInput[0].blur()},this)},doQueryData:function(t){try{if("undefined"==typeof t||""===t||null===t)return;var e=f.get();this.lastinputkey=t,this.$el.find(".s_city_loading").show(),this.getKeywordListData(t,e.ctyId,function(){this.$el.find(".s_city_loading").hide()})}catch(r){}},isVisible:function(){return"none"!=this.$el.css("display").toLowerCase()},getKeywordListData:function(t,e,r){var s=this;s.tuankeyWordList.setParam("cityid",e),s.tuankeyWordList.setParam("keyword",t),s.tuankeyWordList.excute(function(t){s.createPage(t),r.call(this)},function(t){var e=p.getMessage(t);s.isVisible()&&this.showToast(e),r.call(this)},!1,this)},createPage:function(t){try{var e,r,s=h.getHistoryKeyWord();s.length>0&&(e=s[0].id,!t.history&&(t.history=[]),t.history=t.history.concat.apply(t.history,s));var i=this.lastinputkey;t.Results&&t.Results.length&&_.each(t.Results,function(t){t.word&&(t.wordNew=t.word.replace(new RegExp(i.toLocaleLowerCase(),"g"),"<em>"+i.toLocaleLowerCase()+"</em>").replace(new RegExp(i.toLocaleUpperCase(),"g"),"<em>"+i.toLocaleUpperCase()+"</em>")),t.typeNew=c.typeToName[t.type]||""}),r=this.cityListTplfun({data:t,keyid:e}),this.els.keywordSuggestWrap.html(r),t.Results&&(this.els.keywordSuggestWrap.find(".J_historykeysearch").hide(),this.els.keywordSuggestWrap.find(".J_clearhistory").hide())}catch(o){}},onCreate:function(){this.render(),this.buildEvent()},onLoad:function(t){this._refer=t,this.turning(),this.els.keywordInput.val(h.getCurrentKeyWord()?h.getCurrentKeyWord().word:""),this.els.keywordInput[0].focus(),setTimeout(_.bind(function(){this.els.keywordInput[0].focus()},this),1e3),this.renderHotkeyword(),this.createPage({}),this.header&&this.header.rootBox&&(this.header.set({title:"",view:this,tel:null,events:{returnHandler:function(){this.back()}}}),this.header.show(),this.header.rootBox.hide()),this.hideLoading(),this.$el.bind("focus",this.onBodyChange),this.$el.bind("touchstart",this.onBodyChange)},onShow:function(){this.header.hide(),this.els.keywordInput&&this.els.keywordInput[0].focus()},onHide:function(){this.header.show(),this.hotkeywordsSlide&&this.hotkeywordsSlide.destroy(),this.tuankeyWordList.abort(),this.$el.unbind("focus",this.onBodyChange),this.$el.unbind("touchstart",this.onBodyChange)},renderHotkeyword:function(){var t=this,e=f.get();this.tuanHotKeywords.setParam("cityid",e.ctyId),this.tuanHotKeywords.excute(_.bind(function(e){e&&e.hotWords&&e.hotWords.length>0&&(t.hotkeywordsSlide=new I({container:t.els.hotKeywordsWrap,source:e.hotWords,tpl:t.els.hotKeywordsTpl.html()}))},this))},goHotSearch:function(t){var e=$(t.currentTarget),r=decodeURIComponent(e.attr("data-json"));r=JSON.parse(r);var s,i=T.get();if(r){if(h.clearAll(),b.removeAttr("nearby"),r.pos){var o=r.pos.type,a=r.pos.val,n=r.pos.lat,d=r.pos.lon,l=r.pos.name;m.set({type:o,val:a,name:l,pos:{type:3,lat:n,lon:d,name:l}})}if(r.price&&c.priceText[r.price]&&S.setAttr("price",{val:r.price,txt:c.priceText[r.price]}),r.trait&&c.traitText[r.trait]&&S.setAttr("trait",{val:r.trait,txt:c.traitText[r.trait]}),r.star){var u=r.star.split(","),y={};for(var p in u)p=u[p],c.starText[p]&&(y[p]=c.starText[p]);y&&S.setAttr("star",y)}if(r.brand&&r.brand.length>0)for(var w in r.brand)w=r.brand[w],w&&w.val&&w.key&&S.setAttr("brand",{flag:1,val:w.val,txt:w.key});if(r.markland&&h.setCurrentKeyWord({id:r.markland.id,word:r.markland.name,type:"markland"}),r.hotel&&h.setCurrentKeyWord({id:r.hotel.id,word:r.hotel.name,type:"hotelid"}),r.keyword&&h.setCurrentKeyWord({word:r.word}),r.activity&&h.setCurrentKeyWord({id:r.activity.id,word:r.activity.name,type:"activity"}),r.district&&h.setCurrentKeyWord({id:r.district.id,word:r.district.name,type:"district"}),r.isweekend&&T.setAttr("weekendsAvailable",r.isweekend),r.multishop&&S.setAttr("multiShop",r.multishop),r.voucher&&S.setAttr("voucher",r.voucher),r.sort&&(T.setAttr("sortRule",r.sort.stype),T.setAttr("sortType",r.sort.sval)),r.classty){var g,f,k,I;r.classty.parent?(g=r.classty.parent.val,f=c.groupType[g],k=r.classty.val,I=r.word):(g=r.classty.val,f=c.groupType[g]),v.setAttr("tuanType",g),f&&(v.setAttr("category",f.category),v.setAttr("name",f.name),v.setAttr("tuanTypeIndex",f.index)),v.setAttr("subVal",k),v.setAttr("subName",I),T.setAttr("ctype",g)}s=h.getGroupQueryParam(),T.setAttr("qparams",s),T.setAttr("ctyId",i.ctyId),T.setAttr("ctyName",i.ctyName),this.forwardJump("list","/webapp/tuan/list")}}})});