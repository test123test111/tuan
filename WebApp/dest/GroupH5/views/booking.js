define(["TuanApp","c","cUIInputClear","TuanBaseView","cCommonPageFactory","cUIScrollRadioList","cWidgetGuider","cWidgetMember","cUserModel","cUtility","cWidgetFactory","CommonStore","TuanStore","TuanModel","text!BookingTpl","NumberStep","cHolidayPriceCalendar","ValidatorUtil","FieldUtil","Payment"],function(e,t,i,n,o,a,r,s,c,d,u,l,h,m,p,g,f,v,I){function L(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(100*t)/100}function b(e){return!!e}var T,P=h.TuanOrderInfoStore.getInstance(),C=h.TuanInvoiceStore.getInstance(),y=l.UserStore.getInstance(),D=h.TuanDetailsStore.getInstance(),w=l.UnionStore&&l.UnionStore.getInstance(),S=m.TuanCreateOrder.getInstance(),O=m.TuanDetailModel.getInstance(),k=(h.TuanOrderDetailStore.getInstance(),m.TuanCouponListModel.getInstance()),x=(h.TuanCouponListStore.getInstance(),h.TuanSelectedCouponStore.getInstance()),A=c.NotUserLoginModel.getInstance(),U=(h.GroupSearchStore.getInstance(),m.TicketBookingModel.getInstance()),N=d.isInApp(),M=l.HeadStore.getInstance(),R=u.create("Payment"),E=u.create("Guider"),J=u.create("Member"),H={max:9,min:1},B={100:"操作成功",101:"节点数据验证不通过",102:"系统程序错误",201999:"产品不处于可售状态，不能生成订单",201e3:"产品没有供应商,生成订单失败",201001:"产品已团完,生成订单失败",201002:"产品无分销商,生成订单失败",201003:"电话格式不符合规范（例：021-10106666-），未能生成订单",201004:"产品属0元团购，分销联盟不能生成订单",201005:"产品属马上订产品，分销联盟不能生成订单",201006:"超过此产品的最大购买数量，不能生成订单",201007:"小于此产品的最少购买数量，不能生成订单",201008:"本产品携程不开发票，不能生成订单",201009:"发票创建失败，不能生成订单",201010:"发票信息有误，不能生成订单",201012:"本产品每个手机号码仅限购买一次",201011:"产品属0元团购，一个手机号只能预订一次",301e3:"订单取消成功",301001:"订单不属于用户或订单不存在",301002:"订单状态为非新订单",301003:"取消订单失败,订单状态修改失败",301004:"订单删除失败",301005:"订单删除成功",301006:"生成订单失败",301007:"订单状态修改失败",301008:"订单未查到支付记录",301009:"订单不存在",301010:"该订单已在处理中",401e3:"券号或者订单不存在或已更新，券取消失败",401001:"更新订单失败，券取消失败",401002:"更新券号失败，券取消失败",401003:"券使用失败",401004:"现渠道和此张券应属于的渠道不同，不能取消券",401005:"券取消失败",401006:"此张券已使用，不能取消券",401007:"此张券已取消，不能再次取消券",401008:"此张券已作废，不能取消券",401009:"券号已有预约记录,不能使用",401010:"券状态:已过期超过两天,不可使用",401011:"订单类型错误(1为携程收款，2为对方收款)",501e3:"联盟信息错误，无法取消券",501001:"更新联盟信息失败，未能生成订单",501002:"生成券号时发生异常，未能生成订单",601e3:"信用卡发送扣款请求失败",601001:"存在重复流水号",601002:"保存信用卡信息错误",601003:"增加支付记录失败",601004:"调用支付接口失败"};T={submitTitle:"订单提交",submitTip:"由于您长时间未提交订单，数据可能已经过时，请返回重新选择",pageTitle:"订单填写",giftCard:"携程礼品卡",cash:"现金",alertTitle:"提示信息",leaveTips:"您的订单尚未完成，确定要离开吗？",cancel:"取消",sure:"确定",telTips:"请填写正确的手机号码",failTips:"抱歉，订单未能成功提交，请重试！",timeoutTips:"非常抱歉，由于您刚才提交的服务已超时，请稍后在“我的携程”中查看订单信息或拨打服务电话400-008-6666，以确认您的订单是否提交成功。",couponCount:"(<%=count%>张)",phoneListTitle:"选择手机号",dateNone:"请选择游玩日期",telNone:"请输入手机号码",telError:"请输入正确的手机号码",nameNone:"请输入取票人姓名",nameError:"请输入正确的取票人姓名",submitting:"提交中...",selectDateTitle:"选择日期",submitError:"网络不给力，请稍后再试"};var F=o.create("TuanBaseView"),V=F.extend({pageid:"214015",hpageid:"215015",tpl:p,latlon:null,render:function(){var e=this,t=D.get(),i=y.getUser(),n=x.get(),o=P.get();this.store=t,t&&t.id?(t.min=t.min>H.min?t.min:H.min,t.max=t.max<H.max?H.max:t.max,t.curNum=o&&o.curNum||t.min,t.tel=o&&o.tel||i&&(i.BMobile||i.Mobile)||"",t.retainTwoDecimal=L,t.user=i,t.isLogin=y.isLogin(),t.invoice=C.get(),t.invoiceText=t.invoiceText||null,t.isInApp=N,t.coupon=n&&n.pid===t.id?n:void 0,this.pid=t.id,this.price=t.price.dPrice,this.$el.html($.trim(_.template(this.tpl,t))),this.els={curNumDom:this.$el.find("#J_curNum"),numStepDom:this.$el.find(".J_numberStep"),pPriceDom:this.$el.find("#J_pPrice"),totalPriceDom:this.$el.find("#J_totalPrice"),telDom:this.$el.find("#J_tel"),submitBtn:this.$el.find("#J_submitOrder"),couponCount:this.$el.find("#J_couponCount"),couponAmount:this.$el.find("#J_couponAmount"),selectDate:this.$el.find(".J_selectDate"),ticketUserDom:this.$el.find("#J_ticketUser")},y.isLogin()&&this.getCouponList(function(t){e.els.couponCount.html(_.template(T.couponCount,{count:t}))}),this._createNumberStep(),this.initValidator()):(this.alert.setViewData({title:T.submitTitle,message:T.submitTip,buttons:[{text:"知道了",click:function(){var t=D.get();t&&t.id?e.forwardJump("detail","/webapp/tuan/detail/"+t.id+".html"):e.forwardJump("list","/webapp/tuan/list"),this.hide()}}]}),this.alert.show())},isFreeProduct:function(){return this.price<=0},events:{"click #J_submitOrder":"goNextStep","click #J_invoice":function(){this.forwardJump("invoice","/webapp/tuan/invoice")},"click #J_coupon":function(){this.forwardJump("coupon","/webapp/tuan/coupon")},"click .J_loginBtn":"loginAction","click #J_selectContact":"selectContactNew","click .J_selectDate":"selectDate"},initValidator:function(){var e=this;this.validator.removeAllFields(),this.els.selectDate.length&&this.validator.addField(new I({dom:e.els.selectDate,rules:[b],onCheck:function(t,i){t?e._addOrRemoveHighLight(i.dom,!1):e.showToast(T.dateNone,3,function(){e._addOrRemoveHighLight(i.dom,!0),i.dom.focus()})}})),this.els.ticketUserDom.length&&this.validator.addField(new I({dom:e.els.ticketUserDom,rules:[b,function(e){return e.length<=10}],onCheck:function(t,i){var n="";t?e._addOrRemoveHighLight(i.dom,!1):(n=0==i.rule?T.nameNone:T.nameError,e.showToast(n,3,function(){e._addOrRemoveHighLight(i.dom,!0),i.dom.focus()}))}})),this.validator.addField(new I({dom:e.els.telDom,rules:[b,t.utility.validate.isMobile],onCheck:function(t,i){var n="";t?e._addOrRemoveHighLight(i.dom,!1):(n=0==i.rule?T.telNone:T.telError,e.showToast(n,3,function(){e._addOrRemoveHighLight(i.dom,!0),i.dom.focus()}))}}))},_addOrRemoveHighLight:function(e,t){e.closest("li")[t?"addClass":"removeClass"]("errorli")},onCreate:function(){this.validator=new v},getTuanDetail:function(t,i){var i="function"===$.type(i)?i.bind(this):function(){};O.setParam({id:t,environment:e.environment}),this.showLoading(),O.excute(function(){i(),this.hideLoading()},function(e){var t=e.msg?e.msg:"啊哦,数据加载出错了!",n=this;this.showHeadWarning("团购详情",t,function(){n.cancelOrder()}),this.hideLoading(),i()},!1,this)},loadTuan:function(){this.render(),this.isFreeProduct()&&(this.numberStep.disable(),this.$el.find("#J_invoice").hide()),this.store&&this.store.id&&(this.isIOS7()&&this._fixIOS7Bug(),i(this.els.telDom))},onLoad:function(t){var i=Lizard.P("productid")||Lizard.P("detailid");this.refer=t,this._setPageView(),i&&+i>0?(e.saveUnion(),this.getTuanDetail(i,this.loadTuan)):this.loadTuan()},selectContactNew:function(){var e=this;E.chooseContactFromAddressbook({callback:function(t){var i;t&&!_.isEmpty(t)&&(void 0===t.name&&t.phoneList&&!t.phoneList.length?e.showToast("无法访问通讯录，导入失败"):t.phoneList&&t.phoneList.length&&(i=e._formatPhoneList(t.phoneList),1===i.length?e.selectPhoneItem(i[0]):new a({data:i,title:T.phoneListTitle,itemClick:$.proxy(e.selectPhoneItem,e),key:i[0].key}).show()))}})},selectDate:function(){var e=this,t=this.els.selectDate.attr("data-date")||D.getAttr("ckintime"),i="cui_cld_daycrt";this.showLoading(),U.setParam({pid:e.pid,daterange:{sdate:"",edate:""}}),U.excute(function(n){e.hideLoading();var o=n.plist[0].PDList;_.each(o,function(t){t.dateStr=t.date,t.date=new Date(e._convertTimeString(t.date)),t.price=parseInt(t.price,10)}),e.calendar=new f({monthsNum:2,voidInvalid:!0,priceDate:o,header:{title:T.selectDateTitle},onShow:function(){e.hide(),this.$el.find('[data-date="'+t+'"]').addClass(i)},onHide:function(){e.show(),this.remove()},callback:function(t,n,a){var r=e._formatCalendarDate(t)+(n.holiday||n.days);this.$el.find("."+i).removeClass(i),a.addClass(i),e.els.selectDate.val(r).attr("data-date",n.value),D.setAttr("ckintimetxt",r),e._storeDailyPrice(o,n.value),e.numberStep.options.onChange(),e._addOrRemoveHighLight(e.els.selectDate),this.hide()}}),e.calendar.show()},function(){e.hideLoading()})},_storeDailyPrice:function(e,t){var i;_.each(e,function(e){return e.dateStr==t?(i=e.price,!1):void 0}),D.setAttr("ckintime",t),D.setAttr("ticketPrice",i||0)},_formatCalendarDate:function(e){return"string"==typeof e&&(e=new Date(this._convertTimeString(e))),e.getMonth()+1+"月"+e.getDate()+"日 "},_convertTimeString:function(e){return e&&e.replace(/-/g,"/")},_formatPhoneList:function(e){return e.map(function(e,t){return e=_.values(e)[0],e=e.replace(/-| /g,""),e.length>11&&(e=e.substr(-11,11)),{key:t+"",val:e}})},selectPhoneItem:function(e){var t=e.val;t&&(this.els.telDom.val(t),this.changeBtnState())},isIOS7:function(){var e=$.os;return e.ios&&7===Math.floor(e.version)},_fixIOS7Bug:function(){var e=$(".order_btnbox");this.els.telDom.add(this.els.ticketUserDom).on("focus",function(){e.css({position:"absolute",bottom:"0px"})}).on("blur",function(){e.css({position:"fixed",bottom:"0px"})})},_setPageView:function(){var e=this;this.header.set({title:T.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.cancelOrder()},homeHandler:function(){e.redirectToIndex()}}})},onShow:function(){this.setTitle(T.pageTitle),this.hideLoading(),N&&this.$el.find("#J_selectContact").show()},onHide:function(){this.hideLoading(),this.hideLoadingLayer()},redirectToIndex:function(){e.tHome()},cancelOrder:function(){var e=this,i=D.get(),n=new t.ui.Alert({title:T.alertTitle,onShow:function(){e.isCanceling=!0},onHide:function(){e.isCanceling=!1},message:T.leaveTips,buttons:[{text:T.cancel,click:function(){this.hide()}},{text:T.sure,click:function(){D.get();this.hide(),e.showLoading(),i&&i.id?e.back({did:i.id}):e.back()}}]})||this.returnAlert;e.isCanceling||n.show()},changeBtnState:function(){return!1},showLoadingLayer:function(e,i){!this.loadingLayer&&(this.loadingLayer=new t.ui.LoadingLayer(function(){e&&e()},i||T.submitting)),this.loadingLayer.show()},hideLoadingLayer:function(){this.loadingLayer&&this.loadingLayer.hide()},goNextStep:function(){var e=y.getUser();this.validator.validate()&&(this.showLoadingLayer(function(){A.abort(),S.abort()}),e&&e.Auth&&!e.IsNonUser?this.submitOrder():this.noMemberLogin($.proxy(this.submitOrder,this)))},submitOrder:function(){var i,n,o=this,a=e.getQuery("from"),r=this.els.telDom.val(),s=this.numberStep.getCurrentNum(),c={OInfo:{User:{UID:""},Product:{Price:{Price:1,CurCode:"RMB"},ProductID:0,Quantity:1},Contact:{Mobile:"13802200000",Email:"",Phone:""},Invoice:{InvoiceHead:"",InvoiceDesc:"",RevAddr:"",RevPerName:"",PostCode:"",ExType:0,ExInfo:{PName:"",CName:"",LName:"",ExpressAmount:{Price:0,CurCode:"RMB"}}},CouponInfo:null,OrderType:1,PaymentVersion:3,PartnerID:0,IsReturnCute:!1,IsMarketPrice:!1,Source:"1",IsInvoice:!1,MemberType:0,UserIP:""},head:{syscode:"09",lang:"01",auth:"",cid:"",ctok:"",cver:"1.0",sid:"8888"}},d=C.get(),u=D.get(),l=y.getUser(),h=w&&w.get();if(P.setAttr("curNum",s),!r||""===r||!t.utility.validate.isMobile(r))return this.hideLoading(),void this.showMessage(T.telTips);if(P.setAttr("tel",r),!u||!u.id)return this.forwardJump("detial","/webapp/tuan/detail/"+o.pid+".html"),void this.hide();if(u.activities&&u.activities.length>0)for(var m in u.activities){var p=u.activities[m];p&&p.type&&+p.type>0&&1==+p.type&&(c.OInfo.IsMarketPrice=!0)}d&&d.needed&&(c.OInfo.IsInvoice=d.needed,c.OInfo.Invoice.InvoiceHead=d.title,c.OInfo.Invoice.RevPerName=d.recipient,c.OInfo.Invoice.RevAddr=d.addr,c.OInfo.Invoice.PostCode=d.zip,i=d.regionText.split(" "),c.OInfo.Invoice.ExInfo.PName=i[0],c.OInfo.Invoice.ExInfo.CName=i[1],c.OInfo.Invoice.ExInfo.LName=i[2],c.OInfo.ItemType=u.pcId,c.OInfo.Invoice.ExType=d.deliveryMethod||0,c.OInfo.Invoice.ExInfo.ExpressAmount.Price=1==d.deliveryMethod?10:0),c.OInfo.Contact.Mobile=r,c.OInfo.Product.Quantity=s,c.OInfo.Product.ProductID=u.id,n=u.ticketPrice?u.ticketPrice:u.price.dPrice-(this.isCouponUsed()?this.store.coupon.amount:0),c.OInfo.Product.Price.Price=parseFloat(n>0?n:0),M.getAttr("auth")&&(c.head.auth=M.getAttr("auth"),c.OInfo.User.UID=l.UserID,c.LoginToken=l.loginToken),h&&(c.OInfo.AllianceInfo={AllianceID:h.AllianceID,OUID:h.OUID,SID:h.SID},c.OInfo.PartnerID=h.PartnerID),a&&(c.url=a),c.OInfo.Source=o._getUAInfo(),this.isCouponUsed()&&(c.OInfo.CouponInfo={CouponCode:this.store.coupon.code});var g=D.getAttr("ckintime"),f=o.els.ticketUserDom.val();g&&f&&(c.OInfo.binfo={name:f,ckintime:g}),this._sendOrderRequest(c)},_getUAInfo:function(){var e=$.os,t=N?"Hybird":"H5",i="other";return e.ios?e.iphone?i="iphone":e.ipad&&(i="ipad"):e.android&&(i=e.tablet?"android":"androidpad"),"client/"+i+"/"+t},_createNumberStep:function(){var e=this,t=e.store.max<H.max?e.store.max:H.max,i=e.store.min>H.min?e.store.min:H.min,n=D.getAttr("curNum")||1;this.numberStep=new g({max:t,min:i,initialVal:i>n?i:n,wrap:e.els.numStepDom,html:'<i class="minus <%if(initialVal <= min ){ %>num_invalid<%} %>" data-flag="-"></i><span id="J_curNum" class="numtext"><%=initialVal %></span><i data-flag="+" class="plus <%if(initialVal >= max ){ %>num_invalid<%} %>"></i>',onChange:function(){var t,i,n,o,a,r=e.store,s=C.get(),c=parseInt(e.$el.find("#J_curNum").text().trim()),d=e.price;e.isCouponUsed()?(o=r.coupon.amount,a=r.coupon.couponType):o=0,D.setAttr("curNum",c),r.activities&&r.activities.length>0&&e.els.pPriceDom[0]&&(t=r.activities[0],i=t.arg*c,e.els.pPriceDom.html(i)),n=L(2===a?parseFloat(D.getAttr("ticketPrice")||d)*c-o:(parseFloat(D.getAttr("ticketPrice")||d)-o)*c),n=(n>0?n:0)+(s&&1==s.deliveryMethod?10:0),e.els.totalPriceDom.html(n>0?n:0),e.els.couponAmount.length&&(3===a?e.els.couponAmount.html(L(o*c)):2===a&&e.els.couponAmount.html(L(o)))}}),this.numberStep.triggerChange()},_sendOrderRequest:function(e){var t=this;S.setParam(e),S.excute(function(e){var i,n,o,a,r=11,s=M.getAttr("auth"),c=C.get(),d={};a=y.isLogin()?0:1,"success"===e.Status.toLowerCase()?(i=e.GOrder.OID,o=e.GOrder.Price,n=e.GOrder.Price.TotalAmount.Price,d={oid:i,bustype:r,requestid:e.RequestId,islogin:a,from:"",rback:"",sback:"",eback:"",auth:s,title:t.store.name,recall:"Group.Switch.LTPPayment.LTPOrderProcessWS",amount:n,extno:e.GOrder.ExNo,needInvoice:!!c&&c.needed,payTypeList:e.GOrder.PayType,subPayTypeList:e.GOrder.SubPayType},n>0?R.submit(t,d,{IsRealPay:e.IsRealPay}):t.forwardJump("bookingsuccess","/webapp/tuan/bookingsuccess/"+i+".html")):t.showToast("failure"==e.ResponseStatus.Ack.toLowerCase()&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0?t.getMsgByCode(e.ResponseStatus.Errors[0].ErrorCode):"订单提交失败请重试!"),t.hideLoadingLayer(),t.hideLoading(),t.isCouponUsed()&&t._clearUsedCoupon()},function(e){t.hideLoading(),t.hideLoadingLayer();var i="timeout"===e.statusText?T.timeoutTips:T.failTips;e.ResponseStatus&&"failure"==e.ResponseStatus.Ack.toLowerCase()&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0&&(i=t.getMsgByCode(e.ResponseStatus.Errors[0].ErrorCode),i||(i=e.ResponseStatus.Errors[0].Message)),t.showToast(i)},this,!0)},loginAction:function(){var e=this;y.isLogin()||J.memberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent("/webapp/tuan/booking"),callback:function(){e.onLoad(e.refer)}})},h5NoMemberLogin:function(e){var t=this;A.excute(function(){e&&e.call(t)},function(){t.hideLoadingLayer(),t.showToast("自动登录失败")},!1,t,function(){t.hideLoadingLayer()})},noMemberLogin:function(e){N?J.nonMemberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent(location.href),callback:e}):this.h5NoMemberLogin(e)},getMsgByCode:function(e){return B[e]||""},_clearUsedCoupon:function(){delete this.store.coupon,x.remove()},isCouponUsed:function(){var e=this.store.coupon;return e&&"object"==typeof e&&!e.isNotUse},getCouponList:function(e){k.setParam({pid:this.pid,head:k.getHead().get()}),k.execute(function(t){var i=t.coupons&&t.coupons.length;i&&e&&e(i)},function(){},!1,this)}});return V});