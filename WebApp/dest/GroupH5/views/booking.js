define(["TuanApp","c","cUIInputClear","TuanBaseView","cCommonPageFactory","cUIScrollRadioList","cWidgetGuider","cWidgetMember","cUserModel","cUtility","cWidgetFactory","CommonStore","TuanStore","TuanModel","text!BookingTpl","NumberStep","cHolidayPriceCalendar","ValidatorUtil","FieldUtil","Payment"],function(e,t,i,o,n,a,s,r,c,u,d,l,h,m,p,f,g,I,v){function L(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(100*t)/100}function b(e){return!!e}var T,P,C,y=h.TuanOrderInfoStore.getInstance(),O=h.TuanInvoiceStore.getInstance(),w=l.UserStore.getInstance(),S=h.TuanDetailsStore.getInstance(),x=l.UnionStore&&l.UnionStore.getInstance(),k=m.TuanCreateOrder.getInstance(),D=m.TuanDetailModel.getInstance(),U=m.TuanCouponListModel.getInstance(),N=h.TuanSelectedCouponStore.getInstance(),A=c.NotUserLoginModel.getInstance(),R=u.isInApp(),M=l.HeadStore.getInstance(),E=d.create("Payment"),J=d.create("Guider"),H=d.create("Member"),F=/^1[3458]\d{9}$/,B={max:9,min:1};return T={submitTitle:"订单提交",submitTip:"由于您长时间未提交订单，数据可能已经过时，请返回重新选择",pageTitle:"订单填写",giftCard:"携程礼品卡",cash:"现金",alertTitle:"提示信息",leaveTips:"您的订单尚未完成，确定要离开吗？",cancel:"取消",sure:"离开",telTips:"请填写正确的手机号码",failTips:"抱歉，订单未能成功提交，请重试！",timeoutTips:"非常抱歉，由于您刚才提交的服务已超时，请稍后在“我的携程”中查看订单信息或拨打服务电话400-008-6666，以确认您的订单是否提交成功。",couponCount:"(<%=count%>张)",phoneListTitle:"选择手机号",dateNone:"请选择游玩日期",telNone:"请输入手机号码",telError:"请输入正确的手机号码",nameNone:"请输入取票人姓名",nameError:"请输入正确的取票人姓名",submitting:"提交中...",selectDateTitle:"选择日期",submitError:"网络不给力，请稍后再试"},P=n.create("TuanBaseView"),C=P.extend({pageid:"214015",hpageid:"215015",tpl:p,latlon:null,render:function(){var e=this,t=S.get(),i=w.getUser(),o=N.get(),n=y.get();this.store=t,t&&t.id?(t.min=t.min>B.min?t.min:B.min,t.max=t.max<B.max?t.max:B.max,t.curNum=n&&n.curNum||t.min,t.tel=localStorage.getItem("TUAN_USER_MOBILE")||n&&n.tel||i&&(i.BMobile||i.Mobile)||"",t.retainTwoDecimal=L,t.user=i,t.isLogin=w.isLogin(),t.invoice=O.get(),t.invoiceText=t.invoiceText||null,t.isInApp=R,t.coupon=o&&o.pid===t.id?o:void 0,this.pid=t.id,this.price=t.price.dPrice,this.$el.html($.trim(_.template(this.tpl,t))),this.els={curNumDom:this.$el.find("#J_curNum"),numStepDom:this.$el.find(".J_numberStep"),pPriceDom:this.$el.find("#J_pPrice"),totalPriceDom:this.$el.find("#J_totalPrice"),telDom:this.$el.find("#J_tel"),submitBtn:this.$el.find("#J_submitOrder"),couponCount:this.$el.find("#J_couponCount"),couponAmount:this.$el.find("#J_couponAmount"),selectDate:this.$el.find(".J_selectDate"),ticketUserDom:this.$el.find("#J_ticketUser")},w.isLogin()&&this.getCouponList(function(t){e.els.couponCount.html(_.template(T.couponCount,{count:t}))}),this._createNumberStep(),this.initValidator()):(this.alert.setViewData({title:T.submitTitle,message:T.submitTip,buttons:[{text:"知道了",click:function(){var t=S.get();t&&t.id?e.forwardJump("detail","/webapp/tuan/detail/"+t.id+".html"):e.forwardJump("list","/webapp/tuan/list"),this.hide()}}]}),this.alert.show())},isFreeProduct:function(){return this.price<=0},events:{"click #J_submitOrder":"goNextStep","click #J_invoice":function(){this.forwardJump("invoice","/webapp/tuan/invoice")},"click #J_coupon":function(){this.forwardJump("coupon","/webapp/tuan/coupon")},"click .J_loginBtn":"loginAction","input #J_tel":function(e){var t=e.target&&e.target.value;F.test(t)&&localStorage.setItem("TUAN_USER_MOBILE",t)},"click #J_selectContact":"selectContactNew","click .J_selectDate":"selectDate"},initValidator:function(){var e,i=this;this.validator.removeAllFields(),e={date:function(e,t){e?i._addOrRemoveHighLight(t.dom,!1):i.showToast(T.dateNone,3,function(){i._addOrRemoveHighLight(t.dom,!0),t.dom.focus()})},user:function(e,t){var o="";e?i._addOrRemoveHighLight(t.dom,!1):(o=0===t.rule?T.nameNone:T.nameError,i.showToast(o,3,function(){i._addOrRemoveHighLight(t.dom,!0),t.dom.focus()}))},tel:function(e,t){var o="";e?i._addOrRemoveHighLight(t.dom,!1):(o=0===t.rule?T.telNone:T.telError,i.showToast(o,3,function(){i._addOrRemoveHighLight(t.dom,!0),t.dom.focus()}))}},this.els.selectDate.length&&this.validator.addField(new v({dom:i.els.selectDate,rules:[b],onCheck:function(e,t){e?i._addOrRemoveHighLight(t.dom,!1):i.showToast(T.dateNone,3,function(){i._addOrRemoveHighLight(t.dom,!0),t.dom.focus()})}})),this.els.ticketUserDom.length&&this.validator.addField(new v({dom:i.els.ticketUserDom,rules:[b,function(e){return e.length<=10}],onCheck:e.user})),this.validator.addField(new v({dom:i.els.telDom,rules:[b,t.utility.validate.isMobile],onCheck:e.tel}))},_addOrRemoveHighLight:function(e,t){e.closest("li")[t?"addClass":"removeClass"]("errorli")},onCreate:function(){this.validator=new I},getTuanDetail:function(t,i){var o=this;i="function"===$.type(i)?i.bind(this):function(){},D.setParam({id:t,environment:e.environment}),this.showLoading(),D.excute(function(){i(),o.hideLoading()},function(e){var t=e.msg?e.msg:"啊哦,数据加载出错了!";o.showToast(t,3,function(){o.cancelOrder()}),o.hideLoading(),i()},!1,this)},loadTuan:function(){this.render(),this.isFreeProduct()&&(this.numberStep.disable(),this.$el.find("#J_invoice").hide()),this.store&&this.store.id&&(this._fixIOS7Bug(),i(this.els.telDom,"",function(){localStorage.removeItem("TUAN_USER_MOBILE")}))},onLoad:function(t){var i=Lizard.P("productid")||Lizard.P("detailid");this.refer=t,this._setPageView(),i&&+i>0?(e.saveUnion(),this.getTuanDetail(i,this.loadTuan)):this.loadTuan()},selectContactNew:function(){var e=this;J.chooseContactFromAddressbook({callback:function(t){t&&!_.isEmpty(t)&&(void 0===t.name&&t.phoneList&&!t.phoneList.length?e.showToast("无法访问通讯录，导入失败"):t.phoneList&&t.phoneList.length&&e.operateContacts(e._formatPhoneList(t.phoneList)))}})},operateContacts:function(e){1===e.length?this.selectPhoneItem(e[0]):new a({data:e,title:T.phoneListTitle,itemClick:$.proxy(this.selectPhoneItem,this),key:e[0].key}).show()},selectDate:function(){this.forwardJump("calendar","/webapp/tuan/calendar",{})},_formatPhoneList:function(e){return e.map(function(e,t){return e=_.values(e)[0],e=e.replace(/-| /g,""),e.length>11&&(e=e.substr(-11,11)),{key:t+"",val:e}})},selectPhoneItem:function(e){var t=e.val;t&&(this.els.telDom.val(t),y.setAttr("tel",t))},isIOS7:function(){var e=$.os;return e.ios&&7===Math.floor(e.version)},_fixIOS7Bug:function(){var e=$(".J_orderbtnbox");this.els.telDom.add(this.els.ticketUserDom).on("focus",function(){e.css({position:"absolute",bottom:"-45px"})}).on("blur",function(){e.css({position:"fixed",bottom:"0px"})})},_setPageView:function(){var e=this;this.header.set({title:T.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.cancelOrder()},homeHandler:function(){e.redirectToIndex()}}})},onShow:function(){this.setTitle(T.pageTitle),this.hideLoading(),R&&this.$el.find("#J_selectContact").show()},onHide:function(){this.hideLoading(),this.hideLoadingLayer()},redirectToIndex:function(){e.tHome()},cancelOrder:function(){var e=this,i=S.get(),o=new t.ui.Alert({title:T.alertTitle,onShow:function(){e.isCanceling=!0},onHide:function(){e.isCanceling=!1},message:T.leaveTips,buttons:[{text:T.cancel,click:function(){this.hide()}},{text:T.sure,click:function(){this.hide(),e.showLoading(),i&&i.id?e.back({did:i.id},!0):e.back()}}]})||this.returnAlert;e.isCanceling||o.show()},showLoadingLayer:function(e,i){!this.loadingLayer&&(this.loadingLayer=new t.ui.LoadingLayer(function(){e&&e()},i||T.submitting)),this.loadingLayer.show()},hideLoadingLayer:function(){this.loadingLayer&&this.loadingLayer.hide()},goNextStep:function(){var e=w.getUser();this.validator.validate()&&(this.showLoadingLayer(function(){A.abort(),k.abort()}),e&&e.Auth&&!e.IsNonUser?this.submitOrder():this.noMemberLogin($.proxy(this.submitOrder,this)))},submitOrder:function(){var i,o,n=this,a=e.getQuery("from"),s=this.els.telDom.val(),r=this.numberStep.getCurrentNum(),c={OInfo:{User:{UID:""},Product:{Price:{Price:1,CurCode:"RMB"},ProductID:0,Quantity:1},Contact:{Mobile:"13802200000",Email:"",Phone:""},Invoice:{InvoiceHead:"",InvoiceDesc:"",RevAddr:"",RevPerName:"",PostCode:"",ExType:0,ExInfo:{PName:"",CName:"",LName:"",ExpressAmount:{Price:0,CurCode:"RMB"}}},CouponInfo:null,OrderType:1,PaymentVersion:3,PartnerID:0,IsReturnCute:!1,IsMarketPrice:!1,Source:"1",IsInvoice:!1,MemberType:0,UserIP:""},head:{syscode:"09",lang:"01",auth:"",cid:"",ctok:"",cver:"1.0",sid:"8888"}},u=O.get(),d=S.get(),l=w.getUser(),h=x&&x.get();if(y.setAttr("curNum",r),!s||""===s||!t.utility.validate.isMobile(s))return this.hideLoading(),void this.showMessage(T.telTips);if(y.setAttr("tel",s),!d||!d.id)return this.forwardJump("detial","/webapp/tuan/detail/"+n.pid+".html"),void this.hide();d.activities&&_.each(d.activities,function(e){e&&e.type&&+e.type>0&&1===parseInt(e.type)&&(c.OInfo.IsMarketPrice=!0)}),u&&u.needed&&(c.OInfo.IsInvoice=u.needed,c.OInfo.Invoice.InvoiceHead=u.title,c.OInfo.Invoice.RevPerName=u.recipient,c.OInfo.Invoice.RevAddr=u.addr,c.OInfo.Invoice.PostCode=u.zip,i=u.regionText.split(" "),c.OInfo.Invoice.ExInfo.PName=i[0],c.OInfo.Invoice.ExInfo.CName=i[1],c.OInfo.Invoice.ExInfo.LName=i[2],c.OInfo.ItemType=d.pcId,c.OInfo.Invoice.ExType=u.deliveryMethod||0,c.OInfo.Invoice.ExInfo.ExpressAmount.Price=1==u.deliveryMethod?10:0),c.OInfo.Contact.Mobile=s,c.OInfo.Product.Quantity=r,c.OInfo.Product.ProductID=d.id,o=d.ticketPrice?d.ticketPrice:d.price.dPrice-(this.isCouponUsed()?this.store.coupon.amount:0),c.OInfo.Product.Price.Price=parseFloat(o>0?o:0),M.getAttr("auth")&&(c.head.auth=M.getAttr("auth"),c.OInfo.User.UID=l.UserID,c.LoginToken=l.loginToken),h&&(c.OInfo.AllianceInfo={AllianceID:h.AllianceID,OUID:h.OUID,SID:h.SID},c.OInfo.PartnerID=h.PartnerID),a&&(c.url=a),c.OInfo.Source=n._getUAInfo(),this.isCouponUsed()&&(c.OInfo.CouponInfo={CouponCode:this.store.coupon.code});var m=S.getAttr("ckintime"),p=n.els.ticketUserDom.val();m&&p&&(c.OInfo.binfo={name:p,ckintime:m}),this._sendOrderRequest(c)},_getUAInfo:function(){var e=$.os,t=R?"Hybird":"H5",i="other";return e.ios?e.iphone?i="iphone":e.ipad&&(i="ipad"):e.android&&(i=e.tablet?"android":"androidpad"),"client/"+i+"/"+t},_createNumberStep:function(){var e=this,t=e.store.max<B.max?e.store.max:B.max,i=e.store.min>B.min?e.store.min:B.min,o=S.getAttr("curNum")||1;this.numberStep=new f({max:t,min:i,initialVal:i>o?i:o,wrap:e.els.numStepDom,html:'<i class="minus <%if(initialVal <= min ){ %>num_invalid<%} %>" data-flag="-"></i><span id="J_curNum" class="numtext"><%=initialVal %></span><i data-flag="+" class="plus <%if(initialVal >= max ){ %>num_invalid<%} %>"></i>',onChange:function(){var t,i,o,n,a,s=e.store,r=O.get(),c=parseInt(e.$el.find("#J_curNum").text().trim()),u=e.price;e.isCouponUsed()?(n=s.coupon.amount,a=s.coupon.couponType):n=0,S.setAttr("curNum",c),s.activities&&s.activities.length>0&&e.els.pPriceDom[0]&&(t=s.activities[0],i=t.arg*c,e.els.pPriceDom.html(i)),o=L(2===a?parseFloat(S.getAttr("ticketPrice")||u)*c-n:(parseFloat(S.getAttr("ticketPrice")||u)-n)*c),o=(o>0?o:0)+(r&&1==r.deliveryMethod?10:0),e.els.totalPriceDom.html(o>0?o:0),e.els.couponAmount.length&&(3===a?e.els.couponAmount.html(L(n*c)):2===a&&e.els.couponAmount.html(L(n)))}}),this.numberStep.triggerChange()},_sendOrderRequest:function(e){var t=this;k.setParam(e),k.excute(function(e){var i,o,n,a=11,s=M.getAttr("auth"),r=O.get(),c={};n=w.isLogin()?0:1,"success"===e.Status.toLowerCase()?(i=e.GOrder.OID,o=e.GOrder.Price.TotalAmount.Price,c={oid:i,bustype:a,requestid:e.RequestId,islogin:n,from:"",rback:"",sback:"",eback:"",auth:s,title:t.store.name,recall:"Group.Switch.LTPPayment.LTPOrderProcessWS",amount:o,extno:e.GOrder.ExNo,needInvoice:!!r&&r.needed,payTypeList:e.GOrder.PayType,subPayTypeList:e.GOrder.SubPayType},o>0?E.submit(t,c,{IsRealPay:e.IsRealPay}):t.forwardJump("bookingsuccess","/webapp/tuan/bookingsuccess/"+i+".html")):t.showToast("failure"==e.ResponseStatus.Ack.toLowerCase()&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0?this.getErrorMessage(e.ResponseStatus.Errors[0]):"订单提交失败请重试!"),t.hideLoadingLayer(),t.hideLoading(),t.isCouponUsed()&&t._clearUsedCoupon()},function(e){t.hideLoading(),t.hideLoadingLayer();var i="timeout"===e.statusText?T.timeoutTips:T.failTips;e.ResponseStatus&&"failure"==e.ResponseStatus.Ack.toLowerCase()&&e.ResponseStatus.Errors&&e.ResponseStatus.Errors.length>0&&(i=this.getErrorMessage(e.ResponseStatus.Errors[0])),t.showToast(i)})},loginAction:function(){var e=this;w.isLogin()||H.memberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent("/webapp/tuan/booking"),callback:function(){e.onLoad(e.refer)}})},h5NoMemberLogin:function(e){var t=this;A.excute(function(){e&&e.call(t)},function(){t.hideLoadingLayer(),t.showToast("自动登录失败")},!1,t,function(){t.hideLoadingLayer()})},noMemberLogin:function(e){R?H.nonMemberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent(location.href),callback:e}):this.h5NoMemberLogin(e)},_clearUsedCoupon:function(){delete this.store.coupon,N.remove()},isCouponUsed:function(){var e=this.store.coupon;return e&&"object"==typeof e&&!e.isNotUse},getCouponList:function(e){U.setParam({pid:this.pid,head:U.getHead().get()}),U.execute(function(t){var i=t.coupons&&t.coupons.length;i&&e&&e(i)},function(){},!1,this)}})});