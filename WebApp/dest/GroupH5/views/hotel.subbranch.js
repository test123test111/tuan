define(["TuanApp","libs","c","cUtility","cWidgetFactory","cGeoService","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","CommonStore","StoreManage","text!HotelSubbranchTpl","CallPhone","cWidgetGeolocation"],function(t,e,n,o,a,i,s,r,c,l,h,d,u,p){function m(t){return t.toISOString().substring(0,10).replace(/-/g,"")}var f={pageTitle:"商户列表"},g=n.ui,w=(n.base,o.isInApp()),v="ani_rotation",b=s.GroupGeolocation.getInstance(),k=s.TuanDetailsStore.getInstance(),y=l.TuanBranchOfficeModel.getInstance(),C=i.GeoLocation,T=a.create("Guider"),S=c.create("TuanBaseView"),H=S.extend({events:{"click .J_showMap":"showMap","click .J_jumpHotel":"jumpHotel","click .J_busiCity":"showHotel","click #J_relocation":"relocation"},onCreate:function(){this.htmlfun=_.template(u)},onLoad:function(){this.cityId=Lizard.P("cityid"),null!=k.get()?this.showBranch():this.backAction(),this.setHeader()},setHeader:function(){var t=this;this.header.set({title:f.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){t.backAction()},homeHandler:function(){t.backHome()}}})},showBranch:function(t){var e,n=this,o=this.cityId,a=t||b.getAttr("gps")||{};this.showLoading(),e={id:k.get().id,pos:{lon:a.lng,lat:a.lat,type:3,name:a.city}},o&&(e.cityid=o),y.setParam(e),y.excute(function(t){if(n.hideLoading(),!t.groups.length)return void n.showMessage("抱歉，数据加载失败，请重试!");var e=d.getCurrentCity();e.CityName&&(a.CityName=e.CityName),n.$el.html($.trim(n.htmlfun({data:t.groups,gps:a,cityId:o}))),n.CallPhone=new p({view:this})},function(t){var e=t.msg?t.msg:"啊哦,数据加载出错了!",n=this;this.showHeadWarning("团购分店信息",e,function(){n.backAction()}),this.hideLoading()},!0,this)},showPhone:function(t){var e,n=new Array,o=$(t.currentTarget).data("tel").toString();o=o.replace(/，/g,","),_.each(o.split(","),function(t){n.push(" <a href='tel:"+t+"'>"+t+"</a>"),e&&""!=e||(e=t)}),this.alert=new g.Alert({title:"拨打电话",message:' <div id="tuan_tel">'+n.join("")+"</div>",buttons:[{text:"取消",click:function(){this.hide()}},{text:'<a href="tel:'+e+'" data-phone="'+e+'">拨打</a>',click:function(t){this.hide(),T.apply({hybridCallback:function(){var e="data-phone",n=$(t.target);return n.attr(e)||(n=n.find("["+e+"]")),t.preventDefault(),T.callPhone({tel:n.attr(e)}),!1},callback:function(){return!0}})}}]}),this.alert.show()},onShow:function(){},onHide:function(){C.UnSubscribe("tuan/subbranch")},backAction:function(){var t={},e=k.getAttr("id"),n=this.cityId;e&&(t.id=e),n&&(t.cityid=n),this.back(t)},backHome:function(){t.tHome()},showMap:function(t){var e=$(t.currentTarget),n=e.attr("data-coords").split(","),o=e.attr("data-hotel-name");window.mapdata={Longitude:n[0],Latitude:n[1],hotelName:o},this.forwardJump("hotelmap","/webapp/tuan/hotelmap?lon="+n[0]+"&lat="+n[1]+"&hotelName="+o)},jumpHotel:function(e){var n=$(e.currentTarget).data("id");if(n){var o=new Date,a=new Date(o.setDate(o.getDate()+1)),i=encodeURIComponent(location.href),s=w?"ctrip://wireless/InlandHotel?hotelDataType=1&checkInDate="+m(new Date)+"&checkOutDate="+m(a)+"&hotelId="+n+"&from="+i:"http://m.ctrip.com/webapp/hotel/hoteldetail/"+n+".html?from="+i,r=this.getHistory();r.stack.pop(),t.jumpToPage(s,this)}},showHotel:function(t){var e,n=$(t.currentTarget),o=n.find(".J_arrow");o.hasClass("arrow_skin01_up")?(o.toggleClass("arrow_skin01_up arrow_skin01_down"),n.removeClass("J_sticky").removeClass("busi_fixed").css("top","0").next().hide(),n.parent().css("padding-top","0"),document.removeEventListener("scroll",this.onScroll)):(e=this.$el.find(".arrow_skin01_up"),e.toggleClass("arrow_skin01_up arrow_skin01_down"),e.parent().removeClass("J_sticky").removeClass("busi_fixed").css("top","0").next().hide(),e.parent().parent().css("padding-top","0"),o.toggleClass("arrow_skin01_down arrow_skin01_up"),n.addClass("J_sticky").next().show(),document.addEventListener("scroll",this.onScroll)),this.onScroll()},onScroll:function(){var t=document.querySelector(".J_sticky");t&&(window.scrollY>=t.parentNode.offsetTop?(t.classList.add("busi_fixed"),t.parentNode.style.paddingTop="45px",!w&&(t.style.top="48px")):(t.classList.remove("busi_fixed"),t.parentNode.style.paddingTop="0",!w&&(t.style.top="0")))},relocation:function(t){var e=this,n=$(t.target),o=this.$el.find("#J_gpsAddr");n.addClass(v),C.Subscribe("tuan/subbranch",{onComplete:function(t){n.removeClass(v),o.html("您的位置："+(t.address||"未知位置")),e.showBranch(t)},onError:function(){n.removeClass(v),o.html("暂无定位信息"),e.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")},onPosComplete:function(){},onPosError:function(){n.removeClass(v),o.html("暂无定位信息"),e.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")}},this,!0)}});return H});