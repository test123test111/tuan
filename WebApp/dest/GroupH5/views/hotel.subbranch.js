define(["TuanApp","libs","c","cUtility","cWidgetFactory","cGeoService","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","CommonStore","StoreManage","text!HotelSubbranchTpl","CallPhone","cWidgetGeolocation"],function(t,e,o,n,i,a,s,r,c,l,d,h,u,p){function m(t){return t.toISOString().substring(0,10).replace(/-/g,"")}var g,f={pageTitle:"商户列表"},w=n.isInApp(),v="ani_rotation",y=s.GroupGeolocation.getInstance(),C=s.TuanDetailsStore.getInstance(),b=l.TuanBranchOfficeModel.getInstance(),k=a.GeoLocation,T={up:"arrow_skin01_up",down:"arrow_skin01_down"},S=c.create("TuanBaseView");return g=S.extend({events:{"click .J_showMap":"showMap","click .J_jumpHotel":"jumpHotel","click .J_busiCity":"showHotel","click #J_relocation":"relocation"},onCreate:function(){this.htmlfun=_.template(u)},onLoad:function(){this.cityId=Lizard.P("cityid"),null!==C.get()?this.showBranch():this.backAction(),this.setHeader()},setHeader:function(){var t=this;this.header.set({title:f.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){t.backAction()},homeHandler:function(){t.backHome()}}})},showBranch:function(t){var e,o=this,n=this.cityId,i=t||y.getAttr("gps")||{};this.showLoading(),e={id:C.getAttr("id"),pos:{lon:i.lng,lat:i.lat,type:3,name:i.city}},n&&(e.cityid=n),b.setParam(e),b.excute(function(t){if(o.hideLoading(),!t.groups.length)return void o.showMessage("抱歉，数据加载失败，请重试!");var e=h.getCurrentCity();e.CityName&&(i.CityName=e.CityName),o.$el.html($.trim(o.htmlfun({data:t.groups,gps:i,cityId:n}))),document.addEventListener("scroll",o.onScroll),o.CallPhone=new p({view:this})},function(t){var e=t.msg?t.msg:"啊哦,数据加载出错了!";o.showToast(e,3,function(){o.backAction()}),o.hideLoading()},!0,this)},onShow:function(){},onHide:function(){k.UnSubscribe("tuan/subbranch"),this.CallPhone&&this.CallPhone.hideMask()},backAction:function(){var t={},e=C.getAttr("id"),o=this.cityId;e&&(t.did=e),o&&(t.cityid=o),this.back(t)},backHome:function(){t.tHome()},showMap:function(t){var e=$(t.currentTarget),o=e.attr("data-coords").split(","),n=o[0],i=o[1],a=e.attr("data-hotel-name");this.showCommonMap(a,n,i)},jumpHotel:function(e){var o=$(e.currentTarget).data("id");if(o){var n=new Date,i=new Date(n.setDate(n.getDate()+1)),a=encodeURIComponent(location.href),s=w?"ctrip://wireless/InlandHotel?hotelDataType=1&checkInDate="+m(new Date)+"&checkOutDate="+m(i)+"&hotelId="+o+"&from="+a:"http://m.ctrip.com/webapp/hotel/hoteldetail/"+o+".html?from="+a,r=this.getHistory();r.stack.pop(),t.jumpToPage(s,this)}},showHotel:function(t){var e,o,n=$(t.currentTarget),i=n.find(".J_arrow"),a=T.up+" "+T.down,s=document.querySelector("#J_gpsAddr");i.hasClass(T.up)?(i.toggleClass(a),n.removeClass("J_sticky").removeClass("busi_fixed").css("top","0").next().hide(),n.parent().css("padding-top","0"),document.removeEventListener("scroll",this.onScroll)):(e=this.$el.find("."+T.up),e.toggleClass(a),o=e.parent().parent(),o.removeClass("J_sticky").removeClass("busi_fixed").css("top","0").next().hide(),o.parent().css("padding-top","0"),i.toggleClass(a),n.addClass("J_sticky").next().show(),document.body.scrollTop=w?n.offset().top-(s?30:0):n.offset().top-(s?78:0),document.addEventListener("scroll",this.onScroll)),this.onScroll()},onScroll:function(){var t=document.querySelector(".J_sticky");if(t){var e=document.querySelector("#J_gpsAddr"),o=t.parentNode,n=o.offsetTop;window.scrollY>=n&&window.scrollY<=n+o.getBoundingClientRect().height-40?(t.classList.add("busi_fixed"),t.parentNode.style.paddingTop="45px",t.style.top=w?e?"30px":"0":e?"78px":"48px"):(t.classList.remove("busi_fixed"),t.parentNode.style.paddingTop="0",!w&&(t.style.top="0"))}},relocation:function(t){var e=this,o=$(t.target),n=this.$el.find("#J_gpsAddr");o.addClass(v),k.Subscribe("tuan/subbranch",{onComplete:function(t){o.removeClass(v),n.html("您的位置："+(t.address||"未知位置")),e.showBranch(t)},onError:function(){o.removeClass(v),n.html("暂无定位信息"),e.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")},onPosComplete:function(){},onPosError:function(){o.removeClass(v),n.html("暂无定位信息"),e.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")}},this,!0)}})});