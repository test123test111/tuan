define(["TuanApp","libs","c","cUtility","cWidgetFactory","cGeoService","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","CommonStore","StoreManage","text!HotelSubbranchTpl","CallPhone","cWidgetGeolocation"],function(t,e,o,n,a,i,s,r,c,l,d,h,u,p){function m(t){return t.toISOString().substring(0,10).replace(/-/g,"")}var f={pageTitle:"商户列表"},g=o.ui,w=(o.base,n.isInApp()),v="ani_rotation",b=s.GroupGeolocation.getInstance(),y=s.TuanDetailsStore.getInstance(),C=l.TuanBranchOfficeModel.getInstance(),k=i.GeoLocation,T=a.create("Guider"),S={up:"arrow_skin01_up",down:"arrow_skin01_down"},H=c.create("TuanBaseView"),x=H.extend({events:{"click .J_showMap":"showMap","click .J_jumpHotel":"jumpHotel","click .J_busiCity":"showHotel","click #J_relocation":"relocation"},onCreate:function(){this.htmlfun=_.template(u)},onLoad:function(){this.cityId=Lizard.P("cityid"),null!=y.get()?this.showBranch():this.backAction(),this.setHeader()},setHeader:function(){var t=this;this.header.set({title:f.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){t.backAction()},homeHandler:function(){t.backHome()}}})},showBranch:function(t){var e,o=this,n=this.cityId,a=t||b.getAttr("gps")||{};this.showLoading(),e={id:y.get().id,pos:{lon:a.lng,lat:a.lat,type:3,name:a.city}},n&&(e.cityid=n),C.setParam(e),C.excute(function(t){if(o.hideLoading(),!t.groups.length)return void o.showMessage("抱歉，数据加载失败，请重试!");var e=h.getCurrentCity();e.CityName&&(a.CityName=e.CityName),o.$el.html($.trim(o.htmlfun({data:t.groups,gps:a,cityId:n}))),o.onScroll(),o.CallPhone=new p({view:this})},function(t){var e=t.msg?t.msg:"啊哦,数据加载出错了!";o.showToast(e,3,function(){o.backAction()}),o.hideLoading()},!0,this)},showPhone:function(t){var e,o=new Array,n=$(t.currentTarget).data("tel").toString();n=n.replace(/，/g,","),_.each(n.split(","),function(t){o.push(" <a href='tel:"+t+"'>"+t+"</a>"),e&&""!=e||(e=t)}),this.alert=new g.Alert({title:"拨打电话",message:' <div id="tuan_tel">'+o.join("")+"</div>",buttons:[{text:"取消",click:function(){this.hide()}},{text:'<a href="tel:'+e+'" data-phone="'+e+'">拨打</a>',click:function(t){this.hide(),T.apply({hybridCallback:function(){var e="data-phone",o=$(t.target);return o.attr(e)||(o=o.find("["+e+"]")),t.preventDefault(),T.callPhone({tel:o.attr(e)}),!1},callback:function(){return!0}})}}]}),this.alert.show()},onShow:function(){},onHide:function(){k.UnSubscribe("tuan/subbranch")},backAction:function(){var t={},e=y.getAttr("id"),o=this.cityId;e&&(t.did=e),o&&(t.cityid=o),this.back(t)},backHome:function(){t.tHome()},showMap:function(t){var e=$(t.currentTarget),o=e.attr("data-coords").split(","),n=e.attr("data-hotel-name");window.mapdata={Longitude:o[0],Latitude:o[1],hotelName:n},this.forwardJump("hotelmap","/webapp/tuan/hotelmap?lon="+o[0]+"&lat="+o[1]+"&hotelName="+n)},jumpHotel:function(e){var o=$(e.currentTarget).data("id");if(o){var n=new Date,a=new Date(n.setDate(n.getDate()+1)),i=encodeURIComponent(location.href),s=w?"ctrip://wireless/InlandHotel?hotelDataType=1&checkInDate="+m(new Date)+"&checkOutDate="+m(a)+"&hotelId="+o+"&from="+i:"http://m.ctrip.com/webapp/hotel/hoteldetail/"+o+".html?from="+i,r=this.getHistory();r.stack.pop(),t.jumpToPage(s,this)}},showHotel:function(t){var e,o=$(t.currentTarget),n=o.find(".J_arrow"),a=S.up+" "+S.down;n.hasClass(S.up)?(n.toggleClass(a),o.removeClass("J_sticky").removeClass("busi_fixed").css("top","0").next().hide(),o.parent().css("padding-top","0"),document.removeEventListener("scroll",this.onScroll)):(e=this.$el.find("."+S.up),e.toggleClass(a),e.parent().removeClass("J_sticky").removeClass("busi_fixed").css("top","0").next().hide(),e.parent().parent().css("padding-top","0"),n.toggleClass(a),o.addClass("J_sticky").next().show(),document.addEventListener("scroll",this.onScroll)),this.onScroll()},onScroll:function(){var t=document.querySelector(".J_sticky");t&&(window.scrollY>=t.parentNode.offsetTop?(t.classList.add("busi_fixed"),t.parentNode.style.paddingTop="45px",!w&&(t.style.top="48px")):(t.classList.remove("busi_fixed"),t.parentNode.style.paddingTop="0",!w&&(t.style.top="0")))},relocation:function(t){var e=this,o=$(t.target),n=this.$el.find("#J_gpsAddr");o.addClass(v),k.Subscribe("tuan/subbranch",{onComplete:function(t){o.removeClass(v),n.html("您的位置："+(t.address||"未知位置")),e.showBranch(t)},onError:function(){o.removeClass(v),n.html("暂无定位信息"),e.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")},onPosComplete:function(){},onPosError:function(){o.removeClass(v),n.html("暂无定位信息"),e.showToast("抱歉，获取不到当前位置，请打开GPS后重试!")}},this,!0)}});return x});