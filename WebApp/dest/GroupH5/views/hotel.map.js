define(["TuanApp","libs","c","TuanStore","AMapWidget","TuanBaseView","cCommonPageFactory","cUtility","cWidgetFactory","cWidgetGeolocation","TuanModel","CommonStore","text!HotelMapTpl"],function(t,e,i,a,n,o,r,c,s,d,h,p,l){var u,m=s.create("AMapWidget"),g=s.create("Geolocation"),f=r.create("TuanBaseView");return u=f.extend({pageid:"214010",hpageid:"215010",events:{"click #J_return":"returnHandler","click .J_relatedProducts":"gotoProduct","click #J_navigator":"showMapNav"},onCreate:function(){this.$el.html($.trim(l)),this.els={mapContainer:this.$el.find("#J_mapContainer")};var e=Lizard.P("lon"),i=Lizard.P("lat"),a=Lizard.P("hotelName"),n=this.$el.find("#J_navigator");e&&i?(this.mapdata={Longitude:e,Latitude:i,hotelName:a},window.mapdata=this.mapdata):this.returnHandler(),c.isInApp()&&t.isOverOS7()&&(this.$el.find("#J_hotelmapWrap").css({"padding-top":"20px","background-color":"#b3b3b3"}),this.$el.find("#J_return").css("top","30px"),n.css({top:"30px"})),this.loadMapScript(),!c.isInApp()&&n.css("display","none")},showMapNav:function(){var t=this.mapdata||{},e={latitude:t.Latitude,longitude:t.Longitude,title:t.hotelName};e&&g.show_map(e)},onShow:function(){this.header&&this.header.hide()},onHide:function(){!c.isInApp()&&this.header&&this.header.rootBox&&this.header.rootBox.show(),this.centerMarker&&this.centerMarker.hide()},returnHandler:function(){this.back()},addCenterMarker:function(t){var e=this,i=this.mapdata,a=this.map,n=a.addMarker({position:new a.host.LngLat(i.Longitude,i.Latitude),offset:{x:-7,y:-36},content:_.template(e.$el.find("#J_centerMarkerTpl").html())({title:t})}),o="ontouchstart"in window;this.centerMarker=n,a.addEvent(n,o?"touchstart":"click",function(t){var e,i=t.originalEvent;"img"==i.target.tagName.toLowerCase()&&(e=$(i.currentTarget).find("#J_label"),e.toggle())})},hotelMapInit:function(){var t,e=this,i=e.mapdata;i&&i.Longitude&&1e3!=i.Longitude&&-1!=i.Longitude&&(this.map?this.map.map.setCenter(new this.map.host.LngLat(i.Longitude,i.Latitude)):this.map=new m({container:this.els.mapContainer,height:document.body.clientHeight,center:i.Longitude+"|"+i.Latitude,locationButton:'<div class="map_curpos_btn" style="opacity: 0.8"></div>',onReady:function(){},onZoom:function(){},onClick:function(){var t=e.centerMarker;t&&t.tipDOM&&t.tipDOM.hide(),!e.isDetailView&&e.currentMarkerDom&&e.changeMarkerView(!1,e.currentMarkerDom)},onGeoBegin:function(e){e=$(e).children(),e.css("background-color","#1491c5"),t=e},onGeoComplete:function(){t&&t.css("background-color","rgba(0,0,0,.8)"),this.setFitView()},onGeoError:function(){t&&t.css("background-color","rgba(0,0,0,.8)")}}),this.addCenterMarker(i.shortName||i.hotelName))},setMapHeight:function(){var e=function(){var e=window.innerHeight||$("html").offset().height,i=e-$("header").height();c.isInApp()&&t.isOverOS7()&&(i-=20)};$(window).bind("resize",e),e()},loadMapScript:function(){var t,e=this;window.initDetailMap=function(){e.setMapHeight(),e.hotelMapInit(),e.els.mapContainer.click()},t=document.createElement("script"),t.type="text/javascript",t.src="http://webapi.amap.com/maps?v=1.2&key=0b895f63ca21c9e82eb158f46fe7f502&callback=initDetailMap",this.$el.append(t)}})});