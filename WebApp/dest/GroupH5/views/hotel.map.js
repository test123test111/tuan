define(["TuanApp","libs","c","TuanStore","AMapWidget","TuanBaseView","cCommonPageFactory","cUtility","cWidgetFactory","cWidgetGeolocation","TuanModel","CommonStore","text!HotelMapTpl"],function(t,e,a,i,n,o,r,s,c,d,h,p,l){var u,m=(i.TuanDetailsStore.getInstance(),i.GroupSearchStore.getInstance(),c.create("AMapWidget")),g=(c.create("Geolocation"),r.create("TuanBaseView"));return u=g.extend({pageid:"214010",hpageid:"215010",events:{"click #J_return":"returnHandler","click .J_relatedProducts":"gotoProduct","click #J_navigator":"showMapNav"},onCreate:function(){this.$el.html($.trim(l)),this.els={mapContainer:this.$el.find("#J_mapContainer")};var t=Lizard.P("lon"),e=Lizard.P("lat"),a=Lizard.P("hotelName"),i=this.$el.find("#J_navigator");t&&e?(this.mapdata={Longitude:t,Latitude:e,hotelName:a},window.mapdata=this.mapdata):this.returnHandler(),s.isInApp()&&$.os&&$.os.ios&&parseInt($.os.version,10)>=7&&(this.$el.find("#J_hotelmapWrap").css({"padding-top":"20px","background-color":"#b3b3b3"}),this.$el.find("#J_return").css("top","30px"),i.css({top:"30px"})),this.loadMapScript()},showMapNav:function(){{var t=this.mapdata||{};({latitude:t.Latitude,longitude:t.Longitude,title:t.hotelName})}this.forwardJump("hotelmapnav","/webapp/tuan/hotelmapnav?lat="+t.Latitude+"&lng="+t.Longitude+"&title="+t.hotelName)},onShow:function(){this.header&&this.header.hide()},onHide:function(){!s.isInApp()&&this.header&&this.header.rootBox&&this.header.rootBox.show(),this.centerMarker&&this.centerMarker.hide()},returnHandler:function(){this.back()},addCenterMarker:function(t){var e=this,a=this.mapdata,i=this.map,n=i.addMarker({position:new i.host.LngLat(a.Longitude,a.Latitude),offset:{x:-7,y:-36},content:_.template(e.$el.find("#J_centerMarkerTpl").html())({title:t})}),o="ontouchstart"in window;this.centerMarker=n,i.addEvent(n,o?"touchstart":"click",function(t){var e,a=t.originalEvent;"img"==a.target.tagName.toLowerCase()&&(e=$(a.currentTarget).find("#J_label"),e.toggle())})},hotelMapInit:function(){var t,e=this,a=e.mapdata;a&&a.Longitude&&1e3!=a.Longitude&&-1!=a.Longitude&&(this.map?this.map.map.setCenter(new this.map.host.LngLat(a.Longitude,a.Latitude)):this.map=new m({container:this.els.mapContainer,height:document.body.clientHeight,center:a.Longitude+"|"+a.Latitude,locationButton:'<div class="map_curpos_btn" style="opacity: 0.8"></div>',onReady:function(){},onZoom:function(){},onClick:function(){var t=e.centerMarker;t&&t.tipDOM&&t.tipDOM.hide(),!e.isDetailView&&e.currentMarkerDom&&e.changeMarkerView(!1,e.currentMarkerDom)},onGeoBegin:function(e){e=$(e).children(),e.css("background-color","#1491c5"),t=e},onGeoComplete:function(){t&&t.css("background-color","rgba(0,0,0,.8)"),this.setFitView()},onGeoError:function(){t&&t.css("background-color","rgba(0,0,0,.8)")}}),this.addCenterMarker(a.shortName||a.hotelName))},setMapHeight:function(){var t=(this.els.mapContainer,function(){var t=window.innerHeight||$("html").offset().height,e=t-$("header").height();s.isInApp()&&$.os&&$.os.ios&&parseInt($.os.version,10)>=7&&(e-=20)});$(window).bind("resize",t),t()},loadMapScript:function(){var t,e=this;window.initDetailMap=function(){e.setMapHeight(),e.hotelMapInit(),e.els.mapContainer.click()},t=document.createElement("script"),t.type="text/javascript",t.src="http://webapi.amap.com/maps?v=1.2&key=0b895f63ca21c9e82eb158f46fe7f502&callback=initDetailMap",this.$el.append(t)}})});