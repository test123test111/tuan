define(["TuanApp","libs","cUtility","TuanStore","c","cWidgetGuider","cWidgetFactory","TuanModel","TuanBaseView","cCommonPageFactory","CommonStore","Payment","text!BookingSuccessTpl","text!RecommendTpl"],function(e,t,i,a,n,r,o,c,s,d,l,u,h,m){function p(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(100*t)/100}var g,f=o.create("Guider"),v=o.create("Member"),w=n.ui,y=i.isInApp(),T=encodeURIComponent("source=groupon"),b=a.OrderDetailReturnPage.getInstance(),I=c.TuanSubmitOrder.getInstance(),k=a.TuanOrderListStore.getInstance(),x=c.TuanOrderDetailModel.getInstance(),D=a.GroupSearchStore.getInstance(),S=l.UserStore.getInstance(),L=c.CrossRecommendModel.getInstance(),C={pageTitle:"订单完成",warningTip:"没有检索到数据!",needLoginTip:"需要先登录才能查看订单信息"};u=o.create("Payment");var U=d.create("TuanBaseView"),J=U.extend({pageid:"214016",hpageid:"215016",hasAd:!0,render:function(){var e=this,t=S.getUser(),i=_.template(h);if(g&&g>0)x.setParam({oid:g,module:"1",auth:t?t.Auth:"",cityid:D.getAttr("ctyId"),head:l.HeadStore.getInstance().get()}),x.execute(function(a){if(a){if(!a.oid)return void e.forwardJump("list","/webapp/tuan/list");a.user=e.user,a.retainTwoDecimal=p,a.isNonUser=t&&t.IsNonUser,e.$el.html($.trim(i(a))),a.product&&a.product.id&&e.getCrossRecommend(a.product.id)}},function(){e.showToast(C.needLoginTip,3,function(){e.redirectToLogin()},!0)},!0,this);else{var a={};a.user=t,a.oid=g,a.retainTwoDecimal=p,this.$el.html($.trim(i(a)))}},events:{"click #J_orderDetail":"viewOrderDetail","click #J_registerBtn":"redirectToRegister","click #J_tel":"callPhone","click #J_destLink":"gotoDestnation","click .J_viewDetail":"gotoDetail","click .link-more":"gotoNearList","click #J_tabNav>li":"recommendSwitch"},onCreate:function(){},onLoad:function(){if(g=Lizard.P("orderid"),!S.getUser())return void this.redirectToLogin();var e=this.getQuery("paytype");1==e||2==(2&e)||parseInt(this.getQuery("success"),10)?this.submitOrder(function(){this.render()}):this.render(),k.remove(),this.setHeader(),$("#bf_ubt_orderid").val(g)},onShow:function(){},onHide:function(){},setHeader:function(){var e=this;this.header.set({title:C.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.forwardJump("home","/webapp/tuan/home")},homeHandler:function(){e.redirectToIndex()}}}),this.header.show()},getCrossRecommend:function(t){var i=_.template(m),a=this.$el.find("#J_recommendWrap");L.setParam({id:t,isInApp:y,environment:e.environment,head:l.HeadStore.getInstance().get()}),L.execute(function(e){var n=e&&e.RecommendGroups;n.length?(a.show(),a.html(i({data:n,pid:t,city:e.city}))):a.hide()},function(){a.hide()},this,this)},recommendSwitch:function(e){var t=$(e.currentTarget),i=t.data("index");t.hasClass("sta-on")||(t.addClass("sta-on").siblings().removeClass("sta-on"),this.$el.find("#J_tabCon .ui-item").hide().eq(i).show())},gotoDestnation:function(e){var t=$(e.target),i=t.attr("data-dest-id"),a=t.attr("data-dest-name");f.apply({hybridCallback:function(){f.jump({module:"destination/toDestMain",param:{districtId:i,districtName:a},targetModel:"app"})},callback:function(){location.href="http://m.ctrip.com/you/summary/"+i+".html"}})},callPhone:function(e){e.preventDefault(),this.alert=new w.Alert({title:"拨打电话",message:'<a href="tel:4008216666">拨打携程客服</a>',buttons:[{text:"取消",click:function(){this.hide()}},{text:'<a href="tel:4008216666" data-phone="4008216666">拨打</a>',click:function(){this.hide(),f.callService()}}]}),this.alert.show()},submitOrder:function(e){var t=S.getUser(),i={head:l.HeadStore.getInstance().get(),SubmitOrder:{OrderID:+this.getQuery("orderid")||this.getPath(0),Ver:3},Operator:{UID:t.UserID,SourceForm:1}};this.showLoading(),I.setParam(i),I.execute(function(){this.hideLoading(),e.call(this)},function(){this.hideLoading(),e.call(this)},this,this)},redirectToIndex:function(){e.tHome()},gotoDetail:function(e){var t=$(e.currentTarget),i=t.data("pid");99==t.data("type")?y?f.cross({path:"activity",param:"index.html#/dest/t"+i+".html?ext="+T}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/t"+i+".html?from="+encodeURIComponent(location.href)+"&ext="+T:this.forwardJump("detail","/webapp/tuan/detail/"+i+".html")},gotoNearList:function(e){var t=$(e.currentTarget),i=t.data("pid"),a=t.data("cityid"),n=t.data("cityname"),r=t.data("type"),o=t.data("title");99==t.data("type")?y?f.cross({path:"activity",param:"index.html#/dest/ct-"+n+"-"+a+"?ext="+T}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/ct-"+n+"-"+a+".html?from="+encodeURIComponent(location.href)+"&ext="+T:this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+i+"&category="+r+"&title="+o)},viewOrderDetail:function(){var e=S.getUser();if(g&&e&&e.Auth){this.showLoading();var t={Id:g,page:"bookingsuccess"};b.set(t),this.forwardJump("tuanorderdetail","/webapp/tuan/tuanorderdetail/"+g+".html")}},redirectToRegister:function(){v.register()},redirectToLogin:function(){var e="from="+encodeURIComponent("/webapp/tuan/bookingsuccess/"+g+".html");v.memberLogin({param:e})}});return J});