define(["TuanApp","libs","c","cUtility","cWidgetFactory","CommonStore","cWidgetGuider","cWidgetMember","TuanModel","TuanBaseView","cCommonPageFactory","text!RefundTpl","NumberStep"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){var p=l.create("TuanBaseView"),d=i.create("Member"),v={confirmContent:"退款一旦提交，团购券将不能恢复。请问您是否需要继续退款？",confirmNoLabel:"取消",confirmYesLabel:"继续退款",timeoutTip:"加载超时，请重试"},m="num_invalid",g=r.isInApp(),y=a.TuanOrderDetailModel.getInstance(),b=s.UserStore.getInstance(),w=a.TuanRefundlTicketModel.getInstance(),E=function(e,t){var n=parseFloat(e)*t;return Math.round(n*100)/100},S=i.create("Guider"),x="choosed",T="errorli",N=p.extend({pageid:"260004",hpageid:"261004",render:function(){this.$el.html(c),this.els={productName:this.$el.find("#J_productName"),iscCount:this.$el.find("#J_iscCount"),refundCount:this.$el.find("#J_refundCount"),refundAmount:this.$el.find("#J_refundAmount"),refundCouponWrap:this.$el.find("#J_refundCouponWrap"),refundCouponAmount:this.$el.find("#J_refundCouponAmount"),refundInvoiceWrap:this.$el.find("#J_refundInvoiceWrap"),refundInvoiceAmount:this.$el.find("#J_refundInvoiceAmount"),btnMinus:this.$el.find("#J_minus"),btnPlus:this.$el.find("#J_plus"),$types:this.$el.find(".J_refundType"),$numStep:this.$el.find(".J_numberStep")}},onCreate:function(){this.render()},events:{"click .J_btnSubmit":"onSubmitRefund","click .apply_refund_reason>li":"onRefundReasonChange","click .J_refundType":"selectRefundType"},_createNumberStep:function(){var e=this,t=this.maxCoupons,n=1,r=1;this.numberStep=new h({max:t,min:n,initialVal:r<n?n:r,wrap:e.els.$numStep,html:'<i class="minus <%if(initialVal <= min ){ %>num_invalid<%} %>" data-flag="-"></i><span id="J_curNum" class="numtext"><%=initialVal %></span><i data-flag="+" class="plus <%if(initialVal >= max ){ %>num_invalid<%} %>"></i>',onChange:function(){var n=e.tuanCouponPrice,r=e.promoCouponPrice,i=e.couponType,s=parseInt(this.getCurrentNum());r?i===2?s===t?n=Math.round(n*s-r):n=Math.round(n*s):n=E(n-r>0?n-r:0,s):n=E(n,s),e.refundable&&(s>=t&&r?e.showCouponLabel(r):e.els.refundCouponWrap.hide(),e.invoiceAmt>0&&(s>=t?e.showInvoiceLabel(e.invoiceAmt):e.els.refundInvoiceWrap.hide())),e.els.refundAmount.text(n)}})},showCouponLabel:function(e){this.els.refundCouponWrap.show(),this.els.refundCouponAmount.text(e)},showInvoiceLabel:function(e){this.els.refundInvoiceWrap.show(),this.els.refundInvoiceAmount.text(this.invoiceAmt)},onRefundReasonChange:function(e){var t=$(e.currentTarget),n=t.text();t.parent().find("li").removeClass("choosed"),t.addClass("choosed"),n=="其他"?this.$el.find(".reason_other_text").show():this.$el.find(".reason_other_text").hide()},loadDetail:function(){this.showLoading(),y.setParam({oid:this.orderId,head:y.getHead().get()}),y.execute(function(e){this.createPage(e),this.hideLoading()},function(e){this.hideLoading(),e&&e.statusText=="timeout"&&this.showToast(v.timeoutTip)},this,!0)},checkLogin:function(){var e=this,t=b.isLogin();return t||(this.showLoading(),d.memberLogin({domain:"//"+document.domain,param:"?t=1&from="+encodeURIComponent("/webapp/tuan/refund"+this.orderId+".html"),callback:function(){e.onLoad()}})),t},createPage:function(e){this.invoiceAmt=e.invoiceAmt,this.maxCoupons=0,this.tuanCouponList=[],this.tuanCouponPrice=0,this.refundable=!0,e.orderCoupons&&(this.promoCouponPrice=e.orderCoupons.price,this.couponType=e.orderCoupons.couponType);if(e.coupons&&e.coupons.length>0)for(var t=0;t<e.coupons.length;t++)e.coupons[t].isc==1&&(this.maxCoupons++,this.tuanCouponPrice=e.coupons[t].amt,this.tuanCouponList.push(e.coupons[t].val)),e.coupons[t].status===2&&(this.refundable=!1);e.product&&e.product.category&&e.product.category.ctgoryid===6&&e.product.category.subctgory===2&&this.$el.find(".J_needHideInTicket").remove(),this.maxCoupons<=0?this.alertErrorMsg("","此订单不支持退款！"):(this.els.productName.text(e.pname),this.els.iscCount.text(this.maxCoupons),this._createNumberStep(),e.couponAmt>0?this.numberStep.triggerChange():this.els.refundAmount.text(this.tuanCouponPrice),this.refundable&&this.maxCoupons==1&&(this.els.refundInvoiceWrap.show(),this.els.refundInvoiceAmount.text(this.invoiceAmt))),this.els.$types.filter('[data-type="1"]')[e.isFastRefund?"show":"hide"]()},alertErrorMsg:function(e,t){var n=this;this.alert.setViewData({title:e,message:t,buttons:[{text:"知道了",click:function(){this.hide(),n.back()}}]}),this.alert.show()},onLoad:function(){this.orderId=Lizard.P("orderid"),this.header.set({title:"申请退款",view:this,back:!0,home:!0,events:{returnHandler:function(){this.back()},homeHandler:function(){e.tHome()}}}),this.from=decodeURIComponent(Lizard.P("from")||""),this.checkLogin()&&this.loadDetail()},selectRefundType:function(e){var t=$(e.target);this.els.$types.removeClass(T).removeClass(x),t.closest(".J_refundType").addClass(x)},onSubmitRefund:function(){var e=this,t;if(!this.els.$types.filter("."+x).length)return this.showToast("请选择退款方式",3,function(){e.els.$types.addClass(T)}),!1;t=new n.ui.Alert({title:v.alertTitle,message:v.confirmContent,buttons:[{text:v.confirmNoLabel,click:function(){this.hide()}},{text:v.confirmYesLabel,click:function(){this.hide(),e.submitRefund()}}]}),t.show()},submitRefund:function(){var e=this,t="",n=[],r=this.numberStep.getCurrentNum(),i=this.els.$types.filter("."+x).attr("data-type"),o;if(+r<=0){this.showToast("请输入需要退回的数量！");return}if(this.maxCoupons<=0||this.tuanCouponList.length<=0)return;var u=this.$el.find(".apply_refund_reason").find(".choosed");if(u){t=u.text();if(t=="其他"){var a=this.$el.find(".reason_other_text>textarea");a&&a.val()!=""&&(t=a.val())}}for(var f=0;f<+r;f++)o={TicketNO:this.tuanCouponList[f],OrderType:1,Trmk:t||""},i&&(o.PayBackType=parseInt(i,10)),n.push(o);w.setParam({head:s.HeadStore.getInstance().get(),AllianceInfo:null,Operator:null,CancelTicketList:n}),w.execute(function(t){if(t&&t.ResponseStatus.Ack.toLowerCase()=="failure"){e.showToast("退款失败请重试！");return}if(e.from){var n=decodeURIComponent(e.from);g?S.cross({path:"myctrip",param:n.replace(/^\/webapp\/myctrip\//i,"")}):location.href=location.protocol+"//"+location.host+n}else e.back({orderid:e.orderId})},function(){this.showToast("申请退款失败！")},this,!0)},onShow:function(){},onHide:function(){}});return N});