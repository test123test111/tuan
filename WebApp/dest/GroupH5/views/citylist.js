define(["TuanApp","libs","c","TuanBaseView","cCommonPageFactory","cGeoService","TuanModel","TuanStore","StoreManage","text!CityListTpl","HttpErrorHelper","cUtility"],function(t,i,e,s,n,a,o,c,r,l,h,y){var u=e.ui,d=a.GeoLocation,f=c.GroupSearchStore.getInstance(),p=c.GroupGeolocation.getInstance(),C=c.TuanPositionStore.getInstance(),g=c.TuanHistoryCityListStore.getInstance(),m=c.TuanCityListStore.getInstance(),I=o.TuanLocalCityInfo.getInstance(),w=o.TuanCityListModel.getInstance(),v=c.TuanHistoryKeySearchStore.getInstance(),b=n.create("TuanBaseView"),x=y.isInApp(),T=function(){},k={up:"arr_up",down:"arr_down"},B="J_filterResultCity",A=b.extend({pageid:"214002",hpageid:"215002",render:function(){this.els={eltuancitylistbox:this.$el.find("#citylist_box"),eltuancitykeyword:this.$el.find("#J_searchCityInput"),searchBox:this.$el.find(".J_searchWrap")},this.cityListTplfun=_.template(l)},events:{"click .history_close":"cancelInput","click .J_cityType":"cityGroupTitleClick","focus #J_searchCityInput":"clickInput","input #J_searchCityInput":"searchKeyWordInput","click .J_cityItem":"cityItemOnClick","touchmove .J_searchWrap":function(t){t.preventDefault()},"click .J_cityTagTitle":"cityTagTitleClick","submit #J_citySearchForm":"redirectByResult"},backAction:function(){this.back()},cityItemOnClick:function(t){var i=f.get();r.clearAll();var e,s=[],n=this,a=$(t.currentTarget),o=a.attr("data-id"),c=a.attr("data-name");return"nearby"==o.toLowerCase()?(e=r.getCurrentCity(),e?(g.setAttr("nearby",!0),f.setAttr("ctyId",e.CityId),s=r.getGroupQueryParam(),f.setAttr("qparams",s),r.addHistoryCity(e.CityId,e.CityName)):(g.setAttr("nearby",!1),f.setAttr("ctyId",i.ctyId),f.setAttr("ctyName",i.ctyName)),void n.forwardJump("list","/webapp/tuan/list")):"positioning"==o.toLowerCase()?(this.getGeolocation(),void this.upNearbyBtn(2)):(g.setAttr("nearby",!1),p.setAttr("isParentCity",!1),f.setAttr("ctyId",o),f.setAttr("ctyName",c),r.addHistoryCity(o,c),v.remove(),void setTimeout(function(){n.forwardJump("home","/webapp/tuan/home")},100))},cityGroupTitleClick:function(t){var i=$(t.currentTarget);i.next().toggle(),this.els.$cityTypes.not(i).next().hide(),this.els.$cityTags.removeClass(k.up).addClass(k.down)},cityTagTitleClick:function(t){var i,e=$(t.currentTarget),s=e.parent(),n=e.hasClass(k.up);this.els.$cityTags.removeClass(k.up).addClass(k.down),n||e.toggleClass(k.down+" "+k.up),s.siblings().find(".city_list>li").hide(),s.find(".city_list>li").show(),i=x?s.offset().top:s.offset().top-45,window.scrollTo(0,i)},redirectByResult:function(t){t.preventDefault();var i=this.$el.find("."+B);i&&1===i.length?i.trigger("click"):this.els.eltuancitykeyword.blur()},buildEvent:function(){u.InputClear(this.els.eltuancitykeyword),this.onBodyChange=$.proxy(function(){this.els.eltuancitykeyword[0].blur(),this.els.eltuancitylistbox.focus(),this.$el.find(".history_close").hide()},this)},updatePage:function(t){w.excute(function(i){i=m.get(),this.createPage(i),t.call(this)},function(i){var e=h.getMessage(i);this.showToast(e),t.call(this)},!1,this)},getGeolocation:function(){var t=this,i=function(i){var e=t.$el.find(".current>.currentcity");t.upNearbyBtn(1),e.length>0&&(e.attr("data-name",i.cityName),e.attr("data-id",i.cityId),e.html(i.cityName).show())},e=C.get();if(e&&e.cityId&&e.cityName){var s={cityId:e.cityId,cityName:e.cityName,hasGroupProduct:e.hasGroupProduct};return void i(s)}d.Subscribe("tuan/citylist",{onComplete:function(e){C.set(e),e.city=e.city.replace("市市","市"),e.city.length>2&&(e.city=e.city.replace("市","")),p.setAttr("gps",e);var s={lng:e.lng,lat:e.lat,district:e.district,city:e.city,province:e.province,isOverseas:"中国"!=e.country};t.getCityInfo(s,i)},onError:this.geoError,onPosComplete:T,onPosError:this.geoError},this,!0)},geoError:function(){this.upNearbyBtn(3)},getCityCount:function(t){return r.getCityCount(t)},upNearbyBtn:function(t){var i=this.$el.find(".current>li").first();if(i)switch(t){case 1:i.attr("data-id","nearby"),i.attr("data-name","附近"),i.text("附近团购").removeClass("wraploading");break;case 2:i.attr("data-id","positioning"),i.attr("data-name","正在获取您的位置…"),i.text("正在获取您的位置…");break;case 3:i.attr("data-id","positioning"),i.attr("data-name","定位失败，点击重试"),i.text("定位失败，点击重试")}},createPage:function(t){var i,e,s,n=f.get(),a=n.ctyId,o=!1;this.citycount=this.getCityCount(t);var c=r.findHistoryCity(t.cities),l=this.cityListTplfun({data:t.cities,history:c,cityid:a,currentcityid:e,currentcityname:i,currentgroups:s,nearby:o});this.els.eltuancitylistbox.html($.trim(l)),this.els.$allCityBox=this.$el.find("#J_allCitiesBox"),this.els.$cityTags=this.$el.find(".J_cityTagTitle"),this.els.$cityTypes=this.$el.find(".J_cityType"),t.cities.length<=0?this.els.eltuancitylistbox.find(".city_noresult").show():this.els.eltuancitylistbox.find(".city_noresult").hide(),this.getGeolocation(),o===!0&&"undefined"!=typeof e&&null!==e&&""!==e?(o=!0,g.setAttr("nearby",o),f.setAttr("ctyId",e),a=0):(o=!1,g.setAttr("nearby",o),f.setAttr("ctyId",a)),this.$el.find(".s_city_num>span").text(this.citycount),this.$el.find(".s_city_loading").hide(),this.$el.find(".s_city_num").show()},onCreate:function(){this.render(),this.buildEvent()},onLoad:function(){this.setHeader(),this.updatePage(function(){this.hideLoading(),this.$el.bind("focus",this.onBodyChange),this.$el.bind("touchstart",this.onBodyChange)})},setHeader:function(){var t=this;this.header.set({title:"选择城市",back:!0,view:this,tel:null,events:{returnHandler:function(){t.backAction()}}}),this.header.show(),!x&&this.header.rootBox.show()},cancelInput:function(){this.hasSearchShow=!1,this.els.eltuancitykeyword.val(""),this.$el.find(".history_close").hide(),this.$el.find("."+B).removeClass(B),this.els.$cityTags.addClass(k.down).removeClass(k.up).show(),this.showHotCitys(),this.updateZIndex(!1),this.mask&&this.mask.hide(),this.setHeader(),x&&t.isOverOS7()&&this.els.searchBox.css("border-top","0")},clickInput:function(){this.hasSearchShow=!0,this.$el.find(".history_close").show(),this.els.$cityTags.addClass(k.up).removeClass(k.down),this.header&&(this.header.hide(),this.header.rootBox&&this.header.rootBox.hide(),x&&t.isOverOS7()&&this.els.searchBox.css("border-top","20px solid #dfeaf1")),this.updateZIndex(!0),!this.mask&&(this.mask=new e.ui.Mask),this.mask.show()},updateZIndex:function(t){t?(this.els.searchBox.css({zIndex:4e3}),this.els.$allCityBox.css({position:"relative",zIndex:4e3}),!this.els.eltuancitykeyword.val()&&this.els.$allCityBox.hide(),this.els.eltuancitykeyword[0].focus()):(this.els.searchBox.css({zIndex:"auto"}),this.els.$allCityBox.css({position:"static",zIndex:"auto"}).show())},showHotCitys:function(){this.els.eltuancitylistbox.find(".city_list:not(.allcity)").show(),this.els.$cityTypes.show(),this.$el.find(".s_city_num>span").text(this.citycount),this.els.eltuancitylistbox.find(".city_list.allcity>li[data-filter]").hide()},hideHotCitys:function(){this.els.eltuancitylistbox.find(".city_list.allcity").show(),this.els.$cityTypes.hide(),this.els.eltuancitylistbox.find(".city_list:not(.allcity)").hide()},searchKeyWordInput:function(t){var i=$(t.currentTarget),e=i.val();if(e){e=e.replace(/\.|\{|\}|\[|\]|\*|\^|\'/gim,""),e=e.toLowerCase().trim(),this.hideHotCitys(),this.els.eltuancitylistbox.find(".city_list.allcity>li").hide(),this.els.$cityTags.hide(),this.els.$allCityBox.find(".J_cityItem").removeClass(B);var s=this.els.$allCityBox.find(".city_list>li[data-filter*="+e+"]");s.addClass(B).show(),s.length<=0?(this.els.eltuancitylistbox.find(".city_noresult").show(),this.$el.find(".s_city_num>span").text(0)):(this.els.$allCityBox.show(),this.els.eltuancitylistbox.find(".city_noresult").hide(),this.$el.find(".s_city_num>span").text(s.length))}else this.showHotCitys(),this.els.eltuancitylistbox.find(".city_noresult").hide()},onShow:function(){this.els.eltuancitykeyword&&this.els.eltuancitykeyword[0].focus()},onHide:function(){this.hasSearchShow===!0&&this.cancelInput(),d.UnSubscribe("tuan/citylist"),this.$el.unbind("focus",this.onBodyChange),this.$el.unbind("touchstart",this.onBodyChange)},getCityInfo:function(t,i){var e=this;I.setParam({lng:t.lng,lat:t.lat,district:encodeURIComponent(t.district),cityname:encodeURIComponent(t.city),province:encodeURIComponent(t.province),isOverseas:t.isOverseas}),I.excute(function(t){e.locating=!1;var s;t&&t.CityID&&t.CityID>0&&(s={cityId:t.CityID,cityName:t.CityName,hasGroupProduct:t.HasGroupProduct},C.setAttr("cityId",t.CityID),C.setAttr("cityName",t.CityName),C.setAttr("hasGroupProduct",t.HasGroupProduct),r.setCurrentCity(t)),"function"==typeof i&&i.call(e,s)},function(){e.locating=!1,C.setAttr("cityId",null),C.setAttr("cityName",null),e.upNearbyBtn(3)},!1,this)}});return A});