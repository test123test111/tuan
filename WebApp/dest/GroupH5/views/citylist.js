define(["TuanApp","libs","c","TuanBaseView","cCommonPageFactory","cGeoService","TuanModel","TuanStore","StoreManage","text!CityListTpl","HttpErrorHelper","cUtility"],function(e,t,n,r,i,s,o,u,a,f,l,c){var h=n.ui,p=s.GeoLocation,d=u.GroupSearchStore.getInstance(),v=u.GroupGeolocation.getInstance(),m=u.TuanPositionStore.getInstance(),g=u.TuanHistoryCityListStore.getInstance(),y=u.TuanCityListStore.getInstance(),b=o.TuanLocalCityInfo.getInstance(),w=o.TuanCityListModel.getInstance(),E=u.TuanHistoryKeySearchStore.getInstance(),S=i.create("TuanBaseView"),x=c.isInApp(),T={up:"arr_up",down:"arr_down"},N="J_filterResultCity",C=S.extend({pageid:"214002",hpageid:"215002",render:function(){this.els={eltuancitylistbox:this.$el.find("#citylist_box"),eltuancitykeyword:this.$el.find("#J_searchCityInput"),searchBox:this.$el.find(".J_searchWrap")},this.cityListTplfun=_.template(f)},events:{"click .history_close":"cancelInput","click .J_cityType":"cityGroupTitleClick","focus #J_searchCityInput":"clickInput","input #J_searchCityInput":"searchKeyWordInput","click .J_cityItem":"cityItemOnClick","touchmove .J_searchWrap":function(e){e.preventDefault()},"click .J_cityTagTitle":"cityTagTitleClick","submit #J_citySearchForm":"redirectByResult"},backAction:function(){this.back()},cityItemOnClick:function(e){var t=d.get();a.clearAll();var n=[],r=this,i=$(e.currentTarget),s,o=i.attr("data-id"),u=i.attr("data-name");if(o.toLowerCase()=="nearby"){s=a.getCurrentCity(),s?(g.setAttr("nearby",!0),d.setAttr("ctyId",s.CityId),n=a.getGroupQueryParam(),d.setAttr("qparams",n),a.addHistoryCity(s.CityId,s.CityName)):(g.setAttr("nearby",!1),d.setAttr("ctyId",t.ctyId),d.setAttr("ctyName",t.ctyName)),r.forwardJump("list","/webapp/tuan/list");return}if(o.toLowerCase()=="positioning"){this.getGeolocation(),this.upNearbyBtn(2);return}g.setAttr("nearby",!1),v.setAttr("isParentCity",!1),d.setAttr("ctyId",o),d.setAttr("ctyName",u),a.addHistoryCity(o,u),E.remove(),setTimeout(function(){r.forwardJump("home","/webapp/tuan/home")},100)},cityGroupTitleClick:function(e){var t=$(e.currentTarget);t.next().toggle(),this.els.$cityTypes.not(t).next().hide(),this.els.$cityTags.removeClass(T.up).addClass(T.down)},cityTagTitleClick:function(e){var t=$(e.currentTarget),n=t.parent(),r=t.hasClass(T.up),i;this.els.$cityTags.removeClass(T.up).addClass(T.down),r||t.toggleClass(T.down+" "+T.up),n.siblings().find(".city_list>li").hide(),n.find(".city_list>li").show(),i=x?n.offset().top:n.offset().top-45,window.scrollTo(0,i)},redirectByResult:function(e){e.preventDefault();var t=this.$el.find("."+N);t&&t.length===1?t.trigger("click"):this.els.eltuancitykeyword.blur()},buildEvent:function(){h.InputClear(this.els.eltuancitykeyword),this.onBodyChange=$.proxy(function(){this.els.eltuancitykeyword[0].blur(),this.$el.find(".history_close").hide()},this)},updatePage:function(e){w.excute(function(t){t=y.get(),this.createPage(t),e.call(this)},function(t){var n=l.getMessage(t);this.showToast(n),e.call(this)},!1,this)},getGeolocation:function(){var e=this;changeSuccessStatus=function(t){var n=e.$el.find(".current>.currentcity");e.upNearbyBtn(1);if(n.length>0){var r=n.html(),i=v.get(),s=i.gps.Groups;if(!s){var o=a.findCityInfoById(t.cityId);o&&(s=o.cGroups||0)}r=r.replace("<!--cityname-->",t.cityName),r=r.replace("<!--groups-->",s),n.html(r),n.attr("data-name",t.cityName),n.attr("data-id",t.cityId),n.show()}};var t=m.get();if(t&&t.cityId&&t.cityName){var n={cityId:t.cityId,cityName:t.cityName,hasGroupProduct:t.hasGroupProduct};changeSuccessStatus(n);return}p.Subscribe("tuan/citylist",{onComplete:function(t){m.set(t),t.city=t.city.replace("市市","市"),t.city.length>2&&(t.city=t.city.replace("市","")),v.setAttr("gps",t);var n={lng:t.lng,lat:t.lat,district:t.district,city:t.city,province:t.province,isOverseas:t.country!="中国"};e.getCityInfo(n,changeSuccessStatus)},onError:this.geoError,onPosComplete:function(e,t){},onPosError:this.geoError},this,!0)},geoError:function(){this.upNearbyBtn(3)},getCityCount:function(e){return a.getCityCount(e)},upNearbyBtn:function(e){var t=this.$el.find(".current>li").first();if(t)switch(e){case 1:t.attr("data-id","nearby"),t.attr("data-name","附近"),t.text("附近团购");break;case 2:t.attr("data-id","positioning"),t.attr("data-name","正在获取您的位置…"),t.text("正在获取您的位置…");break;case 3:t.attr("data-id","positioning"),t.attr("data-name","定位失败，点击重试"),t.text("定位失败，点击重试")}},createPage:function(e){var t=d.get(),n=g.get(),r=t.ctyId,i=t.ctyName,s,o,u,f=!1;this.citycount=this.getCityCount(e);var l=a.findHistoryCity(e.cities),c=this.cityListTplfun({data:e.cities,history:l,cityid:r,currentcityid:o,currentcityname:s,currentgroups:u,nearby:f});this.els.eltuancitylistbox.html($.trim(c)),this.els.$allCityBox=this.$el.find("#J_allCitiesBox"),this.els.$cityTags=this.$el.find(".J_cityTagTitle"),this.els.$cityTypes=this.$el.find(".J_cityType"),e.cities.length<=0?this.els.eltuancitylistbox.find(".city_noresult").show():this.els.eltuancitylistbox.find(".city_noresult").hide(),this.getGeolocation(),f==1&&typeof o!="undefined"&&o!=null&&o!=""?(f=!0,g.setAttr("nearby",f),d.setAttr("ctyId",o),r=0):(f=!1,g.setAttr("nearby",f),d.setAttr("ctyId",r)),this.$el.find(".s_city_num>span").text(this.citycount),this.$el.find(".s_city_loading").hide(),this.$el.find(".s_city_num").show()},onCreate:function(){this.render(),this.buildEvent()},onLoad:function(e){this.setHeader(),this.updatePage(function(){this.hideLoading(),this.$el.bind("focus",this.onBodyChange),this.$el.bind("touchstart",this.onBodyChange)})},setHeader:function(){var e=this;this.header.set({title:"选择城市",back:!0,view:this,tel:null,events:{returnHandler:function(){e.backAction()}}}),this.header.show(),!x&&this.header.rootBox.show()},cancelInput:function(t){this.hasSearchShow=!1,this.els.eltuancitykeyword.val(""),this.$el.find(".history_close").hide(),this.$el.find("."+N).removeClass(N),this.els.$cityTags.addClass(T.down).removeClass(T.up).show(),this.showHotCitys(),this.updateZIndex(!1),this.mask&&this.mask.hide(),this.setHeader(),x&&e.isOverOS7()&&this.els.searchBox.css("border-top","0")},clickInput:function(){this.hasSearchShow=!0,this.$el.find(".history_close").show(),this.els.$cityTags.addClass(T.up).removeClass(T.down),this.header&&(this.header.hide(),this.header.rootBox&&this.header.rootBox.hide(),x&&e.isOverOS7()&&this.els.searchBox.css("border-top","20px solid #b3b3b3")),this.updateZIndex(!0),!this.mask&&(this.mask=new n.ui.Mask),this.mask.show()},updateZIndex:function(e){e?(this.els.searchBox.css({zIndex:4e3}),this.els.$allCityBox.css({position:"relative",zIndex:4e3}).hide(),this.els.eltuancitykeyword.focus()):(this.els.searchBox.css({zIndex:"auto"}),this.els.$allCityBox.css({position:"static",zIndex:"auto"}).show())},showHotCitys:function(){this.els.eltuancitylistbox.find(".city_list:not(.allcity)").show(),this.els.$cityTypes.show(),this.$el.find(".s_city_num>span").text(this.citycount),this.els.eltuancitylistbox.find(".city_list.allcity>li[data-filter]").hide()},hideHotCitys:function(){this.els.eltuancitylistbox.find(".city_list.allcity").show(),this.els.$cityTypes.hide(),this.els.eltuancitylistbox.find(".city_list:not(.allcity)").hide()},searchKeyWordInput:function(e){var t=$(e.currentTarget),n=t.val();if(n){n=n.replace(/\.|\{|\}|\[|\]|\*|\^|\'/img,""),n=n.toLowerCase().trim(),this.hideHotCitys(),this.els.eltuancitylistbox.find(".city_list.allcity>li").hide(),this.els.$cityTags.hide(),this.els.$allCityBox.find(".J_cityItem").removeClass(N);var r=this.els.$allCityBox.find(".city_list>li[data-filter*="+n+"]");r.addClass(N).show(),r.length<=0?(this.els.eltuancitylistbox.find(".city_noresult").show(),this.$el.find(".s_city_num>span").text(0)):(this.els.$allCityBox.show(),this.els.eltuancitylistbox.find(".city_noresult").hide(),this.$el.find(".s_city_num>span").text(r.length))}else this.showHotCitys(),this.els.eltuancitylistbox.find(".city_noresult").hide()},onShow:function(){},onHide:function(){this.hasSearchShow==1&&this.cancelInput(),p.UnSubscribe("tuan/citylist"),this.$el.unbind("focus",this.onBodyChange),this.$el.unbind("touchstart",this.onBodyChange)},getCityInfo:function(e,t){var n=this;b.setParam({lng:e.lng,lat:e.lat,district:encodeURIComponent(e.district),cityname:encodeURIComponent(e.city),province:encodeURIComponent(e.province),isOverseas:e.isOverseas}),b.excute(function(e){n.locating=!1;var r;e&&e.CityID&&e.CityID>0&&(r={cityId:e.CityID,cityName:e.CityName,hasGroupProduct:e.HasGroupProduct},m.setAttr("cityId",e.CityID),m.setAttr("cityName",e.CityName),m.setAttr("hasGroupProduct",e.HasGroupProduct),a.setCurrentCity(e)),typeof t=="function"&&t.call(n,r)},function(e){n.locating=!1,m.setAttr("cityId",null),m.setAttr("cityName",null),n.upNearbyBtn(3)},!1,this)}});return C});