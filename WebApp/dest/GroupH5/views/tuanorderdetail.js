define(["TuanApp","libs","c","cUtilityCrypt","TuanBaseView","cCommonPageFactory","cWidgetFactory","cUtility","cWidgetGuider","Payment","cWidgetTipslayer","CommonStore","TuanStore","TuanModel","text!TuanOrderDetailTpl","text!OrderDetailItemTpl","text!RecommendTpl","CallPhone"],function(e,t,o,a,n,i,r,s,d,c,l,h,u,p,m,g,f,w){function y(e){var t=parseFloat(e);return isNaN(t)?e:Math.round(100*t)/100}var T,v,I,C,b,x,L,P,k,J,O,S,M=s.isInApp(),R=encodeURIComponent("source=groupon"),U=i.create("TuanBaseView"),D=r.create("Guider");return c=r.create("Payment"),x=p.TuanCancelOrderModel.getInstance(),L=p.TuanDeleteOrderModel.getInstance(),T=u.OrderDetailReturnPage.getInstance(),v=h.UserStore.getInstance(),I=u.TuanOrderDetailStore.getInstance(),C=p.TuanOrderDetailModel.getInstance(),b=p.TuanSendMsgModel.getInstance(),P=p.TuanRetryPayment.getInstance(),k=p.CrossRecommendModel.getInstance(),J={unavailableOrder:"无效订单",pageTitle:"订单详情",timeoutTip:"非常抱歉，由于您刚才提交的服务已超时，请稍后在“我的携程”中查看订单信息或拨打服务电话400-008-6666，以确认您的订单是否提交成功。",sendMsgTitle:"发送券号密码到手机",sendMsg:"发送短信",needOrderID:"必须选择券号哦，亲",alreadySend:"券号和密码已发送至您的手机",sendMsgFailed:"抱歉，发送失败！",pleaseWait:"请等待",sendAgain:"秒后重新发送",orderPending:"正在紧张的为您处理中，请休息一下再来查看吧！",makeCallTitle:"拨打电话",cancel:"取消"},O=U.extend({pageid:"214018",hpageid:"215018",hasAd:!0,tpl:m,cooling:!1,coolingSec:0,render:function(){var t=this,o=v.getUser();this.orderId=Lizard.P("orderid"),this.orderId||this.showToast(J.unavailableOrder,3,function(){T.get()?t.forwardJump("tuanorderdetail","/webapp/tuan/tuanorderdetail/"+t.orderId+".html"):o&&!o.IsNonUser?e.gotoExternalPage("myctrip",t.from.replace(/^\/webapp\/myctrip\//i,"")||"index.html#orders/tuanorderlist"):t.forwardJump("home","/webapp/tuan/home")},!0),o||Lizard.goTo("/webapp/myctrip/#account/login?from="+encodeURIComponent("/webapp/tuan/tuanorderdetail/"+this.orderId+".html")),this.showLoading(),I.remove(),C.setParam({oid:this.orderId,module:2}),C.param.head=C.getHead().get(),C.excute(function(e){var o=e,a=o.coupons&&o.coupons.length,n=!1,i=e.product,r=i&&i.channelInfo,s=r&&r.isCorrectChannel;if(t.hideLoading(),S=e.contact&&e.contact.mphone,t.store=e,v.isLogin()&&2!=e.status&&a){var d=0;_.each(o.coupons,function(e){e.isc===!0&&d++}),d&&(n=!0),i&&i.category&&6===i.category.ctgoryid&&2===i.category.subctgory&&(o.coupons=[])}e.canRefund=n,e.canDelete=e.isdel,e.appNonsupport=s,e.retainTwoDecimal=y,t.$el.html($.trim(_.template(t.tpl,e))),t.CallPhone=new w({view:t,ele:"#J_hotelTel"}),e&&e.pid&&t.getCrossRecommend(e.pid),s||t.showMessage("订单仅供查看，需要进行相关操作请使用电脑登录携程。"),t.couponsWrap=t.$el.find("#J_couponsWrap"),4!=e.mooncakeStatus&&t._loadCoupon(t.couponsWrap,o.coupons,s,o.status,e.btn)},function(e){t.hideLoading(),e&&"timeout"==e.statusText&&t.showToast(J.timeoutTip)},!0,this)},sortCoupons:function(e){var t,o={},a=[];return e&&e.length?(e.forEach(function(e){t=o[e.status]||[],t.push(e),o[e.status]=t}),[1,3,5,4,2].forEach(function(e){t=o[e],t&&(a=a.concat(t))}),a):void 0},gotoListPage:function(){var t=this,o=Lizard.P("from");if(o){var a=decodeURIComponent(o).replace(/^\/webapp\/myctrip\//i,""),n=this.getHistory();n.stack.pop(),e.gotoExternalPage("myctrip",a)}else t.back()},events:{"click #J_tuanDetail":"viewTuanDetail","click #J_refund":"goToRefundPage","click #J_hotelMap":"showHotelMap","click #J_retryPayment":"retryPayment","click .J_sendToPhone":"sendCouponToPhone","click #J_cancelOrder":"cancelOrder","click #J_deleteOrder":"deleteOrder","click #J_viewCoupon":"jumpPromocode","click #J_immediateUse":"gotoMooncake","click .J_viewDetail":"gotoDetail","click .link-more":"gotoNearList","click #J_tabNav>li":"recommendSwitch"},onCreate:function(){},onLoad:function(){var t=this;this.from=decodeURIComponent(Lizard.P("from")||""),this.setTitle(J.pageTitle),this.header.set({title:J.pageTitle,back:!0,view:this,tel:{number:4000086666},home:!0,events:{homeHandler:function(){var t=v.getUser();t&&t.IsNonUser&&v.remove(),e.tHome()},returnHandler:function(){t.gotoListPage()}}}),this.header.show(),this.render()},onShow:function(){},onHide:function(){this.hideLoading(),this._confirm&&this._confirm.hide()},getCrossRecommend:function(t){var o=_.template(f),a=this.$el.find("#J_recommendWrap");k.setParam({id:t,isInApp:M,environment:e.environment,head:h.HeadStore.getInstance().get()}),k.execute(function(e){var n=e&&e.RecommendGroups;n.length?(a.show(),a.html(o({data:n,pid:t,city:e.city}))):a.hide()},function(){a.hide()},this,this)},recommendSwitch:function(e){var t=$(e.currentTarget),o=t.data("index");t.hasClass("sta-on")||(t.addClass("sta-on").siblings().removeClass("sta-on"),this.$el.find("#J_tabCon .ui-item").hide().eq(o).show())},_loadCoupon:function(e,t,o,a,n){e[0]&&t&&(e.html(_.template(g,{isShow:n&&n.send,list:t,orderStatus:0|a})),o||e.find(".J_sendToPhone").hide())},_sendMsg:function(e){var t=this,a=[];if(a.push({code:e.attr("data-id")}),0===a.length)return void this.showMessage(J.needOrderID);b.setParam({head:h.HeadStore.getInstance().get(),mphone:S,coupons:a,oid:this.orderId});var n=new o.ui.LoadingLayer(function(){b.ajax.abort(),this.hide()});n.show(),b.execute(function(e){t.hideLoading(),n.hide(),e.res&&(t.cooling=!0,t.coolingSec=60),t.showMessage(J.alreadySend)},function(){n.hide(),t.showToast(J.sendMsgFailed,3),t.hideLoading()},!1,function(){n.hide(),t.showToast(J.sendMsgFailed,3),t.hideLoading()})},sendCouponToPhone:function(e){this.store&&this.store.status&&3==this.store.status||this._sendMsg($(e.currentTarget))},_checkChange:function(){this.msgBox.show(),this.msgBox.hide();var e,t,o;this.msgBox&&(e=this.msgBox.root.find("#ticket_list"),t=e.find(".code"),o=this.msgBox.root.find(".cui-btns-sure").eq(0),t.off("click"),t.on("click",function(t){var a=$(t.target),n=a.hasClass("checked")?"removeClass":"addClass";a[n]("checked"),o.addClass("disable_btn"),e.find("i.checked")[0]&&o.removeClass("diabled_btn")}))},viewTuanDetail:function(){var e=this.store;e&&this.forwardJump("detail","/webapp/tuan/detail/"+e.pid+".html")},fixHistoryBug:function(){var t=e.app.history,o=location.href,a=t.length;t[a-1]!==o&&t.push(o),e.app.history=t},goToRefundPage:function(){this.forwardJump("refund","/webapp/tuan/refund/"+this.orderId+".html")},showHotelMap:function(e){var t=$(e.currentTarget),o=t.attr("data-coords").split(","),a=t.attr("data-hotel-name");window.mapdata={Longitude:o[0],Latitude:o[1],hotelName:a},this.forwardJump("hotelmap","/webapp/tuan/hotelmap?lon="+o[0]+"&lat="+o[1]+"&hotelName="+a)},getAppUrl:function(){return"ctrip://wireless/GrouponHotelOrder?orderId="+this.orderId},retryPayment:function(e){var t=this;$(e.currentTarget).hasClass("btm_tuan_btn_dis")||(P.setParam({oids:this.orderId+"",head:C.getHead().get()}),P.execute(function(e){var o=e.result&&e.result.length?e.result[0]:{};if(t.hideLoading(),o.CanPay){var a=JSON.parse(o.ToUrl),n=JSON.parse(o.Extend);n&&(a.payTypeList=n.payTypeList||0,a.subPayTypeList=n.subPayTypeList||0),a.from=M?"/webapp/tuan/index.html#tuanorderdetail!"+t.orderId:"/webapp/tuan/tuanorderdetail/"+t.orderId+".html",a.islogin=v.isLogin()?0:1,c.submit(t,a,{IsRealPay:e.IsRealPay})}else t.showToast("此订单不支持继续支付！")},function(){t.showToast("继续支付失败！"),t.hideLoading()},!0,t))},showConfirm:function(e,t){this._confirm=new o.ui.Alert({message:e,buttons:[{text:"否",click:function(){this.hide()}},{text:"是",click:function(){t(),this.hide()}}]}),this._confirm.show()},_sendCancelOrder:function(){var e=this,t="申请取消订单";x.setParam({oid:e.orderId}),e.showLoading(),x.excute(function(o){e.hideLoading(),1==o.status?(e.showToast(t+"成功！"),e.onLoad()):e.showToast(t+"失败！")},function(){e.hideLoading(),e.showToast(t+"失败！")})},cancelOrder:function(){var e=this;e.showConfirm("是否确认取消订单？",function(){e._sendCancelOrder()})},_sendDeleteOrder:function(){var e=this,t="申请删除订单",o=e.from||"/webapp/myctrip/index.html#orders/tuanorderlist";L.setParam({oid:e.orderId}),e.showLoading(),L.excute(function(a){e.hideLoading(),1==a.status?(e.showToast(t+"成功！"),M?D.cross({path:"myctrip",param:o.replace(/^\/webapp\/myctrip\//i,"")}):location.href=location.protocol+"//"+location.host+o):e.showToast(t+"失败！")},function(){e.hideLoading(),e.showToast(t+"失败！")})},deleteOrder:function(){var e=this;e.showConfirm("是否确认删除订单？",function(){e._sendDeleteOrder()})},jumpPromocode:function(){var e="https://sinfo.ctrip.com/webapp/promocode/#index";(location.host.match(/^(localhost|172\.16|127\.0)/i)||location.host.match(/^waptest\.ctrip|^210\.13\.100\.191|fat\d*\.qa\.nt\.ctripcorp\.com/i))&&(e="https://sinfo.fat19.qa.nt.ctripcorp.com/webapp/promocode/#index");var t=JSON.parse(localStorage.getItem("USERINFO"));if(t&&t.data&&t.data.Auth){var o={auth:t.data.Auth};M?D.cross({path:"promocode",param:"index.html#index?token="+encodeURIComponent(a.Base64.encode(JSON.stringify(o)))}):Lizard.goTo(e+"?token="+encodeURIComponent(a.Base64.encode(JSON.stringify(o))))}else Lizard.goTo("/webapp/myctrip/#account/login?from="+encodeURIComponent(location.href))},gotoMooncake:function(){this.forwardJump("home","/webapp/tuan/home")},gotoDetail:function(e){var t=$(e.currentTarget),o=t.data("pid");99==t.data("type")?M?D.cross({path:"activity",param:"index.html#/dest/t"+o+".html?ext="+R}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/t"+o+".html?from="+encodeURIComponent(location.href)+"&ext="+R:this.forwardJump("detail","/webapp/tuan/detail/"+o+".html")},gotoNearList:function(e){var t=$(e.currentTarget),o=t.data("pid"),a=t.data("cityid"),n=t.data("cityname"),i=t.data("type"),r=t.data("title");99==t.data("type")?M?D.cross({path:"activity",param:"index.html#/dest/ct-"+n+"-"+a+"?ext="+R}):location.href=location.protocol+"//"+location.host+"/webapp/activity/dest/ct-"+n+"-"+a+".html?from="+encodeURIComponent(location.href)+"&ext="+R:this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+o+"&category="+i+"&title="+r)}})});