define(["TuanApp","libs","c","MemCache","cUtility","cHybridFacade","cWidgetMember","cWidgetGuider","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","CommonStore","text!DetailTpl","cWidgetFactory","CallPhone","WechatShare"],function(t,e,a,i,o,r,n,s,c,d,l,h,u,f,m,p,v){function g(t){return t.toISOString().substring(0,10).replace(/-/g,"")}var w,I={pageTitle:"团购详情",delFavoriteSuccess:"已取消收藏",addFavoriteSuccess:"收藏成功",delFavoriteError:"取消收藏失败",addFavoriteError:"添加收藏失败"},b={content:"仅售<%=price%>元！<%=name%>，<%if(score>0){%>评价<%=score%>分，<%}%><%if(addr){%><%=addr%><%}%>"},k="view_unfold",D="view_fold",T="success",y="btm_tuan_btn_dis",C=o.isInApp(),F=h.TuanDetailModel.getInstance(),S=c.TuanDetailsStore.getInstance(),J=h.TuanAddFavorite.getInstance(),H=h.TuanDelFavorite.getInstance(),P=c.GroupGeolocation.getInstance(),M=u.UserStore.getInstance(),x=c.TuanOrderInfoStore.getInstance(),L=c.TuanInvoiceStore.getInstance(),U=m.create("Member"),R=m.create("Guider"),A=Lizard.P,O=l.create("TuanBaseView");return w=O.extend({pageid:"214008",hpageid:"215008",hasAd:!1,backHome:function(){t.tHome()},events:{"click #J_submit":"submit","click .J_relatedProducts":"gotoRelatedProducts","click .J_tips":"showTips","click .J_viewMoreBtn":"ctrlInfoTip","click #J_pic":"showImages","click #J_branch":"showBranch","click .J_showDetailMap":"showMap","click #J_comment":"showComment","click #J_service":"showService","click #J_morehotel":"showMorehotel","click #J_expandInvalid":"toggleInvalidDateInfo","click #J_recommendNearby":"recommendNearby","click #J_gotoHotelDetail":"onHotelDetailClick","click .J_nearProducts":"gotoNearProduct","click #J_groupContain":"gotoGroupContent"},onCreate:function(){this.htmlfun=_.template(f),this.cityId=A("cityid"),this.productId=A("pid")||A("productID"),this.externalReferURL=A("url")},_onLoad:function(){this.fromUrl=o.getUrlParam(location.href,"from"),(!this.fromUrl||this.isFromWeChat())&&(this.fromUrl=""),this.removeOrderData(),this.getTuanDetail()},isFromWeChat:function(){return"undefined"!=typeof WeixinJSBridge},recommendNearby:function(){var t=this.cityId;this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+this.productId+(t?"&cityid="+t:""))},setHeader:function(t){var e,a=this;if(e={title:I.pageTitle,back:!0,view:this,favorited:!!t,favorite:!t,share:!0,events:{returnHandler:function(){a.$el.html(""),a.backAction()}}},!C){var i=t?"icon_fav i_bef":"icon_unfav i_bef";e.events.commitHandler=function(){a.favorite()},e.btn={title:"",id:"favorite",classname:i}}this.header.set(e),this.header.show()},favorite:function(){var t=this,e=t.favorInfo;t.checkLogin()&&(e&&e.isFavor?t._delFavorite():t._addFavorite())},prepareShareData:function(t){var e,a=this,i=a.cityId,o=b,r=a.detailData,n="http://m.ctrip.com/webapp/tuan/detail/"+a.productId+".html"+(i?"?cityid="+i:""),s=r.hotels[0]||r.recommendHotel.hotel||{name:r.name},c=r.images,d=c&&c.length&&c[0].small,l=r.name||s.name;e={imgUrl:d,text:_.template(o.content)({price:r.price&&r.price.dPrice||"",name:l,score:s.score,addr:s&&s.addr||"",link:n}),title:s.name,linkUrl:n,isIOSSystemShare:!1},C?d&&R.downloadData({url:d,callback:function(i){e.imgUrl=i.savedPath,t&&t.call(a,e)}}):t&&t.call(a,e)},bindShareEvent:function(){var t=this;R.apply({callback:function(){},hybridCallback:function(){R.register({tagname:r.METHOD_SHARE,callback:function(){t.prepareShareData(function(t){R.shareToVendor(t)})}})}})},updateFavorStatus:function(t,e){var a=this;a.updateFavorButton(t),a.favorInfo={isFavor:!!t,favorId:e},S.setAttr("favorInfo",a.favorInfo)},updateFavorButton:function(t){var e=this;e.setHeader(t),R.apply({callback:function(){},hybridCallback:function(){R.register({tagname:r.METHOD_FAVORITE,callback:function(){e.favorite()}}),R.register({tagname:r.METHOD_FAVORITED,callback:function(){e.favorite()}})}})},_addFavorite:function(){var t=this;J.setParam({pid:t.productId,type:t.productInfo.pcId}),J.excute(function(e){e&&e.ResponseStatus.Ack.toLowerCase()===T&&(t.updateFavorStatus(!0,e.favorId),t.showToast(I.addFavoriteSuccess))},function(){t.showToast(I.addFavoriteError)})},_delFavorite:function(){var t=this;H.setParam({favorId:t.favorInfo.favorId}),H.excute(function(e){e&&e.ResponseStatus.Ack.toLowerCase()===T&&(t.updateFavorStatus(!1),t.showToast(I.delFavoriteSuccess))},function(){t.showToast(I.delFavoriteError)})},checkLogin:function(){var t=this,e=location.port;return M.isLogin()?!0:(!C&&t.showLoading(),U.memberLogin({domain:"//"+document.domain+(e&&80==e?"":":"+e),param:"?t=1&from="+encodeURIComponent("/webapp/tuan/detail/"+t.productId+".html"+(this.cityId?"?cityid="+this.cityId:"")),callback:function(){t._onLoad(t.referer)}}),!1)},onShow:function(){this.hideLoading(),this._onLoad()},onHide:function(){this.timer&&clearInterval(this.timer),this.hideLoading(),this.hideWarning404(),this.mask&&this.mask.hide(),this.CallPhone&&this.CallPhone.hideMask()},isFromHybridFavorPage:function(){return C&&1==A("from_native_page")},isFromHotel:function(t){return t.indexOf("/hotel/")>-1},backAction:function(){if(this.isFromHybridFavorPage())return void R.backToLastPage({param:JSON.stringify({biz:"tuan",refresh:"1"})});var e=decodeURIComponent(this.fromUrl||"");if(e){var a=this.getHistory();a.stack.pop(),this.isFromHotel(e)?location.href=e:t.jumpToPage(e,this)}else this.back()},removeOrderData:function(){L&&L.remove(),x&&x.remove()},getTuanDetail:function(){var e,a=this,i=this.cityId,o=P.getAttr("gps")||{};this.showLoading(),e={id:a.productId,pos:{lon:o.lng,lat:o.lat,type:3,name:o.city},environment:t.environment},i&&(e.cityid=i),F.setParam(e),F.excute(function(t){var e,i=t.channelInfo,o=i&&i.isCorrectChannel;return this.hideLoading(),t&&t.hotels?(o||this.showMessage("该产品暂不支持手机售卖， 请在电脑端登录携程后购买。"),this.detailData=t,this.renderData(t),e=t.favorInfo,a.favorInfo=e,a.productInfo=t,a.updateFavorStatus(e&&e.isFavor,e&&e.favorId),void a.bindShareEvent()):void this.showMessage("抱歉，数据加载失败，请重试或返回!")},function(){var t=this;this.showWarning404($.proxy(t.getTuanDetail,t)),this.hideLoading()},!1,this)},renderData:function(t){var e,a=t.labelVal,i="",o=t.channelInfo,r=o&&o.isCorrectChannel;t.isInApp=C,this.$el.html($.trim(this.htmlfun({data:t}))),e=this.$el.find("#J_submit"),98==a||(99==a?i="已售完":100==a&&(i="已结束")),i&&e.attr("class",y).text(i).removeAttr("id"),r||e.attr("class",y),this.showTimer(t.etime),this.productData=t,this.CallPhone=new p({view:this}),this.isFromWeChat()&&this.initWechatShare()},initWechatShare:function(){this.prepareShareData(function(t){try{{new v({data:{img_url:t.imgUrl,img_width:"200",img_height:"200",link:t.linkUrl,desc:t.text,title:t.title}})}}catch(e){}})},gotoGroupContent:function(){this.forwardJump("lashou","/webapp/tuan/lashou/"+this.productId+".html")},submit:function(){this.$el.find("#J_submit").hasClass(y)||this.forwardJump("booking","/webapp/tuan/booking"+(this.externalReferURL?"?from="+this.externalReferURL:""))},gotoRelatedProducts:function(t){var e=$(t.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(this.cityId?"?cityid="+this.cityId:""))},ctrlInfoTip:function(t){var e=$(t.target),a=e.parent().prev().find(".J_tipsHidden");"hide"===e.attr("data-state")?(a.show(),e.attr({"data-state":"show"}).html("收起").removeClass("view_unfold").addClass("view_fold")):(e.attr({"data-state":"hide"}).html("查看全部").removeClass("view_fold").addClass("view_unfold"),a.hide())},showTips:function(){this.forwardJump("detailtips","/webapp/tuan/detailtips")},showImages:function(){var t=this.productData.images;t&&t.length&&this.forwardJump("hotelimages","/webapp/tuan/hotelimages/"+this.productId+".html",{viewName:"hotelimages"})},showBranch:function(){var t=this.cityId;this.forwardJump("hotelsubbranch","/webapp/tuan/hotelsubbranch"+(t?"?cityid="+t:""))},showMap:function(t){var e=$(t.currentTarget),a=e.attr("data-coords").split(","),i=a[0],o=a[1],r=e.attr("data-hotel-name");this.showCommonMap(r,i,o)},showComment:function(){this.forwardJump("hotelcomments","/webapp/tuan/hotelcomments")},showService:function(){this.forwardJump("hotelservice","/webapp/tuan/hotelservice")},showMorehotel:function(t){var e=this.$el.find(".J_relatedRest"),a=$(t.target),i=a.data("expanded");e.css({display:i?"none":""}).removeClass("no_bb"),a.data("expanded",!i).html(i?"更多":"收起").attr("class",i?"view_unfold":"view_fold")},showTimer:function(t){var e=Date.parse(t.replace(/\-/g,"/")),a=this.getServerDate();this.dateDiff=e-a;var i=864e5;this.dateDiff/i<3&&(this.timer=setInterval(_.bind(this.updateTimer,this),600))},updateTimer:function(){if(this.dateDiff>0){var t=864e5,e=36e5,a=6e4,i=1e3,o=this.dateDiff,r=Math.floor(o/t);o%=t;var n=Math.floor(o/e);o%=e;var s=Math.floor(o/a);o%=a;var c=Math.floor(o/i);this.$el.find(".tuan_hotel_time").text("剩余  "+r+"天"+n+"小时"+s+"分"+c+"秒"),this.dateDiff=this.dateDiff-1e3}else this.endTimer()},endTimer:function(){clearInterval(this.timer),this.$el.find(".tuan_hotel_time").text("0天0小时0分0秒"),this.$el.find("#J_submit").addClass(y)},getAppUrl:function(){var t=A("pid");return"ctrip://wireless/hotel_groupon_detail?c1="+t},toggleInvalidDateInfo:function(t){var e=$(t.target),a=e.hasClass(k),i=e.parent().prev();i[a?"show":"hide"](),a?e.removeClass(k).addClass(D).text("收起"):e.removeClass(D).addClass(k).text("查看不适用日期")},onHotelDetailClick:function(t){var e=$(t.target).attr("data-hotel-id");this.gotoHotelDetail(e)},gotoNearProduct:function(t){var e=$(t.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(this.cityId?"?cityid="+this.cityId:""))},gotoHotelDetail:function(e){var a=new Date,i=new Date(a.setDate(a.getDate()+1)),o=encodeURIComponent(location.href),r=C?"ctrip://wireless/InlandHotel?hotelDataType=1&checkInDate="+g(new Date)+"&checkOutDate="+g(i)+"&hotelId="+e+"&from="+o:"http://m.ctrip.com/webapp/hotel/hoteldetail/"+e+".html?from="+o;t.jumpToPage(r,this)}})});