define(["TuanApp","libs","c","MemCache","cUtility","cHybridFacade","cWidgetMember","cWidgetGuider","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","CommonStore","text!DetailTpl","text!DetailNearTpl","cWidgetFactory","CallPhone","WechatShare","Helper","SmoothSlide"],function(t,e,i,a,o,n,r,s,d,h,c,l,u,m,p,f,v,g){function w(t){return t.toISOString().substring(0,10).replace(/-/g,"")}var I,b={pageTitle:"团购详情",delFavoriteSuccess:"已取消收藏",addFavoriteSuccess:"收藏成功",delFavoriteError:"取消收藏失败",addFavoriteError:"添加收藏失败"},C={content:"仅售<%=price%>元！<%=name%>，<%if(score>0){%>评价<%=score%>分，<%}%><%if(addr){%><%=addr%><%}%>"},y="view_unfold",k="view_fold",J="success",S="btm_tuan_btn_dis",x=o.isInApp(),T=l.TuanDetailModel.getInstance(),D=d.TuanDetailsStore.getInstance(),N=l.TuanAddFavorite.getInstance(),P=l.TuanDelFavorite.getInstance(),F=l.TuanNearListModel.getInstance(),H=d.GroupGeolocation.getInstance(),L=u.UserStore.getInstance(),M=d.TuanOrderInfoStore.getInstance(),A=d.TuanInvoiceStore.getInstance(),U=f.create("Member"),R=f.create("Guider"),B=Lizard.P,W=f.create("SmoothSlide"),O=$("body"),G=5,E=c.create("TuanBaseView");return I=E.extend({pageid:"214008",hpageid:"215008",hasAd:!1,lineHeight:21,backHome:function(){t.tHome()},events:{"click #J_return ":"returnHandler","click #J_submit":"submit","click #J_favBtn":"favorite","click #J_share":"shareHandler","click .J_relatedProducts":"gotoRelatedProducts","click .J_tips":"showTips","click .J_viewMoreBtn":"ctrlInfoTip","click .J_showNotePop":"showNotePop","click .J_notesPopBox":"hideNotePop","click .J_picItem":"showImageSlide","click #J_branch":"showBranch","click .J_showDetailMap":"showMap","click #J_comment":"showComment","click #J_service":"showService","click #J_morehotel":"showMorehotel","click #J_expandInvalid":"toggleInvalidDateInfo","click #J_recommendNearby":"recommendNearby","click #J_gotoHotelDetail":"onHotelDetailClick","click .J_nearProducts":"gotoNearProduct","click #J_groupContain":"gotoGroupContent"},onCreate:function(){this.htmlfun=_.template(m),this.cityId=B("cityid"),this.productId=B("pid")||B("productID"),this.externalReferURL=B("url")},_onLoad:function(){var t=this.fromUrl=o.getUrlParam(location.href,"from"),e=this.isFromWeChat=t&&/singlemessage|timeline/.test(t.toLowerCase());(!t||e)&&(this.fromUrl=""),this.removeOrderData(),this.getTuanDetail()},recommendNearby:function(){var t=this.cityId,e=this.$el.find(".J_nearTabs .cur").attr("data-category")||1;this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+this.productId+"&category="+e+(t?"&cityid="+t:""))},updateHeader:function(t){x?(this.$head&&this.$head.addClass("headerview_detail_app"),this.$buyCon&&this.$buyCon.addClass("tuan_buy_app")):this.$el.find("#J_share").remove(),this.$el.find("#J_favBtn").attr("class",t?"icon_fav i_bef":"icon_unfav i_bef")},favorite:function(){var t=this,e=t.favorInfo;t.checkLogin()&&(e&&e.isFavor?t._delFavorite():t._addFavorite())},prepareShareData:function(t){var e,i=this,a=C,o=i.detailData,n="http://m.ctrip.com/webapp/tuan/detail/"+i.productId+".html?cityid="+i.cityId,r=o.hotels[0]||o.recommendHotel.hotel||{name:o.name},s=o.images,d=s&&s.length&&s[0].small,h=o.name||r.name;e={imgUrl:d,text:_.template(a.content)({price:o.price&&o.price.dPrice||"",name:h,score:r.score,addr:r&&r.addr||"",link:n}),title:r.name,linkUrl:n,isIOSSystemShare:!1},x?d&&R.downloadData({url:d,callback:function(a){e.imgUrl=a.savedPath,t&&t.call(i,e)}}):t&&t.call(i,e)},shareHandler:function(){this.prepareShareData(function(t){R.shareToVendor(t)})},updateFavorStatus:function(t,e){var i=this;this.updateHeader(t),i.favorInfo={isFavor:!!t,favorId:e},D.setAttr("favorInfo",i.favorInfo)},_addFavorite:function(){var t=this;N.setParam({pid:t.productId,type:t.productInfo.pcId}),N.excute(function(e){e&&e.ResponseStatus.Ack.toLowerCase()===J&&(t.updateFavorStatus(!0,e.favorId),t.showToast(b.addFavoriteSuccess))},function(){t.showToast(b.addFavoriteError)})},_delFavorite:function(){var t=this;P.setParam({favorId:t.favorInfo.favorId}),P.excute(function(e){e&&e.ResponseStatus.Ack.toLowerCase()===J&&(t.updateFavorStatus(!1),t.showToast(b.delFavoriteSuccess))},function(){t.showToast(b.delFavoriteError)})},checkLogin:function(){var t=this,e=location.port;return L.isLogin()?!0:(!x&&t.showLoading(),U.memberLogin({domain:"//"+document.domain+(e&&80==e?"":":"+e),param:"?t=1&from="+encodeURIComponent("/webapp/tuan/detail/"+t.productId+".html"+(this.cityId?"?cityid="+this.cityId:"")),callback:function(){t._onLoad(t.referer)}}),!1)},onShow:function(){this.hideLoading(),this.header&&this.header.hide(),this.$el.on("touchmove",this.onScroll.bind(this)),this._onLoad()},onHide:function(){this.hideLoading(),this.hideWarning404(),this.mask&&this.mask.hide(),this.CallPhone&&this.CallPhone.hideMask(),this.$el.off("touchmove",this.onScroll.bind(this)),!t.isInApp&&this.header&&this.header.rootBox&&this.header.rootBox.show()},isFromHybridFavorPage:function(){return x&&1==B("from_native_page")},isFromHotel:function(t){return t.indexOf("/hotel/")>-1},returnHandler:function(){this.$el.html(""),this.backAction()},backAction:function(){if(this.isFromHybridFavorPage())return void R.backToLastPage({param:JSON.stringify({biz:"tuan",refresh:"1"})});var e=decodeURIComponent(this.fromUrl||"");if(e){var i=this.getHistory();i.stack.pop(),this.isFromHotel(e)?location.href=e:t.jumpToPage(e,this)}else this.back()},removeOrderData:function(){A&&A.remove(),M&&M.remove()},getTuanDetail:function(){var e,i=this,a=this.cityId,o=H.getAttr("gps")||{};this.showLoading(),e={id:i.productId,pos:{lon:o.lng,lat:o.lat,type:3,name:o.city},environment:t.environment},a&&(e.cityid=a),T.setParam(e),T.excute(function(t){this.hideWarning404();var e,a=t.channelInfo,o=a&&a.isCorrectChannel;return this.hideLoading(),t&&t.hotels?(o||this.showMessage("该产品暂不支持手机售卖， 请在电脑端登录携程后购买。"),this.detailData=t,this.renderData(t),e=t.favorInfo,i.favorInfo=e,i.productInfo=t,void i.updateFavorStatus(e&&e.isFavor,e&&e.favorId)):void this.showMessage("抱歉，数据加载失败，请重试或返回!")},function(){var t=this;this.showWarning404($.proxy(t.getTuanDetail,t)),this.hideLoading()},!1,this)},renderData:function(t){var e,i=t.labelVal,a="",o=t.channelInfo,n=o&&o.isCorrectChannel;t.isInApp=x,this.$el.html($.trim(this.htmlfun({data:t}))),this.$purNotes=this.$el.find(".J_purchaseNotes"),this.$popNotes=this.$el.find(".J_notesPopBox"),this.$head=this.$el.find("#J_headerview"),this.$buyCon=this.$el.find(".J_sticky"),this.renderArround(1),this.initImageSlider(t.images),this.hideMoreContent(),this.hideMoreNotes(),e=this.$el.find("#J_submit"),98==i||(99==i?a="已售完":100==i&&(a="已结束")),a&&e.attr("class",S).text(a).removeAttr("id"),n||e.attr("class",S),this.productData=t,this.CallPhone=new v({view:this}),this.isFromWeChat&&this.initWechatShare()},renderArround:function(e){var i=this.$el.find(".J_aroundProduct");F.setParam({category:e,id:this.productId,environment:t.environment}),F.excute(function(t){t&&t.products&&t.products.length?i.append(_.template(p,{data:t,num:4})):i.remove()},function(){i.remove()},!1,this)},hideMoreContent:function(){var t,e=this.$el.find(".J_moreOrLessPanel"),i=this.lineHeight;$.each(e,function(){t=$(this),t.height()<=G*i?(t.next().remove(),t.removeClass("shadow")):t.css({overflow:"hidden",height:G*i+"px"})})},hideMoreNotes:function(){this.$purNotes.find("p").length>=5},initImageSlider:function(t){var e=O.offset().width,i=this.$el.find("#J_pic"),a=0|D.getAttr("imageIndex"),o=this;t=t.slice(0,5),a=a>=5?4:0>a?0:a,this.imageSlider=new W({container:i,source:_.map(t,function(t){return{src:t.large,title:t.title}}),itemCls:".J_picItem",autoplay:0,currentIndex:a,prefetch:5,tpl:'<ul class="cont" style="height:180px;width:9999px;font-size:0;z-index: 1;"><%_.each(data, function(t, i) {%><li class="J_picItem" data-index="<%=i%>" style="display:inline-block"><img data-src="<%=t.src%>" data-img-title="<%=t.title%>"/><%if (i === data.length-1) {%><span class="endinfo">滑动查看相册</span><%}%></li><%});%></ul>',width:e,onTouchEnd:function(e,i,a){e===t.length-1&&"left"===i&&a>10&&(D.setAttr("imageIndex",e),o.showImages())},onSwitch:function(t){o.selectImageNav(t)},onInit:function(){o.initSlideNav(i,t.length,a)}})},initSlideNav:function(t,e,i){var a=t.find(".J_navItem");a.length||(a=$(_.template('<div class="navitem J_navItem"><% for(var i=0;i<len;i++) {%><i class="<%if(cur === i){%> cur<%}%>"></i><%}%></div>',{len:e,cur:i})).appendTo(t)),this.sliderNav=a},selectImageNav:function(t){this.sliderNav&&this.sliderNav.length&&this.sliderNav.find("i").removeClass("cur").eq(t).addClass("cur")},initWechatShare:function(){this.prepareShareData(function(t){var e;try{e=new g({data:{img_url:t.imgUrl,img_width:"200",img_height:"200",link:t.linkUrl,desc:t.text,title:t.title}})}catch(i){}})},gotoGroupContent:function(){this.forwardJump("lashou","/webapp/tuan/lashou/"+this.productId+".html")},submit:function(){this.$el.find("#J_submit").hasClass(S)||this.forwardJump("booking","/webapp/tuan/booking"+(this.externalReferURL?"?from="+this.externalReferURL:""))},gotoRelatedProducts:function(t){var e=$(t.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(this.cityId?"?cityid="+this.cityId:""))},ctrlInfoTip:function(t){var e=$(t.target),i=e.parent().prev();"hide"===e.attr("data-state")?(i.removeAttr("style").removeClass("shadow"),e.attr({"data-state":"show"}).html("收起").removeClass("view_unfold").addClass("view_fold")):(i.css({overflow:"hidden",height:this.lineHeight*G+"px"}).addClass("shadow"),e.attr({"data-state":"hide"}).html("查看全部").removeClass("view_fold").addClass("view_unfold"))},showTips:function(){this.forwardJump("detailtips","/webapp/tuan/detailtips")},showImages:function(){var t=this.productData.images;t&&t.length&&this.forwardJump("hotelimages","/webapp/tuan/hotelimages/"+this.productId+".html",{viewName:"hotelimages"})},showImageSlide:function(t){var e=0|$(t.currentTarget).attr("data-index");D.setAttr("imageIndex",e),this.forwardJump("hotelimageslide","/webapp/tuan/hotelimageslide/"+this.productId+"?index="+(e+1),{viewName:"hotelimageslide"})},showBranch:function(){var t=this.cityId;this.forwardJump("hotelsubbranch","/webapp/tuan/hotelsubbranch"+(t?"?cityid="+t:""))},showMap:function(t){var e,i=$(t.currentTarget);/J_phone/gi.test(i.attr("class"))||(e=i.attr("data-coords").split(","),this.showCommonMap(i.attr("data-hotel-name"),e[0],e[1]))},showComment:function(){this.forwardJump("hotelcomments","/webapp/tuan/hotelcomments")},showService:function(){this.forwardJump("hotelservice","/webapp/tuan/hotelservice")},showMorehotel:function(t){var e=this.$el.find(".J_relatedRest"),i=$(t.target),a=i.data("expanded");e.css({display:a?"none":""}).removeClass("no_bb"),i.data("expanded",!a).html(a?"更多":"收起").attr("class",a?"view_unfold":"view_fold")},showNotePop:function(){var t=this.$popNotes,e=this.$purNotes&&this.$purNotes[0];t.html(e?e.outerHTML:""),t.find(".J_showNotePop").remove(),!this.mask&&(this.mask=new i.ui.Mask),t.show(),this.mask.show()},hideNotePop:function(){this.mask&&this.mask.hide(),this.$popNotes&&this.$popNotes.hide()},getAppUrl:function(){var t=B("pid");return"ctrip://wireless/hotel_groupon_detail?c1="+t},toggleInvalidDateInfo:function(t){var e=$(t.target),i=e.hasClass(y),a=e.parent().prev();a[i?"show":"hide"](),i?e.removeClass(y).addClass(k).text("收起"):e.removeClass(k).addClass(y).text("查看不适用日期")},onHotelDetailClick:function(t){var e=$(t.target).attr("data-hotel-id");this.gotoHotelDetail(e)},gotoNearProduct:function(t){var e=$(t.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(this.cityId?"?cityid="+this.cityId:""))},gotoHotelDetail:function(e){var i=new Date,a=new Date(i.setDate(i.getDate()+1)),o=encodeURIComponent(location.href),n=x?"ctrip://wireless/InlandHotel?hotelDataType=1&checkInDate="+w(new Date)+"&checkOutDate="+w(a)+"&hotelId="+e+"&from="+o:"http://m.ctrip.com/webapp/hotel/hoteldetail/"+e+".html?from="+o;t.jumpToPage(n,this)},onScroll:function(){var t=this.$buyCon,e=180-(x?61:41);t&&(window.scrollY>=e?(t.prev().css("marginBottom",t.height()+(parseInt(t.css("margin-bottom"),10)||0)),t.addClass("tuan_buy_fixed"),this.$head&&this.$head.addClass("headerview_bgcolor")):(t.prev().css("marginBottom","0"),t.removeClass("tuan_buy_fixed"),this.$head&&this.$head.removeClass("headerview_bgcolor")))}})});