define(["TuanApp","libs","c","MemCache","cUtility","cHybridFacade","cWidgetMember","cWidgetGuider","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","CommonStore","text!DetailTpl","cWidgetFactory","CallPhone"],function(t,e,a,i,o,r,n,s,c,d,l,h,u,f,m,p){function v(t){return t.toISOString().substring(0,10).replace(/-/g,"")}var g,w={pageTitle:"团购详情",delFavoriteSuccess:"已取消收藏",addFavoriteSuccess:"收藏成功",delFavoriteError:"取消收藏失败",addFavoriteError:"添加收藏失败"},I={content:"仅售<%=price%>元！<%=name%>，<%if(score>0){%>评价<%=score%>分，<%}%><%if(addr){%><%=addr%><%}%>"},b="view_unfold",D="view_fold",k="success",T="btm_tuan_btn_dis",y=o.isInApp(),C=h.TuanDetailModel.getInstance(),F=c.TuanDetailsStore.getInstance(),J=h.TuanAddFavorite.getInstance(),S=h.TuanDelFavorite.getInstance(),H=c.GroupGeolocation.getInstance(),L=u.UserStore.getInstance(),P=c.TuanOrderInfoStore.getInstance(),x=c.TuanInvoiceStore.getInstance(),M=m.create("Member"),U=m.create("Guider"),R=Lizard.P,A=l.create("TuanBaseView");return g=A.extend({pageid:"214008",hpageid:"215008",hasAd:!1,backHome:function(){t.tHome()},events:{"click #J_submit":"submit","click .J_relatedProducts":"gotoRelatedProducts","click .J_tips":"showTips","click .J_viewMoreBtn":"ctrlInfoTip","click #J_pic":"showImages","click #J_branch":"showBranch","click .J_showDetailMap":"showMap","click #J_comment":"showComment","click #J_service":"showService","click #J_morehotel":"showMorehotel","click #J_expandInvalid":"toggleInvalidDateInfo","click #J_recommendNearby":"recommendNearby","click #J_gotoHotelDetail":"onHotelDetailClick","click .J_nearProducts":"gotoNearProduct","click #J_groupContain":"gotoGroupContent"},onCreate:function(){this.htmlfun=_.template(f),this.cityId=R("cityid"),this.productId=R("pid")||R("productID"),this.externalReferURL=R("url")},_onLoad:function(){this.fromUrl=o.getUrlParam(location.href,"from"),(!this.fromUrl||this.isFromWeChat(this.fromUrl))&&(this.fromUrl=""),this.removeOrderData(),this.getTuanDetail()},isFromWeChat:function(t){return t&&t.toLowerCase().indexOf("singlemessage")>-1},recommendNearby:function(){var t=this.cityId;this.forwardJump("nearlist","/webapp/tuan/nearlist?pid="+this.productId+(t?"&cityid="+t:""))},setHeader:function(t){var e,a=this;if(e={title:w.pageTitle,back:!0,view:this,favorited:!!t,favorite:!t,share:!0,events:{returnHandler:function(){a.backAction()}}},!y){var i=t?"icon_fav i_bef":"icon_unfav i_bef";e.events.commitHandler=function(){a.favorite()},e.btn={title:"",id:"favorite",classname:i}}this.header.set(e),this.header.show()},favorite:function(){var t=this,e=t.favorInfo;t.checkLogin()&&(e&&e.isFavor?t._delFavorite():t._addFavorite())},prepareShareData:function(t){var e,a=this,i=I,o=a.detailData,r="http://m.ctrip.com/webapp/tuan/detail/"+a.productId+".html?cityid="+a.cityId,n=o.hotels[0]||o.recommendHotel.hotel||{name:o.name},s=o.images,c=s&&s.length&&s[0].small,d=o.name||n.name;e={imgUrl:c,text:_.template(i.content)({price:o.price&&o.price.dPrice||"",name:d,score:n.score,addr:n&&n.addr||"",link:r}),title:n.name,linkUrl:r,isIOSSystemShare:!1},c&&U.downloadData({url:c,callback:function(i){e.imgUrl=i.savedPath,t&&t.call(a,e)}})},bindShareEvent:function(){var t=this;U.apply({callback:function(){},hybridCallback:function(){U.register({tagname:r.METHOD_SHARE,callback:function(){t.prepareShareData(function(t){U.shareToVendor(t)})}})}})},updateFavorStatus:function(t,e){var a=this;a.updateFavorButton(t),a.favorInfo={isFavor:!!t,favorId:e},F.setAttr("favorInfo",a.favorInfo)},updateFavorButton:function(t){var e=this;e.setHeader(t),U.apply({callback:function(){},hybridCallback:function(){U.register({tagname:r.METHOD_FAVORITE,callback:function(){e.favorite()}}),U.register({tagname:r.METHOD_FAVORITED,callback:function(){e.favorite()}})}})},_addFavorite:function(){var t=this;J.setParam({pid:t.productId,type:t.productInfo.pcId}),J.excute(function(e){e&&e.ResponseStatus.Ack.toLowerCase()===k&&(t.updateFavorStatus(!0,e.favorId),t.showToast(w.addFavoriteSuccess))},function(){t.showToast(w.addFavoriteError)})},_delFavorite:function(){var t=this;S.setParam({favorId:t.favorInfo.favorId}),S.excute(function(e){e&&e.ResponseStatus.Ack.toLowerCase()===k&&(t.updateFavorStatus(!1),t.showToast(w.delFavoriteSuccess))},function(){t.showToast(w.delFavoriteError)})},checkLogin:function(){var t=this,e=location.port;return L.isLogin()?!0:(!y&&t.showLoading(),M.memberLogin({domain:"//"+document.domain+(e&&80==e?"":":"+e),param:"?t=1&from="+encodeURIComponent("/webapp/tuan/detail/"+t.productId+".html"+(this.cityId?"?cityid="+this.cityId:"")),callback:function(){t._onLoad(t.referer)}}),!1)},onShow:function(){this.hideLoading(),this._onLoad()},onHide:function(){this.timer&&clearInterval(this.timer),this.hideLoading(),this.hideWarning404(),this.mask&&this.mask.hide()},isFromHybridFavorPage:function(){return y&&1==R("from_native_page")},isFromHotel:function(t){return t.indexOf("/hotel/")>-1},backAction:function(){if(this.isFromHybridFavorPage())return void U.backToLastPage({param:JSON.stringify({biz:"tuan",refresh:"1"})});var e=decodeURIComponent(this.fromUrl||"");if(e){var a=this.getHistory();a.stack.pop(),this.isFromHotel(e)?location.href=e:t.jumpToPage(e,this)}else this.back()},removeOrderData:function(){x&&x.remove(),P&&P.remove()},getTuanDetail:function(){var e,a=this,i=this.cityId,o=H.getAttr("gps")||{};this.showLoading(),e={id:a.productId,pos:{lon:o.lng,lat:o.lat,type:3,name:o.city},environment:t.environment},i&&(e.cityid=i),C.setParam(e),C.excute(function(t){var e,i=t.channelInfo,o=i&&i.isCorrectChannel;return this.hideLoading(),t&&t.hotels?(o||this.showMessage("该产品暂不支持手机售卖， 请在电脑端登录携程后购买。"),this.detailData=t,this.renderData(t),e=t.favorInfo,a.favorInfo=e,a.productInfo=t,a.updateFavorStatus(e&&e.isFavor,e&&e.favorId),void a.bindShareEvent()):void this.showMessage("抱歉，数据加载失败，请重试或返回!")},function(){var t=this;this.showWarning404($.proxy(t.getTuanDetail,t)),this.hideLoading()},!1,this)},renderData:function(t){var e,a=t.labelVal,i="",o=t.channelInfo,r=o&&o.isCorrectChannel;t.isInApp=y,this.$el.html($.trim(this.htmlfun({data:t}))),e=this.$el.find("#J_submit"),98==a||(99==a?i="已售完":100==a&&(i="已结束")),i&&e.attr("class",T).text(i).removeAttr("id"),r||e.attr("class",T),this.showTimer(t.etime),this.productData=t,this.CallPhone=new p({view:this})},gotoGroupContent:function(){this.forwardJump("lashou","/webapp/tuan/lashou/"+this.productId+".html")},submit:function(){this.$el.find("#J_submit").hasClass(T)||this.forwardJump("booking","/webapp/tuan/booking"+(this.externalReferURL?"?from="+this.externalReferURL:""))},gotoRelatedProducts:function(t){var e=$(t.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(this.cityId?"?cityid="+this.cityId:""))},ctrlInfoTip:function(t){var e=$(t.target),a=e.parent().prev().find(".J_tipsHidden");"hide"===e.attr("data-state")?(a.show(),e.attr({"data-state":"show"}).html("收起").removeClass("view_unfold").addClass("view_fold")):(e.attr({"data-state":"hide"}).html("查看全部").removeClass("view_fold").addClass("view_unfold"),a.hide())},showTips:function(){this.forwardJump("detailtips","/webapp/tuan/detailtips")},showImages:function(){var t=this.productData.images;t&&t.length&&this.forwardJump("hotelimages","/webapp/tuan/hotelimages/"+this.productId+".html",{viewName:"hotelimages"})},showBranch:function(){var t=this.cityId;this.forwardJump("hotelsubbranch","/webapp/tuan/hotelsubbranch"+(t?"?cityid="+t:""))},showMap:function(t){var e=$(t.currentTarget),a=e.attr("data-coords").split(","),i=e.attr("data-hotel-name");window.mapdata={Longitude:a[0],Latitude:a[1],hotelName:i},this.forwardJump("hotelmap","/webapp/tuan/hotelmap?lon="+a[0]+"&lat="+a[1]+"&hotelName="+i)},showComment:function(){this.forwardJump("hotelcomments","/webapp/tuan/hotelcomments")},showService:function(){this.forwardJump("hotelservice","/webapp/tuan/hotelservice")},showMorehotel:function(t){var e=this.$el.find(".J_relatedRest"),a=$(t.target),i=a.data("expanded");e.css({display:i?"none":""}).removeClass("no_bb"),a.data("expanded",!i).html(i?"更多":"收起").attr("class",i?"view_unfold":"view_fold")},showTimer:function(t){var e=Date.parse(t.replace(/\-/g,"/")),a=this.getServerDate();this.dateDiff=e-a;var i=864e5;this.dateDiff/i<3&&(this.timer=setInterval(_.bind(this.updateTimer,this),600))},updateTimer:function(){if(this.dateDiff>0){var t=864e5,e=36e5,a=6e4,i=1e3,o=this.dateDiff,r=Math.floor(o/t);o%=t;var n=Math.floor(o/e);o%=e;var s=Math.floor(o/a);o%=a;var c=Math.floor(o/i);this.$el.find(".tuan_hotel_time").text("剩余  "+r+"天"+n+"小时"+s+"分"+c+"秒"),this.dateDiff=this.dateDiff-1e3}else this.endTimer()},endTimer:function(){clearInterval(this.timer),this.$el.find(".tuan_hotel_time").text("0天0小时0分0秒"),this.$el.find("#J_submit").addClass(T)},getAppUrl:function(){var t=R("pid");return"ctrip://wireless/hotel_groupon_detail?c1="+t},toggleInvalidDateInfo:function(t){var e=$(t.target),a=e.hasClass(b),i=e.parent().prev();i[a?"show":"hide"](),a?e.removeClass(b).addClass(D).text("收起"):e.removeClass(D).addClass(b).text("查看不适用日期")},onHotelDetailClick:function(t){var e=$(t.target).attr("data-hotel-id");this.gotoHotelDetail(e)},gotoNearProduct:function(t){var e=$(t.currentTarget).data("id");this.forwardJump("detail","/webapp/tuan/detail/"+e+".html"+(this.cityId?"?cityid="+this.cityId:""))},gotoHotelDetail:function(e){var a=new Date,i=new Date(a.setDate(a.getDate()+1)),o=encodeURIComponent(location.href),r=y?"ctrip://wireless/InlandHotel?hotelDataType=1&checkInDate="+v(new Date)+"&checkOutDate="+v(i)+"&hotelId="+e+"&from="+o:"http://m.ctrip.com/webapp/hotel/hoteldetail/"+e+".html?from="+o;t.jumpToPage(r,this)}})});