define(["TuanApp","libs","c","TuanStore","TuanBaseView","cCommonPageFactory","TuanModel","text!HotelCommentsTpl"],function(t,i,e,s,o,a,n,h){var l={pageTitle:"酒店点评"},d=e.base,r=s.TuanDetailsStore.getInstance(),c=(s.TuanHotelCommentListStore.getInstance(),n.TuanHotelCommentListModel.getInstance()),g=a.create("TuanBaseView"),m=g.extend({pageid:"214012",hpageid:"215012",pageSize:25,events:{},onCreate:function(){var t=this.$el;t.html($.trim(h)),this.totalWrap=t.find("#J_commTotal"),this.listWrap=t.find("#J_commList"),this.totalTpl=_.template(t.find("#J_commTotalTpl").html()),this.listTpl=_.template(t.find("#J_commListTpl").html()),this.onWindowScroll=$.proxy(this._onWindowScroll,this),this.showLoading(),r&&null!=r.get()?(this.productId=r.get().id,this.hotelId=r.get().hotels[0].id,this.showComments()):this.backAction(),this.totalWrap.empty(),this.listWrap.empty()},setHeader:function(){var t=this;this.header.set({title:l.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){t.backAction()},homeHandler:function(){t.backHome()}}}),this.header.show()},showComments:function(){this.pageIdx=1,this.getCommentListData(this.pageIdx)},rederList:function(t){t.dateFormat=d.Date.format,t.cDate=d.Date,this.totalPages=Math.ceil(t.count/this.pageSize),pageNum=isNaN(this.pageIdx)?1:this.pageIdx,1>=pageNum&&this.totalWrap.html(this.totalTpl(t)),this.listWrap.append(this.listTpl(t)),1==this.pageIdx&&$(window).bind("scroll",this.onWindowScroll)},getCommentListData:function(t){c.setParam({hotelId:this.hotelId,pageIdx:t}),c.param.head=c.getHead().get(),c.excute(function(t){return this.hideLoading(),this.isLoading=!1,t?void this.rederList(t):void this.showMessage("抱歉，数据加载失败，请重试!")},function(t){this.isLoading=!1;var i=t.msg?t.msg:"啊哦,数据加载出错了!",e=this;this.showHeadWarning("酒店评论信息",i,function(){e.backAction()}),this.hideLoading()},!0,this)},_onWindowScroll:function(){var t=e.ui.Tools.getPageScrollPos(),i=isNaN(this.pageIdx)?1:this.pageIdx;if(!(this.pageIdx<this.totalPages&&this.totalPages>1))return this.isComplete=!0,void $(window).unbind("scroll",this.onWindowScroll);this.isComplete=!1;var s=t.pageHeight-(t.top+t.height);if(300>=s&&!this.isComplete&&!this.isLoading){if(this.isLoading=!0,this.pageIdx>this.totalPages)return void(this.isComplete=!0);this.pageIdx=++i,this.getCommentListData(this.pageIdx)}},onShow:function(){this.setHeader()},onHide:function(){$(window).unbind("scroll",this.onWindowScroll)},backAction:function(){this.back()},backHome:function(){t.tHome()}});return m});