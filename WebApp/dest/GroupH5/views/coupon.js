define(["TuanApp","libs","c","cUtility","cUserModel","CommonStore","TuanStore","TuanModel","TuanBaseView","cCommonPageFactory","text!CouponTpl"],function(e,o,t,n,i,s,a,u,p,c,r){function d(e){return new t.base.Date(e).format("Y-m-d")}var l=a.TuanDetailsStore.getInstance(),h=u.TuanValidateCouponModel.getInstance(),g=u.TuanCouponListModel.getInstance(),C=(a.TuanCouponListStore.getInstance(),a.TuanSelectedCouponStore.getInstance()),f=s.UserStore.getInstance(),T=n.isInApp(),v="choosed",m={pageTitle:"使用优惠券",invaildCoupon:"优惠券代码无效，请更换优惠券",codeNotEmpty:"请输入团购优惠券码",errorTry:"发生错误，请重试"},I=c.create("TuanBaseView"),L=I.extend({tpl:r,events:{"click #J_useCouponToggle":"useCouponToggle","click #J_clearCoupon":"clearCoupon","input #J_couponInput":"showClearIcon","focus #J_couponInput":"adjustInputPosition","click #J_validateCoupon":"validateCoupon","click #J_couponList>li":"selectedCoupon"},render:function(e){e=e||[];var o=this.$el,t=C.get(),n={coupons:e,dateFormat:d,notUse:t&&t.pid==this.pid&&t.isNotUse};if(this.coupons=e,o.html($.trim(_.template(this.tpl,n))),this.els={useCouponToggle:o.find("#J_useCouponToggle"),couponInput:o.find("#J_couponInput"),clearCoupon:o.find("#J_clearCoupon"),couponWrap:o.find("#J_couponList"),couponList:o.find("#J_couponList>li"),enterWrap:o.find("#J_enterWrap")},e.length&&t&&t.pid==this.pid){var i=this.els.couponWrap.find('[data-code="'+t.code+'"]');i&&(i.addClass(v),i.remove().prependTo("#J_couponList"))}},onCreate:function(){},onLoad:function(){this.pid=l.getAttr("id"),this._setPageView(),f.isLogin()?this.getCouponList():this.render()},_setPageView:function(){var e=this;this.header.set({title:m.pageTitle,back:!0,home:!0,view:this,tel:4000086666,events:{returnHandler:function(){e.back()},homeHandler:function(){e.redirectToIndex()}}}),this.header.show()},onShow:function(){this.setTitle(m.pageTitle)},onHide:function(){},redirectToIndex:function(){e.tHome()},useCouponToggle:function(e){var o=$(e.target);o.hasClass(v)||(this.els.couponList.removeClass(v),C.remove(),C.set({pid:this.pid,isNotUse:!0}),this.back())},adjustInputPosition:function(){this.els.enterWrap[0].scrollIntoView(),T||(document.body.scrollTop=document.body.scrollTop-48)},getCouponList:function(){var e=this;this.showLoading(),g.setParam({pid:this.pid,head:g.getHead().get()}),g.execute(function(o){e.render(o.coupons),e.hideLoading()},function(){e.render(),e.hideLoading()},!1,this)},showClearIcon:function(e){$(e.target).val()?this.els.clearCoupon.show():this.els.clearCoupon.hide()},clearCoupon:function(){this.els.couponInput.val(""),this.els.clearCoupon.hide()},validateCoupon:function(){var e=this,o=this.els.couponInput.val();return o?(h.setParam({code:o,pid:this.pid}),void h.execute(function(t){if(1===t.res){var n=t.couponInfo;n.pid=e.pid,n.isInput=!0,n.code=o;var i=e.$el.find('li[data-code="'+o+'"]');i&&(i.siblings("."+v).removeClass(v),i.addClass(v),i.remove().prependTo("#J_couponList")),e.els.useCouponToggle.removeClass(v),C.set(n),e.back("booking")}else e.showToast(t.msg||m.invaildCoupon)},function(){e.showToast(m.errorTry)},!1,this)):void this.showToast(m.codeNotEmpty)},selectedCoupon:function(e){var o=$(e.currentTarget),t=o.data("index"),n=this.coupons[t];o.siblings("."+v).removeClass(v),o.toggleClass(v),this.els.useCouponToggle.removeClass(v),o.hasClass(v)?(n&&(n.pid=this.pid,C.set(n)),this.back("booking"),o.remove().prependTo("#J_couponList")):C.remove()}});return L});