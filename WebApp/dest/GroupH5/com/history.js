define(["c","cStore","PageTreeConfig"],function(t,r,e){function i(t){return null===t||void 0===t}function n(t){this.data={};for(var r in t)t[r]&&this.add(r,t[r].url,t[r].prev,t[r].jump,t[r].range,t[r].params)}function s(){this.stack=o.getInstance()}var a=t.base,u=/\{([^\{\}]+)\}/g;n.prototype={constructor:n,buildNode:function(t,r,e,i,n,s){return{id:t,prev:e,url:r,jump:i||!1,range:n,params:s||{}}},add:function(t,r,e,i,n,s){this.data[t]=this.buildNode(t,r,e,i,n,s)},getNode:function(t,r){var e=this.data[t];if(!e)return null;var n=(e.url||"",e.param||{});r=r||{};var s=(e.url||"").replace(u,function(t,e){return i(r[e])?i(n[e])?"":n[e]:r[e]});return{id:e.id,prev:e.prev,url:e.url,reurl:s,jump:e.jump,range:e.range}},getPrevNode:function(t,r){var e=this.data[t],n=e&&e.prev&&this.data[e.prev]&&this.data[e.prev];if(!n)return null;r=r||{};var s=n.params||{},a=(n.url||"").replace(u,function(t,e){return i(r[e])?i(s[e])?"":s[e]:r[e]});return{id:n.id,url:n.url,prevurl:a,prev:n.prev,jump:n.jump,range:n.range}}};var c=new n(e),o=new a.Class(r,{__propertys__:function(){this.key="P_TUAN_HISTORY_STACK",this.lifeTime="30D",this.isUserData=!0},initialize:function($super,t){$super(t)},pop:function(){var t=this.getAttr("history")||[],r=t.pop();return this.setAttr("history",t),r},push:function(t,r){var e=this.getAttr("history")||[],i=Math.max(0,e.length-1);r?e[i]=t:e.push(t),this.setAttr("history",e)},top:function(){var t=this.getAttr("history")||[],r=Math.max(0,t.length-1);return t[r]},length:function(){var t=this.getAttr("history");return t&&t.length||0},clear:function(){this.setAttr("history",[])},index:function(t){var r=this.getAttr("history")||[];return t=0>t?r.length+t:t,r[t]},addCache:function(t,r,e){var i={id:t,obj:r,replace:e};this.setAttr("cache",i)},getCache:function(){return this.getAttr("cache")||{}},clearCache:function(){this.setAttr("cache",{})},popById:function(t){for(var r=this.getAttr("history")||[],e=-1,i=0,n=null,s=r.length-1;s>-1;s--)if(i++,r[s].id===t){e=s;break}return e>-1&&(n=r.splice(e,i)),this.setAttr("history",r),n},addSequeHistory:function(t){var r=this.getAttr("sequehistory")||[],e=Math.max(0,r.length-1),i=r[e]||{};i.id!==t.id&&(r.length>10&&r.splice(0,3),r.push(t),this.setAttr("sequehistory",r))},getSequeTop:function(t){var r=this.getAttr("sequehistory")||[],e=Math.max(0,r.length-1),i=null;return r[e]&&(r[e].id!=t?i=r[e]:r[e-1]&&(i=r[e-1])),i}});s.prototype={constructor:s,push:function(t,r,e,i){this.stack.addCache(t,s.buildEntry(t,r,e),i)},confirmPush:function(t){var r=this.stack.getCache();r.id===t&&(this.stack.push(r.obj,r.replace),this.stack.clearCache())},pop:function(){return this.stack.pop()},top:function(){return this.stack.top()},index:function(t){return this.stack.index(t)},clear:function(){this.stack.clear()},getCache:function(){return this.stack.getCache()},clearCache:function(){this.stack.clearCache()},popById:function(t){return this.stack.popById(t)},addSequeHistory:function(t){this.stack.addSequeHistory(t)},getSequeTop:function(t){return this.stack.getSequeTop(t)}},s.buildEntry=function(t,r,e){return{id:t,url:r,ver:e}};var h="_____FROM_____",d=function(t,r){this.tree=t,this.stack=r};d.prototype={constructor:d,back:function(t,r){var e=this.stack.pop(),i=this.stack.top(),n=this.tree.getPrevNode(t,r),s=this.tree.getNode(t),a="",u=s.range||[];if(i&&i.id===h)return this.stack.addSequeHistory({id:t,url:a}),this.stack.pop(),{fullurl:i.url,url:i.url.replace(/^[^#]+#/g,"").replace(/^#+/g,""),jump:!0};var t,c=!1;return e&&e.id===t&&i&&i.id&&(!u.length||_.indexOf(u,i.id)>-1)?(a=i.url,c=e.ver!==i.ver||s.jump,t=i.id):(a=n.prevurl,c=!!s.jump,t=n.id,this.stack.clear()),this.stack.addSequeHistory({id:t,url:a}),{fullurl:a,url:a.replace(/^[^#]+#/g,"").replace(/^#+/g,""),jump:c,id:t}},popById:function(t){return this.stack.popById(t)},forward:function(t,r,e,i){if("object"==typeof r){var n=this.tree.getNode(t,r);r=n.reurl}return this.stack.push(t,r,e,i),this.stack.addSequeHistory({id:t,url:r}),r},confirmForward:function(t){this.stack.confirmPush(t)},getLastView:function(){var t,r=this.stack.getCache()||{};return t=r.id?this.stack.top():this.stack.index(-2)},getLatelyView:function(t){var r=this.stack.getSequeTop(t);return r?r.id:null},addHistory:function(t,r,e){var i=this.stack.getCache()||{};i.id&&i.id!==t&&this.stack.clearCache();var n=this.stack.top(),s=this._getFromByUrl(r);(!n||n.id!==t||s)&&(s&&(this.clearHistory(),this.stack.push(h,s),this.stack.addSequeHistory({id:h,url:s}),this.confirmForward(h)),this.stack.push(t,r,e),this.stack.addSequeHistory({id:t,url:r}),this.confirmForward(t))},clearHistory:function(t,r,e){this.stack.clear(),t&&r&&this.addHistory(t,r,e)},isPrevPageOrigin:function(){var t=this.getLastView();return t&&t.id===h},switchTree:function(t){this.tree=t},_getFromByUrl:function(t){var r="from",e=(t||"").split(/#+/g),i=e[0],n=e[1]||"",s=null;if(i.indexOf(r)>-1){var a=this._getQueryString(i);a[r]&&(s=a[r])}if(n.indexOf(r)>-1){var u=this._getQueryString(n);u[r]&&(s=u[r])}return s&&(s=decodeURIComponent(s)),s&&!s.match(/^\s*(?:http|\/)/)&&(s=null),s},_getQueryString:function(t){var r=(t||"").split("?");r.shift();for(var e,r=r.join("?").split(/(?!\?[^?]*)&/g),i={},n=0,s=r.length;s>n;n++)e=r[n].split("="),i[e.shift()]=e.join("=");return i}};var l=new d(c,new s);return l});